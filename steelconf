!muf 4
;; ============================================================
;; steelconf — Vitte Project (corrected)
;; ============================================================

[workspace]
  .set name "vitte"
  .set root "."
  .set target_dir "build"
  .set profile "release"
..

;; ------------------------------------------------------------
;; Profiles
;; ------------------------------------------------------------

[profile debug]
  .set opt 0
  .set debug 1
..

[profile release]
  .set opt 2
  .set debug 1
..

;; ------------------------------------------------------------
;; Tools
;; ------------------------------------------------------------

[tool cc]
  .exec "clang"
..

[tool cxx]
  .exec "clang++"
..

[tool sh]
  .exec "sh"
..

[tool format]
  .exec "clang-format"
..

[tool tidy]
  .exec "clang-tidy"
..

;; ------------------------------------------------------------
;; Build
;; ------------------------------------------------------------

[bake build]
  .make c_src   cglob "src/**/*.c"
  .make cpp_src cglob "src/**/*.cpp"

  [run cxx]
    .set "-std=c++20" 1
    .set "-Wall" 1
    .set "-Wextra" 1
    .set "-Werror" 1
    .set "-O2" 1
    .set "-g" 1
    .set inputs "{c_src, cpp_src}"
    .set output "bin/vitte"
  ..
  .output exe "bin/vitte"
..

;; ------------------------------------------------------------
;; Format
;; ------------------------------------------------------------

[bake format]
  .make c_src   cglob "src/**/*.c"
  .make cpp_src cglob "src/**/*.cpp"

  [run format]
    .set "-i" 1
    .set inputs "{c_src, cpp_src}"
  ..
  .output marker "build/.format.ok"
..

;; ------------------------------------------------------------
;; Static analysis
;; ------------------------------------------------------------

[bake tidy]
  .make cpp_src cglob "src/**/*.cpp"

  [run tidy]
    .set inputs "{cpp_src}"
    .set "--" 1
    .set "-std=c++20" 1
  ..
  .output marker "build/.tidy.ok"
..

;; ------------------------------------------------------------
;; Tests
;; ------------------------------------------------------------

[bake test]
  [run sh]
    .set "-c" "echo 'Running Vitte tests (std/test)…'"
  ..
  .output marker "build/.test.ok"
..

[bake parse-watch]
  [run sh]
    .set "-c" "tools/parse_watch.sh"
  ..
  .output marker "build/.parse_watch.ok"
..

;; ------------------------------------------------------------
;; Stdlib checks
;; ------------------------------------------------------------

[bake std-check]
  [run sh]
    .set "-c" "test -d src/vitte/std/core && test -d src/vitte/std/io && test -d src/vitte/std/math && test -d src/vitte/std/test && echo 'std layout OK'"
  ..
  .output marker "build/.std.ok"
..

;; ------------------------------------------------------------
;; Clean
;; ------------------------------------------------------------

[bake clean]
  [run sh]
    .set "-c" "rm -rf build bin"
  ..
  .output marker "build/.clean.ok"
..

[bake distclean]
  [run sh]
    .set "-c" "rm -rf build bin .cache .clangd"
  ..
  .output marker "build/.distclean.ok"
..