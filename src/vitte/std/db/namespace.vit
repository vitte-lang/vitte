<<<
namespace.vit
std db namespace helpers
>>>

space std/db/namespace


<<<
imports
>>>

use std/core/types.string
use std/core/types.Unit
use std/core/result.Result
use std/core/option.Option
use std/core/types.usize
use std/db/types.Db
use std/db/types.Entry
use std/db/kv


<<<
types
>>>

form Namespace {
    db: *Db
    prefix: string
}


<<<
helpers
>>>

#[inline]
proc namespace(db: *Db, prefix: string) -> Namespace {
    give Namespace(db = db, prefix = prefix)
}

#[inline]
proc ns_key(scope: Namespace, key: string) -> string {
    give scope.prefix + ":" + key
}

#[inline]
proc put(scope: Namespace, key: string, value: string) -> Result[Unit, string] {
    give kv.put(scope.db, ns_key(scope, key), value)
}

#[inline]
proc get(scope: Namespace, key: string) -> Result[Option[string], string] {
    give kv.get(scope.db, ns_key(scope, key))
}

#[inline]
proc del(scope: Namespace, key: string) -> Result[bool, string] {
    give kv.del(scope.db, ns_key(scope, key))
}

#[inline]
proc keys(scope: Namespace) -> Result[[string], string] {
    give kv.keys_prefix(scope.db, scope.prefix + ":")
}

#[inline]
proc batch_put(scope: Namespace, entries: [Entry]) -> Result[Unit, string] {
    let i: usize = 0
    let out_entries: [Entry] = []
    loop {
        if i >= entries.len { break }
        let e = entries[i]
        out_entries = out_entries + [Entry(key = ns_key(scope, e.key), value = e.value)]
        i = i + 1
    }
    give kv.batch_put(scope.db, out_entries)
}
