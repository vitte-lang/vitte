<<<
target.vit
compiler-builtins config
>>>

space std/alloc/compiler_builtins/builtins_shim/config


<<<
primitive aliases
>>>

type bool  = builtin.bool
type u8    = builtin.u8
type u16   = builtin.u16
type u32   = builtin.u32
type u64   = builtin.u64
type usize = builtin.usize


<<<
endianness
>>>

pick Endianness {
    Little
    Big
}


<<<
architecture
>>>

pick Architecture {
    X86
    X86_64
    ARM
    AARCH64
    RISCV32
    RISCV64
    WASM32
    WASM64
}


<<<
operating system
>>>

pick OperatingSystem {
    Linux
    Windows
    MacOS
    FreeBSD
    WASI
    BareMetal
}


<<<
abi kind
>>>

pick AbiKind {
    SysV
    MSVC
    EABI
    WASI
    Bare
}


<<<
primitive sizes
>>>

form PrimitiveSizes {
    size_bool:  usize
    size_char:  usize
    size_i16:   usize
    size_i32:   usize
    size_i64:   usize
    size_i128:  usize

    size_f32:   usize
    size_f64:   usize

    size_ptr:   usize
    size_usize: usize
}


<<<
primitive alignments
>>>

form PrimitiveAlignments {
    align_bool:  usize
    align_char:  usize
    align_i16:   usize
    align_i32:   usize
    align_i64:   usize
    align_i128:  usize

    align_f32:   usize
    align_f64:   usize

    align_ptr:   usize
    align_usize: usize
}


<<<
target descriptor
>>>

form Target {
    arch: Architecture
    os: OperatingSystem
    abi: AbiKind

    endianness: Endianness

    pointer_bits: usize
    page_size: usize

    sizes: PrimitiveSizes
    aligns: PrimitiveAlignments

    supports_unaligned_access: bool
    supports_atomic_u64: bool
    supports_atomic_ptr: bool
}


<<<
x86_64 linux target
>>>

#[export]
const TARGET_X86_64_LINUX: Target = Target(
    arch = Architecture.X86_64,
    os   = OperatingSystem.Linux,
    abi  = AbiKind.SysV,

    endianness = Endianness.Little,

    pointer_bits = 64,
    page_size   = 4096,

    sizes = PrimitiveSizes(
        size_bool  = 1,
        size_char  = 1,
        size_i16   = 2,
        size_i32   = 4,
        size_i64   = 8,
        size_i128  = 16,
        size_f32   = 4,
        size_f64   = 8,
        size_ptr   = 8,
        size_usize = 8,
    ),

    aligns = PrimitiveAlignments(
        align_bool  = 1,
        align_char  = 1,
        align_i16   = 2,
        align_i32   = 4,
        align_i64   = 8,
        align_i128  = 16,
        align_f32   = 4,
        align_f64   = 8,
        align_ptr   = 8,
        align_usize = 8,
    ),

    supports_unaligned_access = true,
    supports_atomic_u64       = true,
    supports_atomic_ptr       = true,
)


<<<
wasm32 wasi target
>>>

#[export]
const TARGET_WASM32_WASI: Target = Target(
    arch = Architecture.WASM32,
    os   = OperatingSystem.WASI,
    abi  = AbiKind.WASI,

    endianness = Endianness.Little,

    pointer_bits = 32,
    page_size   = 65536,

    sizes = PrimitiveSizes(
        size_bool  = 1,
        size_char  = 1,
        size_i16   = 2,
        size_i32   = 4,
        size_i64   = 8,
        size_i128  = 0,
        size_f32   = 4,
        size_f64   = 8,
        size_ptr   = 4,
        size_usize = 4,
    ),

    aligns = PrimitiveAlignments(
        align_bool  = 1,
        align_char  = 1,
        align_i16   = 2,
        align_i32   = 4,
        align_i64   = 8,
        align_i128  = 0,
        align_f32   = 4,
        align_f64   = 8,
        align_ptr   = 4,
        align_usize = 4,
    ),

    supports_unaligned_access = true,
    supports_atomic_u64       = false,
    supports_atomic_ptr       = false,
)


<<<
active target
>>>

#[export]
const TARGET: Target = TARGET_X86_64_LINUX


<<<
target invariants
>>>

#[export]
proc assert_target_sane() {
    if TARGET.pointer_bits != TARGET.sizes.size_ptr * 8 {
        builtin.trap("target invariant: pointer size mismatch")
    }

    if TARGET.sizes.size_usize != TARGET.sizes.size_ptr {
        builtin.trap("target invariant: usize/ptr mismatch")
    }
}