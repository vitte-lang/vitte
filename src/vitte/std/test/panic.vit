<<<
panic.vit
std test panic helpers
>>>

space std/test/panic


<<<
imports
>>>

use std/core/types.bool
use std/core/types.string
use std/core/types.Unit

use std/core/panic as core_panic
use std/test/assert


<<<
panic capture (backend hook)
>>>

#[extern]
proc panic_occurred() -> bool

#[extern]
proc reset_panic_state()


<<<
panic assertions
>>>

#[inline]
proc assert_panics(f: proc() -> Unit) {
    reset_panic_state()
    f()
    if not panic_occurred() {
        core_panic.panic("expected panic, but none occurred")
    }
}

#[inline]
proc assert_not_panics(f: proc() -> Unit) {
    reset_panic_state()
    f()
    if panic_occurred() {
        core_panic.panic("unexpected panic occurred")
    }
}


<<<
message-oriented helpers
>>>

#[extern]
proc panic_message() -> string


#[inline]
proc assert_panics_with(msg: string, f: proc() -> Unit) {
    reset_panic_state()
    f()
    if not panic_occurred() {
        core_panic.panic("expected panic, but none occurred")
    }
    let m = panic_message()
    if m != msg {
        core_panic.panic("panic message mismatch")
    }
}