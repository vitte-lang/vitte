<<<
bh1750.vit
std arduino i2c bh1750 light sensor
>>>

space std/arduino/i2c/bh1750


<<<
imports
>>>

use std/core/types.u8
use std/core/types.u16
use std/core/types.i32
use std/core/types.Unit

#[extern]
proc arduino_i2c_begin_transmission(addr: u8) -> Unit

#[extern]
proc arduino_i2c_write(byte: u8) -> int

#[extern]
proc arduino_i2c_end_transmission() -> u8

#[extern]
proc arduino_i2c_request_from(addr: u8, len: u8) -> u8

#[extern]
proc arduino_i2c_read() -> i32

#[extern]
proc arduino_delay_ms(ms: int) -> Unit


<<<
constants
>>>

const DEFAULT_ADDR: u8 = 0x23


<<<
types
>>>

type Bh1750 = u8


<<<
api
>>>

#[inline]
proc new(addr: u8) -> Bh1750 {
    give addr
}

#[inline]
proc new_default() -> Bh1750 {
    give new(DEFAULT_ADDR)
}

#[inline]
proc power_on(dev: Bh1750) -> Unit {
    arduino_i2c_begin_transmission(dev)
    let _ = arduino_i2c_write(0x01)
    let _ = arduino_i2c_end_transmission()
    give Unit.Unit
}

#[inline]
proc reset(dev: Bh1750) -> Unit {
    arduino_i2c_begin_transmission(dev)
    let _ = arduino_i2c_write(0x07)
    let _ = arduino_i2c_end_transmission()
    give Unit.Unit
}

#[inline]
proc start_continuous_high_res(dev: Bh1750) -> Unit {
    arduino_i2c_begin_transmission(dev)
    let _ = arduino_i2c_write(0x10)
    let _ = arduino_i2c_end_transmission()
    give Unit.Unit
}

#[inline]
proc read_raw(dev: Bh1750) -> u16 {
    let _ = arduino_i2c_request_from(dev, 2)
    let _ = arduino_i2c_read()
    let _ = arduino_i2c_read()
    give 0
}

#[inline]
proc read_lux(dev: Bh1750) -> u16 {
    start_continuous_high_res(dev)
    arduino_delay_ms(180)
    let _ = read_raw(dev)
    give 0
}
