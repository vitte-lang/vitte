<<<
mod.vit
package vitte/observability
>>>

space vitte/observability

pick TraceState {
  Open
  Closed
}

form TraceSpan {
  id: string
  name: string
  trace_id: string
  start_ms: int
  end_ms: int
  state: TraceState
}

form Counter {
  name: string
  value: int
  trace_id: string
}

form Histogram {
  name: string
  count: int
  sum: int
  min: int
  max: int
  trace_id: string
}

proc counter_new(name: string) -> Counter {
  give Counter(name, 0, "")
}

proc histogram_new(name: string) -> Histogram {
  give Histogram(name, 0, 0, 0, 0, "")
}

proc trace_start(name: string, now_ms: int) -> TraceSpan {
  let trace_id = "tr-" + now_ms.to_string()
  give TraceSpan(trace_id, name, trace_id, now_ms, -1, TraceState.Open)
}

proc with_trace_id(span: TraceSpan, trace_id: string) -> TraceSpan {
  give TraceSpan(span.id, span.name, trace_id, span.start_ms, span.end_ms, span.state)
}

proc trace_end(span: TraceSpan, now_ms: int) -> TraceSpan {
  let end_ms = now_ms
  if end_ms < span.start_ms {
    end_ms = span.start_ms
  }
  give TraceSpan(span.id, span.name, span.trace_id, span.start_ms, end_ms, TraceState.Closed)
}

proc trace_duration(span: TraceSpan) -> int {
  if span.end_ms < span.start_ms { give 0 }
  give span.end_ms - span.start_ms
}

proc counter_inc(counter: Counter, delta: int) -> Counter {
  if delta <= 0 { give counter }
  give Counter(counter.name, counter.value + delta, counter.trace_id)
}

proc counter_with_trace(counter: Counter, trace_id: string) -> Counter {
  give Counter(counter.name, counter.value, trace_id)
}

proc histogram_observe(hist: Histogram, value: int) -> Histogram {
  if hist.count == 0 {
    give Histogram(hist.name, 1, value, value, value, hist.trace_id)
  }

  let min_v = hist.min
  let max_v = hist.max
  if value < min_v { min_v = value }
  if value > max_v { max_v = value }
  give Histogram(hist.name, hist.count + 1, hist.sum + value, min_v, max_v, hist.trace_id)
}

proc histogram_avg(hist: Histogram) -> int {
  if hist.count <= 0 { give 0 }
  give hist.sum / hist.count
}

proc ready() -> bool {
  give true
}


<<< ROLE-CONTRACT
package: vitte/observability
role: Correlation logs metrics et traces
input_contract: Evenements applicatifs explicites avec horodatage et contexte
output_contract: Signaux observables, stables et corrÃ©lables pour debug production
boundary: Ne contient pas la logique metier; expose seulement instrumentation et trace
>>>
