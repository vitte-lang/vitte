module vitte.bootstrap.back.emit_files

import std.collections as coll
import vitte.compiler.diagnostics as diag
import vitte.bootstrap.back.codegen_c as cgen
import vitte.bootstrap.back.codegen_vm as vmgen
import vitte.bootstrap.back.driver_c as cdrv

# ============================================================================
# Vitte bootstrap - Emission de fichiers backend
# Modèle logique maximal pour décrire l’émission de fichiers (C, VM, logs…)
# purement déclaratif, sans I/O
#
# Objectifs
#   - Décrire comment les backends produisent des fichiers concrets :
#       * fichiers C, headers, objets, binaires,
#       * dumps IR/VM, logs, fichiers de dépendances,
#       * fichiers temporaires utilisés pour des écritures atomiques.
#   - Représenter :
#       * les cibles d’émission,
#       * les flux de contenu (chunks textuels / binaires),
#       * les plans d’actions (create, write, rename, chmod, clean),
#       * les transformations applicables (normalisation de fins de ligne,
#         indentation, trimming, etc.),
#       * les hints d’intégrité (taille, hash) et les stats de job.
#   - Servir de contrat entre :
#       * les backends (codegen_c, codegen_vm),
#       * le driver C (driver_c),
#       * la couche runtime qui effectue réellement les opérations I/O.
#
# Conventions
#   - Aucune fonction, aucune logique d’écriture : uniquement des données.
#   - Tous les éléments clés ont un identifiant stable.
#   - Aucune dépendance à des APIs système, chemins modélisés sous forme de String.
#   - Aucun usage d’accolades, blocs terminés par `.end`.
# ============================================================================

# ----------------------------------------------------------------------------
# Identifiants & noms
# ----------------------------------------------------------------------------

type BtEmitJobId       = i32
type BtEmitTargetId    = i32
type BtEmitChunkId     = i32
type BtEmitStreamId    = i32
type BtEmitPlanId      = i32
type BtEmitStepId      = i32
type BtEmitSessionId   = i32
type BtEmitTransformId = i32

struct BtEmitName
    id: i32
    text: String
    origin_span: diag.SpanId
.end

# ----------------------------------------------------------------------------
# Fichiers cibles & méta-informations
# ----------------------------------------------------------------------------

enum BtEmitFileKind
    | TextFile
    | BinaryFile
    | Directory
    | Symlink
    | CopyOfArtifact
.end

# Catégorie logique de fichier pour tri / reporting / UX
enum BtEmitFileCategory
    | Source              # sources utilisateur
    | GeneratedSource     # fichiers C générés, etc.
    | Header
    | IntermediateObject
    | StaticLibrary
    | SharedLibrary
    | Executable
    | DiagnosticLog
    | Report
    | Temp
    | Misc
.end

enum BtEmitEncoding
    | Binary        # aucun encodage, octets bruts
    | Utf8
    | Latin1
    | SystemDefault
.end

enum BtEmitNewlineStyle
    | Preserve      # ne modifie pas les fins de ligne
    | Lf            # \n (Unix)
    | CrLf          # \r\n (Windows)
    | Native        # dépendant de la plateforme cible
.end

enum BtEmitWriteMode
    | Truncate          # ouvre + tronque, réécrit intégralement
    | Append            # ajoute à la fin
    | CreateNew         # échoue si le fichier existe déjà
    | TempThenAtomic    # écrit dans un temporaire puis rename atomique
.end

enum BtEmitPermissionMode
    | UseUmask          # laisse l’OS appliquer la umask
    | Explicit          # permissions explicites ci-dessous
.end

struct BtEmitPermissions
    mode: BtEmitPermissionMode
    user_read: bool
    user_write: bool
    user_exec: bool
    group_read: bool
    group_write: bool
    group_exec: bool
    other_read: bool
    other_write: bool
    other_exec: bool
.end

# Hints d’intégrité pour vérification optionnelle des outputs
enum BtEmitHashAlgorithm
    | None
    | Sha256
    | Blake3
.end

struct BtEmitIntegrityHint
    algorithm: BtEmitHashAlgorithm
    expected_digest_hex: String   # chaîne hexadécimale (0..9a..f)
    expected_size_bytes: i64      # -1 si inconnue
.end

# On réutilise les chemins du driver C pour éviter la duplication
type BtEmitPath = cdrv.BtCPath

struct BtEmitTarget
    id: BtEmitTargetId
    name: BtEmitName
    kind: BtEmitFileKind
    category: BtEmitFileCategory

    path: BtEmitPath
    is_temporary: bool
    keep_on_success: bool
    keep_on_failure: bool

    encoding: BtEmitEncoding
    newline_style: BtEmitNewlineStyle
    write_mode: BtEmitWriteMode
    permissions: BtEmitPermissions

    has_integrity_hint: bool
    integrity_hint: BtEmitIntegrityHint

    # lien logique avec un artefact de build (optionnel)
    attached_artifact: cdrv.BtCArtifactId
.end

# ----------------------------------------------------------------------------
# Transformations de flux / post-traitement
# ----------------------------------------------------------------------------

enum BtEmitTransformKind
    | NormalizeNewlines         # applique BtEmitNewlineStyle au flux
    | TrimTrailingWhitespace    # supprime les espaces en fin de ligne
    | EnsureFinalNewline        # garantit un \n final
    | PrefixLines               # ajoute un préfixe en début de ligne
    | SuffixLines               # ajoute un suffixe en fin de ligne
    | Indent                    # ajoute une indentation homogène
    | CustomTag                 # tag générique pour extensions runtime
.end

struct BtEmitTransform
    id: BtEmitTransformId
    kind: BtEmitTransformKind
    name: BtEmitName

    enabled: bool
    priority: i32             # ordre relatif d’application (croissant)

    # Paramètres génériques, interprétés par le runtime :
    param_string: String      # ex: préfixe/suffixe/nom de profil
    param_i64: i64            # ex: nombre d’espaces d’indentation
.end

# ----------------------------------------------------------------------------
# Chunks de contenu & flux d’émission
# ----------------------------------------------------------------------------

enum BtEmitChunkKind
    | LiteralText            # chaîne UTF-8
    | LiteralBytes           # octets encodés en base16 / base64
    | FromArtifactPath       # chemin vers un artefact existant
    | FromArtifactContent    # contenu produit à partir d’un artefact logique
    | FromCFile              # serialisation d’un CFile (backend C)
    | FromVmModule           # serialisation d’un module VM
    | FromDiagnosticsSummary # résumé de diagnostics
    | Newline                # fin de ligne logique
.end

struct BtEmitChunkLiteralText
    text: String
.end

struct BtEmitChunkLiteralBytes
    hex_bytes: String      # représentation hexadécimale continue
.end

struct BtEmitChunkFromArtifactPath
    artifact: cdrv.BtCArtifactId
.end

struct BtEmitChunkFromArtifactContent
    artifact: cdrv.BtCArtifactId
    hint: String           # indice libre (ex: "preprocessed", "raw")
.end

struct BtEmitChunkFromCFile
    c_file: cgen.CFileId
    backend_context: cgen.CBackendContext
.end

struct BtEmitChunkFromVmModule
    vm_module: vmgen.VmModuleId
    # à terme, on pourrait référencer un contexte backend VM dédié
.end

struct BtEmitChunkFromDiagnosticsSummary
    job: cdrv.BtCJobId
    only_errors: bool
    include_warnings: bool
    include_notes: bool
.end

struct BtEmitChunkNewline
    explicit_style: BtEmitNewlineStyle
.end

union BtEmitChunkPayload
    lit_text: BtEmitChunkLiteralText
    lit_bytes: BtEmitChunkLiteralBytes
    from_artifact_path: BtEmitChunkFromArtifactPath
    from_artifact_content: BtEmitChunkFromArtifactContent
    from_c_file: BtEmitChunkFromCFile
    from_vm_module: BtEmitChunkFromVmModule
    from_diag_summary: BtEmitChunkFromDiagnosticsSummary
    newline_chunk: BtEmitChunkNewline
.end

struct BtEmitChunk
    id: BtEmitChunkId
    kind: BtEmitChunkKind
    payload: BtEmitChunkPayload
    origin_span: diag.SpanId
.end

struct BtEmitStream
    id: BtEmitStreamId
    name: BtEmitName
    target: BtEmitTargetId
    chunks: coll.Vec[BtEmitChunkId]
    auto_final_newline: bool

    # transform chain appliquée logiquement après assemblage du flux brut
    transforms: coll.Vec[BtEmitTransformId]
.end

# ----------------------------------------------------------------------------
# Plan d’émission : opérations sur le système de fichiers
# ----------------------------------------------------------------------------

enum BtEmitStepKind
    | EnsureParentDirs           # créer les répertoires parents
    | CreateDirectory            # créer un répertoire
    | WriteStream                # écrire un flux dans un fichier
    | CopyFile                   # copie d’un fichier existant
    | Symlink                    # création d’un lien symbolique
    | SetPermissions             # application de permissions
    | TempToFinalAtomic          # rename atomique temp -> final
    | RemoveTemporary            # suppression d’un temporaire
    | FlushDiagnosticsLog        # émission explicite d’un log de diagnostics
    | CustomEmitStep             # point d’extension futur
.end

enum BtEmitStepStatus
    | Planned
    | Running
    | Succeeded
    | Failed
    | Skipped
.end

struct BtEmitStepEnsureParentDirs
    target: BtEmitTargetId
.end

struct BtEmitStepCreateDirectory
    target: BtEmitTargetId
    recursive: bool
.end

struct BtEmitStepWriteStream
    stream: BtEmitStreamId
    target: BtEmitTargetId
.end

struct BtEmitStepCopyFile
    source_path: BtEmitPath
    dest_target: BtEmitTargetId
    overwrite: bool
.end

struct BtEmitStepSymlink
    link_target_path: BtEmitPath   # destination du lien (string brut)
    link_location: BtEmitTargetId
.end

struct BtEmitStepSetPermissions
    target: BtEmitTargetId
    permissions: BtEmitPermissions
.end

struct BtEmitStepTempToFinalAtomic
    temp_target: BtEmitTargetId
    final_target: BtEmitTargetId
.end

struct BtEmitStepRemoveTemporary
    target: BtEmitTargetId
    ignore_errors: bool
.end

struct BtEmitStepFlushDiagnosticsLog
    job: cdrv.BtCJobId
    log_target: BtEmitTargetId
.end

struct BtEmitStepCustom
    tag: String
    description: String
    related_targets: coll.Vec[BtEmitTargetId]
.end

union BtEmitStepPayload
    ensure_parents: BtEmitStepEnsureParentDirs
    create_dir: BtEmitStepCreateDirectory
    write_stream: BtEmitStepWriteStream
    copy_file: BtEmitStepCopyFile
    symlink_step: BtEmitStepSymlink
    set_perms: BtEmitStepSetPermissions
    temp_to_final: BtEmitStepTempToFinalAtomic
    remove_temp: BtEmitStepRemoveTemporary
    flush_diag: BtEmitStepFlushDiagnosticsLog
    custom_step: BtEmitStepCustom
.end

struct BtEmitStep
    id: BtEmitStepId
    kind: BtEmitStepKind
    name: BtEmitName

    payload: BtEmitStepPayload

    depends_on: coll.Vec[BtEmitStepId]
    order_index: i32

    status: BtEmitStepStatus
    start_time_millis: i64
    end_time_millis: i64
.end

struct BtEmitPlan
    id: BtEmitPlanId
    name: BtEmitName

    targets: coll.Vec[BtEmitTarget]
    streams: coll.Vec[BtEmitStream]
    steps: coll.Vec[BtEmitStep]

    # catalogue global des transformations disponibles pour ce plan
    transforms: coll.Vec[BtEmitTransform]
.end

# ----------------------------------------------------------------------------
# Jobs et session d’émission
# ----------------------------------------------------------------------------

enum BtEmitJobStatus
    | NotPlanned
    | Planned
    | Running
    | Succeeded
    | Failed
    | Cancelled
.end

struct BtEmitJobStats
    total_targets: i32
    total_streams: i32
    total_steps: i32

    targets_succeeded: i32
    targets_failed: i32

    bytes_planned: i64
    bytes_written: i64
    bytes_copied: i64
.end

struct BtEmitJob
    id: BtEmitJobId
    name: BtEmitName

    # lien avec un job backend C (facultatif)
    related_c_job: cdrv.BtCJobId

    plans: coll.Vec[BtEmitPlan]
    status: BtEmitJobStatus

    root_output_dir: BtEmitPath

    stats: BtEmitJobStats
.end

struct BtEmitSessionDefaults
    default_encoding: BtEmitEncoding
    default_newline_style: BtEmitNewlineStyle
    default_write_mode: BtEmitWriteMode
    default_permissions: BtEmitPermissions
.end

struct BtEmitSession
    id: BtEmitSessionId
    name: BtEmitName

    jobs: coll.Vec[BtEmitJob]

    # mapping pratique depuis des artefacts C vers des cibles d’émission
    artifact_to_target: coll.Map[cdrv.BtCArtifactId, BtEmitTargetId]

    # valeurs par défaut pour les nouveaux targets/streams
    defaults: BtEmitSessionDefaults

    # racine logique pour les chemins relatifs
    workspace_root: BtEmitPath
.end