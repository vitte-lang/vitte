module vitte.bootstrap.cli.bt_tests

import std.collections as coll
import vitte.compiler.diagnostics as diag
import vitte.bootstrap.cli.bt_args as bt_args
import vitte.bootstrap.cli.bt_cli as bt_cli
import vitte.bootstrap.cli.bt_commands as bt_commands
import vitte.bootstrap.cli.bt_help as bt_help
import vitte.bootstrap.cli.bt_colors as bt_colors
import vitte.bootstrap.cli.bt_cmd_build as cmd_build
import vitte.bootstrap.cli.bt_cmd_check as cmd_check
import vitte.bootstrap.cli.bt_cmd_clean as cmd_clean

# ============================================================================
# Vitte bootstrap - CLI tests model (bt_tests)
# Modèle logique ultra complet pour décrire les tests CLI du bootstrap :
#   - tests de fumée (smoke), d’intégration et de non-régression,
#   - cas de tests paramétrés par argv, env, workspace,
#   - attentes sur exit code, diagnostics, commandes, pipelines,
#   - scénarios multi-étapes (ex: build puis check).
#
# Objectifs
#   - Aucun parsing, aucune I/O, aucun runner directement ici.
#   - Servir de contrat entre :
#       * les fichiers de définition de tests `.vitte`,
#       * le runner de tests CLI stage0,
#       * des outils externes (CI, Vitte Studio).
#   - Respect strict de la syntaxe Vitte : pas d’accolades, blocs terminés par `.end`.
# ============================================================================

# ----------------------------------------------------------------------------
# Identifiants & noms
# ----------------------------------------------------------------------------

type BtTestSuiteId        = i32
type BtTestCaseId         = i32
type BtTestStepId         = i32
type BtTestExpectationId  = i32
type BtTestTagId          = i32
type BtTestMatrixId       = i32
type BtTestSnapshotId     = i32
type BtTestSessionId      = i32

struct BtTestName
    id: i32
    text: String
    origin_span: diag.SpanId
.end

# ----------------------------------------------------------------------------
# Tags, niveaux et catégories de tests
# ----------------------------------------------------------------------------

enum BtTestLevel
    | TestSmoke         # tests ultra rapides, essentiels
    | TestIntegration   # tests d’intégration complets
    | TestRegression    # non-régression
    | TestExperimental  # tests pour fonctionnalités en cours
    | TestCustom
.end

enum BtTestCategory
    | TestCategoryCliParsing
    | TestCategoryCommands
    | TestCategoryBuild
    | TestCategoryCheck
    | TestCategoryClean
    | TestCategoryHelp
    | TestCategoryColors
    | TestCategoryProfiles
    | TestCategoryWorkspace
    | TestCategoryErrorReporting
    | TestCategoryCustom
.end

struct BtTestTag
    id: BtTestTagId
    name: BtTestName

    # Label lisible (ex: "smoke", "ci", "slow", "workspace", "studio")
    label: String
    description: String
.end

# ----------------------------------------------------------------------------
# Matrices de paramètres de tests
# ----------------------------------------------------------------------------

enum BtTestMatrixParamKind
    | MatrixCliFlag          # ex: "--color=always", "--verbose"
    | MatrixEnvVar           # variables d’environnement
    | MatrixWorkspaceLayout  # disposition du workspace (mono/multi module)
    | MatrixProfile          # profil CLI
    | MatrixBackend          # C/VM/mixed
    | MatrixCustom
.end

struct BtTestMatrixParam
    kind: BtTestMatrixParamKind

    # Nom logique (ex: "color_mode", "verbosity", "profile")
    name: String

    # Valeur symbolique (ex: "auto", "always", "never")
    value: String
.end

struct BtTestMatrix
    id: BtTestMatrixId
    name: BtTestName

    # Description de la matrice
    description: String

    # Ensemble de paramètres combinables
    params: coll.Vec[BtTestMatrixParam]
.end

# ----------------------------------------------------------------------------
# Contexte d’exécution d’un test
# ----------------------------------------------------------------------------

enum BtTestWorkspaceKind
    | WorkspaceSingleModule
    | WorkspaceMultiModule
    | WorkspaceBootstrapTree
    | WorkspaceCustom
.end

struct BtTestEnvVar
    name: String
    value: String
.end

struct BtTestWorkspaceConfig
    kind: BtTestWorkspaceKind

    # Racine logique du workspace (chemin relatif pour le runner)
    root_rel_path: String

    # Notes pour le runner (ex: "requires git", "requires tmpdir")
    notes: String
.end

struct BtTestContext
    # Matrice éventuelle à appliquer pour ce test
    matrix: BtTestMatrixId
    has_matrix: bool

    # Profil CLI à utiliser
    cli_profile: bt_args.BtCliProfileId
    has_cli_profile: bool

    # Workspace
    workspace: BtTestWorkspaceConfig

    # Environnement (préfixe)
    env: coll.Vec[BtTestEnvVar]
.end

# ----------------------------------------------------------------------------
# Étapes et commandes d’un test
# ----------------------------------------------------------------------------

enum BtTestStepKind
    | StepRunLc           # exécution du binaire `lc`
    | StepRunAlias        # alias spécifique (ex: `lc build`)
    | StepRunHelp         # `lc help`, `lc --help`, `lc help build`
    | StepCustom
.end

struct BtTestStepCommand
    # Arguments bruts, tels que vus par lc (argv[1..])
    argv: coll.Vec[String]

    # Texte brut optionnel (ligne de commande) pour logs
    raw_line: String
.end

struct BtTestStep
    id: BtTestStepId
    name: BtTestName
    kind: BtTestStepKind

    # Commande à exécuter
    command: BtTestStepCommand

    # Indique si l’échec de cette étape doit stopper le test
    is_critical: bool
.end

# ----------------------------------------------------------------------------
# Attentes / expectations
# ----------------------------------------------------------------------------

enum BtTestExitExpectationKind
    | ExpectExitOk
    | ExpectExitUsageError
    | ExpectExitFailure
    | ExpectExitSpecificCode
.end

struct BtTestExitExpectation
    kind: BtTestExitExpectationKind

    # Code spécifique (si ExpectExitSpecificCode)
    expected_code: i32
    has_expected_code: bool
.end

enum BtTestDiagExpectationKind
    | ExpectNoDiagnostics
    | ExpectAnyError
    | ExpectAnyWarning
    | ExpectErrorCountAtLeast
    | ExpectWarningCountAtLeast
    | ExpectSpecificMessageSubstring
    | ExpectSpecificDiagKind
    | ExpectCustom
.end

struct BtTestDiagExpectation
    kind: BtTestDiagExpectationKind

    # Valeurs numériques (ex: "au moins 1 erreur")
    min_count: i32

    # Sous-chaîne attendue dans le message principal (si applicable)
    message_substring: String

    # Span attendu (optionnel)
    expected_span: diag.SpanId
    has_expected_span: bool
.end

enum BtTestCommandExpectationKind
    | ExpectCommandKind
    | ExpectCommandGroup
    | ExpectPipelineSelected
    | ExpectHelpTopic
    | ExpectCustomCommandExpectation
.end

struct BtTestCommandExpectation
    kind: BtTestCommandExpectationKind

    # Commande attendue
    expected_command: bt_commands.BtCmdDescriptorId
    has_expected_command: bool

    # Groupe attendu
    expected_group: bt_commands.BtCmdGroupId
    has_expected_group: bool

    # Pipeline attendu
    expected_pipeline: bt_cli.BtCliPipelineId
    has_expected_pipeline: bool

    # Topic d’aide attendu (si StepRunHelp)
    expected_help_topic: bt_help.BtHelpTopicId
    has_expected_help_topic: bool
.end

enum BtTestColorExpectationKind
    | ExpectColorEnabled
    | ExpectColorDisabled
    | ExpectThemeKind
    | ExpectCustomColorExpectation
.end

struct BtTestColorExpectation
    kind: BtTestColorExpectationKind

    # Profil ou thème attendu
    expected_profile: bt_colors.BtColorProfileId
    has_expected_profile: bool

    expected_theme: bt_colors.BtColorThemeId
    has_expected_theme: bool
.end

enum BtTestBackendExpectationKind
    | ExpectBuildConfigUsed
    | ExpectCheckConfigUsed
    | ExpectCleanConfigUsed
    | ExpectNoBackend
    | ExpectCustomBackendExpectation
.end

struct BtTestBackendExpectation
    kind: BtTestBackendExpectationKind

    build_config: cmd_build.BtBuildCommandConfig
    has_build_config: bool

    check_config: cmd_check.BtCheckCommandConfig
    has_check_config: bool

    clean_config: cmd_clean.BtCleanCommandConfig
    has_clean_config: bool
.end

enum BtTestExpectationKind
    | ExpectExit
    | ExpectDiagnostics
    | ExpectCommand
    | ExpectColors
    | ExpectBackend
    | ExpectCustom
.end

struct BtTestExpectation
    id: BtTestExpectationId
    kind: BtTestExpectationKind

    # Les différentes sous-attentes possibles (unions logiques)
    exit_expectation: BtTestExitExpectation
    has_exit_expectation: bool

    diag_expectation: BtTestDiagExpectation
    has_diag_expectation: bool

    command_expectation: BtTestCommandExpectation
    has_command_expectation: bool

    color_expectation: BtTestColorExpectation
    has_color_expectation: bool

    backend_expectation: BtTestBackendExpectation
    has_backend_expectation: bool

    # Description lisible de cette expectation
    description: String
.end

# ----------------------------------------------------------------------------
# Cas de test & suites
# ----------------------------------------------------------------------------

enum BtTestCaseKind
    | TestCaseSmoke
    | TestCaseIntegration
    | TestCaseRegression
    | TestCaseExperimental
    | TestCaseCustom
.end

struct BtTestCase
    id: BtTestCaseId
    name: BtTestName
    kind: BtTestCaseKind

    level: BtTestLevel
    category: BtTestCategory

    # Tags (ci, slow, workspace, etc.)
    tags: coll.Vec[BtTestTagId]

    # Contexte d’exécution
    context: BtTestContext

    # Étapes d’exécution
    steps: coll.Vec[BtTestStepId]

    # Attentes globales (test complet)
    expectations: coll.Vec[BtTestExpectationId]

    # Indique si ce test doit être ignoré (skipped) par défaut
    is_skipped_by_default: bool

    # Message de skip (ex: "requires external toolchain")
    skip_reason: String
.end

enum BtTestSuiteKind
    | TestSuiteSmoke
    | TestSuiteIntegration
    | TestSuiteFull
    | TestSuiteCiDefault
    | TestSuiteExperimental
    | TestSuiteCustom
.end

struct BtTestSuite
    id: BtTestSuiteId
    name: BtTestName
    kind: BtTestSuiteKind

    # Description de la suite
    description: String

    # Cas de tests inclus
    test_cases: coll.Vec[BtTestCaseId]

    # Tags communs à la suite
    tags: coll.Vec[BtTestTagId]
.end

# ----------------------------------------------------------------------------
# Snapshots / états capturés
# ----------------------------------------------------------------------------

enum BtTestSnapshotKind
    | SnapshotCliSession
    | SnapshotCliRunSession
    | SnapshotHelpSession
    | SnapshotColorSession
    | SnapshotCustom
.end

struct BtTestSnapshot
    id: BtTestSnapshotId
    kind: BtTestSnapshotKind

    # Snapshots logiques (copies de sessions)
    cli_session: bt_args.BtCliSession
    has_cli_session: bool

    cli_run: bt_cli.BtCliRunSession
    has_cli_run: bool

    help_session: bt_help.BtHelpSession
    has_help_session: bool

    color_session: bt_colors.BtColorSession
    has_color_session: bool

    # Note libre (pour debug/inspection)
    note: String
.end

# ----------------------------------------------------------------------------
# Résultats & statistiques
# ----------------------------------------------------------------------------

enum BtTestResultStatus
    | TestResultPassed
    | TestResultFailed
    | TestResultSkipped
    | TestResultErrored
.end

struct BtTestResult
    case_id: BtTestCaseId
    status: BtTestResultStatus

    # Liste des expectations qui ont échoué (si applicable)
    failed_expectations: coll.Vec[BtTestExpectationId]

    # Diagnostics globaux liés à ce test
    diagnostics: coll.Vec[diag.DiagnosticId]
.end

struct BtTestSuiteSummary
    suite_id: BtTestSuiteId

    total_cases: i32
    passed: i32
    failed: i32
    skipped: i32
    errored: i32
.end

# ----------------------------------------------------------------------------
# Configuration globale des tests CLI bootstrap
# ----------------------------------------------------------------------------

struct BtTestConfig
    # Tags connus
    tags: coll.Vec[BtTestTag]

    # Matrices de tests
    matrices: coll.Vec[BtTestMatrix]

    # Contexte global par défaut
    default_context: BtTestContext

    # Suites
    suites: coll.Vec[BtTestSuite]

    # Cas de test
    cases: coll.Vec[BtTestCase]

    # Étapes
    steps: coll.Vec[BtTestStep]

    # Expectations
    expectations: coll.Vec[BtTestExpectation]

    # Snapshots de référence (pour tests "golden" ou introspection)
    reference_snapshots: coll.Vec[BtTestSnapshot]
.end

# ----------------------------------------------------------------------------
# Session de tests pour une exécution de runner
# ----------------------------------------------------------------------------

struct BtTestSession
    id: BtTestSessionId
    name: BtTestName

    # Configuration globale
    config: BtTestConfig

    # Suites exécutées
    executed_suites: coll.Vec[BtTestSuiteSummary]

    # Résultats par cas
    results: coll.Vec[BtTestResult]

    # Snapshots collectés pendant l’exécution
    collected_snapshots: coll.Vec[BtTestSnapshot]
.end
