module vitte.bootstrap.pipeline.bt_stage1

import std.collections as coll
import vitte.bootstrap.host.bt_env as env
import vitte.bootstrap.host.bt_fs as fs
import vitte.bootstrap.host.bt_platform as pl
import vitte.bootstrap.host.bt_io as io
import vitte.bootstrap.core.bt_toolchain as tc
import vitte.bootstrap.middle.bt_dep_graph as dep
import vitte.bootstrap.middle.bt_lowering as lw
import vitte.bootstrap.middle.bt_ir as ir
import vitte.bootstrap.pipeline.bt_build_pipeline as bp
import vitte.bootstrap.front.bt_diagnostics as diag

# ============================================================================
# Vitte bootstrap pipeline – Spécialisation "Stage1"
# (maximal, déclaratif, sans I/O)
#
# Objectifs :
#   - Décrire, de manière purement déclarative, le bootstrap Stage1 :
#       * phases logiques (prepare, build, test, install),
#       * tâches Stage1 et liens vers jobs/steps du pipeline générique,
#       * rattachement aux unités de build (DepBuildUnit),
#       * liens vers lowering/IR/stage1-compiler,
#       * résumés et sessions de bootstrap Stage1.
#   - S’appuie sur le modèle générique bt_build_pipeline (Bp*),
#     et le spécialise pour le cas "Stage1" du projet vitte-core.
#   - Ne contient :
#       * aucune fonction,
#       * aucune logique d’exécution,
#       * aucune I/O ni formatage.
# ============================================================================

# ---------------------------------------------------------------------------
# Identifiants internes
# ---------------------------------------------------------------------------

struct St1PhaseId
    raw: u32
.end

struct St1TaskId
    raw: u32
.end

struct St1MilestoneId
    raw: u32
.end

struct St1RunId
    raw: u32
.end

# ---------------------------------------------------------------------------
# Genres de phases, tâches, milestones
# ---------------------------------------------------------------------------

enum St1PhaseKind
    St1PhasePrepareEnv          # vérification de l’environnement host (env/fs/platform/toolchain)
    St1PhaseBuildCompiler       # build du compilateur Stage1
    St1PhaseBuildStdCore        # build de la std "core" minimale
    St1PhaseBuildStdExtras      # build d’autres composantes std/tooling
    St1PhaseTests               # exécution des tests Stage1
    St1PhaseIntegration         # vérification intégration Stage1 (self-check)
    St1PhaseInstall             # installation/packaging Stage1
    St1PhaseCleanup             # nettoyage caches/artefacts temporaires
    St1PhaseOther
.end

enum St1TaskKind
    St1TaskCheckHostEnv         # checks de l’environnement host
    St1TaskCheckToolchain       # validation toolchain de bootstrap
    St1TaskResolveDeps          # construction graphe de dépendances bootstrap
    St1TaskBuildStage1Compiler  # compilation binaire compiler Stage1
    St1TaskBuildStage1Tools     # build outils complémentaires stage1
    St1TaskBuildStdCore         # compilation std core
    St1TaskBuildStdCollections  # compilation std collections
    St1TaskRunUnitTests         # tests unitaires
    St1TaskRunIntegrationTests  # tests d’intégration
    St1TaskRunSelfHostSmoke     # smoke pour futur self-host (Stage1 → Stage2)
    St1TaskInstallArtifacts     # installation binaire/librairies Stage1
    St1TaskCleanupCaches        # nettoyage caches temporaires
    St1TaskCustom
    St1TaskOther
.end

enum St1PhaseStatus
    St1PhasePending
    St1PhaseRunning
    St1PhaseSucceeded
    St1PhaseFailed
    St1PhasePartial
    St1PhaseSkipped
.end

enum St1TaskStatus
    St1TaskPending
    St1TaskRunning
    St1TaskSucceeded
    St1TaskFailed
    St1TaskSkipped
    St1TaskCanceled
.end

enum St1MilestoneKind
    St1MilestoneCompilerBuilt       # binaire Stage1 compilateur disponible
    St1MilestoneStdCoreBuilt        # std core Stage1 disponible
    St1MilestoneTestsGreen          # suite de tests Stage1 green
    St1MilestoneInstallReady        # artefacts prêts à être installés
    St1MilestoneSelfHostPrepared    # prérequis pour self-host remplis
    St1MilestoneOther
.end

# ---------------------------------------------------------------------------
# Liens vers pipeline générique / middle / toolchain
# ---------------------------------------------------------------------------

struct St1JobLink
    # Lien vers la config pipeline générique
    pipeline_id: bp.BpPipelineId
    stage_id: bp.BpStageId
    job_id: bp.BpJobId

    # Configuration de build de référence
    config_id: bp.BpConfigId

    # Matrice associée (si job matrix-enabled)
    matrix_id: bp.BpMatrixId

    extra: coll.HashMap<String, String>
.end

struct St1IoLink
    # Liens vers les tâches/pipelines IO sous-jacents
    io_task_id: io.IoTaskId
    io_pipeline_id: io.IoPipelineId

    # Session IO typiquement utilisée
    preferred_session_id: io.IoSessionId

    extra: coll.HashMap<String, String>
.end

struct St1BuildUnitLink
    # Unité de build middle correspondant à cette tâche
    build_unit_id: dep.DepBuildUnitId

    # Dépendances directes/transitives en plus de build_unit
    extra_build_units: coll.Vec<dep.DepBuildUnitId>

    # Graphe de dépendances global
    dep_graph_id: dep.DepGraphId

    extra: coll.HashMap<String, String>
.end

struct St1CompilerLink
    # Liens vers IR/lowering pour le compilateur Stage1 lui-même
    lowering_model_id: String       # id logique vers BtLoweringModel
    ir_model_id: String             # id logique vers BtIrModel

    # Ids IR pour la fonction main du compilateur Stage1
    main_function_id: ir.IrFuncId

    # Module IR principal du compilateur
    compiler_module_id: ir.IrModuleId

    extra: coll.HashMap<String, String>
.end

struct St1ToolchainLink
    # Toolchain utilisée pour Stage1
    toolchain_profile_id: String

    # Composants principaux (compiler, linker, runner, vm, tools)
    component_ids: coll.Vec<String>

    # Profil de runtime
    runtime_name: String

    extra: coll.HashMap<String, String>
.end

# ---------------------------------------------------------------------------
# Phases et tâches Stage1
# ---------------------------------------------------------------------------

struct St1Phase
    id: St1PhaseId
    kind: St1PhaseKind

    name: String                    # ex: "prepare-env", "build-stage1-compiler"
    display_name: String
    description: String

    # Ordre logique (0..N) pour Stage1
    order_index: u32

    # Liens vers le stage pipeline générique
    job_link: St1JobLink

    # Tâches inclues dans cette phase
    task_ids: coll.Vec<St1TaskId>

    # Milestones attendus à la fin de cette phase
    milestone_ids: coll.Vec<St1MilestoneId>

    extra: coll.HashMap<String, String>
.end

struct St1Task
    id: St1TaskId
    kind: St1TaskKind

    name: String
    display_name: String
    description: String

    # Phase parente
    phase_id: St1PhaseId

    # Liens externes
    job_link: St1JobLink
    io_link: St1IoLink
    build_link: St1BuildUnitLink
    toolchain_link: St1ToolchainLink
    compiler_link: St1CompilerLink

    # Contexte env/platform
    workspace_id: env.BtEnvWorkspaceId
    env_profile_id: env.BtEnvProfileId
    target_id: pl.PlTargetId
    build_profile_name: String

    # Paths et artefacts principaux
    workspace_root: fs.FsPath
    source_roots: coll.Vec<fs.FsPath>
    target_root: fs.FsPath
    artifact_paths: coll.Vec<fs.FsPath>

    # Diagnostics globaux pour cette tâche
    diag_ids: coll.Vec<diag.DiagId>

    extra: coll.HashMap<String, String>
.end

# ---------------------------------------------------------------------------
# Milestones / critères de complétion
# ---------------------------------------------------------------------------

struct St1MilestoneCriteria
    # Conditions textuelles ou symboliques pour considérer le milestone atteint
    description: String

    # Liens vers jobs/tâches requis
    required_task_ids: coll.Vec<St1TaskId>

    # Liens vers artefacts requis (noms logiques du pipeline)
    required_artifact_names: coll.Vec<String>

    # Conditions sur les diagnostics (ex: "no errors", "no tests failed")
    require_no_errors: bool
    require_tests_green: bool

    extra: coll.HashMap<String, String>
.end

struct St1Milestone
    id: St1MilestoneId
    kind: St1MilestoneKind

    name: String
    display_name: String
    description: String

    # Phase principale associée
    primary_phase_id: St1PhaseId

    # Critères
    criteria: St1MilestoneCriteria

    extra: coll.HashMap<String, String>
.end

# ---------------------------------------------------------------------------
# Résumés de phases / tâches pour un run Stage1
# ---------------------------------------------------------------------------

struct St1TaskRunSummary
    task_id: St1TaskId

    status: St1TaskStatus

    # Liens vers exécutions sous-jacentes
    job_run_summary: bp.BpJobRunSummary
    io_pipeline_run_id: io.IoRunId

    # Statistiques
    started_at: String
    finished_at: String
    duration_ms: u64

    # Diagnostics
    error_count: u32
    warning_count: u32
    has_errors: bool

    extra: coll.HashMap<String, String>
.end

struct St1PhaseRunSummary
    phase_id: St1PhaseId

    status: St1PhaseStatus

    task_summaries: coll.Vec<St1TaskRunSummary>

    # Synthèse
    tasks_total: u32
    tasks_succeeded: u32
    tasks_failed: u32
    tasks_skipped: u32

    started_at: String
    finished_at: String
    duration_ms: u64

    extra: coll.HashMap<String, String>
.end

struct St1MilestoneStatus
    milestone_id: St1MilestoneId

    # True si critère rempli dans ce run
    achieved: bool

    # Date/heure d’atteinte
    achieved_at: String

    # Tâches clés ayant contribué au milestone
    contributing_task_ids: coll.Vec<St1TaskId>

    extra: coll.HashMap<String, String>
.end

# ---------------------------------------------------------------------------
# Run Stage1 complet
# ---------------------------------------------------------------------------

struct St1RunMetadata
    id: St1RunId

    name: String                    # ex: "stage1-bootstrap-main-2025-12-05"
    description: String

    project_name: String
    edition: String
    profile: String

    created_at: String
    updated_at: String

    # Contexte pipeline
    build_session_id: bp.BpSessionId
    pipeline_id: bp.BpPipelineId
    config_id: bp.BpConfigId

    # Contexte host / platform
    host_env_id: String
    platform_snapshot_id: pl.PlPlatformSnapshotId

    extra: coll.HashMap<String, String>
.end

struct St1RunSummary
    run_id: St1RunId

    phase_summaries: coll.Vec<St1PhaseRunSummary>
    milestone_statuses: coll.Vec<St1MilestoneStatus>

    # Statistiques globales
    phases_total: u32
    phases_succeeded: u32
    phases_failed: u32
    phases_partial: u32

    tasks_total: u32
    tasks_succeeded: u32
    tasks_failed: u32
    tasks_skipped: u32

    milestones_total: u32
    milestones_achieved: u32

    error_count: u32
    warning_count: u32

    has_errors: bool

    duration_ms: u64

    extra: coll.HashMap<String, String>
.end

struct St1Run
    meta: St1RunMetadata

    # Phases et tâches Stage1
    phases: coll.Vec<St1Phase>
    tasks: coll.Vec<St1Task>
    milestones: coll.Vec<St1Milestone>

    summary: St1RunSummary

    extra: coll.HashMap<String, String>
.end

# ---------------------------------------------------------------------------
# Index global et modèle racine Stage1
# ---------------------------------------------------------------------------

struct St1Index
    # Index par nom logique
    phase_id_by_name: coll.HashMap<String, St1PhaseId>
    task_id_by_name: coll.HashMap<String, St1TaskId>
    milestone_id_by_name: coll.HashMap<String, St1MilestoneId>

    # Lien rapide task → job pipeline
    job_id_by_task_id: coll.HashMap<u32, bp.BpJobId>

    extra: coll.HashMap<String, String>
.end

struct BtStage1Model
    # Pipeline générique utilisé par Stage1
    build_pipeline_model_id: String     # id logique vers BtBuildPipelineModel

    # Runs Stage1 observés
    runs: coll.Vec<St1Run>

    # Index global Stage1
    index: St1Index

    # Données libres (notes, versions, tags)
    extra: coll.HashMap<String, String>
.end
