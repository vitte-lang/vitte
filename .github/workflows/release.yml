name: release-artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute version and platform
        id: meta
        run: |
          set -euo pipefail
          VERSION=$(cat VERSION)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "os=$(uname -s | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"
          echo "arch=$(uname -m)" >> "$GITHUB_OUTPUT"

      - name: Install deps
        run: brew install cmake ninja

      - name: Build release binary (compiler)
        run: |
          cmake -S compiler -B compiler/build/release -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build compiler/build/release --target vittec

      - name: Create tarball
        run: |
          set -euo pipefail
          mkdir -p dist
          BIN="compiler/build/release/vittec"
          [[ -x "${BIN}" ]] || { echo "missing binary: ${BIN}" >&2; exit 1; }
          TARBALL="dist/vittec-${{ steps.meta.outputs.version }}-${{ steps.meta.outputs.os }}-${{ steps.meta.outputs.arch }}.tar.gz"
          tar -czf "${TARBALL}" -C compiler/build/release vittec -C "${GITHUB_WORKSPACE}" README.md LICENSE

      - name: Capture SHA256
        id: sha
        run: |
          set -euo pipefail
          TARBALL="dist/vittec-${{ steps.meta.outputs.version }}-${{ steps.meta.outputs.os }}-${{ steps.meta.outputs.arch }}.tar.gz"
          [[ -f "${TARBALL}" ]] || { echo "tarball missing: ${TARBALL}" >&2; exit 1; }
          SHA=$(shasum -a 256 "${TARBALL}" | awk '{print $1}')
          echo "${SHA}  ${TARBALL}" > "${TARBALL}.sha256"
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: vittec-${{ steps.meta.outputs.version }}-${{ steps.meta.outputs.os }}-${{ steps.meta.outputs.arch }}
          path: |
            ${{ steps.sha.outputs.tarball }}
            ${{ steps.sha.outputs.tarball }}.sha256

      - name: Update Homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.meta.outputs.version }}
          OS: ${{ steps.meta.outputs.os }}
          ARCH: ${{ steps.meta.outputs.arch }}
          SHA: ${{ steps.sha.outputs.sha }}
        run: |
          set -euo pipefail
          TAP_REPO="https://github.com/vitte-lang/homebrew-vitte.git"
          TAP_DIR="${GITHUB_WORKSPACE}/homebrew-vitte"

          if [[ -z "${TAP_TOKEN:-}" ]]; then
            echo "HOMEBREW_TAP_TOKEN secret is required to push to ${TAP_REPO}" >&2
            exit 1
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone "https://${TAP_TOKEN}@github.com/vitte-lang/homebrew-vitte.git" "${TAP_DIR}"
          mkdir -p "${TAP_DIR}/Formula"

          cat > "${TAP_DIR}/Formula/vittec.rb" <<EOF
class Vittec < Formula
  desc "Vitte compiler placeholder (lexer/parser/AST/diag)"
  homepage "https://github.com/vitte-lang/vitte-core"
  url "https://github.com/vitte-lang/vitte-core/releases/download/v${VERSION}/vittec-${VERSION}-${OS}-${ARCH}.tar.gz"
  sha256 "${SHA}"
  version "${VERSION}"
  license "MIT"

  def install
    bin.install "vittec"
    pkgshare.install "README.md" if File.exist?("README.md")
    pkgshare.install "LICENSE" if File.exist?("LICENSE")
  end

  test do
    (testpath/"hello.vitte").write("main() {}")
    output = shell_output("\#{bin}/vittec --version")
    assert_match "${VERSION}", output
  end
end
EOF

          cd "${TAP_DIR}"
          git add Formula/vittec.rb
          if git diff --cached --quiet; then
            echo "No tap changes to commit."
            exit 0
          fi

          git commit -m "Update vittec to v${VERSION} (${OS}/${ARCH})"
          git push origin HEAD
