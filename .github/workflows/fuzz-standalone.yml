name: Fuzz Harnesses (standalone)

on:
  push:
    paths:
      - "fuzz/**"
      - "include/**"
      - "src/**"
      - "runtime/**"
      - "compiler/**"
      - ".github/workflows/fuzz-standalone.yml"
  pull_request:
    paths:
      - "fuzz/**"
      - "include/**"
      - "src/**"
      - "runtime/**"
      - "compiler/**"
      - ".github/workflows/fuzz-standalone.yml"

jobs:
  build-and-fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang cmake ninja-build zip

      - name: Build standalone harnesses
        env:
          ASAN_OPTIONS: "abort_on_error=1:detect_leaks=0:allocator_may_return_null=1:handle_segv=0:handle_sigbus=0:handle_abort=0:symbolize=1:fast_unwind_on_malloc=0"
          UBSAN_OPTIONS: "halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1"
        run: |
          export VITTE_FUZZ_SANITIZE=1
          export VITTE_FUZZ_SANITIZER=asan_ubsan
          ./fuzz/scripts/build_targets.sh

      - name: Quick libFuzzer runs (max_total_time)
        run: |
          set -euo pipefail
          mkdir -p fuzz/artifacts

          run_one() {
            name="$1"
            corpus="$2"
            dict="${3:-}"
            bin="./fuzz/out/$name"

            if [ ! -x "$bin" ]; then
              echo "[fuzz-quick] skip (missing bin): $name"
              return 0
            fi
            if [ ! -d "$corpus" ]; then
              echo "[fuzz-quick] skip (missing corpus): $name ($corpus)"
              return 0
            fi

            ap="fuzz/artifacts/$name/"
            mkdir -p "$ap"

            args="-runs=0 -max_total_time=20 -timeout=10 -artifact_prefix=$ap"
            if [ -n "$dict" ] && [ -f "$dict" ]; then
              args="$args -dict=$dict"
            fi

            echo "[fuzz-quick] $name -> $corpus"
            # shellcheck disable=SC2086
            "$bin" $args "$corpus"
          }

          run_one "fuzz_lexer" "fuzz/corpora/lexer" "fuzz/dict/lexer_tokers.dict"
          run_one "fuzz_parser" "fuzz/corpora/parser" "fuzz/dict/parsergrammar.dict"
          run_one "fuzz_parser_recovery" "fuzz/corpora/parser" "fuzz/dict/parsergrammar.dict"
          run_one "fuzz_ast_invariants" "fuzz/corpora/parser" "fuzz/dict/parsergrammar.dict"
          run_one "fuzz_lowering" "fuzz/corpora/parser" "fuzz/dict/parsergrammar.dict"
          run_one "fuzz_ast_printer" "fuzz/corpora/parser" "fuzz/dict/parsergrammar.dict"
          run_one "fuze_vm_decode" "fuzz/corpora/vm_decode"
          run_one "fuzz_vittec_lexer_roundtrip" "fuzz/corpora/vitte" "fuzz/dict/vittec_front.dict"
          run_one "fuzz_vittec_parser_toplevel" "fuzz/corpora/vitte" "fuzz/dict/vittec_front.dict"

      - name: Sync corpora (best effort)
        if: always()
        run: |
          set -euo pipefail
          for t in lexer parser; do
            ./fuzz/scripts/corpus_sync.sh "$t" --clean || true
          done
          mkdir -p out
          tar -czf out/corpora-sync.tar.gz fuzz/corpora/*/_sync 2>/dev/null || true

          # Per-target corpus snapshot (zip + sha256 list) for easy download/review.
          mkdir -p out/corpora
          for d in fuzz/corpora/*; do
            [ -d "$d" ] || continue
            t="$(basename "$d")"
            if [ -d "$d/_sync" ]; then
              (cd "$d" && find "_sync" -type f -print0 | sort -z | xargs -0 sha256sum) >"out/corpora/${t}.sha256" 2>/dev/null || true
              (cd "$d" && zip -qr "../../out/corpora/${t}.zip" "_sync") || true
            fi
          done

      - name: Upload corpus snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpora-sync
          path: out/corpora-sync.tar.gz
          if-no-files-found: warn
          retention-days: 14

      - name: Upload per-target corpus snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpora-per-target
          path: out/corpora
          if-no-files-found: warn
          retention-days: 14

      - name: Upload fuzz artifacts (crashes/timeouts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-artifacts
          path: fuzz/artifacts
          if-no-files-found: warn
          retention-days: 14

      - name: Repro minimized/crash inputs (best effort)
        if: always()
        run: |
          set -euo pipefail
          # If previous jobs or local reproduction artifacts are present in the repo,
          # verify they still reproduce deterministically against the standalone harnesses.
          shopt -s nullglob
          found=0
          infer_target() {
            p="$1"
            case "$p" in
              fuzz/minimized/*/*) echo "${p#fuzz/minimized/}" | cut -d/ -f1 ;;
              fuzz/artifacts/*/*) echo "${p#fuzz/artifacts/}" | cut -d/ -f1 ;;
              fuzz/findings/*/artifacts/*) echo "${p#fuzz/findings/}" | cut -d/ -f1 ;;
              *) echo "" ;;
            esac
          }
          for f in fuzz/minimized/*/*.min fuzz/artifacts/*/* fuzz/findings/*/artifacts/*; do
            [ -f "$f" ] || continue
            found=1
            tdir="$(infer_target "$f")"
            [ -n "$tdir" ] || continue
            [ -x "./fuzz/out/$tdir" ] || continue
            ./fuzz/scripts/reproduce.sh "$tdir" "./fuzz/out/$tdir" "$f" --timeout 10 --repeat 1 || true
          done
          if [ "$found" -eq 0 ]; then
            echo "No repro inputs found; skipping."
          fi

  minimize:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-and-fuzz]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download fuzz artifacts
        uses: actions/download-artifact@v4
        with:
          name: fuzz-artifacts
          path: fuzz/artifacts

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang cmake ninja-build

      - name: Build standalone harnesses (for minimization)
        env:
          ASAN_OPTIONS: "abort_on_error=1:detect_leaks=0:allocator_may_return_null=1:handle_segv=0:handle_sigbus=0:handle_abort=0:symbolize=1:fast_unwind_on_malloc=0"
          UBSAN_OPTIONS: "halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1"
        run: |
          export VITTE_FUZZ_SANITIZE=1
          export VITTE_FUZZ_SANITIZER=asan_ubsan
          ./fuzz/scripts/build_targets.sh

      - name: Minimize crash artifacts (best effort)
        if: always()
        run: |
          set -euo pipefail
          shopt -s nullglob
          found=0
          for f in fuzz/artifacts/*/crash-* fuzz/artifacts/*/timeout-*; do
            [ -f "$f" ] || continue
            found=1
            tdir="$(basename "$(dirname "$f")")"
            [ -x "./fuzz/out/$tdir" ] || continue
            mode="crash"
            case "$(basename "$f")" in
              timeout-*) mode="hang" ;;
            esac
            ./fuzz/scripts/minimize.sh "$tdir" "./fuzz/out/$tdir" "$f" --mode "$mode" --timeout 25 || true
          done
          if [ "$found" -eq 0 ]; then
            echo "No crash artifacts found; skipping."
          fi

      - name: Upload minimized artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-minimized
          path: fuzz/minimized
          if-no-files-found: warn
          retention-days: 30

  windows-build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build standalone harnesses (PowerShell)
        shell: pwsh
        env:
          VITTE_FUZZ_SANITIZE: "0"
          VITTE_FUZZ_SANITIZER: "none"
          ASAN_OPTIONS: "abort_on_error=1:detect_leaks=0:allocator_may_return_null=1:symbolize=1"
          UBSAN_OPTIONS: "halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1"
        run: |
          pwsh -ExecutionPolicy Bypass -File fuzz/scripts/build_targets.ps1
