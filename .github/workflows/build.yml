

name: build

on:
  push:
    branches:
      - "**"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Rust toolchain (only if Rust is present)
      # -----------------------------
      - name: Setup Rust
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}

      - name: Rust format (rustfmt)
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        run: cargo fmt --all -- --check

      - name: Rust lint (clippy)
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Rust tests
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        run: cargo test --workspace --all-features

      - name: Rust build (release)
        if: ${{ hashFiles('**/Cargo.toml') != '' }}
        run: cargo build --workspace --release

      # -----------------------------
      # Optional repo-specific CI scripts
      # -----------------------------
      - name: Run scripts/ci.sh
        if: ${{ runner.os != 'Windows' && hashFiles('scripts/ci.sh') != '' }}
        run: |
          chmod +x scripts/ci.sh
          ./scripts/ci.sh

      - name: Run scripts/ci.ps1
        if: ${{ runner.os == 'Windows' && hashFiles('scripts/ci.ps1') != '' }}
        shell: pwsh
        run: ./scripts/ci.ps1

      # -----------------------------
      # Artifact packaging (best-effort)
      # - Packs release binaries if they exist
      # -----------------------------
      - name: Package artifacts (unix)
        if: ${{ runner.os != 'Windows' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          if [ -d target/release ]; then
            # Copy likely binaries (exclude .d and build artifacts)
            find target/release -maxdepth 1 -type f -perm -111 \
              ! -name "*.d" \
              -exec cp -f {} dist/ \; || true
          fi

          # If nothing was copied, still emit an empty marker so artifact upload works.
          if [ -z "$(ls -A dist 2>/dev/null || true)" ]; then
            echo "(no binaries found)" > dist/README.txt
          fi

          tar -czf vitte-${{ runner.os }}.tar.gz -C dist .

      - name: Package artifacts (windows)
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          if (Test-Path -Path target\release) {
            Get-ChildItem target\release -File | Where-Object {
              $_.Extension -notin @('.d', '.pdb')
            } | ForEach-Object {
              Copy-Item $_.FullName -Destination dist -Force
            }
          }

          if (-not (Get-ChildItem dist -File -ErrorAction SilentlyContinue)) {
            Set-Content -Path dist\README.txt -Value "(no binaries found)"
          }

          Compress-Archive -Path dist\* -DestinationPath "vitte-${{ runner.os }}.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vitte-${{ runner.os }}
          path: |
            vitte-${{ runner.os }}.tar.gz
            vitte-${{ runner.os }}.zip
          if-no-files-found: ignore