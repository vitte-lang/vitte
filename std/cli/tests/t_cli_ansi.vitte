# /Users/vincent/Documents/Github/vitte/std/cli/tests/t_cli_ansi.vitte
# -----------------------------------------------------------------------------
# std/cli/tests/t_cli_ansi
# -----------------------------------------------------------------------------
# MAX tests for std.cli.ansi
#
# Coverage:
# - primitives (ESC/CSI/OSC)
# - sgr_code + resets
# - styles on/off
# - colors (8/256/rgb) + helpers
# - paint composer
# - cursor controls + clear/erase
# - OSC title + hyperlink
# - strip_ansi + truecolor detection (best-effort)
#
# Notes:
# - Uses std.runtime::assert for smoke-style tests.
# - Assumes std.cli.ansi API as previously generated in MAX form.
# - All blocks use `.end` only.
# -----------------------------------------------------------------------------

module std.cli.tests.t_cli_ansi

use std.runtime
use std.string
use std.cli.ansi

type Bool = bool
type U32  = u32
type I32  = i32
type Str  = str

fn str_len(s: Str) -> U32
  ret std.string::len(s)
.end

fn str_find(s: Str, needle: Str) -> I32
  ret std.string::find(s, needle)
.end

fn assert_nonempty(s: Str, msg: Str)
  do std.runtime::assert(str_len(s) > 0, msg)
.end

fn assert_contains(hay: Str, needle: Str, msg: Str)
  do std.runtime::assert(str_find(hay, needle) >= 0, msg)
.end

fn assert_eq(a: Str, b: Str, msg: Str)
  do std.runtime::assert(a == b, msg)
.end

# -----------------------------------------------------------------------------
# Primitive construction
# -----------------------------------------------------------------------------

scn test_ansi_primitives
  let esc = std.cli.ansi::ESC()
  do assert_nonempty(esc, "ESC nonempty")

  let s1 = std.cli.ansi::csi("A")
  do assert_contains(s1, "[", "CSI has [")
  do assert_contains(s1, "A", "CSI final")

  let s2 = std.cli.ansi::osc("0;title")
  do assert_contains(s2, "]", "OSC has ]")
  do assert_contains(s2, "0;title", "OSC payload")

  let s3 = std.cli.ansi::osc_st()
  do assert_nonempty(s3, "OSC ST")
.end

# -----------------------------------------------------------------------------
# SGR + styles
# -----------------------------------------------------------------------------

scn test_ansi_sgr_styles
  let reset = std.cli.ansi::reset()
  do assert_nonempty(reset, "reset")

  let bold = std.cli.ansi::bold()
  do assert_nonempty(bold, "bold")

  let nobold = std.cli.ansi::no_bold()
  do assert_nonempty(nobold, "no_bold")

  let under = std.cli.ansi::underline()
  let nounder = std.cli.ansi::no_underline()
  do assert_nonempty(under, "underline")
  do assert_nonempty(nounder, "no_underline")

  let inv = std.cli.ansi::inverse()
  let noin = std.cli.ansi::no_inverse()
  do assert_nonempty(inv, "inverse")
  do assert_nonempty(noin, "no_inverse")

  let it = std.cli.ansi::italic()
  let noit = std.cli.ansi::no_italic()
  do assert_nonempty(it, "italic")
  do assert_nonempty(noit, "no_italic")

  let dim = std.cli.ansi::dim()
  let nodim = std.cli.ansi::no_dim()
  do assert_nonempty(dim, "dim")
  do assert_nonempty(nodim, "no_dim")

  let st = std.cli.ansi::strikethrough()
  let nost = std.cli.ansi::no_strikethrough()
  do assert_nonempty(st, "strike")
  do assert_nonempty(nost, "no_strike")
.end

# -----------------------------------------------------------------------------
# Colors
# -----------------------------------------------------------------------------

scn test_ansi_colors_8
  let red = std.cli.ansi::red()
  let on_blue = std.cli.ansi::on_blue()
  do assert_nonempty(red, "fg red")
  do assert_nonempty(on_blue, "bg blue")

  let painted = std.cli.ansi::paint("x", red + on_blue)
  do assert_contains(painted, "x", "paint contains text")
.end

scn test_ansi_colors_256
  let fg = std.cli.ansi::fg256(196)
  let bg = std.cli.ansi::bg256(17)
  do assert_nonempty(fg, "fg256")
  do assert_nonempty(bg, "bg256")

  let p = std.cli.ansi::paint("hi", fg + bg)
  do assert_contains(p, "hi", "paint hi")
.end

scn test_ansi_colors_rgb
  let fg = std.cli.ansi::fgrgb(255, 128, 0)
  let bg = std.cli.ansi::bgrgb(0, 64, 255)
  do assert_nonempty(fg, "fgrgb")
  do assert_nonempty(bg, "bgrgb")

  let p = std.cli.ansi::paint("rgb", fg + bg)
  do assert_contains(p, "rgb", "paint rgb")
.end

# -----------------------------------------------------------------------------
# Cursor + erase/clear
# -----------------------------------------------------------------------------

scn test_ansi_cursor_controls
  let up = std.cli.ansi::cursor_up(3)
  let dn = std.cli.ansi::cursor_down(2)
  let rt = std.cli.ansi::cursor_right(10)
  let lf = std.cli.ansi::cursor_left(4)
  do assert_nonempty(up, "cursor up")
  do assert_nonempty(dn, "cursor down")
  do assert_nonempty(rt, "cursor right")
  do assert_nonempty(lf, "cursor left")

  let pos = std.cli.ansi::cursor_pos(5, 12)
  do assert_nonempty(pos, "cursor pos")

  let save = std.cli.ansi::cursor_save()
  let restore = std.cli.ansi::cursor_restore()
  do assert_nonempty(save, "cursor save")
  do assert_nonempty(restore, "cursor restore")

  let hide = std.cli.ansi::cursor_hide()
  let show = std.cli.ansi::cursor_show()
  do assert_nonempty(hide, "cursor hide")
  do assert_nonempty(show, "cursor show")
.end

scn test_ansi_clear_erase
  let cl0 = std.cli.ansi::clear_screen()
  let cl1 = std.cli.ansi::clear_screen_from_cursor()
  let cl2 = std.cli.ansi::clear_screen_to_cursor()
  do assert_nonempty(cl0, "clear screen")
  do assert_nonempty(cl1, "clear from cursor")
  do assert_nonempty(cl2, "clear to cursor")

  let ln0 = std.cli.ansi::clear_line()
  let ln1 = std.cli.ansi::clear_line_from_cursor()
  let ln2 = std.cli.ansi::clear_line_to_cursor()
  do assert_nonempty(ln0, "clear line")
  do assert_nonempty(ln1, "clear line from cursor")
  do assert_nonempty(ln2, "clear line to cursor")
.end

# -----------------------------------------------------------------------------
# OSC: title + hyperlink
# -----------------------------------------------------------------------------

scn test_ansi_osc_title
  let t = std.cli.ansi::set_title("hello")
  do assert_contains(t, "hello", "title payload")
.end

scn test_ansi_hyperlink
  let link = std.cli.ansi::hyperlink("OpenAI", "https://example.com")
  do assert_contains(link, "OpenAI", "text present")
  do assert_contains(link, "https://example.com", "url present")
.end

# -----------------------------------------------------------------------------
# strip_ansi + detect truecolor
# -----------------------------------------------------------------------------

scn test_ansi_strip
  let s = std.cli.ansi::paint("hi", std.cli.ansi::red())
  let plain = std.cli.ansi::strip_ansi(s)
  do assert_eq(plain, "hi", "strip returns raw text")
.end

scn test_ansi_truecolor_detection
  # best-effort: should return a bool, no assertion on value
  let b = std.cli.ansi::supports_truecolor()
  do std.runtime::assert(b == true || b == false, "bool")
.end

# -----------------------------------------------------------------------------
# Composition sanity: multiple styles chained
# -----------------------------------------------------------------------------

scn test_ansi_compose
  let style = std.cli.ansi::bold() + std.cli.ansi::underline() + std.cli.ansi::green()
  let s = std.cli.ansi::paint("ok", style)
  do assert_contains(s, "ok", "composed paint")
.end

# End of t_cli_ansi.vitte