module tests.compiler.parser.extension_test:
    import compiler.lexer as lexer
    import compiler.parser as native_parser
    import bootstrap.compiler.ir as ir

    scenario expect(condition, message):
        if not condition:
            panic message

    scenario assert_kind(node, expected):
        expect(node != null, "node missing")
        expect(node.kind == expected, "attendu " + expected + " mais trouvé " + node.kind)

    scenario run_extension_suite():
        let source =
            "table metrics:\n" +
            "    use runtime.log\n" +
            "plot usage:\n" +
            "    feature tracing enable true\n" +
            "ui panel:\n" +
            "    package runtime.console { level: info }\n"

        let native_tokens = lexer.tokenize(source)
        let native_ast = native_parser.parse(native_tokens)
        expect(native_ast.kind == "Block", "la racine doit être un bloc")
        expect(native_ast.statements.len == 3, "trois blocs d'extension attendus")

        let table_block = native_ast.statements[0]
        assert_kind(table_block, "ExtensionBlock")
        expect(table_block.extension_kind == "table", "table attendu")
        expect(table_block.name == "metrics", "nom de table incorrect")
        expect(table_block.body.statements.len == 1, "table doit contenir 1 instruction")
        assert_kind(table_block.body.statements[0], "Directive")
        expect(table_block.body.statements[0].directive_kind == "use", "table doit contenir une directive use")

        let plot_block = native_ast.statements[1]
        assert_kind(plot_block, "ExtensionBlock")
        expect(plot_block.extension_kind == "plot", "plot attendu")
        expect(plot_block.body.statements.len == 1, "plot doit contenir une instruction")
        assert_kind(plot_block.body.statements[0], "Directive")
        expect(plot_block.body.statements[0].directive_kind == "feature", "plot doit contenir une directive feature")

        let ui_block = native_ast.statements[2]
        assert_kind(ui_block, "ExtensionBlock")
        expect(ui_block.extension_kind == "ui", "ui attendu")
        expect(ui_block.body.statements.len == 1, "ui doit contenir une instruction")
        assert_kind(ui_block.body.statements[0], "Directive")
        expect(ui_block.body.statements[0].directive_kind == "package", "ui doit contenir une directive package")

        let native_ir = ir.lower(native_ast)
        expect(native_ir.len == 3, "chaque bloc d'extension se transforme en op séparée")
        for stmt in native_ir:
            expect(stmt.op == "unknown", "les blocs d'extension restent inconnus dans l'IR bootstrap")

    program extension_parser_suite:
        scenario main(args):
            run_extension_suite()
