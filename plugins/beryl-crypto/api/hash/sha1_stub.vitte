# plugins/beryl/api/hash/sha1.vitte
# SHA-1 — hash — API contract (data-first, backend-agnostic) — MAX++
# Blocks use `.end` only.
#
# Objectifs:
#   - Contrat SHA-1 maximal:
#       * one-shot + streaming
#       * views (zero-copy) optionnelles
#       * providers/caps/limits
#   - Aucun I/O ici. Aucune impl crypto réelle.
#
# Notes:
#   - SHA-1 (20 bytes) est considéré obsolète pour la sécurité (collisions).
#   - Usage typique: compat legacy, HMAC legacy, checksums non-crypto.

module plugins.crypto.api.hash.sha1

import std.collections as coll

# ============================================================================
# Versioning
# ============================================================================

const SHA1_API_VERSION_MAJOR : u32 = 1
const SHA1_API_VERSION_MINOR : u32 = 0
const SHA1_API_VERSION_PATCH : u32 = 0

# ============================================================================
# Constants
# ============================================================================

const SHA1_OUT_LEN    : u32 = 20
const SHA1_BLOCK_LEN  : u32 = 64

# ============================================================================
# Errors
# ============================================================================

enum Sha1Error
  Ok
  Unsupported

  InvalidProvider
  InvalidPolicy

  InvalidInput
  InvalidOutput
  InvalidLength

  BufferTooSmall
  OutputTooLarge
  MessageTooLarge

  ProviderUnavailable
  ProviderBusy
  RateLimited
  Timeout

  MalformedInput
  SerializationError
  DeserializationError

  InternalError
.end

# ============================================================================
# Provider metadata
# ============================================================================

type Sha1ProviderId = string

enum Sha1BackendKind
  Unknown
  Software
  Hardware
  Remote
.end

const SHA1_FLAG_ONE_SHOT          : u32 = 1
const SHA1_FLAG_STREAMING         : u32 = 2
const SHA1_FLAG_VIEWS             : u32 = 4

const SHA1_FLAG_SIMD              : u32 = 8

const SHA1_PROVIDER_FLAG_SOFTWARE   : u32 = 1
const SHA1_PROVIDER_FLAG_HARDWARE   : u32 = 2
const SHA1_PROVIDER_FLAG_REMOTE     : u32 = 4
const SHA1_PROVIDER_FLAG_THREADSAFE : u32 = 8
const SHA1_PROVIDER_FLAG_SANDBOXED  : u32 = 16

struct Sha1Limits
  in_max            : u64
  out_max           : u64
  msg_max           : u64

  block_len         : u32
.end

struct Sha1ProviderInfo
  id                : Sha1ProviderId
  name              : string
  vendor            : string
  version           : string

  backend           : Sha1BackendKind
  priority          : i32
  flags             : u32

  build             : string
  device            : string
  location          : string

  limits            : Sha1Limits
.end

# ============================================================================
# Views (zero-copy optional)
# ============================================================================

struct ByteSlice
  ptr               : u64
  len               : u64
.end

struct MutByteSlice
  ptr               : u64
  len               : u64
.end

struct IoVec
  slices            : coll.Vec[ByteSlice]
  total_len         : u64
.end

# ============================================================================
# Policy
# ============================================================================

struct Sha1Policy
  out_len           : u32
  strict_out_len    : bool

  # Hardening
  constant_time     : bool
.end

# ============================================================================
# Owned payload containers
# ============================================================================

struct Sha1Bytes
  bytes             : coll.Vec[u8]
.end

struct Sha1Digest
  bytes             : coll.Vec[u8]
.end

# ============================================================================
# One-shot
# ============================================================================

struct Sha1HashRequest
  provider_id        : Sha1ProviderId
  policy             : Sha1Policy
  input              : Sha1Bytes
.end

struct Sha1HashResponse
  err                : Sha1Error
  digest             : Sha1Digest
.end

struct Sha1HashRequestView
  provider_id        : Sha1ProviderId
  policy             : Sha1Policy
  input              : ByteSlice
  output             : MutByteSlice
.end

struct Sha1HashResponseView
  err                : Sha1Error
  written            : u64
.end

# ============================================================================
# Streaming
# ============================================================================

enum Sha1StreamState
  Init
  Data
  Final
  Closed
.end

struct Sha1StreamInfo
  provider_id        : Sha1ProviderId
  policy             : Sha1Policy
  state              : Sha1StreamState

  total_in           : u64
  flags              : u32
.end

struct Sha1Stream
  handle             : u64
  info               : Sha1StreamInfo
.end

struct Sha1StreamStartRequest
  provider_id        : Sha1ProviderId
  policy             : Sha1Policy
.end

struct Sha1StreamStartResponse
  err                : Sha1Error
  stream             : Sha1Stream
.end

struct Sha1StreamUpdateRequest
  stream             : Sha1Stream
  input              : Sha1Bytes
.end

struct Sha1StreamUpdateResponse
  err                : Sha1Error
.end

struct Sha1StreamUpdateRequestView
  stream             : Sha1Stream
  input              : ByteSlice
.end

struct Sha1StreamUpdateResponseView
  err                : Sha1Error
.end

struct Sha1StreamFinishRequest
  stream             : Sha1Stream
  out_len            : u32
.end

struct Sha1StreamFinishResponse
  err                : Sha1Error
  digest             : Sha1Digest
.end

struct Sha1StreamFinishRequestView
  stream             : Sha1Stream
  output             : MutByteSlice
.end

struct Sha1StreamFinishResponseView
  err                : Sha1Error
  written            : u64
.end

# ============================================================================
# ABI outputs (runtime provided)
# ============================================================================

fn abi_out_provider_info_struct(info : Sha1ProviderInfo)
.end

fn abi_out_hash_response(resp : Sha1HashResponse)
.end

fn abi_out_hash_response_view(resp : Sha1HashResponseView)
.end

fn abi_out_stream_start_response(resp : Sha1StreamStartResponse)
.end

fn abi_out_stream_finish_response(resp : Sha1StreamFinishResponse)
.end

fn abi_out_stream_finish_response_view(resp : Sha1StreamFinishResponseView)
.end

fn abi_out_error(err : Sha1Error)
.end

# ============================================================================
# Provider surface (typed entrypoints)
# ============================================================================

fn sha1_provider_enumerate()
.end

fn sha1_provider_query(provider_id : Sha1ProviderId)
.end

fn sha1_hash(req : Sha1HashRequest)
.end

fn sha1_hash_view(req : Sha1HashRequestView)
.end

fn sha1_stream_start(req : Sha1StreamStartRequest)
.end

fn sha1_stream_update(req : Sha1StreamUpdateRequest)
.end

fn sha1_stream_update_view(req : Sha1StreamUpdateRequestView)
.end

fn sha1_stream_finish(req : Sha1StreamFinishRequest)
.end

fn sha1_stream_finish_view(req : Sha1StreamFinishRequestView)
.end

fn sha1_stream_destroy(stream : Sha1Stream)
.end

# ============================================================================
# Helpers (pure)
# ============================================================================

fn sha1_block_len() -> u32
  return SHA1_BLOCK_LEN
.end

fn sha1_out_len() -> u32
  return SHA1_OUT_LEN
.end

fn sha1_default_policy() -> Sha1Policy
  let p : Sha1Policy = Sha1Policy
  return p
.end

# ============================================================================
# TODO checklist (impl réelle) — MAX++
# ============================================================================

# Providers
# - Impl enumerate/query + `Sha1ProviderInfo`.
# - Remplacer toute sortie "texte" par ABI structs.
# - Politique de choix provider (software vs hw vs remote) + fallback.

# Core SHA-1
# - Impl SHA-1 compression:
#     * message schedule W[0..79]
#     * rounds 0..79 (K constants)
#     * rotate-left, endian big-endian parsing
# - Padding:
#     * append 0x80, pad zeros, append 64-bit length (bits) big-endian.
# - Streaming:
#     * buffer partial blocks
#     * maintain state (5 u32)

# One-shot
# - Impl `sha1_hash` and `sha1_hash_view`:
#     * if strict_out_len => out_len must be 20
#     * BufferTooSmall + written
#     * output stable

# Streaming
# - Impl start/update/finish:
#     * finish idempotent
#     * allow arbitrary chunk sizes
#     * finalize padding
# - Views update:
#     * avoid copies when possible

# Validation / limits
# - Enforce msg_max / in_max / out_max.
# - Return MessageTooLarge on overflow.

# Side-channel hardening
# - constant_time best effort.
# - memwipe internal state on destroy.

# Tests
# - Vectors SHA-1:
#     * "" -> da39a3ee5e6b4b0d3255bfef95601890afd80709
#     * "abc" -> a9993e364706816aba3e25717850c26c9cd0d89d
# - Properties:
#     * streaming == one-shot.
# - Negative:
#     * out_len invalid, buffer too small.
# - Fuzz:
#     * random chunking + random input sizes.

# Bench
# - microbench one-shot vs streaming.

.end