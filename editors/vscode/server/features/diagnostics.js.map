{"version":3,"file":"diagnostics.js","sourceRoot":"","sources":["diagnostics.ts"],"names":[],"mappings":"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","sourcesContent":["\n\nimport {\n  type Connection,\n  TextDocuments,\n  type TextDocument,\n  Diagnostic,\n  DiagnosticSeverity,\n  Range,\n  Position\n} from 'vscode-languageserver/node';\n\n/**\n * Diagnostics subsystem for Vitte LSP — strict-safe (no implicit undefined),\n * minimal heuristics, debounced publication, and configuration hooks.\n */\n\nexport interface DiagnosticsConfig {\n  maxProblems: number;            // hard cap to avoid flooding the client\n  longLine: number;               // warn on lines longer than this (0 = disabled)\n  allowTabs: boolean;             // flag usage of tabs\n  todoSeverity: DiagnosticSeverity; // severity for TODO markers\n}\n\nconst DEFAULT_CONFIG: DiagnosticsConfig = {\n  maxProblems: 200,\n  longLine: 160,\n  allowTabs: false,\n  todoSeverity: DiagnosticSeverity.Hint,\n};\n\n// Internal state\nlet currentConfig: DiagnosticsConfig = { ...DEFAULT_CONFIG };\nconst debounceMs = 200; // light debounce between rapid edits\nconst timers = new Map<string, NodeJS.Timeout>();\n\n/** Register diagnostics on connection & documents */\nexport function registerDiagnostics(connection: Connection, documents: TextDocuments<TextDocument>): void {\n  documents.onDidChangeContent((change) => scheduleValidate(connection, change.document));\n  documents.onDidOpen((open) => scheduleValidate(connection, open.document));\n  documents.onDidClose((close) => clearDiagnostics(connection, close.document));\n\n  // Optional: react to config changes from client (if supported)\n  connection.onDidChangeConfiguration((params) => {\n    try {\n      const cfg = (params.settings as any)?.vitte?.diagnostics as Partial<DiagnosticsConfig> | undefined;\n      if (cfg && typeof cfg === 'object') {\n        updateConfig(cfg);\n        // revalidate all open docs after config change\n        for (const doc of documents.all()) scheduleValidate(connection, doc);\n      }\n    } catch {\n      // ignore invalid settings payloads\n    }\n  });\n}\n\nexport function updateConfig(partial: Partial<DiagnosticsConfig>): void {\n  const next: DiagnosticsConfig = { ...currentConfig };\n  if (typeof partial.maxProblems === 'number' && Number.isFinite(partial.maxProblems) && partial.maxProblems >= 0) {\n    next.maxProblems = partial.maxProblems;\n  }\n  if (typeof partial.longLine === 'number' && Number.isFinite(partial.longLine) && partial.longLine >= 0) {\n    next.longLine = partial.longLine;\n  }\n  if (typeof partial.allowTabs === 'boolean') {\n    next.allowTabs = partial.allowTabs;\n  }\n  if (typeof partial.todoSeverity === 'number') {\n    next.todoSeverity = partial.todoSeverity as DiagnosticSeverity;\n  }\n  currentConfig = next;\n}\n\nfunction scheduleValidate(connection: Connection, doc: TextDocument): void {\n  const uri = doc.uri;\n  const existing = timers.get(uri);\n  if (existing) clearTimeout(existing);\n  const t = setTimeout(() => {\n    timers.delete(uri);\n    void validateAndPublish(connection, doc);\n  }, debounceMs);\n  timers.set(uri, t);\n}\n\nfunction clearDiagnostics(connection: Connection, doc: TextDocument): void {\n  // Publish an empty list to clear diagnostics on close\n  connection.sendDiagnostics({ uri: doc.uri, diagnostics: [] });\n  const timer = timers.get(doc.uri);\n  if (timer) {\n    clearTimeout(timer);\n    timers.delete(doc.uri);\n  }\n}\n\nasync function validateAndPublish(connection: Connection, doc: TextDocument): Promise<void> {\n  const diagnostics = computeDiagnostics(doc, currentConfig);\n  // Respect cap\n  const limited = diagnostics.length > currentConfig.maxProblems\n    ? diagnostics.slice(0, currentConfig.maxProblems)\n    : diagnostics;\n  // Publish\n  // In LSP, diagnostics are pushed by server to client\n  try { connection.sendDiagnostics({ uri: doc.uri, diagnostics: limited }); } catch { /* ignore */ }\n}\n\n/** Compute diagnostics with lightweight, syntax-agnostic heuristics. */\nfunction computeDiagnostics(doc: TextDocument, cfg: DiagnosticsConfig): Diagnostic[] {\n  const text = doc.getText();\n  const lines = splitLines(text);\n  const out: Diagnostic[] = [];\n\n  // Simple brace balance check (pairs of {} [] ()) — heuristic\n  const braceStack: Array<{ ch: string; line: number; col: number }> = [];\n  const openers = new Set(['{', '(', '[']);\n  const closers: Record<string, string> = { '}': '{', ')': '(', ']': '[' };\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n\n    // 1) Trailing whitespace\n    const tw = /\\s+$/.exec(line);\n    if (tw) {\n      out.push(diagnostic(\n        range(i, Math.max(0, line.length - (tw[0]?.length ?? 0)), i, line.length),\n        'Espace(s) de fin de ligne inutile(s)',\n        DiagnosticSeverity.Hint,\n      ));\n    }\n\n    // 2) Tabs when not allowed\n    if (!cfg.allowTabs && line.includes('\\t')) {\n      const col = line.indexOf('\\t');\n      out.push(diagnostic(range(i, col, i, col + 1), 'Tabulation trouvée (préférer des espaces)', DiagnosticSeverity.Information));\n    }\n\n    // 3) Long lines\n    if (cfg.longLine > 0 && line.length > cfg.longLine) {\n      out.push(diagnostic(range(i, cfg.longLine, i, line.length), `Ligne trop longue (${line.length} > ${cfg.longLine})`, DiagnosticSeverity.Hint));\n    }\n\n    // 4) TODO markers\n    const todoIdx = line.indexOf('TODO');\n    if (todoIdx >= 0) {\n      out.push(diagnostic(range(i, todoIdx, i, Math.min(line.length, todoIdx + 4)), 'TODO trouvé', cfg.todoSeverity));\n    }\n\n    // 5) Brace tracking\n    for (let j = 0; j < line.length; j++) {\n      const ch = line[j];\n      if (openers.has(ch)) {\n        braceStack.push({ ch, line: i, col: j });\n      } else if (ch in closers) {\n        const need = closers[ch];\n        const top = braceStack.pop();\n        if (!top || top.ch !== need) {\n          out.push(diagnostic(range(i, j, i, j + 1), `Fermeture inattendue « ${ch} »`, DiagnosticSeverity.Warning));\n        }\n      }\n    }\n  }\n\n  // Unclosed openers\n  for (const b of braceStack) {\n    out.push(diagnostic(range(b.line, b.col, b.line, Math.max(b.col + 1, 0)), `Délimiteur « ${b.ch} » non refermé`, DiagnosticSeverity.Warning));\n  }\n\n  return out;\n}\n\n// ----------------- helpers -----------------\n\nfunction diagnostic(r: Range, message: string, severity: DiagnosticSeverity): Diagnostic {\n  return { range: r, message, severity, source: 'vitte' };\n}\n\nfunction range(sl: number, sc: number, el: number, ec: number): Range {\n  return Range.create(Position.create(sl, sc), Position.create(el, ec));\n}\n\nfunction splitLines(text: string): string[] {\n  // Keep it simple and fast; LSP Document provides all text\n  // Normalize to \\n and split, preserving last empty line if any\n  return text.replace(/\\r\\n?/g, '\\n').split('\\n');\n}\n"]}