{"version":3,"file":"completion.js","sourceRoot":"","sources":["../../features/completion.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  type Connection,\n  type TextDocumentPositionParams,\n  type CompletionItem,\n  type CompletionList,\n  CompletionItemKind,\n  InsertTextFormat,\n  TextDocuments,\n  type TextDocument,\n  Range,\n  Position\n} from 'vscode-languageserver/node';\n\n/**\n * Completion subsystem for Vitte LSP — strict-safe, keyword + snippet items,\n * minimal context, and resolve support. No implicit undefineds.\n */\n\nexport interface CompletionConfig {\n  enableSnippets: boolean;\n  maxItems: number;\n}\n\nconst DEFAULT_CONFIG: CompletionConfig = {\n  enableSnippets: true,\n  maxItems: 200,\n};\n\nlet currentConfig: CompletionConfig = { ...DEFAULT_CONFIG };\n\n/** Register completion feature */\nexport function registerCompletion(connection: Connection, documents: TextDocuments<TextDocument>): void {\n  connection.onDidChangeConfiguration((params) => {\n    try {\n      const cfg = (params.settings as any)?.vitte?.completion as Partial<CompletionConfig> | undefined;\n      if (cfg && typeof cfg === 'object') {\n        updateConfig(cfg);\n      }\n    } catch {\n      // ignore invalid payload\n    }\n  });\n\n  connection.onCompletion((params): CompletionList => {\n    const doc = documents.get(params.textDocument.uri);\n    if (!doc) return emptyList();\n    return completeAt(doc, params);\n  });\n\n  // Provide resolve to enrich details/documentation lazily\n  connection.onCompletionResolve((item: CompletionItem): CompletionItem => {\n    if (item.data === 'vitte:snippet:for') {\n      item.detail = 'Boucle for (snippet)';\n      item.documentation = 'Insère une boucle `for` Vitte avec index et bornes incluses.';\n    } else if (item.data === 'vitte:kw:fn') {\n      item.detail = 'Déclaration de fonction';\n    }\n    return item;\n  });\n}\n\nexport function updateConfig(partial: Partial<CompletionConfig>): void {\n  const next: CompletionConfig = { ...currentConfig };\n  if (typeof partial.enableSnippets === 'boolean') next.enableSnippets = partial.enableSnippets;\n  if (typeof partial.maxItems === 'number' && Number.isFinite(partial.maxItems) && partial.maxItems > 0) next.maxItems = partial.maxItems;\n  currentConfig = next;\n}\n\n// ---------------- core logic ----------------\n\nfunction completeAt(doc: TextDocument, params: TextDocumentPositionParams): CompletionList {\n  const { position } = params;\n  const prefix = linePrefix(doc, position);\n\n  const items: CompletionItem[] = [];\n  // Keywords (subset placeholder — adapt to Vitte real grammar)\n  const keywords: Array<{ label: string; kind: CompletionItemKind; detail?: string; data?: string }> = [\n    { label: 'fn', kind: CompletionItemKind.Keyword, detail: 'Déclare une fonction', data: 'vitte:kw:fn' },\n    { label: 'let', kind: CompletionItemKind.Keyword, detail: 'Bind immuable' },\n    { label: 'mut', kind: CompletionItemKind.Keyword, detail: 'Mutabilité' },\n    { label: 'struct', kind: CompletionItemKind.Keyword },\n    { label: 'enum', kind: CompletionItemKind.Keyword },\n    { label: 'use', kind: CompletionItemKind.Keyword },\n    { label: 'mod', kind: CompletionItemKind.Keyword },\n    { label: 'impl', kind: CompletionItemKind.Keyword },\n    { label: 'return', kind: CompletionItemKind.Keyword },\n    { label: 'if', kind: CompletionItemKind.Keyword },\n    { label: 'else', kind: CompletionItemKind.Keyword },\n    { label: 'for', kind: CompletionItemKind.Keyword },\n    { label: 'while', kind: CompletionItemKind.Keyword },\n  ];\n\n  for (const k of keywords) {\n    if (startsWithWord(prefix, k.label)) {\n      items.push({\n        label: k.label,\n        kind: k.kind,\n        detail: k.detail,\n        data: k.data,\n      });\n    }\n  }\n\n  if (currentConfig.enableSnippets) {\n    items.push(...snippetItems(prefix));\n  }\n\n  // Cap results\n  const limited = items.length > currentConfig.maxItems ? items.slice(0, currentConfig.maxItems) : items;\n  return { isIncomplete: false, items: limited };\n}\n\nfunction snippetItems(prefix: string): CompletionItem[] {\n  const out: CompletionItem[] = [];\n\n  if (startsWithWord(prefix, 'for')) {\n    out.push({\n      label: 'for (i in 0..N)',\n      kind: CompletionItemKind.Snippet,\n      detail: 'Boucle for (0..N)',\n      insertTextFormat: InsertTextFormat.Snippet,\n      insertText: 'for (let ${1:i} in 0..${2:N}) {\\n    ${3:// ...}\\n}',\n      data: 'vitte:snippet:for',\n    });\n  }\n\n  // Function template\n  if (startsWithWord(prefix, 'fn')) {\n    out.push({\n      label: 'fn name(args) -> T {}',\n      kind: CompletionItemKind.Snippet,\n      detail: 'Déclaration de fonction',\n      insertTextFormat: InsertTextFormat.Snippet,\n      insertText: 'fn ${1:name}(${2:args}) -> ${3:T} {\\n    ${4:// body}\\n}',\n      data: 'vitte:snippet:fn',\n    });\n  }\n\n  return out;\n}\n\n// ---------------- helpers ----------------\n\nfunction linePrefix(doc: TextDocument, pos: Position): string {\n  const start = Position.create(pos.line, 0);\n  const r = Range.create(start, pos);\n  const text = doc.getText(r);\n  // Keep only the last wordish fragment to compare startsWith\n  const m = /([A-Za-z_][A-Za-z0-9_]*)$/.exec(text);\n  return m ? m[1] : '';\n}\n\nfunction startsWithWord(prefix: string, word: string): boolean {\n  if (prefix.length === 0) return true; // offer at BOF\n  return word.startsWith(prefix);\n}\n\nfunction emptyList(): CompletionList {\n  return { isIncomplete: false, items: [] };\n}\n"]}