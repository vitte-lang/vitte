{"version":3,"file":"formatting.js","sourceRoot":"","sources":["../../features/formatting.ts"],"names":[],"mappings":"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","sourcesContent":["\n/**\n * Vitte Language Server â€” Formatting Helpers\n * ------------------------------------------\n * Pure deterministic text formatter with no LSP side effects.\n * Provides whitespace normalization, indentation policy enforcement,\n * EOL normalization, and final newline management.\n */\n\nexport type EolKind = 'lf' | 'crlf' | 'auto';\n\nexport interface FormattingSettings {\n  tabSize: number;\n  insertSpaces: boolean;\n  trimTrailingWhitespace: boolean;\n  insertFinalNewline: boolean;\n  eol: EolKind;\n  detectMixedIndentation?: boolean;\n}\n\nexport const defaultFormatting: FormattingSettings = {\n  tabSize: 2,\n  insertSpaces: true,\n  trimTrailingWhitespace: true,\n  insertFinalNewline: true,\n  eol: 'lf',\n  detectMixedIndentation: true,\n};\n\n/**\n * Detects indentation style in a given text sample.\n * Returns true if spaces are dominant, false if tabs are dominant.\n */\nexport function detectIndentationStyle(text: string): boolean {\n  const lines = text.split(/\\r?\\n/);\n  let spaceCount = 0;\n  let tabCount = 0;\n  for (const line of lines) {\n    if (/^\\s*$/.test(line)) continue;\n    const m = line.match(/^(\\s+)/);\n    if (m) {\n      if (m[1].includes('\\t')) tabCount++;\n      else if (m[1].includes(' ')) spaceCount++;\n    }\n  }\n  return spaceCount >= tabCount;\n}\n\n/**\n * Normalize EOLs in text to desired format.\n */\nexport function normalizeEol(text: string, eol: EolKind): string {\n  if (eol === 'auto') return text;\n  if (eol === 'crlf') {\n    return text.replace(/\\r\\n/g, '\\n').replace(/\\n/g, '\\r\\n');\n  }\n  // default 'lf'\n  return text.replace(/\\r\\n/g, '\\n');\n}\n\n/**\n * Apply indentation and trailing space policy.\n */\nexport function applyWhitespacePolicy(lines: string[], opts: FormattingSettings): string[] {\n  const tabUnit = opts.insertSpaces ? ' '.repeat(Math.max(1, opts.tabSize)) : '\\t';\n  return lines.map((line) => {\n    if (opts.insertSpaces) {\n      // Replace leading tabs by configured number of spaces\n      const matchTabs = line.match(/^\\t+/)?.[0] ?? '';\n      if (matchTabs.length > 0) {\n        line = matchTabs.split('').map(() => tabUnit).join('') + line.slice(matchTabs.length);\n      }\n    } else {\n      // Replace groups of spaces by tabs\n      const re = new RegExp(`^(?: {${opts.tabSize}})+`);\n      const m = line.match(re);\n      if (m) {\n        const spaces = m[0].length;\n        const tabs = Math.floor(spaces / opts.tabSize);\n        line = '\\t'.repeat(tabs) + line.slice(spaces);\n      }\n    }\n\n    // Remove trailing spaces/tabs if configured\n    if (opts.trimTrailingWhitespace) {\n      line = line.replace(/[ \\t]+$/g, '');\n    }\n    return line;\n  });\n}\n\n/**\n * Determines appropriate EOL character sequence for a text sample.\n */\nexport function detectEol(text: string): EolKind {\n  const crlfCount = (text.match(/\\r\\n/g) || []).length;\n  const lfCount = (text.match(/(?<!\\r)\\n/g) || []).length;\n  if (crlfCount === 0 && lfCount === 0) return 'lf';\n  if (crlfCount > lfCount) return 'crlf';\n  return 'lf';\n}\n\n/**\n * Performs deterministic format of provided text according to settings.\n * @param text - Original text\n * @param opts - Formatting settings\n * @param isFragment - Whether text is a fragment or full document\n * @returns Formatted text\n */\nexport function formatText(text: string, opts: FormattingSettings, isFragment = false): string {\n  if (typeof text !== 'string') return '';\n\n  // Optionally detect indentation\n  let cfg = { ...opts };\n  if (cfg.detectMixedIndentation && text.match(/\\t/) && text.match(/^ +/m)) {\n    cfg.insertSpaces = detectIndentationStyle(text);\n  }\n\n  // Normalize input line endings to LF for consistent handling\n  let work = text.replace(/\\r\\n/g, '\\n');\n  const lines = work.split('\\n');\n\n  // Apply whitespace and indentation normalization\n  const processed = applyWhitespacePolicy(lines, cfg);\n  work = processed.join('\\n');\n\n  // Normalize EOLs to target style\n  work = normalizeEol(work, cfg.eol);\n\n  // Ensure trailing newline for full documents\n  if (!isFragment && cfg.insertFinalNewline) {\n    const ending = cfg.eol === 'crlf' ? '\\r\\n' : '\\n';\n    if (!work.endsWith(ending)) work += ending;\n  }\n\n  return work;\n}\n\n/**\n * Compare two formatted texts for equality ignoring EOL differences.\n */\nexport function isSameFormat(a: string, b: string): boolean {\n  return a.replace(/\\r\\n/g, '\\n') === b.replace(/\\r\\n/g, '\\n');\n}\n\n/**\n * Utility to quickly preview what would change by formatting.\n */\nexport function diffPreview(before: string, after: string, contextLines = 2): string {\n  const beforeLines = before.split(/\\r?\\n/);\n  const afterLines = after.split(/\\r?\\n/);\n  const diffs: string[] = [];\n  const max = Math.max(beforeLines.length, afterLines.length);\n  for (let i = 0; i < max; i++) {\n    const a = beforeLines[i] ?? '';\n    const b = afterLines[i] ?? '';\n    if (a !== b) {\n      const start = Math.max(0, i - contextLines);\n      const end = Math.min(max, i + contextLines + 1);\n      diffs.push(`--- difference around line ${i + 1} ---`);\n      for (let j = start; j < end; j++) {\n        const beforeLine = beforeLines[j] ?? '';\n        const afterLine = afterLines[j] ?? '';\n        if (beforeLine !== afterLine) {\n          diffs.push(`- ${beforeLine}`);\n          diffs.push(`+ ${afterLine}`);\n        } else {\n          diffs.push(`  ${beforeLine}`);\n        }\n      }\n    }\n  }\n  return diffs.join('\\n');\n}\n"]}