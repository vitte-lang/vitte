{"version":3,"file":"server.js","sourceRoot":"","sources":["../../src/server.ts"],"names":[],"mappings":"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","sourcesContent":["// server.ts â€” Vitte/Vit hardened LSP server\n// Goals:\n// - Full capabilities: completion, hover, symbols, def/refs, rename, formatting, diagnostics, semantic tokens\n// - Dynamic config management + watchers + graceful shutdown\n// - Lint with debounce, size guards, cancellation\n// - Controlled logging, lightweight metrics, pervasive try/catch\n\nimport {\n  createConnection,\n  ProposedFeatures,\n  TextDocumentSyncKind,\n  TextDocuments,\n  TextEdit,\n  DidChangeConfigurationNotification,\n  FileChangeType,\n} from \"vscode-languageserver/node\";\nimport type {\n  Connection,\n  InitializeParams,\n  InitializeResult,\n  CompletionParams,\n  CompletionItem,\n  HoverParams,\n  Hover,\n  DocumentSymbolParams,\n  DocumentSymbol,\n  DocumentFormattingParams,\n  SemanticTokens,\n  SemanticTokensParams,\n  SemanticTokensLegend,\n  WorkspaceSymbolParams,\n  WorkspaceSymbol,\n  DefinitionParams,\n  Location,\n  ReferenceParams,\n  RenameParams,\n  PrepareRenameParams,\n  Range,\n  WorkspaceEdit,\n  CancellationToken,\n  RemoteWorkspace,\n} from \"vscode-languageserver/node\";\nimport { TextDocument } from \"vscode-languageserver-textdocument\";\n\n/* Modules internes */\nimport { provideCompletions, resolveCompletion, triggerCharacters } from \"./completion.js\";\nimport {\n  documentSymbols,\n  definitionAtPosition,\n  referencesAtPosition,\n  renameSymbol,\n  prepareRename,\n  workspaceSymbols,\n} from \"./navigation.js\";\nimport { provideFormattingEdits } from \"./formatting.js\";\nimport { getSemanticTokensLegend, buildSemanticTokens, provideHover } from \"./semantic.js\";\nimport { lintToPublishable } from \"./lint.js\";\nimport { registerCommands } from \"./commands.js\";\nimport { indexDocument as indexWorkspaceDocument, removeDocument as removeWorkspaceDocument, clearIndex } from \"./indexer.js\";\n\nconst createSemanticTokens: (doc: TextDocument) => SemanticTokens = buildSemanticTokens;\n\ninterface MetricAggregate {\n  count: number;\n  totalMs: number;\n  maxMs: number;\n  lastMs: number;\n  lastAt: number;\n  lastUri: string;\n  lastCount?: number;\n}\n\nconst metricStore = new Map<string, MetricAggregate>();\n\n/* --------------------------- Connection + documents ----------------------- */\nconst connection: Connection = createConnection(ProposedFeatures.all);\nconst documents = new TextDocuments<TextDocument>(TextDocument);\nfunction emptySemanticTokens(): SemanticTokens {\n  return { data: [] };\n}\n\n/* ------------------------------- Configuration --------------------------- */\ninterface ServerSettings {\n  trace: \"off\" | \"messages\" | \"verbose\";\n  lintDebounceMs: number;\n  enableFormatting: boolean;\n  maxFileSizeKB: number; // above this limit, skip lint + semantic tokens to preserve perf\n}\n\nconst DEFAULT_SETTINGS: ServerSettings = {\n  trace: \"off\",\n  lintDebounceMs: 200,\n  enableFormatting: true,\n  maxFileSizeKB: 1024, // 1 MB\n};\n\nlet globalSettings: ServerSettings = { ...DEFAULT_SETTINGS };\nlet hasConfigurationCapability = false;\nlet hasWorkspaceFoldersCapability = false;\n\nconnection.onInitialize((params: InitializeParams): InitializeResult => {\n  const capabilities = params.capabilities;\n  hasConfigurationCapability = !!capabilities.workspace?.configuration;\n  hasWorkspaceFoldersCapability = !!capabilities.workspace?.workspaceFolders;\n\n  const legend: SemanticTokensLegend = getSemanticTokensLegend();\n\n  const result: InitializeResult = {\n    capabilities: {\n      textDocumentSync: TextDocumentSyncKind.Incremental,\n      // Enable resolve to enrich completion items lazily and use centralized trigger characters\n      completionProvider: { resolveProvider: true, triggerCharacters: triggerCharacters() },\n      hoverProvider: true,\n      documentSymbolProvider: true,\n      documentFormattingProvider: true,\n      definitionProvider: true,\n      referencesProvider: true,\n      renameProvider: { prepareProvider: true },\n      workspaceSymbolProvider: true,\n      semanticTokensProvider: { legend, full: true, range: false },\n    },\n  };\n\n  if (hasWorkspaceFoldersCapability) {\n    result.capabilities.workspace = { workspaceFolders: { supported: true } };\n  }\n  return result;\n});\n\nconnection.onInitialized(() => {\n  registerCommands(connection);\n  if (hasConfigurationCapability) {\n    void connection.client.register(DidChangeConfigurationNotification.type, undefined);\n  }\n  // Watch classiques pour compat large versions du client\n  connection.onDidChangeWatchedFiles((change) => {\n    for (const ev of change.changes) {\n      if (ev.type === FileChangeType.Deleted) {\n        void connection.sendDiagnostics({ uri: ev.uri, diagnostics: [] });\n      }\n    }\n  });\n});\n\nconnection.onRequest(\"vitte/metrics\", () => {\n  const snapshot = Array.from(metricStore.entries()).map(([name, data]) => ({\n    name,\n    count: data.count,\n    averageMs: data.count > 0 ? data.totalMs / data.count : 0,\n    maxMs: data.maxMs,\n    lastMs: data.lastMs,\n    lastAt: data.lastAt,\n    lastUri: data.lastUri,\n    lastCount: data.lastCount ?? null,\n  }));\n  snapshot.sort((a, b) => b.averageMs - a.averageMs);\n  return snapshot;\n});\n\nconnection.onShutdown(() => {\n  for (const t of lintTimers.values()) clearTimeout(t);\n  lintTimers.clear();\n  clearIndex();\n});\n\n/* ------------------------------- Config updates --------------------------- */\nasync function applyConfiguration(): Promise<void> {\n  const workspace = Reflect.get(connection, \"workspace\") as RemoteWorkspace | undefined;\n  if (hasConfigurationCapability && workspace) {\n    try {\n      const cfg = await workspace.getConfiguration({ section: \"vitte\" }) as Partial<ServerSettings> | null | undefined;\n      globalSettings = { ...DEFAULT_SETTINGS, ...(cfg ?? {}) };\n    } catch {\n      globalSettings = { ...DEFAULT_SETTINGS };\n    }\n  } else {\n    globalSettings = { ...DEFAULT_SETTINGS };\n  }\n  for (const doc of documents.all()) scheduleLint(doc);\n}\n\nconnection.onDidChangeConfiguration(() => {\n  void applyConfiguration();\n});\n\n/* --------------------------------- Guards -------------------------------- */\nfunction tooLarge(doc: TextDocument): boolean {\n  const kb = Buffer.byteLength(doc.getText(), \"utf8\") / 1024;\n  return kb > (globalSettings.maxFileSizeKB | 0);\n}\n\nfunction cancelled(token?: CancellationToken): boolean { return !!token?.isCancellationRequested; }\n\n/* --------------------------------- Handlers ------------------------------- */\n\nconnection.onCompletion((params: CompletionParams, token?: CancellationToken): CompletionItem[] => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return [];\n  try {\n    const result = provideCompletions(doc, params.position);\n    metric(\"completion\", start, doc.uri, result.length);\n    return result;\n  } catch (e) { logErr(\"completion\", e); return []; }\n});\n\n// Allow the client to resolve/enrich completion items on demand (details, docs)\nconnection.onCompletionResolve((item: CompletionItem): CompletionItem => {\n  const start = now();\n  try {\n    const resolved = resolveCompletion(item);\n    metric(\"completionResolve\", start, \"completionResolve\");\n    return resolved;\n  } catch (e) { logErr(\"completionResolve\", e); return item; }\n});\n\nconnection.onHover((params: HoverParams, token?: CancellationToken): Hover | null => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return null;\n  try {\n    const hover = provideHover(doc, params.position);\n    metric(\"hover\", start, doc.uri);\n    return hover;\n  } catch (e) { logErr(\"hover\", e); return null; }\n});\n\nconnection.onDocumentSymbol((params: DocumentSymbolParams, token?: CancellationToken): DocumentSymbol[] => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return [];\n  try {\n    const symbols = documentSymbols(doc);\n    metric(\"documentSymbols\", start, doc.uri, symbols.length);\n    return symbols;\n  } catch (e) { logErr(\"documentSymbols\", e); return []; }\n});\n\nconnection.onDocumentFormatting((params: DocumentFormattingParams, token?: CancellationToken) => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || !globalSettings.enableFormatting || cancelled(token)) return [];\n  try {\n    const edits = provideFormattingEdits(doc, params.options);\n    metric(\"formatting\", start, doc.uri, edits.length);\n    return edits;\n  } catch (e) { logErr(\"formatting\", e); return []; }\n});\n\nconnection.onDefinition((params: DefinitionParams, token?: CancellationToken): Location[] => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return [];\n  try {\n    const defs = definitionAtPosition(doc, params.position, params.textDocument.uri);\n    metric(\"definition\", start, doc.uri, defs.length);\n    return defs;\n  } catch (e) { logErr(\"definition\", e); return []; }\n});\n\nconnection.onReferences((params: ReferenceParams, token?: CancellationToken): Location[] => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return [];\n  try {\n    const refs = referencesAtPosition(doc, params.position, params.textDocument.uri);\n    metric(\"references\", start, doc.uri, refs.length);\n    return refs;\n  } catch (e) { logErr(\"references\", e); return []; }\n});\n\nconnection.onPrepareRename((params: PrepareRenameParams, token?: CancellationToken): { range: Range; placeholder: string } | null => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return null;\n  try {\n    const result = prepareRename(doc, params.position);\n    if (result) metric(\"prepareRename\", start, doc.uri);\n    return result;\n  } catch (e) { logErr(\"prepareRename\", e); return null; }\n});\n\n// Correction de type: renvoie WorkspaceEdit\nconnection.onRenameRequest((params: RenameParams, token?: CancellationToken): WorkspaceEdit | null => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return null;\n  try {\n    const edits = renameSymbol(doc, params.position, params.newName).map(e => TextEdit.replace(e.range, e.newText));\n    const we: WorkspaceEdit = { changes: { [doc.uri]: edits } };\n    metric(\"rename\", start, doc.uri, edits.length);\n    return we;\n  } catch (e) { logErr(\"rename\", e); return null; }\n});\n\nconnection.onWorkspaceSymbol((params: WorkspaceSymbolParams, token?: CancellationToken): WorkspaceSymbol[] => {\n  const start = now();\n  if (cancelled(token)) return [];\n  try {\n    const openDocs = documents.all().map(d => ({ uri: d.uri, doc: d }));\n    const symbols = workspaceSymbols(params.query ?? \"\", openDocs, 200);\n    metric(\"workspaceSymbols\", start, params.query ?? \"\", symbols.length);\n    return symbols;\n  } catch (e) { logErr(\"workspaceSymbols\", e); return []; }\n});\n\nconnection.languages.semanticTokens.on((params: SemanticTokensParams, token?: CancellationToken) => {\n  const start = now();\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc || cancelled(token)) return Promise.resolve(emptySemanticTokens());\n  if (tooLarge(doc)) return Promise.resolve(emptySemanticTokens());\n  try {\n    const tokens = createSemanticTokens(doc);\n    metric(\"semanticTokens\", start, doc.uri, tokens.data.length / 5);\n    return Promise.resolve(tokens);\n  } catch (e) {\n    logErr(\"semanticTokens\", e);\n    return Promise.resolve(emptySemanticTokens());\n  }\n});\n\n/* -------------------------------- Diagnostics ----------------------------- */\nconst lintTimers = new Map<string, NodeJS.Timeout>();\n\nfunction runLint(doc: TextDocument): void {\n  try {\n    if (tooLarge(doc)) { void connection.sendDiagnostics({ uri: doc.uri, diagnostics: [] }); return; }\n    const text = doc.getText();\n    const uri = doc.uri;\n    const t0 = now();\n    const diags = lintToPublishable(text, uri) ?? [];\n    void connection.sendDiagnostics({ uri, diagnostics: diags });\n    metric(\"lint\", t0, uri, diags.length);\n  } catch (e) {\n    logErr(\"lint\", e);\n  }\n}\n\nfunction scheduleLint(doc: TextDocument): void {\n  const key = doc.uri;\n  const delay = Math.max(0, globalSettings.lintDebounceMs | 0);\n  const prev = lintTimers.get(key);\n  if (prev) clearTimeout(prev);\n  lintTimers.set(key, setTimeout(() => runLint(doc), delay));\n}\n\n/* --------------------------------- Events -------------------------------- */\n\ndocuments.onDidOpen((e) => { indexWorkspaceDocument(e.document); scheduleLint(e.document); });\ndocuments.onDidChangeContent((e) => { indexWorkspaceDocument(e.document); scheduleLint(e.document); });\ndocuments.onDidClose((e) => {\n  removeWorkspaceDocument(e.document.uri);\n  void connection.sendDiagnostics({ uri: e.document.uri, diagnostics: [] });\n  lintTimers.delete(e.document.uri);\n});\n\n/* --------------------------------- Launch -------------------------------- */\n\ndocuments.listen(connection);\nconnection.listen();\n\n/* --------------------------------- Utils --------------------------------- */\n\nfunction now(): number {\n  if (typeof process !== \"undefined\" && typeof process.hrtime === \"function\") {\n    const [sec, nanosec] = process.hrtime();\n    return sec * 1000 + nanosec / 1e6;\n  }\n  return Date.now();\n}\n\nfunction metric(what: string, startMs: number, uri: string, n?: number) {\n  const elapsed = now() - startMs;\n  const entry = metricStore.get(what) ?? {\n    count: 0,\n    totalMs: 0,\n    maxMs: 0,\n    lastMs: 0,\n    lastAt: 0,\n    lastUri: \"\",\n  };\n  entry.count += 1;\n  entry.totalMs += elapsed;\n  entry.maxMs = Math.max(entry.maxMs, elapsed);\n  entry.lastMs = elapsed;\n  entry.lastAt = Date.now();\n  entry.lastUri = uri;\n  entry.lastCount = typeof n === \"number\" ? n : undefined;\n  metricStore.set(what, entry);\n\n  if (globalSettings.trace === \"verbose\") {\n    connection.console.log(\n      `[metric] ${what} ${elapsed.toFixed(1)}ms uri=${uri}${typeof n === \"number\" ? ` n=${n}` : \"\"}`\n    );\n  }\n}\n\nfunction logErr(ctx: string, err: unknown) {\n  const msg = err instanceof Error ? `${err.name}: ${err.message}` : String(err);\n  if (globalSettings.trace === \"verbose\" && err instanceof Error && err.stack) {\n    connection.console.error(`[${ctx}] ${msg}\\n${err.stack}`);\n  } else {\n    connection.console.error(`[${ctx}] ${msg}`);\n  }\n}\n"]}