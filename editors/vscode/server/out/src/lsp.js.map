{"version":3,"file":"lsp.js","sourceRoot":"","sources":["../../src/lsp.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Vitte LSP — Main Server (synchronized)\n * --------------------------------------\n * Unified LSP server aligned with the updated config/logger/utils/languageService modules.\n */\n\nimport {\n  createConnection,\n  ProposedFeatures,\n  TextDocuments,\n  TextDocumentSyncKind,\n  DidChangeConfigurationNotification,\n  DidChangeWatchedFilesNotification,\n  FileChangeType,\n  CompletionItemKind,\n  MarkupKind,\n  Location,\n} from 'vscode-languageserver/node';\nimport type {\n  InitializeParams,\n  InitializeResult,\n  CompletionItem,\n  TextDocumentPositionParams,\n  Hover,\n  Range,\n} from 'vscode-languageserver/node';\n\nimport { TextDocument } from 'vscode-languageserver-textdocument';\n\nimport Config, { defaultFormatting } from './config';\nimport type { FormattingSettings } from './config';\nimport { logLsp, attachConnection } from './logger';\nimport { provideCompletions, resolveCompletion, triggerCharacters } from './completion';\nimport { getSemanticTokensLegend, buildSemanticTokens, provideHover as keywordHover } from './semantic';\nimport { lintToPublishable } from './lint';\nimport { definitionAtPosition, documentSymbols } from './navigation';\nimport { indexDocument, updateDocument, removeDocument, searchWorkspaceSymbols, toWorkspaceSymbols, getDocumentIndex, getIndex, indexText } from './indexer';\nimport { getDocstringAtLine } from './docstrings';\nimport { provideFormattingEdits } from './formatting';\nimport type { ExtraFormattingOptions } from './formatting';\nimport fs from 'node:fs/promises';\nimport path from 'node:path';\nimport { fileURLToPath, pathToFileURL } from 'node:url';\n\nconst fileCache = new Map<string, { mtimeMs: number; size: number; text: string }>();\nimport {\n  normalizeIndentation,\n  computeMinimalSmartEdits,\n  expandSelectionToEnclosingBrackets,\n} from './utils/text';\n\n// ---------------------------------------------------------------------------\n// Connection & documents\n// ---------------------------------------------------------------------------\n\nexport const connection = createConnection(ProposedFeatures.all);\nattachConnection(connection);\nlogLsp.info('Vitte LSP: connection created');\n\nconst documents = new TextDocuments<TextDocument>(TextDocument);\n\nlet hasConfigurationCapability = false;\nlet hasWorkspaceFolderCapability = false;\nconst semanticLegend = getSemanticTokensLegend();\n\ninterface FormatDocumentParams {\n  textDocument?: { uri?: string };\n}\n\ninterface FormatRangeParams extends FormatDocumentParams {\n  range?: Range;\n}\n\ninterface ExpandSelectionParams extends FormatDocumentParams {\n  position?: { line: number; character: number };\n}\n\nfunction wordAt(doc: TextDocument, pos: { line: number; character: number }): string | null {\n  const text = doc.getText();\n  const off = doc.offsetAt(pos);\n  let s = off;\n  let e = off;\n  while (s > 0 && /[A-Za-z0-9_]/.test(text.charAt(s - 1))) s--;\n  while (e < text.length && /[A-Za-z0-9_]/.test(text.charAt(e))) e++;\n  return e > s ? text.slice(s, e) : null;\n}\n\nfunction toExtraFormatting(opts: FormattingSettings): ExtraFormattingOptions {\n  const normalizeEOL = opts.eol === 'auto' ? undefined : opts.eol;\n  return {\n    tabSize: opts.tabSize,\n    insertSpaces: opts.insertSpaces,\n    trimTrailingWhitespace: opts.trimTrailingWhitespace,\n    insertFinalNewline: opts.insertFinalNewline,\n    normalizeEOL,\n  };\n}\n\nfunction isIdentChar(ch: string): boolean {\n  return /[A-Za-z0-9_]/.test(ch);\n}\n\nfunction buildCodeMask(text: string): Uint8Array {\n  const n = text.length;\n  const mask = new Uint8Array(n);\n  let i = 0;\n  const mark = (from: number, to: number) => { for (let k = from; k < to; k++) mask[k] = 1; };\n  while (i < n) {\n    const c = text.charCodeAt(i);\n    const c2 = i + 1 < n ? text.charCodeAt(i + 1) : 0;\n\n    if (c === 0x23 /* # */ && c2 !== 0x5b /* [ */) {\n      i += 1;\n      while (i < n && text.charCodeAt(i) !== 0x0a) i++;\n      continue;\n    }\n    if (c === 0x2f && c2 === 0x2f) {\n      i += 2;\n      while (i < n && text.charCodeAt(i) !== 0x0a) i++;\n      continue;\n    }\n    if (c === 0x2f && c2 === 0x2a) {\n      i += 2;\n      while (i < n) {\n        if (text.charCodeAt(i) === 0x2a && i + 1 < n && text.charCodeAt(i + 1) === 0x2f) { i += 2; break; }\n        i++;\n      }\n      continue;\n    }\n    if (c === 0x72 /* r */) {\n      let j = i + 1;\n      let hashes = 0;\n      while (j < n && text.charCodeAt(j) === 0x23) { hashes++; j++; }\n      if (j < n && text.charCodeAt(j) === 0x22) {\n        j++;\n        for (; j < n; j++) {\n          if (text.charCodeAt(j) === 0x22) {\n            let k = j + 1;\n            let ok = true;\n            for (let h = 0; h < hashes; h++) {\n              if (k >= n || text.charCodeAt(k) !== 0x23) { ok = false; break; }\n              k++;\n            }\n            if (ok) { j = k; break; }\n          }\n        }\n        i = j;\n        continue;\n      }\n    }\n    if (c === 0x22 || c === 0x27) {\n      const quote = c;\n      i++;\n      while (i < n) {\n        if (text.charCodeAt(i) === 0x5c) { i += 2; continue; }\n        if (text.charCodeAt(i) === quote) { i++; break; }\n        i++;\n      }\n      continue;\n    }\n    const start = i;\n    while (i < n) {\n      const a = text.charCodeAt(i);\n      const b = i + 1 < n ? text.charCodeAt(i + 1) : 0;\n      if (\n        (a === 0x2f && (b === 0x2f || b === 0x2a)) ||\n        a === 0x22 ||\n        a === 0x27 ||\n        a === 0x72 ||\n        (a === 0x23 && b !== 0x5b)\n      ) break;\n      i++;\n    }\n    mark(start, i);\n  }\n  return mask;\n}\n\nfunction buildLineIndex(text: string): number[] {\n  const idx: number[] = [0];\n  for (let i = 0; i < text.length; i++) if (text.charCodeAt(i) === 10) idx.push(i + 1);\n  return idx;\n}\n\nfunction offsetToPos(nlIdx: number[], off: number): { line: number; character: number } {\n  let lo = 0;\n  let hi = nlIdx.length - 1;\n  while (lo <= hi) {\n    const mid = (lo + hi) >> 1;\n    const v = nlIdx[mid];\n    if (v === off) return { line: mid, character: 0 };\n    if (v < off) lo = mid + 1; else hi = mid - 1;\n  }\n  const line = Math.max(0, lo - 1);\n  return { line, character: off - nlIdx[line] };\n}\n\nfunction findWordLocationsInText(text: string, uri: string, word: string): Location[] {\n  if (!word) return [];\n  const mask = buildCodeMask(text);\n  const nlIdx = buildLineIndex(text);\n  const out: Location[] = [];\n  let idx = text.indexOf(word);\n  while (idx !== -1) {\n    const before = idx === 0 ? \"\" : text.charAt(idx - 1);\n    const after = idx + word.length >= text.length ? \"\" : text.charAt(idx + word.length);\n    if (!isIdentChar(before) && !isIdentChar(after) && mask[idx]) {\n      const start = offsetToPos(nlIdx, idx);\n      const end = offsetToPos(nlIdx, idx + word.length);\n      out.push(Location.create(uri, { start, end }));\n    }\n    idx = text.indexOf(word, idx + word.length);\n  }\n  return out;\n}\n\nasync function readFileCached(filePath: string): Promise<string | null> {\n  try {\n    const stat = await fs.stat(filePath);\n    const cached = fileCache.get(filePath);\n    if (cached && cached.mtimeMs === stat.mtimeMs && cached.size === stat.size) {\n      return cached.text;\n    }\n    const text = await fs.readFile(filePath, \"utf8\");\n    fileCache.set(filePath, { mtimeMs: stat.mtimeMs, size: stat.size, text });\n    return text;\n  } catch {\n    return null;\n  }\n}\n\ninterface IndexerSettings {\n  exclude: string[];\n  maxFiles: number;\n  maxFileSizeKB: number;\n}\n\nconst defaultIndexerSettings: IndexerSettings = {\n  exclude: [\"**/node_modules/**\", \"**/.git/**\", \"**/target/**\", \"**/build/**\", \"**/dist/**\", \"**/out/**\", \"**/.vscode/**\"],\n  maxFiles: 3000,\n  maxFileSizeKB: 1000,\n};\n\nfunction compileExcludeMatchers(patterns: string[]): ((p: string) => boolean)[] {\n  return (patterns ?? []).map((p) => {\n    const esc = p.replace(/[.+^${}()|[\\]\\\\]/g, \"\\\\$&\");\n    const rx = new RegExp(\"^\" + esc.replace(/\\*/g, \".*\").replace(/\\?/g, \".\") + \"$\");\n    return (pathStr: string) => rx.test(pathStr);\n  });\n}\n\nfunction isExcluded(pathStr: string, matchers: ((p: string) => boolean)[], roots: string[]): boolean {\n  const norm = pathStr.replace(/\\\\/g, \"/\");\n  for (const root of roots) {\n    const rel = norm.startsWith(root) ? norm.slice(root.length) : norm;\n    const relNorm = rel.startsWith(\"/\") ? rel.slice(1) : rel;\n    for (const m of matchers) {\n      if (m(relNorm) || m(norm)) return true;\n    }\n  }\n  return false;\n}\n\nasync function getIndexerSettings(): Promise<IndexerSettings> {\n  if (!hasConfigurationCapability) return { ...defaultIndexerSettings };\n  try {\n    const raw = await connection.workspace.getConfiguration({ section: 'vitte.indexer' }) as Partial<IndexerSettings> | null | undefined;\n    const out: IndexerSettings = { ...defaultIndexerSettings, ...(raw ?? {}) };\n    if (!Array.isArray(out.exclude)) out.exclude = defaultIndexerSettings.exclude;\n    out.maxFiles = Math.max(100, Math.min(20000, Number(out.maxFiles) || defaultIndexerSettings.maxFiles));\n    out.maxFileSizeKB = Math.max(64, Math.min(10000, Number(out.maxFileSizeKB) || defaultIndexerSettings.maxFileSizeKB));\n    return out;\n  } catch {\n    return { ...defaultIndexerSettings };\n  }\n}\n\nasync function indexWorkspaceFolders(): Promise<void> {\n  const folders = await connection.workspace.getWorkspaceFolders();\n  if (!folders || folders.length === 0) return;\n\n  const exts = new Set([\".vit\", \".vitte\"]);\n  const settings = await getIndexerSettings();\n  const maxFiles = settings.maxFiles;\n  const maxSize = settings.maxFileSizeKB * 1024;\n\n  let indexed = 0;\n  const stack: string[] = [];\n  const roots: string[] = [];\n  for (const f of folders) {\n    if (f.uri.startsWith(\"file://\")) {\n      const root = fileURLToPath(f.uri);\n      roots.push(root.replace(/\\\\/g, \"/\"));\n      stack.push(root);\n    }\n  }\n  const excludeMatchers = compileExcludeMatchers(settings.exclude);\n\n  while (stack.length > 0 && indexed < maxFiles) {\n    const dir = stack.pop()!;\n    if (isExcluded(dir, excludeMatchers, roots)) continue;\n    let entries;\n    try {\n      entries = await fs.readdir(dir, { withFileTypes: true });\n    } catch {\n      continue;\n    }\n    for (const ent of entries) {\n      if (indexed >= maxFiles) break;\n      const full = path.join(dir, ent.name);\n      if (ent.isDirectory()) {\n        if (!ent.name.startsWith(\".\") && !isExcluded(full, excludeMatchers, roots)) {\n          stack.push(full);\n        }\n        continue;\n      }\n      if (!ent.isFile()) continue;\n      const ext = path.extname(ent.name).toLowerCase();\n      if (!exts.has(ext)) continue;\n      const text = await readFileCached(full);\n      if (!text) continue;\n      if (text.length > maxSize) continue;\n      const uri = pathToFileURL(full).toString();\n      indexText(uri, text);\n      indexed++;\n    }\n  }\n\n  logLsp.info(\"Workspace index built\", { files: indexed });\n}\n\n// ---------------------------------------------------------------------------\n// Initialize / Initialized\n// ---------------------------------------------------------------------------\n\nconnection.onInitialize((params: InitializeParams): InitializeResult => {\n  const caps = Config.initConfigFromInitialize(params);\n  hasConfigurationCapability = caps.hasConfigurationCapability;\n  hasWorkspaceFolderCapability = caps.hasWorkspaceFolderCapability;\n\n  logLsp.info('Vitte LSP: initializing', caps);\n\n  const result: InitializeResult = {\n    capabilities: {\n      textDocumentSync: TextDocumentSyncKind.Incremental,\n      // Completion via completion.ts (with resolve)\n      completionProvider: { resolveProvider: true, triggerCharacters: triggerCharacters() },\n      hoverProvider: true,\n      definitionProvider: true,\n      referencesProvider: true,\n      documentSymbolProvider: true,\n      workspaceSymbolProvider: true,\n      semanticTokensProvider: { legend: semanticLegend, full: true, range: false },\n      // Formatting endpoints are exposed via custom requests below\n      documentFormattingProvider: true,\n      documentRangeFormattingProvider: true,\n    },\n  };\n\n  if (hasWorkspaceFolderCapability) {\n    result.capabilities.workspace = {\n      workspaceFolders: { supported: true, changeNotifications: true },\n    };\n  }\n\n  return result;\n});\n\nconnection.onInitialized(() => {\n  logLsp.info('Vitte LSP: initialized');\n  if (hasConfigurationCapability) {\n    void connection.client.register(DidChangeConfigurationNotification.type, undefined);\n    logLsp.debug('Registered DidChangeConfiguration');\n    void connection.client.register(DidChangeWatchedFilesNotification.type, {\n      watchers: [\n        { globPattern: '**/*.vit' },\n        { globPattern: '**/*.vitte' },\n      ],\n    });\n  }\n  void indexWorkspaceFolders();\n});\n\n// ---------------------------------------------------------------------------\n// Configuration changes → clear settings & revalidate\n// ---------------------------------------------------------------------------\n\nconst handleConfigChange = Config.makeOnDidChangeConfigurationHandler<TextDocument>(connection, {\n  getOpenDocuments: () => documents.all(),\n  validateDocument: (doc) => {\n    try {\n      const diagnostics = lintToPublishable(doc.getText(), doc.uri);\n      void connection.sendDiagnostics({ uri: doc.uri, diagnostics });\n    } catch (e) {\n      logLsp.warn('Validation error after config change', { uri: doc.uri, error: String(e) });\n    }\n  },\n});\n\nconnection.onDidChangeConfiguration(() => {\n  void handleConfigChange();\n});\n\nasync function handleWatchedFiles(e: { changes: { uri: string; type: FileChangeType }[] }) {\n  for (const change of e.changes) {\n    const uri = change.uri;\n    if (!uri.startsWith(\"file://\")) continue;\n    const filePath = fileURLToPath(uri);\n    if (change.type === FileChangeType.Deleted) {\n      removeDocument(uri);\n      fileCache.delete(filePath);\n      continue;\n    }\n    if (change.type === FileChangeType.Changed || change.type === FileChangeType.Created) {\n      const text = await readFileCached(filePath);\n      if (text) indexText(uri, text);\n    }\n  }\n}\n\nconnection.onDidChangeWatchedFiles((e) => {\n  void handleWatchedFiles(e);\n});\n\n// ---------------------------------------------------------------------------\n// Diagnostics lifecycle\n// ---------------------------------------------------------------------------\n\ndocuments.onDidOpen((e) => { void handleValidate(e.document); });\ndocuments.onDidChangeContent((e) => { void handleValidate(e.document); });\ndocuments.onDidClose((e) => {\n  // Clear diagnostics when closing\n  void connection.sendDiagnostics({ uri: e.document.uri, diagnostics: [] });\n  removeDocument(e.document.uri);\n});\n\nfunction handleValidate(doc: TextDocument) {\n  try {\n    const diags = lintToPublishable(doc.getText(), doc.uri);\n    void connection.sendDiagnostics({ uri: doc.uri, diagnostics: diags });\n    logLsp.debug('Diagnostics sent', { uri: doc.uri, count: diags.length });\n  } catch (err) {\n    logLsp.error('Validation failed', { uri: doc.uri, error: String(err) });\n  }\n}\n\n// Indexation pour navigation/complétions workspace\ndocuments.onDidOpen((e) => { indexDocument(e.document); });\ndocuments.onDidChangeContent((e) => { updateDocument(e.document); });\n\n// ---------------------------------------------------------------------------\n// Completion\n// ---------------------------------------------------------------------------\n\nconnection.onCompletion((params: TextDocumentPositionParams): CompletionItem[] => {\n  try {\n    const doc = documents.get(params.textDocument.uri);\n    if (!doc) return [];\n    return provideCompletions(doc, params.position);\n  } catch (err) {\n    logLsp.error('Completion failed', { error: String(err) });\n    return [\n      { label: 'error', kind: CompletionItemKind.Text, detail: 'Error during completion' },\n    ];\n  }\n});\n\nconnection.onCompletionResolve((item: CompletionItem): CompletionItem => {\n  try { return resolveCompletion(item); } catch { return item; }\n});\n\n// ---------------------------------------------------------------------------\n// Hover\n// ---------------------------------------------------------------------------\n\nconnection.onHover((params): Hover | null => {\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc) return null;\n\n  const kw = keywordHover(doc, params.position);\n  if (kw) return kw;\n\n  const word = wordAt(doc, params.position);\n  if (!word) return null;\n\n  const defs = getDocumentIndex(doc.uri).filter(s => s.name === word);\n  if (defs.length === 0) return null;\n\n  const closest = defs.sort((a, b) =>\n    Math.abs(a.line - params.position.line) - Math.abs(b.line - params.position.line)\n  )[0];\n  const docstring = getDocstringAtLine(doc, closest.line);\n  if (!docstring) return null;\n\n  return {\n    contents: {\n      kind: MarkupKind.Markdown,\n      value: `**${word}**\\n\\n${docstring}`,\n    },\n  };\n});\n\n// ---------------------------------------------------------------------------\n// Definition / References\n// ---------------------------------------------------------------------------\n\nconnection.onDefinition((params) => {\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc) return [];\n  return definitionAtPosition(doc, params.position, params.textDocument.uri);\n});\n\nconnection.onReferences(async (params) => {\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc) return [];\n  const word = wordAt(doc, params.position);\n  if (!word) return [];\n\n  const out: Location[] = [];\n  const uris = new Set<string>();\n  for (const uri of getIndex().keys()) uris.add(uri);\n  uris.add(doc.uri);\n\n  for (const uri of uris) {\n    const open = documents.get(uri);\n    if (open) {\n      out.push(...findWordLocationsInText(open.getText(), uri, word));\n      continue;\n    }\n    if (!uri.startsWith(\"file://\")) continue;\n    const text = await readFileCached(fileURLToPath(uri));\n    if (text) out.push(...findWordLocationsInText(text, uri, word));\n  }\n  return out;\n});\n\n// ---------------------------------------------------------------------------\n// Symbols\n// ---------------------------------------------------------------------------\n\nconnection.onDocumentSymbol((params) => {\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc) return [];\n  return documentSymbols(doc);\n});\n\nconnection.onWorkspaceSymbol((params) => {\n  const q = params.query ?? '';\n  const symbols = searchWorkspaceSymbols(q, 200);\n  return toWorkspaceSymbols(symbols);\n});\n\n// ---------------------------------------------------------------------------\n// Semantic tokens\n// ---------------------------------------------------------------------------\n\nconnection.languages.semanticTokens.on((params) => {\n  const doc = documents.get(params.textDocument.uri);\n  if (!doc) return { data: [] };\n  return buildSemanticTokens(doc);\n});\n\n// ---------------------------------------------------------------------------\n// Formatting (document, range, documentOrRange)\n// ---------------------------------------------------------------------------\n\nconnection.onDocumentFormatting(async (params) => {\n  const uri = params.textDocument.uri;\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  return provideFormattingEdits(doc, toExtraFormatting(opts));\n});\n\nconnection.onDocumentRangeFormatting(async (params) => {\n  const uri = params.textDocument.uri;\n  const doc = documents.get(uri);\n  if (!doc) return [];\n  const lspRange = params.range;\n  if (!lspRange) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n\n  const start = doc.offsetAt(lspRange.start);\n  const end = doc.offsetAt(lspRange.end);\n  const text = doc.getText();\n  const target = text.slice(start, end);\n  const targetNorm = normalizeIndentation(target, opts.insertSpaces, opts.tabSize);\n  const formattedTarget = formatText(targetNorm, opts, /*isFragment*/ true);\n  if (formattedTarget === target) return [];\n  return [{ range: lspRange, newText: formattedTarget }];\n});\n\nconnection.onRequest('vitte/formatDocument', async (params: FormatDocumentParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return [];\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  const original = doc.getText();\n\n  // Normalize indentation quickly before running formatter logic\n  const pre = normalizeIndentation(original, opts.insertSpaces, opts.tabSize);\n  const formatted = formatText(pre, opts);\n\n  // Return minimal edits\n  const edits = computeMinimalSmartEdits(original, formatted);\n  logLsp.info('Formatter produced edit(s)', { uri, edits: edits.length });\n  return edits;\n});\n\nconnection.onRequest('vitte/formatRange', async (params: FormatRangeParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return [];\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  const lspRange = params?.range;\n  if (!lspRange) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  const start = doc.offsetAt(lspRange.start);\n  const end = doc.offsetAt(lspRange.end);\n\n  const text = doc.getText();\n  const target = text.slice(start, end);\n\n  const targetNorm = normalizeIndentation(target, opts.insertSpaces, opts.tabSize);\n  const formattedTarget = formatText(targetNorm, opts, /*isFragment*/ true);\n\n  if (formattedTarget === target) return [];\n  return [{ range: lspRange, newText: formattedTarget }];\n});\n\nconnection.onRequest('vitte/formatDocumentOrRange', async (params: FormatRangeParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return [];\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  const lspRange = params?.range;\n  const original = doc.getText();\n\n  if (!lspRange) {\n    const pre = normalizeIndentation(original, opts.insertSpaces, opts.tabSize);\n    const formatted = formatText(pre, opts);\n    const edits = computeMinimalSmartEdits(original, formatted);\n    return edits;\n  } else {\n    const start = doc.offsetAt(lspRange.start);\n    const end = doc.offsetAt(lspRange.end);\n    const fragment = original.slice(start, end);\n    const fragmentNorm = normalizeIndentation(fragment, opts.insertSpaces, opts.tabSize);\n    const formattedFragment = formatText(fragmentNorm, opts, /*isFragment*/ true);\n    if (formattedFragment === fragment) return [];\n    return [{ range: lspRange, newText: formattedFragment }];\n  }\n});\n\n// ---------------------------------------------------------------------------\n// Extra: expand selection to enclosing brackets\n// ---------------------------------------------------------------------------\n\nconnection.onRequest('vitte/expandSelectionToEnclosingBrackets', (params: ExpandSelectionParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return null;\n  const doc = documents.get(uri);\n  if (!doc) return null;\n  const text = doc.getText();\n  const range = params.position ? expandSelectionToEnclosingBrackets(text, params.position) : null;\n  return range ?? null;\n});\n\n// ---------------------------------------------------------------------------\n// Basic formatter (whitespace + EOL policy) — deterministic & quick\n// ---------------------------------------------------------------------------\n\nfunction normalizeEol(text: string, eol: 'lf' | 'crlf' | 'auto'): string {\n  if (eol === 'auto') return text;\n  if (eol === 'crlf') return text.replace(/\\r\\n/g, '\\n').replace(/\\n/g, '\\r\\n');\n  return text.replace(/\\r\\n/g, '\\n');\n}\n\nfunction applyWhitespacePolicy(lines: string[], opts: { tabSize: number; insertSpaces: boolean; trimTrailingWhitespace: boolean; }): string[] {\n  const unit = opts.insertSpaces ? ' '.repeat(Math.max(1, opts.tabSize)) : '\\t';\n  return lines.map((line) => {\n    if (opts.insertSpaces) {\n      const leadingMatch = /^\\t+/.exec(line);\n      const leading = leadingMatch?.[0] ?? '';\n      if (leading.length > 0) {\n        line = leading\n          .split('')\n          .map(() => unit)\n          .join('') + line.slice(leading.length);\n      }\n    } else {\n      const re = new RegExp(`^(?: {${opts.tabSize}})+`);\n      const match = re.exec(line);\n      if (match) {\n        const spaces = match[0].length;\n        const tabs = Math.floor(spaces / opts.tabSize);\n        line = '\\t'.repeat(tabs) + line.slice(spaces);\n      }\n    }\n    if (opts.trimTrailingWhitespace) line = line.replace(/[ \\t]+$/g, '');\n    return line;\n  });\n}\n\nfunction formatText(text: string, opts: { tabSize: number; insertSpaces: boolean; trimTrailingWhitespace: boolean; insertFinalNewline: boolean; eol: 'lf'|'crlf'|'auto' }, isFragment = false): string {\n  let work = text.replace(/\\r\\n/g, '\\n');\n  let lines = work.split('\\n');\n  lines = applyWhitespacePolicy(lines, opts);\n  work = lines.join('\\n');\n  work = normalizeEol(work, opts.eol);\n  if (!isFragment && opts.insertFinalNewline) {\n    const term = opts.eol === 'crlf' ? '\\r\\n' : '\\n';\n    if (!work.endsWith(term)) work += term;\n  }\n  return work;\n}\n\n// ---------------------------------------------------------------------------\n// Start server\n// ---------------------------------------------------------------------------\n\ndocuments.listen(connection);\nconnection.listen();\nlogLsp.info('Vitte LSP: listening');\n"]}