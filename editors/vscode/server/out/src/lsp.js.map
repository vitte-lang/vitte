{"version":3,"file":"lsp.js","sourceRoot":"","sources":["../../src/lsp.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Vitte LSP — Main Server (synchronized)\n * --------------------------------------\n * Unified LSP server aligned with the updated config/logger/utils/languageService modules.\n */\n\nimport {\n  createConnection,\n  ProposedFeatures,\n  TextDocuments,\n  TextDocumentSyncKind,\n  DidChangeConfigurationNotification,\n  CompletionItemKind,\n} from 'vscode-languageserver/node';\nimport type {\n  InitializeParams,\n  InitializeResult,\n  CompletionItem,\n  TextDocumentPositionParams,\n  Range,\n} from 'vscode-languageserver/node';\n\nimport { TextDocument } from 'vscode-languageserver-textdocument';\n\nimport Config, { defaultFormatting } from './config';\nimport type { FormattingSettings } from './config';\nimport { logLsp, attachConnection } from './logger';\nimport { VitteLanguageService } from './languageService';\nimport type { LspTextDocument } from './languageService';\nimport {\n  normalizeIndentation,\n  computeMinimalSmartEdits,\n  expandSelectionToEnclosingBrackets,\n} from './utils/text';\n\n// ---------------------------------------------------------------------------\n// Connection & documents\n// ---------------------------------------------------------------------------\n\nexport const connection = createConnection(ProposedFeatures.all);\nattachConnection(connection);\nlogLsp.info('Vitte LSP: connection created');\n\nconst documents = new TextDocuments<TextDocument>(TextDocument);\nconst lang = new VitteLanguageService();\n\nlet hasConfigurationCapability = false;\nlet hasWorkspaceFolderCapability = false;\n\ninterface FormatDocumentParams {\n  textDocument?: { uri?: string };\n}\n\ninterface FormatRangeParams extends FormatDocumentParams {\n  range?: Range;\n}\n\ninterface ExpandSelectionParams extends FormatDocumentParams {\n  position?: { line: number; character: number };\n}\n\nfunction toLspDocument(doc: TextDocument): LspTextDocument {\n  return {\n    uri: doc.uri,\n    getText: doc.getText.bind(doc),\n  };\n}\n\n// ---------------------------------------------------------------------------\n// Initialize / Initialized\n// ---------------------------------------------------------------------------\n\nconnection.onInitialize((params: InitializeParams): InitializeResult => {\n  const caps = Config.initConfigFromInitialize(params);\n  hasConfigurationCapability = caps.hasConfigurationCapability;\n  hasWorkspaceFolderCapability = caps.hasWorkspaceFolderCapability;\n\n  logLsp.info('Vitte LSP: initializing', caps);\n\n  const result: InitializeResult = {\n    capabilities: {\n      textDocumentSync: TextDocumentSyncKind.Incremental,\n      // We provide completion via VitteLanguageService (with resolve)\n      completionProvider: { resolveProvider: true, triggerCharacters: ['.', ':', '>'] },\n      // Formatting endpoints are exposed via custom requests below\n      documentFormattingProvider: true,\n      documentRangeFormattingProvider: true,\n    },\n  };\n\n  if (hasWorkspaceFolderCapability) {\n    result.capabilities.workspace = {\n      workspaceFolders: { supported: true, changeNotifications: true },\n    };\n  }\n\n  return result;\n});\n\nconnection.onInitialized(() => {\n  logLsp.info('Vitte LSP: initialized');\n  if (hasConfigurationCapability) {\n    void connection.client.register(DidChangeConfigurationNotification.type, undefined);\n    logLsp.debug('Registered DidChangeConfiguration');\n  }\n});\n\n// ---------------------------------------------------------------------------\n// Configuration changes → clear settings & revalidate\n// ---------------------------------------------------------------------------\n\nconst handleConfigChange = Config.makeOnDidChangeConfigurationHandler<TextDocument>(connection, {\n  getOpenDocuments: () => documents.all(),\n  validateDocument: async (doc) => {\n    try {\n      const diagnostics = await lang.doValidation(toLspDocument(doc));\n      void connection.sendDiagnostics({ uri: doc.uri, diagnostics });\n    } catch (e) {\n      logLsp.warn('Validation error after config change', { uri: doc.uri, error: String(e) });\n    }\n  },\n});\n\nconnection.onDidChangeConfiguration(() => {\n  void handleConfigChange();\n});\n\n// ---------------------------------------------------------------------------\n// Diagnostics lifecycle\n// ---------------------------------------------------------------------------\n\ndocuments.onDidOpen((e) => { void handleValidate(e.document); });\ndocuments.onDidChangeContent((e) => { void handleValidate(e.document); });\ndocuments.onDidClose((e) => {\n  // Clear diagnostics when closing\n  void connection.sendDiagnostics({ uri: e.document.uri, diagnostics: [] });\n});\n\nasync function handleValidate(doc: TextDocument) {\n  try {\n    const diags = await lang.doValidation(toLspDocument(doc));\n    void connection.sendDiagnostics({ uri: doc.uri, diagnostics: diags });\n    logLsp.debug('Diagnostics sent', { uri: doc.uri, count: diags.length });\n  } catch (err) {\n    logLsp.error('Validation failed', { uri: doc.uri, error: String(err) });\n  }\n}\n\n// ---------------------------------------------------------------------------\n// Completion\n// ---------------------------------------------------------------------------\n\nconnection.onCompletion((params: TextDocumentPositionParams): CompletionItem[] => {\n  try {\n    const items = lang.doComplete(params);\n    return items;\n  } catch (err) {\n    logLsp.error('Completion failed', { error: String(err) });\n    return [\n      { label: 'error', kind: CompletionItemKind.Text, detail: 'Error during completion' },\n    ];\n  }\n});\n\nconnection.onCompletionResolve((item: CompletionItem): CompletionItem => {\n  try { return lang.doResolve(item); } catch { return item; }\n});\n\n// ---------------------------------------------------------------------------\n// Formatting (document, range, documentOrRange)\n// ---------------------------------------------------------------------------\n\nconnection.onRequest('vitte/formatDocument', async (params: FormatDocumentParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return [];\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  const original = doc.getText();\n\n  // Normalize indentation quickly before running formatter logic\n  const pre = normalizeIndentation(original, opts.insertSpaces, opts.tabSize);\n  const formatted = formatText(pre, opts);\n\n  // Return minimal edits\n  const edits = computeMinimalSmartEdits(original, formatted);\n  logLsp.info('Formatter produced edit(s)', { uri, edits: edits.length });\n  return edits;\n});\n\nconnection.onRequest('vitte/formatRange', async (params: FormatRangeParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return [];\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  const lspRange = params?.range;\n  if (!lspRange) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  const start = doc.offsetAt(lspRange.start);\n  const end = doc.offsetAt(lspRange.end);\n\n  const text = doc.getText();\n  const target = text.slice(start, end);\n\n  const targetNorm = normalizeIndentation(target, opts.insertSpaces, opts.tabSize);\n  const formattedTarget = formatText(targetNorm, opts, /*isFragment*/ true);\n\n  if (formattedTarget === target) return [];\n  return [{ range: lspRange, newText: formattedTarget }];\n});\n\nconnection.onRequest('vitte/formatDocumentOrRange', async (params: FormatRangeParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return [];\n  const doc = documents.get(uri);\n  if (!doc) return [];\n\n  let opts: FormattingSettings;\n  try {\n    opts = await Config.getFormattingSettings(connection, uri);\n  } catch {\n    opts = defaultFormatting;\n  }\n  const lspRange = params?.range;\n  const original = doc.getText();\n\n  if (!lspRange) {\n    const pre = normalizeIndentation(original, opts.insertSpaces, opts.tabSize);\n    const formatted = formatText(pre, opts);\n    const edits = computeMinimalSmartEdits(original, formatted);\n    return edits;\n  } else {\n    const start = doc.offsetAt(lspRange.start);\n    const end = doc.offsetAt(lspRange.end);\n    const fragment = original.slice(start, end);\n    const fragmentNorm = normalizeIndentation(fragment, opts.insertSpaces, opts.tabSize);\n    const formattedFragment = formatText(fragmentNorm, opts, /*isFragment*/ true);\n    if (formattedFragment === fragment) return [];\n    return [{ range: lspRange, newText: formattedFragment }];\n  }\n});\n\n// ---------------------------------------------------------------------------\n// Extra: expand selection to enclosing brackets\n// ---------------------------------------------------------------------------\n\nconnection.onRequest('vitte/expandSelectionToEnclosingBrackets', (params: ExpandSelectionParams) => {\n  const uri = params?.textDocument?.uri;\n  if (!uri) return null;\n  const doc = documents.get(uri);\n  if (!doc) return null;\n  const text = doc.getText();\n  const range = params.position ? expandSelectionToEnclosingBrackets(text, params.position) : null;\n  return range ?? null;\n});\n\n// ---------------------------------------------------------------------------\n// Basic formatter (whitespace + EOL policy) — deterministic & quick\n// ---------------------------------------------------------------------------\n\nfunction normalizeEol(text: string, eol: 'lf' | 'crlf' | 'auto'): string {\n  if (eol === 'auto') return text;\n  if (eol === 'crlf') return text.replace(/\\r\\n/g, '\\n').replace(/\\n/g, '\\r\\n');\n  return text.replace(/\\r\\n/g, '\\n');\n}\n\nfunction applyWhitespacePolicy(lines: string[], opts: { tabSize: number; insertSpaces: boolean; trimTrailingWhitespace: boolean; }): string[] {\n  const unit = opts.insertSpaces ? ' '.repeat(Math.max(1, opts.tabSize)) : '\\t';\n  return lines.map((line) => {\n    if (opts.insertSpaces) {\n      const leadingMatch = /^\\t+/.exec(line);\n      const leading = leadingMatch?.[0] ?? '';\n      if (leading.length > 0) {\n        line = leading\n          .split('')\n          .map(() => unit)\n          .join('') + line.slice(leading.length);\n      }\n    } else {\n      const re = new RegExp(`^(?: {${opts.tabSize}})+`);\n      const match = re.exec(line);\n      if (match) {\n        const spaces = match[0].length;\n        const tabs = Math.floor(spaces / opts.tabSize);\n        line = '\\t'.repeat(tabs) + line.slice(spaces);\n      }\n    }\n    if (opts.trimTrailingWhitespace) line = line.replace(/[ \\t]+$/g, '');\n    return line;\n  });\n}\n\nfunction formatText(text: string, opts: { tabSize: number; insertSpaces: boolean; trimTrailingWhitespace: boolean; insertFinalNewline: boolean; eol: 'lf'|'crlf'|'auto' }, isFragment = false): string {\n  let work = text.replace(/\\r\\n/g, '\\n');\n  let lines = work.split('\\n');\n  lines = applyWhitespacePolicy(lines, opts);\n  work = lines.join('\\n');\n  work = normalizeEol(work, opts.eol);\n  if (!isFragment && opts.insertFinalNewline) {\n    const term = opts.eol === 'crlf' ? '\\r\\n' : '\\n';\n    if (!work.endsWith(term)) work += term;\n  }\n  return work;\n}\n\n// ---------------------------------------------------------------------------\n// Start server\n// ---------------------------------------------------------------------------\n\ndocuments.listen(connection);\nconnection.listen();\nlogLsp.info('Vitte LSP: listening');\n"]}