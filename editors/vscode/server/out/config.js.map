{"version":3,"file":"config.js","sourceRoot":"","sources":["../../src/config.ts"],"names":[],"mappings":"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","sourcesContent":["\n\n/**\n * Vitte LSP — Configuration module (ultra complete)\n * -------------------------------------------------\n * Centralizes client capability detection, per-document settings cache,\n * validation/normalization of user configuration, and helpers to wire\n * configuration change events. Dependency-free and side-effect free\n * (except for functions that explicitly take a `Connection`).\n */\n\nimport type { Connection, InitializeParams } from 'vscode-languageserver';\n\n// ---------------------------------------------------------------------------\n// Types\n// ---------------------------------------------------------------------------\n\nexport type EolKind = 'lf' | 'crlf' | 'auto';\n\nexport interface FormattingSettings {\n  tabSize: number;                 // >= 1\n  insertSpaces: boolean;           // true → spaces, false → tabs\n  trimTrailingWhitespace: boolean; // trim spaces/tabs at end of line\n  insertFinalNewline: boolean;     // ensure final newline on full doc\n  eol: EolKind;                    // target EOL policy (lf/crlf/auto)\n  detectMixedIndentation?: boolean; // heuristics when both tabs/spaces appear\n}\n\nexport const defaultFormatting: FormattingSettings = {\n  tabSize: 2,\n  insertSpaces: true,\n  trimTrailingWhitespace: true,\n  insertFinalNewline: true,\n  eol: 'lf',\n  detectMixedIndentation: true,\n};\n\nexport interface ConfigState {\n  hasConfigurationCapability: boolean;\n  hasWorkspaceFolderCapability: boolean;\n}\n\n// Internal cache for per-document settings acquired via `workspace/configuration`.\nconst documentSettings = new Map<string, Thenable<FormattingSettings>>();\n\n// Global state derived from client capabilities.\nconst state: ConfigState = {\n  hasConfigurationCapability: false,\n  hasWorkspaceFolderCapability: false,\n};\n\n// ---------------------------------------------------------------------------\n// Capability detection\n// ---------------------------------------------------------------------------\n\nexport function initConfigFromInitialize(params: InitializeParams): ConfigState {\n  const capabilities = params.capabilities;\n  state.hasConfigurationCapability = Boolean(capabilities.workspace?.configuration);\n  state.hasWorkspaceFolderCapability = Boolean(capabilities.workspace?.workspaceFolders);\n  return { ...state };\n}\n\nexport function getConfigState(): ConfigState {\n  return { ...state };\n}\n\n// ---------------------------------------------------------------------------\n// Settings retrieval & cache\n// ---------------------------------------------------------------------------\n\n/**\n * Returns formatting settings for a given resource URI. If the client does not\n * support workspace configuration, returns the default settings.\n */\nexport function getFormattingSettings(connection: Connection, resourceUri: string): Thenable<FormattingSettings> {\n  if (!state.hasConfigurationCapability) {\n    return Promise.resolve(defaultFormatting);\n  }\n  let result = documentSettings.get(resourceUri);\n  if (!result) {\n    const request = connection.workspace.getConfiguration({\n      scopeUri: resourceUri,\n      section: 'vitte.formatting',\n    }) as Thenable<Partial<FormattingSettings> | null | undefined>;\n    // Wrap with validation/normalization before caching result to callers.\n    result = request.then(raw => validateAndNormalizeFormatting(raw ?? undefined));\n    documentSettings.set(resourceUri, result);\n  }\n  return result;\n}\n\n/** Clears all cached per-document settings or a single document when `uri` is provided. */\nexport function clearDocumentSettings(uri?: string): void {\n  if (uri) documentSettings.delete(uri); else documentSettings.clear();\n}\n\n// ---------------------------------------------------------------------------\n// Validation & normalization\n// ---------------------------------------------------------------------------\n\nexport function validateAndNormalizeFormatting(raw: Partial<FormattingSettings> | undefined | null): FormattingSettings {\n  const out: FormattingSettings = { ...defaultFormatting };\n  if (!raw || typeof raw !== 'object') return out;\n\n  // tabSize\n  if (typeof raw.tabSize === 'number' && Number.isFinite(raw.tabSize)) {\n    const v = Math.max(1, Math.min(16, Math.floor(raw.tabSize)));\n    out.tabSize = v;\n  }\n  // insertSpaces\n  if (typeof raw.insertSpaces === 'boolean') out.insertSpaces = raw.insertSpaces;\n  // trimTrailingWhitespace\n  if (typeof raw.trimTrailingWhitespace === 'boolean') out.trimTrailingWhitespace = raw.trimTrailingWhitespace;\n  // insertFinalNewline\n  if (typeof raw.insertFinalNewline === 'boolean') out.insertFinalNewline = raw.insertFinalNewline;\n  // eol\n  const eol = raw.eol;\n  if (eol === 'lf' || eol === 'crlf' || eol === 'auto') out.eol = eol;\n  // detectMixedIndentation\n  if (typeof raw.detectMixedIndentation === 'boolean') out.detectMixedIndentation = raw.detectMixedIndentation;\n\n  return out;\n}\n\n// ---------------------------------------------------------------------------\n// Wiring helpers for onDidChangeConfiguration\n// ---------------------------------------------------------------------------\n\n/**\n * Create a handler for `connection.onDidChangeConfiguration`.\n * You can pass an optional callback to revalidate open documents.\n */\nexport function makeOnDidChangeConfigurationHandler<TDoc = { uri: string }>(\n  connection: Connection,\n  options?: {\n    /** List of currently open documents to revalidate. */\n    getOpenDocuments?: () => Iterable<TDoc>;\n    /** Callback after cache clear to revalidate one document. */\n    validateDocument?: (doc: TDoc) => Promise<void> | void;\n  }\n) {\n  return async function onDidChangeConfiguration() {\n    clearDocumentSettings();\n    if (options?.getOpenDocuments && options?.validateDocument) {\n      for (const doc of options.getOpenDocuments()) {\n        try { await options.validateDocument(doc); } catch (e) {\n          connection.console.warn(`validateDocument error: ${String(e)}`);\n        }\n      }\n    }\n  };\n}\n\n// ---------------------------------------------------------------------------\n// Optional: JSON schema (informational only; not enforced here)\n// ---------------------------------------------------------------------------\n\n/**\n * Informational JSON schema-like description for `vitte.formatting`.\n * Can be exposed by clients or used in docs; this module does not enforce it.\n */\nexport const formattingSchema = {\n  type: 'object',\n  properties: {\n    tabSize: { type: 'integer', minimum: 1, maximum: 16, default: 2 },\n    insertSpaces: { type: 'boolean', default: true },\n    trimTrailingWhitespace: { type: 'boolean', default: true },\n    insertFinalNewline: { type: 'boolean', default: true },\n    eol: { enum: ['lf', 'crlf', 'auto'], default: 'lf' },\n    detectMixedIndentation: { type: 'boolean', default: true },\n  },\n  additionalProperties: false,\n};\n\n// ---------------------------------------------------------------------------\n// Convenience helpers for server wiring\n// ---------------------------------------------------------------------------\n\n/** Expose a small facade so `lsp.ts` can import a stable API. */\nexport const Config = {\n  state,\n  initConfigFromInitialize,\n  getConfigState,\n  getFormattingSettings,\n  clearDocumentSettings,\n  validateAndNormalizeFormatting,\n  makeOnDidChangeConfigurationHandler,\n  defaultFormatting,\n  formattingSchema,\n};\n\nexport default Config;\n"]}