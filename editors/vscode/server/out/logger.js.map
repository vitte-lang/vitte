{"version":3,"file":"logger.js","sourceRoot":"","sources":["../../src/logger.ts"],"names":[],"mappings":"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","sourcesContent":["\n/**\n * Vitte LSP — Logger (ultra complete)\n * -----------------------------------\n * Dependency‑free structured logger with:\n *  - Levels: trace/debug/info/warn/error/off\n *  - Scopes & child loggers (\"lsp\", \"features.hover\"…)\n *  - Pretty or JSON line output (env controlled)\n *  - Optional ANSI colors (auto‑disabled when not TTY or env)\n *  - In‑memory ring buffer (recent records)\n *  - Rate‑limiting / once‑only helpers\n *  - Timers & perf marks (time/timeEnd)\n *  - LSP connection sink (connection.console.X)\n */\n\nimport type { Connection } from 'vscode-languageserver';\n\n// ---------------------------------------------------------------------------\n// Levels & configuration\n// ---------------------------------------------------------------------------\n\nexport enum LogLevel {\n  TRACE = 10,\n  DEBUG = 20,\n  INFO  = 30,\n  WARN  = 40,\n  ERROR = 50,\n  OFF   = 100,\n}\n\nconst LEVEL_NAMES: Record<LogLevel, string> = {\n  [LogLevel.TRACE]: 'TRACE',\n  [LogLevel.DEBUG]: 'DEBUG',\n  [LogLevel.INFO]:  'INFO',\n  [LogLevel.WARN]:  'WARN',\n  [LogLevel.ERROR]: 'ERROR',\n  [LogLevel.OFF]:   'OFF',\n};\n\nfunction env(name: string, def?: string): string | undefined {\n  try { return process.env?.[name] ?? def; } catch { return def; }\n}\n\nconst ENV_LEVEL = env('VITTE_LOG_LEVEL');\nconst ENV_JSON  = env('VITTE_LOG_JSON');\nconst ENV_COLOR = env('VITTE_LOG_COLOR');\nfunction isWriteStream(value: unknown): value is NodeJS.WriteStream {\n  return typeof value === 'object' && value !== null && 'isTTY' in value;\n}\n\nfunction detectStderrTTY(): boolean {\n  try {\n    const stderr = process.stderr;\n    return isWriteStream(stderr) && Boolean(stderr.isTTY);\n  } catch {\n    return false;\n  }\n}\n\nconst IS_TTY = detectStderrTTY();\n\nconst NAMED_LEVELS: Record<string, LogLevel> = {\n  TRACE: LogLevel.TRACE,\n  DEBUG: LogLevel.DEBUG,\n  INFO: LogLevel.INFO,\n  WARN: LogLevel.WARN,\n  ERROR: LogLevel.ERROR,\n  OFF: LogLevel.OFF,\n};\n\nfunction parseLevel(input?: string | null): LogLevel {\n  if (!input) return LogLevel.INFO;\n  const t = String(input).trim().toUpperCase();\n  const named = NAMED_LEVELS[t];\n  if (named !== undefined) return named;\n  const numeric = Number(t);\n  return Number.isFinite(numeric) ? (numeric as LogLevel) : LogLevel.INFO;\n}\n\nlet GLOBAL_LEVEL: LogLevel = parseLevel(ENV_LEVEL);\nlet GLOBAL_JSON: boolean = ENV_JSON === '1' || ENV_JSON === 'true';\nlet GLOBAL_COLOR: boolean = ENV_COLOR === '1' || (ENV_COLOR !== '0' && IS_TTY);\n\nexport function setGlobalLogLevel(level: LogLevel) { GLOBAL_LEVEL = level; }\nexport function getGlobalLogLevel(): LogLevel { return GLOBAL_LEVEL; }\nexport function enableJson(enabled: boolean) { GLOBAL_JSON = enabled; }\nexport function enableColor(enabled: boolean) { GLOBAL_COLOR = enabled; }\n\n// ---------------------------------------------------------------------------\n// Types & ring buffer\n// ---------------------------------------------------------------------------\n\nexport interface LogRecord {\n  level: LogLevel;\n  time: number;            // epoch ms\n  scope: string;           // e.g. \"lsp\", \"features.hover\"\n  msg: string;\n  data?: unknown;          // optional structured payload\n}\n\nclass RingBuffer<T> {\n  private buf: T[];\n  private idx = 0;\n  private filled = false;\n  constructor(private capacity: number) { this.buf = new Array<T>(capacity); }\n  push(v: T) { this.buf[this.idx] = v; this.idx = (this.idx + 1) % this.capacity; if (this.idx === 0) this.filled = true; }\n  toArray(): T[] {\n    if (!this.filled) return this.buf.slice(0, this.idx);\n    return this.buf.slice(this.idx).concat(this.buf.slice(0, this.idx));\n  }\n}\n\nconst HISTORY = new RingBuffer<LogRecord>(500);\nexport function getRecentLogs(): LogRecord[] { return HISTORY.toArray(); }\n\n// ---------------------------------------------------------------------------\n// ANSI formatting (safe)\n// ---------------------------------------------------------------------------\n\nconst ANSI = {\n  reset: '\\u001b[0m',\n  dim: '\\u001b[2m',\n  gray: '\\u001b[90m',\n  red: '\\u001b[31m',\n  yellow: '\\u001b[33m',\n  blue: '\\u001b[34m',\n  magenta: '\\u001b[35m',\n};\nfunction colorize(s: string, color: keyof typeof ANSI): string {\n  if (!GLOBAL_COLOR) return s;\n  return ANSI[color] + s + ANSI.reset;\n}\n\nfunction safeStringify(v: unknown): string {\n  const seen = new WeakSet<object>();\n  const replacer = (_key: string, raw: unknown): unknown => {\n    if (raw instanceof Error) {\n      return { name: raw.name, message: raw.message, stack: raw.stack };\n    }\n    if (isObject(raw)) {\n      if (seen.has(raw)) return '[Circular]';\n      seen.add(raw);\n    }\n    return raw;\n  };\n  return JSON.stringify(v, replacer);\n}\n\nfunction isObject(value: unknown): value is object {\n  return typeof value === 'object' && value !== null;\n}\n\n// ---------------------------------------------------------------------------\n// Sinks: stderr & LSP connection\n// ---------------------------------------------------------------------------\n\nexport interface LogSink { write(rec: LogRecord): void; }\n\nclass StderrSink implements LogSink {\n  write(rec: LogRecord) {\n    HISTORY.push(rec);\n    if (GLOBAL_JSON) {\n      try { console.error(safeStringify({ ...rec, levelName: LEVEL_NAMES[rec.level] })); } catch {}\n      return;\n    }\n    const ts = new Date(rec.time).toISOString();\n    const scope = rec.scope ? `[${rec.scope}]` : '';\n    const base = `${ts} ${LEVEL_NAMES[rec.level]} ${scope} ${rec.msg}`;\n    let line = base;\n    if (rec.data !== undefined) line += ' ' + safeStringify(rec.data);\n\n    switch (rec.level) {\n      case LogLevel.ERROR: line = colorize(line, 'red'); break;\n      case LogLevel.WARN:  line = colorize(line, 'yellow'); break;\n      case LogLevel.INFO:  line = colorize(line, 'blue'); break;\n      case LogLevel.DEBUG: line = colorize(line, 'magenta'); break;\n      case LogLevel.TRACE: line = colorize(line, 'gray'); break;\n    }\n    try { console.error(line); } catch {}\n  }\n}\n\nclass ConnectionSink implements LogSink {\n  constructor(private conn: Connection) {}\n  write(rec: LogRecord) {\n    HISTORY.push(rec);\n    const text = GLOBAL_JSON\n      ? safeStringify({ ...rec, levelName: LEVEL_NAMES[rec.level] })\n      : `${new Date(rec.time).toISOString()} ${LEVEL_NAMES[rec.level]} [${rec.scope}] ${rec.msg}` + (rec.data !== undefined ? ' ' + safeStringify(rec.data) : '');\n    try {\n      if (rec.level >= LogLevel.ERROR) this.conn.console.error(text);\n      else if (rec.level >= LogLevel.WARN) this.conn.console.warn(text);\n      else this.conn.console.info(text);\n    } catch {}\n  }\n}\n\nlet SINK: LogSink = new StderrSink();\nexport function attachConnection(connection: Connection) { SINK = new ConnectionSink(connection); }\nexport function detachConnection() { SINK = new StderrSink(); }\n\n// ---------------------------------------------------------------------------\n// Logger with scopes, timers, rate limiting, once, children\n// ---------------------------------------------------------------------------\n\nexport class Logger {\n  private onceKeys = new Set<string>();\n  private rateMap = new Map<string, number>();\n  private timers = new Map<string, number>();\n  constructor(private scope: string) {}\n\n  child(sub: string): Logger { return new Logger(this.scope ? `${this.scope}.${sub}` : sub); }\n\n  private emit(level: LogLevel, msg: string, data?: unknown) {\n    if (level < GLOBAL_LEVEL) return;\n    const rec: LogRecord = { level, time: Date.now(), scope: this.scope, msg, data };\n    SINK.write(rec);\n  }\n\n  trace(msg: string, data?: unknown) { this.emit(LogLevel.TRACE, msg, data); }\n  debug(msg: string, data?: unknown) { this.emit(LogLevel.DEBUG, msg, data); }\n  info(msg: string, data?: unknown)  { this.emit(LogLevel.INFO,  msg, data); }\n  warn(msg: string, data?: unknown)  { this.emit(LogLevel.WARN,  msg, data); }\n  error(msg: string, data?: unknown) { this.emit(LogLevel.ERROR, msg, data); }\n\n  once(key: string, level: LogLevel, msg: string, data?: unknown) {\n    if (this.onceKeys.has(key)) return; this.onceKeys.add(key); this.emit(level, msg, data);\n  }\n\n  rateLimited(token: string, intervalMs: number, level: LogLevel, msg: string, data?: unknown) {\n    const now = Date.now();\n    const last = this.rateMap.get(token) ?? 0;\n    if (now - last < intervalMs) return;\n    this.rateMap.set(token, now);\n    this.emit(level, msg, data);\n  }\n\n  time(label: string, level: LogLevel = LogLevel.DEBUG) {\n    const start = Date.now();\n    this.timers.set(label, start);\n    return (extra?: unknown) => {\n      const t0 = this.timers.get(label) ?? start;\n      const dt = Date.now() - t0;\n      this.emit(level, `${label} ${dt}ms`, extra);\n      this.timers.delete(label);\n      return dt;\n    };\n  }\n\n  async timeAsync<T>(label: string, fn: () => Promise<T>, level: LogLevel = LogLevel.DEBUG): Promise<T> {\n    const stop = this.time(label, level);\n    try { const r = await fn(); stop(); return r; } catch (e) { stop({ error: String(e) }); throw e; }\n  }\n}\n\nconst ROOT = new Logger('');\nexport function getLogger(scope: string): Logger { return ROOT.child(scope); }\n\nexport const logLsp = getLogger('lsp');\nexport const logServer = getLogger('server');\nexport const logFeatures = getLogger('features');\n\nlogServer.once('boot', LogLevel.INFO, 'Logger initialized', { level: LEVEL_NAMES[getGlobalLogLevel()], json: GLOBAL_JSON, color: GLOBAL_COLOR });\n"]}