{"version":3,"file":"playgroundPanel.js","sourceRoot":"","sources":["../../src/providers/playgroundPanel.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from 'vscode';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport * as cp from 'child_process';\nimport { locateVitteRuntime } from '../debug/runtimeLocator';\n\n/**\n * Vitte Playground Panel\n * - Local, offline: edit a Vitte snippet, format it, run it via vitte-runtime.\n * - Stores temp files under ${workspace}/.vitte/playground/\n */\nexport function registerPlaygroundPanel(ctx: vscode.ExtensionContext) {\n  ctx.subscriptions.push(\n    vscode.commands.registerCommand('vitte.openPlayground', () => PlaygroundPanel.createOrShow(ctx))\n  );\n}\n\nexport class PlaygroundPanel implements vscode.Disposable {\n  private static current: PlaygroundPanel | undefined;\n  private readonly panel: vscode.WebviewPanel;\n  private readonly disposables: vscode.Disposable[] = [];\n  private terminal: vscode.Terminal | undefined;\n  private lastFile: string | undefined;\n\n  static createOrShow(ctx: vscode.ExtensionContext) {\n    const column = vscode.window.activeTextEditor?.viewColumn ?? vscode.ViewColumn.Two;\n    if (PlaygroundPanel.current) {\n      PlaygroundPanel.current.panel.reveal(column);\n      return;\n    }\n    const panel = vscode.window.createWebviewPanel(\n      'vittePlayground',\n      'Vitte • Playground',\n      column,\n      {\n        enableScripts: true,\n        retainContextWhenHidden: true,\n        enableFindWidget: true,\n      }\n    );\n    PlaygroundPanel.current = new PlaygroundPanel(ctx, panel);\n  }\n\n  private constructor(private readonly ctx: vscode.ExtensionContext, panel: vscode.WebviewPanel) {\n    this.panel = panel;\n    this.panel.onDidDispose(() => this.dispose(), null, this.disposables);\n    this.panel.webview.onDidReceiveMessage((m) => this.onMessage(m), null, this.disposables);\n    void this.render();\n  }\n\n  dispose(): void {\n    PlaygroundPanel.current = undefined;\n    try { this.terminal?.dispose(); } catch {}\n    while (this.disposables.length) this.disposables.pop()?.dispose();\n  }\n\n  // ---- Messaging ----\n  private async onMessage(msg: unknown) {\n    if (!msg || typeof msg !== 'object') return;\n    const m = msg as Partial<{ type: string; text: unknown; save: unknown }>;\n    switch (m.type) {\n      case 'format': {\n        const text = typeof m.text === 'string' ? m.text : '';\n        const formatted = await this.formatCode(text);\n        this.post({ type: 'formatted', text: formatted ?? text });\n        return;\n      }\n      case 'run': {\n        const text = typeof m.text === 'string' ? m.text : '';\n        const save = Boolean(m.save);\n        await this.runSnippet(text, save);\n        return;\n      }\n      case 'save': {\n        const text = typeof m.text === 'string' ? m.text : '';\n        const file = await this.saveSnippet(text);\n        this.post({ type: 'saved', file });\n        return;\n      }\n      case 'openFolder': {\n        const folder = await this.ensurePlaygroundDir();\n        if (folder) void vscode.commands.executeCommand('revealFileInOS', vscode.Uri.file(folder));\n        return;\n      }\n      default:\n        return;\n    }\n  }\n\n  private post(payload: unknown) {\n    void this.panel.webview.postMessage(payload);\n  }\n\n  // ---- Tooling helpers ----\n  private async getTooling(): Promise<{ runtime: string; fmt?: string }> {\n    const located = await locateVitteRuntime();\n    const runtime = located.runtimePath ?? 'vitte-runtime';\n    const out: { runtime: string; fmt?: string } = { runtime };\n    if (typeof located.fmtPath === 'string') out.fmt = located.fmtPath;\n    return out;\n  }\n\n  private async ensurePlaygroundDir(): Promise<string | undefined> {\n    const wf = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;\n    if (!wf) return undefined;\n    const dir = path.join(wf, '.vitte', 'playground');\n    try { await fs.promises.mkdir(dir, { recursive: true }); } catch { /* ignore */ }\n    return dir;\n  }\n\n  private async saveSnippet(text: string): Promise<string | undefined> {\n    const dir = await this.ensurePlaygroundDir();\n    if (!dir) return undefined;\n    const file = path.join(dir, 'main.vitte');\n    await fs.promises.writeFile(file, text, 'utf8');\n    this.lastFile = file;\n    return file;\n  }\n\n  private async formatCode(text: string): Promise<string | undefined> {\n    try {\n      const { fmt } = await this.getTooling();\n      if (!fmt) return undefined;\n      return await new Promise<string>((resolve, reject) => {\n        const p = cp.spawn(fmt, [], { stdio: ['pipe', 'pipe', 'pipe'] });\n        let out = '';\n        let err = '';\n        p.stdout.on('data', (b: Buffer) => { out += b.toString(); });\n        p.stderr.on('data', (b: Buffer) => { err += b.toString(); });\n        p.on('error', reject);\n        p.on('close', (code) => {\n          if (code === 0) resolve(out);\n          else reject(new Error(err || `vitte-fmt exited with ${code}`));\n        });\n        if (p.stdin) {\n          p.stdin.write(text);\n          p.stdin.end();\n        } else {\n          reject(new Error('vitte-fmt stdin unavailable'));\n        }\n      });\n    } catch (e) {\n      const message = e instanceof Error ? e.message : String(e);\n      void vscode.window.showWarningMessage(`Format: ${message}`);\n      return undefined;\n    }\n  }\n\n  private async runSnippet(text: string, saveFirst: boolean) {\n    const file = saveFirst ? (await this.saveSnippet(text)) : (this.lastFile ?? await this.saveSnippet(text));\n    if (!file) {\n      void vscode.window.showErrorMessage('Playground: impossible d’écrire le fichier.');\n      return;\n    }\n\n    const { runtime } = await this.getTooling();\n    const wf = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath ?? path.dirname(file);\n    const cmd = `${runtime} run ${quote(file)}`;\n\n    // Ensure terminal\n    this.terminal ??= vscode.window.createTerminal({ name: 'Vitte Playground', cwd: wf });\n    this.terminal.show(true);\n    this.terminal.sendText(cmd, true);\n  }\n\n  // ---- Render ----\n  private render() {\n    const webview = this.panel.webview;\n    const nonce = String(Date.now());\n    const csp = `default-src 'none'; style-src 'unsafe-inline' ${webview.cspSource}; script-src 'nonce-${nonce}';`;\n    const initial = `// Éditez votre code Vitte ici\\nfn main() {\\n    println(\"Hello from Playground!\");\\n}`;\n\n    this.panel.webview.html = `<!DOCTYPE html>\n      <html lang=\"fr\">\n      <head>\n        <meta charset=\"UTF-8\" />\n        <meta http-equiv=\"Content-Security-Policy\" content=\"${csp}\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n        <title>Vitte • Playground</title>\n        <style>\n          :root { --pad: 12px; }\n          body { font: 13px/1.5 -apple-system, Segoe UI, system-ui, sans-serif; padding: 0; margin: 0; }\n          header { position: sticky; top: 0; backdrop-filter: blur(8px); background: var(--vscode-editor-background); border-bottom: 1px solid var(--vscode-panel-border); padding: 10px var(--pad); display:flex; gap:10px; align-items:center; }\n          .btn { padding:6px 10px; border-radius:6px; border:1px solid var(--vscode-button-border, transparent); background: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); cursor:pointer; }\n          .btn.primary { background: var(--vscode-button-background); color: var(--vscode-button-foreground); }\n          textarea { width: 100%; height: calc(100vh - 120px); box-sizing: border-box; padding: var(--pad); border: none; outline: none; resize: none; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", monospace; font-size: 12.5px; background: var(--vscode-editor-background); color: var(--vscode-editor-foreground); }\n          footer { padding: 8px var(--pad); color: var(--vscode-descriptionForeground); display: flex; justify-content: space-between; align-items:center; }\n        </style>\n      </head>\n      <body>\n        <header>\n          <button id=\"format\" class=\"btn\">Formater</button>\n          <button id=\"run\" class=\"btn primary\">Exécuter ▶</button>\n          <button id=\"save\" class=\"btn\">Enregistrer</button>\n          <button id=\"open\" class=\"btn\">Ouvrir le dossier</button>\n          <span id=\"status\"></span>\n        </header>\n        <textarea id=\"code\" spellcheck=\"false\">${escapeHtml(initial)}</textarea>\n        <footer>\n          <span>Les sorties d’exécution s’affichent dans le terminal intégré “Vitte Playground”.</span>\n          <span id=\"info\"></span>\n        </footer>\n        <script nonce=\"${nonce}\">\n          const vscodeApi = acquireVsCodeApi();\n          const $ = (sel) => document.querySelector(sel);\n          const code = $('#code');\n          const status = $('#status');\n          const info = $('#info');\n\n          function post(type, payload) { vscodeApi.postMessage({ type, ...payload }); }\n\n          $('#format').addEventListener('click', () => { status.textContent = 'Formatage…'; post('format', { text: code.value }); });\n          $('#run').addEventListener('click', () => { status.textContent = 'Exécution…'; post('run', { text: code.value, save: true }); });\n          $('#save').addEventListener('click', () => { post('save', { text: code.value }); });\n          $('#open').addEventListener('click', () => { post('openFolder', {}); });\n\n          window.addEventListener('message', (e) => {\n            const m = e.data || {};\n            if (m.type === 'formatted') {\n              code.value = m.text || code.value;\n              status.textContent = 'Formatté.';\n              setTimeout(() => status.textContent = '', 800);\n            }\n            if (m.type === 'saved') {\n              info.textContent = m.file ? 'Enregistré: ' + m.file : '';\n              status.textContent = m.file ? 'Enregistré.' : 'Erreur sauvegarde';\n              setTimeout(() => status.textContent = '', 1000);\n            }\n          });\n        </script>\n      </body>\n      </html>`;\n  }\n}\n\nexport default PlaygroundPanel;\n\nconst HTML_ESCAPE: Record<string, string> = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  '\\'': '&#39;',\n};\n\nfunction escapeHtml(s: string): string {\n  return s.replace(/[&<>\"']/g, (c) => HTML_ESCAPE[c] ?? c);\n}\n\nfunction quote(p: string): string {\n  if (process.platform === 'win32') return `\"${p.replace(/\"/g, '\\\\\"')}\"`;\n  return `'${p.replace(/'/g, `'\\\\''`)}'`;\n}\n"]}