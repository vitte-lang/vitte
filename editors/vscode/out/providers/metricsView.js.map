{"version":3,"file":"metricsView.js","sourceRoot":"","sources":["../../src/providers/metricsView.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from \"vscode\";\nimport type { LanguageClient } from \"vscode-languageclient/node\";\nimport type { ServerMetricEntry } from \"../types/metrics\";\n\ntype MetricTreeNode = ServerMetricEntry | PlaceholderNode;\n\ninterface PlaceholderNode {\n  placeholder: true;\n  message: string;\n  command?: vscode.Command;\n  icon?: vscode.ThemeIcon;\n  context?: string;\n  description?: string;\n}\n\nclass VitteMetricsProvider implements vscode.TreeDataProvider<MetricTreeNode>, vscode.Disposable {\n  private readonly _onDidChangeTreeData = new vscode.EventEmitter<MetricTreeNode | void>();\n  readonly onDidChangeTreeData = this._onDidChangeTreeData.event;\n\n  private metrics: ServerMetricEntry[] = [];\n  private lastError: string | undefined;\n  private hasClient = false;\n  private interval: NodeJS.Timeout | undefined;\n\n  constructor(private readonly getClient: () => LanguageClient | undefined) {}\n\n  dispose(): void {\n    if (this.interval) {\n      clearInterval(this.interval);\n      this.interval = undefined;\n    }\n  }\n\n  start(): void {\n    void this.refresh();\n    this.interval = setInterval(() => { void this.refresh(); }, 5000);\n  }\n\n  async refresh(): Promise<void> {\n    try {\n      const client = this.getClient();\n      if (!client) {\n        this.hasClient = false;\n        this.metrics = [];\n        this.lastError = undefined;\n      } else {\n        this.hasClient = true;\n        this.metrics = await client.sendRequest<ServerMetricEntry[]>(\"vitte/metrics\");\n        this.lastError = undefined;\n      }\n    } catch {\n      this.metrics = [];\n      this.lastError = \"Unable to fetch metrics from the server.\";\n    }\n    this._onDidChangeTreeData.fire();\n  }\n\n  getTreeItem(element: MetricTreeNode): vscode.TreeItem {\n    if (isPlaceholder(element)) {\n      const item = new vscode.TreeItem(element.message, vscode.TreeItemCollapsibleState.None);\n      item.iconPath = element.icon ?? new vscode.ThemeIcon(\"info\");\n      item.contextValue = element.context ?? \"placeholder\";\n      if (element.command) {\n        item.command = element.command;\n      }\n      if (element.description) {\n        item.description = element.description;\n      }\n      return item;\n    }\n    const avg = element.averageMs.toFixed(2);\n    const last = element.lastMs.toFixed(2);\n    const max = element.maxMs.toFixed(2);\n    const p99 = typeof element.p99Ms === \"number\" ? element.p99Ms.toFixed(2) : undefined;\n    const item = new vscode.TreeItem(`${element.name}`, vscode.TreeItemCollapsibleState.None);\n    const errCount = typeof element.errorCount === \"number\" ? element.errorCount : 0;\n    item.description = `${avg} ms avg (${element.count}×)${errCount ? `, ${errCount} errors` : \"\"}`;\n    const when = element.lastAt ? new Date(element.lastAt).toLocaleTimeString() : \"—\";\n    const countInfo = typeof element.lastCount === \"number\" ? `last n=${element.lastCount}` : \"\";\n    item.tooltip = [\n      `Average: ${avg} ms`,\n      p99 ? `P99: ${p99} ms` : undefined,\n      `Last: ${last} ms`,\n      `Max: ${max} ms`,\n      `Calls: ${element.count}`,\n      errCount ? `Errors: ${errCount}` : undefined,\n      element.lastError ? `Last error: ${element.lastError}` : undefined,\n      `Last URI: ${element.lastUri || \"n/a\"}`,\n      `Last at: ${when} ${countInfo}`.trim(),\n    ].filter(Boolean).join(\"\\n\");\n    item.contextValue = \"metricEntry\";\n    return item;\n  }\n\n  getChildren(): MetricTreeNode[] | Thenable<MetricTreeNode[]> {\n    if (this.metrics.length === 0) {\n      return this.getEmptyStateNodes();\n    }\n    return this.getMetricsNodes();\n  }\n\n  private getEmptyStateNodes(): MetricTreeNode[] {\n    const nodes: MetricTreeNode[] = [];\n\n    if (!this.hasClient) {\n      nodes.push({\n        placeholder: true,\n        message: \"Vitte server not running.\",\n        icon: new vscode.ThemeIcon(\"debug-stop\"),\n        command: { command: \"vitte.restartServer\", title: \"Start Vitte server\" },\n        context: \"placeholder.server\",\n      });\n    } else if (this.lastError) {\n      nodes.push({\n        placeholder: true,\n        message: this.lastError,\n        icon: new vscode.ThemeIcon(\"error\"),\n        command: { command: \"vitte.showServerLog\", title: \"Open server log\" },\n        context: \"placeholder.error\",\n      });\n    } else {\n      nodes.push({\n        placeholder: true,\n        message: \"No metrics captured yet.\",\n        icon: new vscode.ThemeIcon(\"info\"),\n        context: \"placeholder.empty\",\n      });\n    }\n\n    nodes.push({\n      placeholder: true,\n      message: \"Open a .vitte or .vit file and trigger completions/hover to record metrics.\",\n      icon: new vscode.ThemeIcon(\"file-code\"),\n      context: \"placeholder.hint\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Refresh metrics\",\n      icon: new vscode.ThemeIcon(\"refresh\"),\n      command: { command: \"vitte.metrics.refresh\", title: \"Refresh metrics\" },\n      context: \"placeholder.refresh\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Show metrics snapshot in the Output panel\",\n      icon: new vscode.ThemeIcon(\"output\"),\n      command: { command: \"vitte.showServerMetrics\", title: \"Show server metrics\" },\n      context: \"placeholder.snapshot\",\n    });\n\n    return nodes;\n  }\n\n  private getMetricsNodes(): MetricTreeNode[] {\n    const nodes: MetricTreeNode[] = [];\n    const totalCalls = this.metrics.reduce((sum, entry) => sum + entry.count, 0);\n    const weightedAvg = totalCalls > 0\n      ? this.metrics.reduce((sum, entry) => sum + entry.averageMs * entry.count, 0) / totalCalls\n      : 0;\n    const first = this.metrics[0];\n    if (!first) return nodes;\n    const slowestAvg = this.metrics.reduce((best, entry) => (entry.averageMs > best.averageMs ? entry : best), first);\n    const highestMax = this.metrics.reduce((best, entry) => (entry.maxMs > best.maxMs ? entry : best), first);\n    const lastSeen = this.metrics.reduce((best, entry) => (entry.lastAt > best.lastAt ? entry : best), first);\n\n    nodes.push({\n      placeholder: true,\n      message: \"Summary\",\n      icon: new vscode.ThemeIcon(\"dashboard\"),\n      context: \"summary.header\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Total metrics\",\n      description: `${this.metrics.length}`,\n      icon: new vscode.ThemeIcon(\"symbol-number\"),\n      context: \"summary.total\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Total calls\",\n      description: `${totalCalls}`,\n      icon: new vscode.ThemeIcon(\"symbol-event\"),\n      context: \"summary.calls\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Weighted avg\",\n      description: `${weightedAvg.toFixed(2)} ms`,\n      icon: new vscode.ThemeIcon(\"clock\"),\n      context: \"summary.avg\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Slowest avg\",\n      description: `${slowestAvg.name} (${slowestAvg.averageMs.toFixed(2)} ms)`,\n      icon: new vscode.ThemeIcon(\"warning\"),\n      context: \"summary.slowest\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Highest max\",\n      description: `${highestMax.name} (${highestMax.maxMs.toFixed(2)} ms)`,\n      icon: new vscode.ThemeIcon(\"graph\"),\n      context: \"summary.max\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Last activity\",\n      description: `${lastSeen.name} (${new Date(lastSeen.lastAt).toLocaleTimeString()})`,\n      icon: new vscode.ThemeIcon(\"history\"),\n      context: \"summary.last\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Refresh metrics\",\n      icon: new vscode.ThemeIcon(\"refresh\"),\n      command: { command: \"vitte.metrics.refresh\", title: \"Refresh metrics\" },\n      context: \"summary.refresh\",\n    });\n    nodes.push({\n      placeholder: true,\n      message: \"Reset metrics\",\n      icon: new vscode.ThemeIcon(\"trash\"),\n      command: { command: \"vitte.metrics.reset\", title: \"Reset metrics\" },\n      context: \"summary.reset\",\n    });\n\n    const sorted = [...this.metrics].sort((a, b) => b.averageMs - a.averageMs);\n    return [...nodes, ...sorted];\n  }\n}\n\nfunction isPlaceholder(node: MetricTreeNode): node is PlaceholderNode {\n  return (node as PlaceholderNode).placeholder === true;\n}\n\nexport function registerMetricsView(context: vscode.ExtensionContext, getClient: () => LanguageClient | undefined): void {\n  const provider = new VitteMetricsProvider(getClient);\n  const treeView = vscode.window.createTreeView(\"vitteMetrics\", { treeDataProvider: provider });\n  context.subscriptions.push(treeView);\n  context.subscriptions.push(provider);\n  context.subscriptions.push(vscode.commands.registerCommand(\"vitte.metrics.refresh\", () => provider.refresh()));\n  provider.start();\n}\n"]}