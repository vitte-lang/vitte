{"version":3,"file":"buildTasks.js","sourceRoot":"","sources":["../../src/tasks/buildTasks.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from 'vscode';\nimport * as cp from 'child_process';\nimport { locateVitteRuntime } from '../debug/runtimeLocator';\n\n/**\n * Build / Run / Test tasks & commands for Vitte\n *\n * Commands:\n *  - vitte.build           → builds the workspace\n *  - vitte.clean           → cleans build artifacts\n *  - vitte.run             → runs the project (or current file)\n *  - vitte.test            → runs all tests discovered by the toolchain\n *  - vitte.testCurrent     → runs tests for the current file if applicable\n *  - vitte.switchProfile   → cycles dev → test → release → bench\n *  - vitte.toggleIncremental → toggles incremental build\n *\n * Task provider:\n *  - type: 'vitte' with command: 'build' | 'clean' | 'run' | 'test'\n */\nexport function registerBuildTasks(ctx: vscode.ExtensionContext) {\n  // Commands\n  ctx.subscriptions.push(\n    vscode.commands.registerCommand('vitte.build', async () => { await runBuild('build'); }),\n    vscode.commands.registerCommand('vitte.clean', async () => { await runBuild('clean'); }),\n    vscode.commands.registerCommand('vitte.run', async () => { await runBuild('run'); }),\n    vscode.commands.registerCommand('vitte.test', async () => { await runBuild('test'); }),\n    vscode.commands.registerCommand('vitte.testCurrent', async () => { await runTestCurrentFile(); }),\n    vscode.commands.registerCommand('vitte.switchProfile', async () => { await cycleProfile(); }),\n    vscode.commands.registerCommand('vitte.toggleIncremental', async () => { await toggleIncremental(); }),\n  );\n\n  const provider = {\n    provideTasks: async (_token?: vscode.CancellationToken): Promise<vscode.Task[]> => {\n      const defs: { cmd: SubCmd; label: string }[] = [\n        { cmd: 'build', label: 'Vitte Build' },\n        { cmd: 'run',   label: 'Vitte Run' },\n        { cmd: 'test',  label: 'Vitte Test' },\n        { cmd: 'clean', label: 'Vitte Clean' },\n      ];\n      return Promise.all(defs.map(async ({ cmd, label }) => {\n        const exec = new vscode.ShellExecution(await buildCommandLine(cmd));\n        const definition: VitteTaskDefinition = { type: 'vitte', command: cmd };\n        return new vscode.Task(definition, vscode.TaskScope.Workspace, label, 'vitte', exec);\n      }));\n    },\n    resolveTask: (task: vscode.Task) => task,\n  } as unknown as vscode.TaskProvider;\n  ctx.subscriptions.push(vscode.tasks.registerTaskProvider('vitte', provider));\n}\n\n// ---- Types & helpers ----\n\ntype SubCmd = 'build' | 'clean' | 'run' | 'test';\n\ninterface VitteBuildConfig {\n  build?: {\n    profile?: string;\n    distributed?: boolean;\n    incremental?: boolean;\n  };\n  targets?: (string | { triple?: string })[];\n}\n\ninterface VitteTaskDefinition extends vscode.TaskDefinition {\n  type: 'vitte';\n  command: SubCmd;\n}\n\nasync function readProjectConfig(): Promise<VitteBuildConfig | undefined> {\n  try {\n    const files = await vscode.workspace.findFiles('vitte.config.json', '**/node_modules/**', 1);\n    const first = files[0];\n    if (!first) return undefined;\n    const doc = await vscode.workspace.openTextDocument(first);\n    return JSON.parse(doc.getText()) as VitteBuildConfig;\n  } catch {\n    return undefined;\n  }\n}\n\nasync function buildBin(): Promise<string> {\n  const located = await locateVitteRuntime();\n  return located.buildPath ?? 'vitte-build';\n}\n\nasync function buildArgs(sub: SubCmd, extra?: { currentFile?: string }): Promise<string[]> {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  const project = await readProjectConfig();\n\n  const profile = project?.build?.profile ?? cfg.get<string>('build.profile') ?? 'dev';\n  const distributed = (project?.build?.distributed ?? cfg.get<boolean>('build.distributed')) ?? false;\n  const incremental = (project?.build?.incremental ?? cfg.get<boolean>('build.incremental')) ?? false;\n  const targets = collectTargets(project);\n\n  const args: string[] = [sub, '--profile', profile];\n  if (distributed) args.push('--distributed');\n  if (incremental) args.push('--incremental');\n  for (const t of targets) args.push('--target', t);\n\n  if (sub === 'run') {\n    // allow running current file with runtime directly if build tool supports pass-through\n    if (extra?.currentFile) args.push('--file', extra.currentFile);\n  }\n\n  return args;\n}\n\nfunction collectTargets(project?: VitteBuildConfig): string[] {\n  const t = project?.targets;\n  const out: string[] = [];\n  if (Array.isArray(t)) {\n    for (const x of t) {\n      if (typeof x === 'string') out.push(x);\n      else if (x && typeof x === 'object') {\n        const triple = (x as { triple?: unknown }).triple;\n        if (typeof triple === 'string') out.push(triple);\n      }\n    }\n  }\n  return out;\n}\n\nasync function buildCommandLine(sub: SubCmd, extra?: { currentFile?: string }): Promise<string> {\n  const bin = await buildBin();\n  const args = await buildArgs(sub, extra);\n  return [quote(bin), ...args.map(quote)].join(' ');\n}\n\nasync function runBuild(sub: SubCmd) {\n  const root = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;\n  if (!root) {\n    void vscode.window.showErrorMessage('Vitte: aucun workspace ouvert.');\n    return;\n  }\n\n  // run current file for run/test if applicable\n  let cmdLine: string;\n  if (sub === 'run') {\n    const current = vscode.window.activeTextEditor?.document.uri.fsPath;\n    const isVitte = !!(current && /\\.(vitte|vit)$/i.test(current));\n    const extra = isVitte && current ? { currentFile: current } : undefined;\n    cmdLine = await buildCommandLine('run', extra);\n  } else if (sub === 'test') {\n    cmdLine = await buildCommandLine('test');\n  } else if (sub === 'clean') {\n    cmdLine = await buildCommandLine('clean');\n  } else {\n    cmdLine = await buildCommandLine('build');\n  }\n\n  const chan = vscode.window.createOutputChannel('Vitte Build');\n  await vscode.window.withProgress({\n    location: vscode.ProgressLocation.Notification,\n    title: `Vitte: ${sub}…`,\n    cancellable: false,\n  }, async () => {\n    chan.clear();\n    chan.show(true);\n    chan.appendLine(`[cmd] ${cmdLine}`);\n    await new Promise<void>((resolve) => {\n      const proc = cp.spawn(cmdLine, { cwd: root, shell: true, env: process.env });\n      proc.stdout?.on('data', (b: Buffer) => chan.append(b.toString()));\n      proc.stderr?.on('data', (b: Buffer) => chan.append(b.toString()));\n      proc.on('error', (e) => { chan.appendLine(`\\n[error] ${e.message}`); resolve(); });\n      proc.on('close', (code) => { chan.appendLine(`\\n[exit] code=${code}`); resolve(); });\n    });\n  });\n}\n\nasync function runTestCurrentFile() {\n  const file = vscode.window.activeTextEditor?.document.uri.fsPath;\n  if (!file) { void vscode.window.showInformationMessage('Aucun fichier actif.'); return; }\n  const isTest = /(_test\\.vitte|\\.(vitte|vit))$/i.test(file); // permissive\n  if (!isTest) { void vscode.window.showInformationMessage('Le fichier actif ne semble pas être un test.'); return; }\n  await runBuild('test');\n}\n\nasync function cycleProfile() {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  const current = (cfg.get<string>('build.profile') ?? 'dev').toLowerCase();\n  const order = ['dev', 'test', 'release', 'bench'];\n  const idx = order.indexOf(current);\n  const next = order[(idx + 1) % order.length];\n  await cfg.update('build.profile', next, vscode.ConfigurationTarget.Workspace);\n  void vscode.window.showInformationMessage(`Vitte: profil → ${next}`);\n}\n\nasync function toggleIncremental() {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  const cur = Boolean(cfg.get<boolean>('build.incremental'));\n  await cfg.update('build.incremental', !cur, vscode.ConfigurationTarget.Workspace);\n  void vscode.window.showInformationMessage(`Vitte: incremental → ${!cur ? 'ON' : 'OFF'}`);\n}\n\nfunction quote(s: string): string {\n  if (process.platform === 'win32') return `\"${s.replace(/\"/g, '\\\\\"')}\"`;\n  return `'${s.replace(/'/g, `\\'`)}'`;\n}\n"]}