{"version":3,"file":"benchTasks.js","sourceRoot":"","sources":["../../src/tasks/benchTasks.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from 'vscode';\nimport * as cp from 'child_process';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { locateVitteRuntime } from '../debug/runtimeLocator';\n\n/**\n * Bench tasks & commands for Vitte\n *\n * Commands:\n *  - vitte.bench: Run benchmarks for the current workspace (profile/targets from settings or vitte.config.json)\n *  - vitte.benchReport: Run + open the latest HTML/SVG report if produced\n *  - vitte.openBenchDir: Reveal the bench report directory\n *\n * Task provider:\n *  - type: 'vitte' with command: 'bench' to integrate with VS Code Tasks\n */\nexport function registerBenchTasks(ctx: vscode.ExtensionContext) {\n  // Commands\n  ctx.subscriptions.push(\n    vscode.commands.registerCommand('vitte.bench', async () => {\n      await runBench(false);\n    }),\n    vscode.commands.registerCommand('vitte.benchReport', async () => {\n      await runBench(true);\n    }),\n    vscode.commands.registerCommand('vitte.openBenchDir', async () => {\n      const dir = await benchReportDir();\n      if (dir) void vscode.commands.executeCommand('revealFileInOS', vscode.Uri.file(dir));\n    }),\n  );\n\n  const provider = {\n    provideTasks: async (_token?: vscode.CancellationToken): Promise<vscode.Task[]> => {\n      const cmd = await benchCommandLine();\n      const definition: VitteBenchTaskDefinition = { type: 'vitte', command: 'bench' };\n      const task = new vscode.Task(\n        definition,\n        vscode.TaskScope.Workspace,\n        'Vitte Bench',\n        'vitte',\n        new vscode.ShellExecution(cmd)\n      );\n      return [task];\n    },\n    resolveTask: (task: vscode.Task) => task,\n  } as unknown as vscode.TaskProvider;\n  ctx.subscriptions.push(vscode.tasks.registerTaskProvider('vitte', provider));\n}\n\ninterface VitteConfig {\n  build?: {\n    profile?: string;\n    distributed?: boolean;\n    incremental?: boolean;\n  };\n  bench?: {\n    reportDir?: string;\n    export?: unknown;\n    regressionThreshold?: number;\n  };\n}\n\ninterface VitteBenchTaskDefinition extends vscode.TaskDefinition {\n  type: 'vitte';\n  command: 'bench';\n}\n\n// ---- Helpers ----\nasync function benchBin(): Promise<string> {\n  const located = await locateVitteRuntime();\n  return located.benchPath ?? 'vitte-bench';\n}\n\nasync function readProjectConfig(): Promise<VitteConfig | undefined> {\n  try {\n    const files = await vscode.workspace.findFiles('vitte.config.json', '**/node_modules/**', 1);\n    const uri = files[0];\n    if (!uri) return undefined;\n    const doc = await vscode.workspace.openTextDocument(uri);\n    return JSON.parse(doc.getText()) as VitteConfig;\n  } catch {\n    return undefined;\n  }\n}\n\nasync function benchReportDir(): Promise<string | undefined> {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  const project = await readProjectConfig();\n  const root = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;\n  if (!root) return undefined;\n  const reportDir = (project?.bench?.reportDir ?? cfg.get<string>('bench.reportDir')) ?? '.vitte/bench';\n  return path.isAbsolute(reportDir) ? reportDir : path.join(root, reportDir);\n}\n\nasync function benchArgs(): Promise<string[]> {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  const project = await readProjectConfig();\n\n  const profile = project?.build?.profile ?? cfg.get<string>('build.profile') ?? 'bench';\n  const distributed = (project?.build?.distributed ?? cfg.get<boolean>('build.distributed')) ?? false;\n  const incremental = (project?.build?.incremental ?? cfg.get<boolean>('build.incremental')) ?? false;\n  const reportDir = await benchReportDir();\n\n  const args: string[] = ['--profile', profile];\n  if (distributed) args.push('--distributed');\n  if (incremental) args.push('--incremental');\n  if (reportDir) args.push('--out', reportDir);\n\n  // Export formats from config\n  const exportKinds = project?.bench?.export;\n  if (Array.isArray(exportKinds)) {\n    for (const kind of exportKinds) {\n      if (typeof kind === 'string') {\n        args.push('--export', kind);\n      }\n    }\n  }\n\n  // Regression threshold\n  if (typeof project?.bench?.regressionThreshold === 'number') {\n    args.push('--threshold', String(project.bench.regressionThreshold));\n  }\n\n  return args;\n}\n\nasync function benchCommandLine(): Promise<string> {\n  const bin = await benchBin();\n  const args = await benchArgs();\n  const cmd = [quote(bin), ...args.map(quote)].join(' ');\n  return cmd;\n}\n\nasync function runBench(openAfter: boolean) {\n  const root = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;\n  if (!root) {\n    void vscode.window.showErrorMessage('Vitte: aucun workspace ouvert.');\n    return;\n  }\n\n  const cmd = await benchCommandLine();\n  const outChan = vscode.window.createOutputChannel('Vitte Bench');\n\n  await vscode.window.withProgress({\n    location: vscode.ProgressLocation.Notification,\n    title: 'Vitte: Benchmarks en cours…',\n    cancellable: false,\n  }, async () => {\n    outChan.clear();\n    outChan.show(true);\n    outChan.appendLine(`[cmd] ${cmd}`);\n\n    await new Promise<void>((resolve) => {\n      const proc = cp.spawn(cmd, { cwd: root, shell: true, env: process.env });\n      proc.stdout?.on('data', (b: Buffer) => outChan.append(b.toString()));\n      proc.stderr?.on('data', (b: Buffer) => outChan.append(b.toString()));\n      proc.on('error', (e) => {\n        outChan.appendLine(`\\n[error] ${e.message}`);\n        resolve();\n      });\n      proc.on('close', (code) => {\n        outChan.appendLine(`\\n[exit] code=${code}`);\n        resolve();\n      });\n    });\n  });\n\n  if (openAfter) await openLatestReport();\n}\n\nasync function openLatestReport() {\n  try {\n    const dir = await benchReportDir();\n    if (!dir) return;\n    const files = await vscode.workspace.findFiles(new vscode.RelativePattern(dir, '*.{html,svg}'));\n    if (files.length === 0) {\n      void vscode.window.showInformationMessage('Vitte Bench: aucun rapport HTML/SVG trouvé.');\n      return;\n    }\n    // Sort by mtime (best-effort). Guard array access for noUncheckedIndexedAccess.\n    const entries = files\n      .map((u) => {\n        try {\n          return { uri: u, mtime: fs.statSync(u.fsPath).mtimeMs };\n        } catch {\n          return { uri: u, mtime: 0 };\n        }\n      })\n      .sort((a, b) => b.mtime - a.mtime);\n\n    const first = entries[0];\n    if (!first) {\n      void vscode.window.showInformationMessage('Vitte Bench: aucun rapport HTML/SVG trouvé.');\n      return;\n    }\n    void vscode.commands.executeCommand('vscode.open', first.uri);\n  } catch (e) {\n    const message = e instanceof Error ? e.message : String(e);\n    void vscode.window.showWarningMessage(`Vitte Bench: échec d'ouverture du rapport (${message})`);\n  }\n}\n\nfunction quote(s: string): string {\n  if (process.platform === 'win32') return `\"${s.replace(/\"/g, '\\\\\"')}\"`;\n  return `'${s.replace(/'/g, `\\'`)}'`;\n}\n"]}