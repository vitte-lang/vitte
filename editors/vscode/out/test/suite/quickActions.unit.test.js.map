{"version":3,"file":"quickActions.unit.test.js","sourceRoot":"","sources":["../../../src/test/suite/quickActions.unit.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as assert from \"node:assert/strict\";\nimport * as vscode from \"vscode\";\nimport { __test } from \"../../commands/quickActions\";\nimport type { QuickActionDefinition, QuickActionsContext, QuickPickWithMeta } from \"../../commands/quickActions\";\n\nconst originalGetConfiguration = vscode.workspace.getConfiguration;\n\nfunction stubConfiguration(values: Record<string, unknown>): void {\n  (vscode.workspace as unknown as { getConfiguration: typeof vscode.workspace.getConfiguration }).getConfiguration =\n    ((section: string) => {\n      if (section !== \"vitte\") {\n        return originalGetConfiguration.call(vscode.workspace, section);\n      }\n      return {\n        get: <T>(key: string) => values[key] as T,\n      } as vscode.WorkspaceConfiguration;\n    }) as typeof vscode.workspace.getConfiguration;\n}\n\nfunction restoreConfiguration(): void {\n  (vscode.workspace as unknown as { getConfiguration: typeof vscode.workspace.getConfiguration }).getConfiguration =\n    originalGetConfiguration;\n}\n\nsuite(\"Quick Actions (unit)\", () => {\n  teardown(() => restoreConfiguration());\n\n  test(\"readConfiguredSequences filters invalid entries and clones args\", () => {\n    const sequences = [\n      { label: \"   \", steps: [{ command: \"vitte.clean\" }] },\n      { label: \"Missing command\", steps: [{ command: \"\" }] },\n      {\n        label: \"Valid flow\",\n        steps: [\n          { command: \"first.cmd\", args: [\"a\", { x: 1 }] },\n          { command: \"second.cmd\", args: [\"b\"] },\n        ],\n      },\n    ];\n    stubConfiguration({ \"quickActions.sequences\": sequences });\n\n    const defs = __test.readConfiguredSequences();\n    assert.equal(defs.length, 1, \"Only the valid sequence should be kept\");\n    const [def] = defs;\n    assert.ok(def, \"Definition missing\");\n    assert.equal(def.label, \"Valid flow\");\n    assert.ok(def.actions, \"Actions missing\");\n    const actions = def.actions ?? [];\n    assert.equal(actions.length, 2);\n    assert.deepEqual(actions[0]?.args, [\"a\", { x: 1 }]);\n\n    // Mutating the original array should not leak into stored args\n    const originalSteps = sequences[2]?.steps;\n    if (Array.isArray(originalSteps)) {\n      const [firstStep] = originalSteps as { args?: unknown[] }[];\n      if (Array.isArray(firstStep?.args)) {\n        firstStep.args.push(\"extra\");\n      }\n    }\n    assert.deepEqual(actions[0]?.args, [\"a\", { x: 1 }]);\n  });\n\n  test(\"readQuickActionOverrides trims invalid fields and clones args\", () => {\n    const overrides = {\n      build: { label: \"   \", command: \"   \" },\n      run: { command: \" custom.run \", args: [\"foo\", { bar: 1 }] },\n    };\n    stubConfiguration({ \"quickActions.defaults\": overrides });\n\n    const sanitized = __test.readQuickActionOverrides();\n    assert.ok(!sanitized.build?.label, \"Empty labels should be ignored\");\n    assert.ok(!sanitized.build?.command, \"Blank commands should be ignored\");\n    assert.equal(sanitized.run?.command, \"custom.run\");\n    assert.deepEqual(sanitized.run?.args, [\"foo\", { bar: 1 }]);\n\n    // Ensure args are cloned\n    overrides.run.args?.push(\"mutated\");\n    assert.deepEqual(sanitized.run?.args, [\"foo\", { bar: 1 }]);\n  });\n\n  test(\"buildItems orders pinned and recent items deterministically\", async () => {\n    const ctx: QuickActionsContext = {\n      hasBenchConfig: false,\n      activeIsTestFile: false,\n      workspaceBuilt: false,\n      diagnosticsStale: true,\n      telemetryEnabled: false,\n      usageStats: {},\n      buildProfile: \"dev\",\n      buildIncremental: false,\n    };\n    const defs: QuickActionDefinition[] = [\n      { id: \"alpha\", label: \"Alpha\", command: \"cmd.alpha\" },\n      { id: \"beta\", label: \"Beta\", command: \"cmd.beta\" },\n    ];\n    const recentEntries = [\n      { command: \"cmd.alpha\", actionId: \"alpha\", timestamp: 10 },\n      { command: \"cmd.beta\", actionId: \"beta\", timestamp: 20 },\n    ];\n\n    const items = await __test.buildItems(defs, ctx, recentEntries, \"beta\");\n    assert.deepEqual(\n      items.map((item) => item.actionId),\n      [\"beta\", \"alpha\"],\n      \"Pinned action should be first, followed by recents\"\n    );\n    assert.ok(items[0]?.label.startsWith(\"★ \"), \"Pinned item label should be prefixed\");\n    assert.ok(items[1]?.label.startsWith(\"↺ \"), \"Recent item label should be prefixed\");\n    assert.ok(items[0]?.__isPinned, \"Pinned flag not set\");\n    assert.ok(items[1]?.__isRecent, \"Recent flag not set\");\n  });\n\n  test(\"updateQuickPickItems keeps the selected action after reordering\", () => {\n    const quickPick = {\n      items: [] as readonly QuickPickWithMeta[],\n      selectedItems: [] as readonly QuickPickWithMeta[],\n    } as unknown as vscode.QuickPick<QuickPickWithMeta>;\n\n    const items: QuickPickWithMeta[] = [\n      {\n        label: \"First\",\n        command: \"cmd.one\",\n        actionId: \"one\",\n        steps: [],\n        baseCommand: \"cmd.one\",\n        __isPinned: false,\n        __isRecent: false,\n        __isSuggested: false,\n      },\n      {\n        label: \"Second\",\n        command: \"cmd.two\",\n        actionId: \"two\",\n        steps: [],\n        baseCommand: \"cmd.two\",\n        __isPinned: false,\n        __isRecent: false,\n        __isSuggested: false,\n      },\n    ];\n\n    quickPick.selectedItems = [items[1]!];\n    __test.updateQuickPickItems(quickPick, [items[1]!, items[0]!]);\n    assert.equal(\n      quickPick.selectedItems[0]?.actionId,\n      \"two\",\n      \"Selection should remain on the same action after reorder\"\n    );\n  });\n});\n"]}