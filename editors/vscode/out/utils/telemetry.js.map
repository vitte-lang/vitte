{"version":3,"file":"telemetry.js","sourceRoot":"","sources":["../../src/utils/telemetry.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from 'vscode';\nimport * as path from 'path';\nimport { ensureDir, writeFileText, workspaceRoot, findUp, readJson } from './fs';\n\n/**\n * Lightweight, opt‑in telemetry for VitteLangVsCode.\n * - No external network calls. Writes JSONL batches locally under `.vitte/telemetry/`.\n * - Respects project config (vitte.config.json → workspace.telemetry) and optional `vitte.telemetry.*` settings.\n * - Sampling, error tracking, durations, flush on deactivate.\n * - PII guard: we never capture source contents or file paths unless explicitly provided.\n */\n\nexport type TelemetryProperties = Record<string, string | number | boolean | undefined>;\nexport interface TelemetryOptions {\n  enabled?: boolean;\n  sampleRate?: number; // 0..1\n  channelName?: string; // VS Code OutputChannel name\n}\n\ninterface TelemetryEventBase {\n  t: number;           // epoch ms\n  s: string;           // session id\n  ext?: string;        // extension version\n  k: string;           // event key\n  p?: TelemetryProperties; // properties (stringifiable)\n  d?: number;          // duration ms (optional)\n  lvl?: 'info' | 'warn' | 'error';\n}\n\nconst DEFAULT_SAMPLE = 0.1;\nconst BATCH_MAX = 256;      // max events per file\nconst FLUSH_INTERVAL_MS = 5000;\n\nexport class Telemetry implements vscode.Disposable {\n  private ctx: vscode.ExtensionContext;\n  private enabled = false;\n  private sample = DEFAULT_SAMPLE;\n  private session = randId();\n  private extVersion = '0.0.0';\n  private queue: TelemetryEventBase[] = [];\n  private timer: NodeJS.Timeout | undefined;\n  private output?: vscode.OutputChannel;\n\n  private constructor(ctx: vscode.ExtensionContext, opts?: TelemetryOptions) {\n    this.ctx = ctx;\n    this.enabled = !!opts?.enabled;\n    this.sample = clamp01(opts?.sampleRate ?? DEFAULT_SAMPLE);\n    const extensionPkg = ctx.extension?.packageJSON as { version?: unknown } | undefined;\n    const version = extensionPkg?.version;\n    this.extVersion = typeof version === 'string' ? version : '0.0.0';\n    if (opts?.channelName) this.output = vscode.window.createOutputChannel(opts.channelName);\n    this.armTimer();\n  }\n\n  static async create(ctx: vscode.ExtensionContext, opts?: TelemetryOptions): Promise<Telemetry> {\n    const { enabled, sampleRate } = await readProjectTelemetryConfig();\n    const cfg = vscode.workspace.getConfiguration('vitte');\n    const enabledSetting = cfg.get<boolean>('telemetry.enabled');\n    const sampleSetting = cfg.get<number>('telemetry.sampleRate');\n\n    const t = new Telemetry(ctx, {\n      ...opts,\n      enabled: typeof enabledSetting === 'boolean' ? enabledSetting : enabled,\n      sampleRate: typeof sampleSetting === 'number' ? sampleSetting : sampleRate,\n      channelName: 'Vitte Telemetry',\n    });\n    return t;\n  }\n\n  dispose(): void {\n    if (this.timer) { clearInterval(this.timer); this.timer = undefined; }\n    void this.flush(true);\n    this.output?.dispose();\n  }\n\n  isEnabled(): boolean { return this.enabled; }\n  setEnabled(v: boolean): void { this.enabled = !!v; }\n  setSampleRate(r: number): void { this.sample = clamp01(r); }\n\n  /** Track an event with optional properties. */\n  track(key: string, props?: TelemetryProperties): void {\n    if (!this.shouldSample()) return;\n    const sp = sanitize(props);\n    const ev: TelemetryEventBase = { t: Date.now(), s: this.session, ext: this.extVersion, k: key, lvl: 'info' };\n    if (sp !== undefined) ev.p = sp;\n    this.enqueue(ev);\n  }\n\n  /** Track an error (message + optional props). */\n  error(key: string, err: unknown, props?: TelemetryProperties): void {\n    if (!this.shouldSample()) return;\n    const msg = err instanceof Error ? err.message : String(err);\n    const sp = sanitize({ ...props, error: msg });\n    const ev: TelemetryEventBase = { t: Date.now(), s: this.session, ext: this.extVersion, k: key, lvl: 'error' };\n    if (sp !== undefined) ev.p = sp;\n    this.enqueue(ev);\n  }\n\n  /** Measure a duration around an async function. */\n  async time<T>(key: string, fn: () => Promise<T>, props?: TelemetryProperties): Promise<T> {\n    const start = Date.now();\n    try {\n      const res = await fn();\n      this.duration(key, Date.now() - start, props);\n      return res;\n    } catch (e) {\n      this.duration(key, Date.now() - start, { ...props, ok: false });\n      throw e;\n    }\n  }\n\n  /** Record a duration with optional properties. */\n  duration(key: string, ms: number, props?: TelemetryProperties): void {\n    if (!this.shouldSample()) return;\n    const sp = sanitize(props);\n    const ev: TelemetryEventBase = { t: Date.now(), s: this.session, ext: this.extVersion, k: key, d: Math.max(0, Math.floor(ms)), lvl: 'info' };\n    if (sp !== undefined) ev.p = sp;\n    this.enqueue(ev);\n  }\n\n  /** Force flush queued events to disk. */\n  async flush(now = false): Promise<void> {\n    if (!this.enabled || this.queue.length === 0) return;\n    const slice = this.queue.splice(0, Math.min(this.queue.length, BATCH_MAX));\n    try {\n      const root = workspaceRoot()?.fsPath;\n      if (!root) return; // nothing we can do without a workspace\n      const dir = vscode.Uri.file(`${root}/.vitte/telemetry`);\n      await ensureDir(dir);\n      const ts = new Date().toISOString().replace(/[:.]/g, '-');\n      const file = vscode.Uri.file(path.join(dir.fsPath, `events-${ts}-${randId()}.jsonl`));\n      const lines = slice.map(e => JSON.stringify(e)).join('\\n') + '\\n';\n      await writeFileText(file, lines);\n      this.output?.appendLine(`[telemetry] wrote ${slice.length} event(s) to ${file.fsPath}`);\n    } catch (e) {\n      const message = e instanceof Error ? e.message : String(e);\n      this.output?.appendLine(`[telemetry] flush failed: ${message}`);\n    }\n    if (!now) this.armTimer();\n  }\n\n  // ---- internals ----\n  private armTimer() {\n    if (this.timer) clearInterval(this.timer);\n    this.timer = setInterval(() => { void this.flush(); }, FLUSH_INTERVAL_MS);\n  }\n\n  private shouldSample(): boolean {\n    return this.enabled && Math.random() < this.sample;\n  }\n\n  private enqueue(ev: TelemetryEventBase) {\n    this.queue.push(ev);\n    if (this.queue.length >= BATCH_MAX) { void this.flush(true); }\n  }\n}\n\n// ---- config loader ----\ninterface ProjectTelemetryConfig {\n  workspace?: {\n    telemetry?: {\n      enabled?: boolean;\n      sampleRate?: number;\n    };\n  };\n}\n\nasync function readProjectTelemetryConfig(): Promise<{ enabled: boolean; sampleRate: number }> {\n  try {\n    const found = await findUp(['vitte.config.json', '.vitte/config.json']);\n    if (found) {\n      const json = await readJson<ProjectTelemetryConfig>(found);\n      const enabled = !!json?.workspace?.telemetry?.enabled;\n      const rate = Number(json?.workspace?.telemetry?.sampleRate);\n      return { enabled, sampleRate: Number.isFinite(rate) ? clamp01(rate) : DEFAULT_SAMPLE };\n    }\n  } catch { /* ignore */ }\n  return { enabled: false, sampleRate: DEFAULT_SAMPLE };\n}\n\n// ---- helpers ----\nfunction clamp01(n: number): number { return Math.max(0, Math.min(1, n)); }\nfunction randId(): string { return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2); }\n\nfunction sanitize(input?: TelemetryProperties): TelemetryProperties | undefined {\n  if (!input) return undefined;\n  const out: TelemetryProperties = {};\n  for (const [k, v] of Object.entries(input)) {\n    if (v === undefined) continue;\n    const key = String(k).slice(0, 64);\n    if (typeof v === 'string') {\n      // Drop suspicious long strings (no source code, no paths). Keep small identifiers.\n      if (v.length > 256) continue;\n      if (/[/\\\\]/.test(v) && v.length > 64) continue; // path-like, discard if long\n      out[key] = v;\n    } else if (typeof v === 'number') {\n      if (Number.isFinite(v)) out[key] = v;\n    } else if (typeof v === 'boolean') {\n      out[key] = v;\n    } else {\n      out[key] = String(v).slice(0, 128);\n    }\n  }\n  return Object.keys(out).length ? out : undefined;\n}\n\n// ---- singleton convenience ----\nlet _telemetry: Telemetry | undefined;\nexport async function getTelemetry(ctx: vscode.ExtensionContext): Promise<Telemetry> {\n  _telemetry ??= await Telemetry.create(ctx);\n  return _telemetry;\n}\n\nexport async function registerTelemetry(ctx: vscode.ExtensionContext) {\n  const tel = await getTelemetry(ctx);\n  // Optional toggle command if user adds to package.json\n  const toggle = vscode.commands.registerCommand('vitte.telemetry.toggle', () => {\n    tel.setEnabled(!tel.isEnabled());\n    void vscode.window.showInformationMessage(`Vitte Telemetry: ${tel.isEnabled() ? 'enabled' : 'disabled'}`);\n  });\n  // Flush on shutdown\n  ctx.subscriptions.push(tel, toggle);\n}\n"]}