{"version":3,"file":"toolchain.js","sourceRoot":"","sources":["../../src/utils/toolchain.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from 'vscode';\nimport * as path from 'path';\nimport * as os from 'os';\nimport * as cp from 'child_process';\nimport { exists } from './fs';\n\n/**\n * Vitte toolchain resolver\n * - Detects toolchain root from settings/env/which\n * - Resolves binaries (vitte-runtime/lsp/build/fmt/bench)\n * - Reads versions lazily (\"--version\")\n * - Caches results in globalState with a short TTL to avoid costy lookups\n */\n\nexport type BinKind = 'runtime' | 'lsp' | 'build' | 'fmt' | 'bench';\n\nexport interface ToolchainInfo {\n  /** Toolchain root directory, if known (folder that contains `bin/`). */\n  root?: string;\n  /** Map of resolved absolute binary paths. Missing keys are `undefined`. */\n  bins: Partial<Record<BinKind, string>>;\n  /** Parsed versions per binary (e.g., `vitte-runtime --version`). */\n  versions: Partial<Record<BinKind, string>>;\n  /** True if at least the main runtime was found. */\n  ok: boolean;\n  /** Human-readable notes and warnings. */\n  messages: string[];\n}\n\ninterface CacheEntry {\n  info: ToolchainInfo;\n  ts: number; // epoch ms\n}\n\nconst CACHE_KEY = 'vitte.toolchain.cache';\nconst CACHE_TTL_MS = 30_000; // 30s — safe for repeated commands\n\n/** Resolve the configured toolchain root from settings/env, or undefined. */\nexport function configuredToolchainRoot(): string | undefined {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  const s1 = cfg.get<string>('toolchain.root');\n  const s2 = cfg.get<string>('toolchainPath'); // legacy\n  const env = process.env.VITTE_TOOLCHAIN_ROOT;\n  return firstNonEmpty(s1, s2, env);\n}\n\n/** Try to resolve a binary path by checking setting, toolchain root, then PATH. */\nexport async function resolveBinary(\n  name: string,\n  opts?: { settingKeys?: string[] | undefined; root?: string | undefined }\n): Promise<string | undefined> {\n  const cfg = vscode.workspace.getConfiguration('vitte');\n  // 1) explicit settings\n  const keys = opts?.settingKeys ?? [];\n  for (const k of keys) {\n    const raw = cfg.get<string>(k)?.trim();\n    if (raw) {\n      const p = absolutize(raw, opts?.root);\n      if (await exists(p)) return p;\n    }\n  }\n  // 2) toolchain root/bin\n  const root = opts?.root ?? configuredToolchainRoot();\n  if (root) {\n    const candidate = path.join(root, 'bin', nameWithExt(name));\n    if (await exists(candidate)) return candidate;\n  }\n  // 3) PATH lookup\n  return await which(name);\n}\n\n/** Main resolution entry point with short-lived cache. */\nexport async function getToolchain(ctx?: vscode.ExtensionContext, forceRefresh = false): Promise<ToolchainInfo> {\n  const state = ctx?.globalState;\n  if (!forceRefresh && state) {\n    const cache = state.get<CacheEntry>(CACHE_KEY);\n    if (cache && Date.now() - cache.ts < CACHE_TTL_MS) return cache.info;\n  }\n\n  const messages: string[] = [];\n  const root = configuredToolchainRoot();\n  if (!root) messages.push('Aucun \"vitte.toolchain.root\" configuré — recherche via PATH…');\n\n  const rootOpt = root !== undefined ? { root } : undefined;\n  const runtime = await resolveBinary('vitte-runtime', { settingKeys: ['debug.program', 'runtime.path', 'runtime'], ...rootOpt });\n  const lsp = await resolveBinary('vitte-lsp', { settingKeys: ['lsp.path'], ...rootOpt });\n  const build = await resolveBinary('vitte-build', { settingKeys: ['build.path'], ...rootOpt });\n  const fmt = await resolveBinary('vitte-fmt', { settingKeys: ['fmt.path'], ...rootOpt });\n  const bench = await resolveBinary('vitte-bench', { settingKeys: ['bench.path'], ...rootOpt });\n\n  const bins: ToolchainInfo['bins'] = {};\n  if (runtime !== undefined) bins.runtime = runtime;\n  if (lsp !== undefined) bins.lsp = lsp;\n  if (build !== undefined) bins.build = build;\n  if (fmt !== undefined) bins.fmt = fmt;\n  if (bench !== undefined) bins.bench = bench;\n\n  const ok = !!runtime;\n  if (!ok) messages.push('vitte-runtime introuvable (paramètre vitte.debug.program ou PATH).');\n\n  const info: ToolchainInfo = { bins, versions: {}, ok, messages };\n  if (root !== undefined) info.root = root;\n\n  // Optionally read versions (best-effort, don't throw)\n  await Promise.all(\n    (Object.entries(bins) as [BinKind, string][]).map(async ([k, p]) => {\n      const ver = await readVersion(p);\n      if (ver) info.versions[k] = ver;\n    })\n  );\n\n  if (state) await state.update(CACHE_KEY, { info, ts: Date.now() } as CacheEntry);\n  return info;\n}\n\n/** Force refresh of the toolchain cache. */\nexport async function refreshToolchain(ctx?: vscode.ExtensionContext): Promise<ToolchainInfo> {\n  if (ctx) await ctx.globalState.update(CACHE_KEY, undefined);\n  return getToolchain(ctx, true);\n}\n\n/** Register a user-facing command that shows a quick status of the toolchain. */\nexport function registerToolchainCommands(ctx: vscode.ExtensionContext) {\n  const cmd = vscode.commands.registerCommand('vitte.detectToolchain', async () => {\n    const info = await getToolchain(ctx, true);\n    const out = vscode.window.createOutputChannel('Vitte Toolchain');\n    out.clear();\n    out.appendLine('[Vitte] Toolchain detection');\n    if (info.root) out.appendLine(`root: ${info.root}`);\n    for (const [k, p] of Object.entries(info.bins)) out.appendLine(`${k}: ${p ?? '—'}`);\n    for (const [k, v] of Object.entries(info.versions)) out.appendLine(`${k} version: ${v}`);\n    if (info.messages.length) out.appendLine(info.messages.map(m => `! ${m}`).join('\\n'));\n    out.show(true);\n  });\n  ctx.subscriptions.push(cmd);\n}\n\n// ------------------------- internals -------------------------\n\nfunction nameWithExt(name: string): string {\n  // Defensive: ensure a string even under odd narrowings\n  if (!name) return '';\n  if (process.platform === 'win32') {\n    const pathext = (process.env.PATHEXT ?? '.EXE;.CMD;.BAT').toLowerCase().split(';');\n    for (const ext of pathext) if (name.toLowerCase().endsWith(ext.toLowerCase())) return name; // already has an ext\n    return name + '.exe';\n  }\n  return name;\n}\n\n/** PATH lookup that respects PATHEXT on Windows. */\nexport async function which(bin: string | undefined): Promise<string | undefined> {\n  if (!bin) return undefined;\n  const b: string = bin; // narrow to plain string for downstream calls\n  const parts = (process.env.PATH ?? '').split(path.delimiter).filter(Boolean);\n  const exts = process.platform === 'win32' ? (process.env.PATHEXT ?? '.EXE;.CMD;.BAT').split(';') : [''];\n  for (const dir of parts) {\n    for (const ext of exts) {\n      const candidate = path.join(dir, b + ext);\n      if (await exists(candidate)) return candidate;\n    }\n  }\n  return undefined;\n}\n\nasync function readVersion(bin: string): Promise<string | undefined> {\n  try {\n    const out = await execCapture([bin, '--version']);\n    const match = /\\b(\\d+\\.\\d+\\.\\d+(?:[-+][\\w.]+)?)\\b/.exec(String(out));\n    return match ? match[1] : String(out).trim().split(/\\r?\\n/)[0];\n  } catch { return undefined; }\n}\n\nfunction firstNonEmpty(...values: (string | undefined | null)[]): string | undefined {\n  for (const value of values) {\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed.length > 0) return trimmed;\n    }\n  }\n  return undefined;\n}\n\n/** Execute a command and capture stdout (utf-8). */\nasync function execCapture(cmd: string[] | string, opts?: { cwd?: string; env?: NodeJS.ProcessEnv; timeoutMs?: number }): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const timeout = Math.max(1000, Math.min(10_000, opts?.timeoutMs ?? 3000));\n\n    const fileOrArray = Array.isArray(cmd) ? cmd[0] : cmd;\n    const args: string[] = Array.isArray(cmd) ? cmd.slice(1) : [];\n\n    // ⛑️ Narrow strict: forbid undefined/empty command reaching spawn\n    if (typeof fileOrArray !== 'string' || fileOrArray.length === 0) {\n      reject(new Error('invalid command'));\n      return;\n    }\n    const file: string = fileOrArray;\n\n    const options: cp.SpawnOptions = {\n      cwd: opts?.cwd,\n      env: opts?.env ?? process.env,\n      shell: false,\n    };\n\n    const child = cp.spawn(file, args, options); // type: cp.ChildProcess\n\n    let out = '';\n    let err = '';\n\n    const to = setTimeout(() => {\n      try { child.kill(); } catch { /* ignore */ }\n      reject(new Error('timeout'));\n    }, timeout);\n\n    child.stdout?.on('data', (b: Buffer) => { out += b.toString(); });\n    child.stderr?.on('data', (b: Buffer) => { err += b.toString(); });\n    child.on('error', (e) => { clearTimeout(to); reject(e); });\n    child.on('close', (code) => {\n      clearTimeout(to);\n      if (code === 0) resolve(out);\n      else if (out) resolve(out); // some tools print version even on non-zero exit\n      else reject(new Error(err || `exit ${code}`));\n    });\n  });\n}\n\n/** Convenience: return a friendly snapshot string (for status bars, etc.). */\nexport function formatToolchainStatus(info: ToolchainInfo): string {\n  const v = info.versions.runtime ?? info.versions.lsp ?? info.versions.build;\n  const ver = v ? `v${v}` : 'unknown';\n  const ok = info.ok ? '✓' : '✗';\n  return `Vitte ${ok} · ${ver}`;\n}\n\n/** Returns recommended default env for child processes (PATH patched with toolchain bin). */\nexport function childEnvWithToolchain(info: ToolchainInfo, base: NodeJS.ProcessEnv = process.env): NodeJS.ProcessEnv {\n  const env = { ...base };\n  let binDir: string | undefined;\n  const r = info.root;\n  if (typeof r === 'string' && r.length > 0) {\n    binDir = path.join(r, 'bin');\n  }\n  if (binDir) env.PATH = binDir + path.delimiter + (base.PATH ?? '');\n  env.HOME ??= os.homedir();\n  return env;\n}\n\nfunction absolutize(p: string, root?: string): string {\n  if (path.isAbsolute(p)) return p;\n  if (root) return path.join(root, p);\n  return path.resolve(p);\n}\n"]}