{"version":3,"file":"vitlDebugAdapter.js","sourceRoot":"","sources":["../../src/debug/vitlDebugAdapter.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from 'vscode';\nimport * as cp from 'child_process';\nimport * as net from 'net';\nimport * as path from 'path';\n\n/**\n * Vitl Debug Adapter\n * Tries to start a DAP server from `vitl-runtime` first, then falls back to stdio.\n * Understands workspace settings under `vitte.*` to keep parity with Vitte.\n */\nexport function registerVitlDebugAdapter(context: vscode.ExtensionContext) {\n  const factory = new VitlDebugAdapterFactory();\n  context.subscriptions.push(\n    vscode.debug.registerDebugAdapterDescriptorFactory('vitl', factory),\n    factory\n  );\n}\n\nclass VitlDebugAdapterFactory implements vscode.DebugAdapterDescriptorFactory, vscode.Disposable {\n  private readonly sessions = new Map<string, cp.ChildProcess>();\n\n  dispose(): void {\n    for (const proc of this.sessions.values()) {\n      try { proc.kill(); } catch { /* noop */ }\n    }\n    this.sessions.clear();\n  }\n\n  async createDebugAdapterDescriptor(session: vscode.DebugSession): Promise<vscode.DebugAdapterDescriptor> {\n    const cfg = vscode.workspace.getConfiguration('vitte');\n\n    const { program, cwd, extraArgs } = this.resolveRuntimeAndArgs(cfg, session);\n\n    // Prefer server mode\n    const server = await this.tryStartServer(program, cwd, extraArgs);\n    if (server.ok) {\n      this.sessions.set(session.id, server.proc);\n      return new vscode.DebugAdapterServer(server.port, '127.0.0.1');\n    }\n\n    // Fallback to stdio\n    const exec = this.buildExecutable(program, cwd, extraArgs);\n    const opts: vscode.DebugAdapterExecutableOptions = { cwd: exec.cwd };\n    const envMap = this.toVscodeEnv(exec.env);\n    if (envMap) { opts.env = envMap; }\n    return new vscode.DebugAdapterExecutable(exec.command, exec.args, opts);\n  }\n\n  // ---- helpers (typing/guards) ------------------------------------------------\n  private toVscodeEnv(env: NodeJS.ProcessEnv | undefined): Record<string, string> | undefined {\n    if (!env) return undefined;\n    const out: Record<string, string> = {};\n    for (const [key, value] of Object.entries(env)) {\n      if (typeof value === 'string') out[key] = value;\n    }\n    return Object.keys(out).length > 0 ? out : undefined;\n  }\n\n  private ensureString(x: string | undefined, fallback: string): string {\n    return (typeof x === 'string' && x.length > 0) ? x : fallback;\n  }\n\n  private sanitizeArgs(args: (string | undefined)[]): string[] {\n    return args.filter((a): a is string => typeof a === 'string' && a.length > 0);\n  }\n\n  // ---- resolution -------------------------------------------------------------\n  private resolveRuntimeAndArgs(cfg: vscode.WorkspaceConfiguration, session: vscode.DebugSession): { program: string; cwd: string; extraArgs: string[] } {\n    // Settings or default (accept vitlâ€‘specific first, then vitte.debug.program, else 'vitl-runtime')\n    const explicit = cfg.get<string>('vitl.debug.program')\n      ?? cfg.get<string>('debug.program')\n      ?? 'vitl-runtime';\n\n    const toolchainRoot = cfg.get<string>('toolchain.root') ?? cfg.get<string>('toolchainPath');\n    const program = toolchainRoot && explicit && !path.isAbsolute(explicit)\n      ? path.join(toolchainRoot, explicit)\n      : explicit;\n\n    const rawConfig = session.configuration as Record<string, unknown>;\n    const workspaceRoot = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath ?? process.cwd();\n    const cwdValue = typeof rawConfig.cwd === 'string' && rawConfig.cwd.length > 0 ? rawConfig.cwd : workspaceRoot;\n\n    // Allow passing args from launch.json\n    const configArgs = rawConfig.args;\n    let rawArgs: (string | undefined)[] = [];\n    if (Array.isArray(configArgs)) {\n      rawArgs = configArgs.map((value) => (typeof value === 'string' ? value : undefined));\n    } else if (typeof configArgs === 'string' && configArgs.length > 0) {\n      rawArgs = [configArgs];\n    }\n    const extraArgs = this.sanitizeArgs(rawArgs);\n\n    return { program: this.ensureString(program, 'vitl-runtime'), cwd: this.ensureString(cwdValue, process.cwd()), extraArgs };\n  }\n\n  // ---- server probing ---------------------------------------------------------\n  private async tryStartServer(program: string, cwd: string, extraArgs: string[]): Promise<{ ok: true, proc: cp.ChildProcess, port: number } | { ok: false, error: Error }> {\n    // Strategy A: `dap --port 0`\n    const a = await this.spawnAndDetectPort(program, ['dap', '--port', '0', ...extraArgs], cwd);\n    if (a.ok) return a;\n\n    // Strategy B: `--dap --port 0`\n    const b = await this.spawnAndDetectPort(program, ['--dap', '--port', '0', ...extraArgs], cwd);\n    if (b.ok) return b;\n\n    // Strategy C: `dap` and parse announced port\n    const c = await this.spawnAndDetectPort(program, ['dap', ...extraArgs], cwd);\n    if (c.ok) return c;\n\n    return { ok: false, error: new Error('No DAP server mode detected for vitl runtime') };\n  }\n\n  private spawnAndDetectPort(program: string, args: string[], cwd: string): Promise<{ ok: true, proc: cp.ChildProcess, port: number } | { ok: false, error: Error }> {\n    return new Promise((resolve) => {\n      let resolved = false;\n      const cmd = this.ensureString(program, 'vitl-runtime');\n      const argv = this.sanitizeArgs(args);\n      const proc = cp.spawn(cmd, argv, { cwd: this.ensureString(cwd, process.cwd()), env: process.env, stdio: ['ignore', 'pipe', 'pipe'] });\n\n      const finish = (err?: Error) => {\n        if (!resolved) {\n          resolved = true;\n          resolve({ ok: false, error: err ?? new Error('port detection failed') });\n        }\n      };\n\n      const sniff = (buf: Buffer) => {\n        if (resolved) return;\n        const text = buf.toString();\n        const match = /(?:listening\\s+on\\s+[^:]+:|port\\s*=|DAP_PORT=)(\\d{3,5})/i.exec(text);\n        if (!match) return;\n        const port = Number.parseInt(match[1] ?? '', 10);\n        if (!Number.isInteger(port) || port <= 0 || port >= 65536) return;\n        resolved = true;\n        // quick probe\n        const sock = new net.Socket();\n        sock.once('error', () => resolve({ ok: true, proc, port }));\n        sock.connect(port, '127.0.0.1', () => {\n          sock.destroy();\n          resolve({ ok: true, proc, port });\n        });\n      };\n\n      proc.stdout?.on('data', sniff);\n      proc.stderr?.on('data', sniff);\n      proc.once('error', (e) => finish(e instanceof Error ? e : new Error(String(e))));\n      proc.once('exit', (code, sig) => finish(new Error(`exited early (code=${String(code)}, sig=${String(sig ?? 'null')})`)));\n      setTimeout(() => finish(new Error('timeout waiting for dap port')), 4000);\n    });\n  }\n\n  // ---- stdio fallback ---------------------------------------------------------\n  private buildExecutable(program: string, cwd: string, extraArgs: string[]) {\n    // Try stdio flags, otherwise pass through\n    const candidates: string[][] = [\n      ['dap', '--stdio'],\n      ['--dap', '--stdio'],\n      []\n    ];\n    const base = this.sanitizeArgs(extraArgs);\n    const args = base.length > 0 ? base : candidates[0];\n    return { command: program, args, cwd, env: process.env };\n  }\n\n}\n"]}