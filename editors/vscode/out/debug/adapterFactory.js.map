{"version":3,"file":"adapterFactory.js","sourceRoot":"","sources":["../../src/debug/adapterFactory.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8KA,oDAMC;AApLD,+CAAiC;AACjC,kDAAoC;AACpC,yCAA2B;AAC3B,2CAA6B;AAE7B;;;;GAIG;AACH,MAAa,kCAAkC;IAA/C;QACU,mBAAc,GAAwB,EAAE,CAAC;QACzC,cAAS,GAAG,IAAI,GAAG,EAAoD,CAAC;IAgKlF,CAAC;IA9JS,WAAW,CAAC,GAAkC;QACpD,IAAI,CAAC,GAAG;YAAE,OAAO,SAAS,CAAC;QAC3B,MAAM,GAAG,GAA2B,EAAE,CAAC;QACvC,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;YAC/C,IAAI,OAAO,KAAK,KAAK,QAAQ;gBAAE,GAAG,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;QAClD,CAAC;QACD,OAAO,GAAG,CAAC;IACb,CAAC;IAEO,YAAY,CAAC,CAAqB,EAAE,QAAgB;QAC1D,OAAO,CAAC,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;IAChE,CAAC;IAEO,YAAY,CAAC,IAAe;QAClC,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,EAAe,EAAE,CAAC,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;IAChF,CAAC;IAED,OAAO;QACL,KAAK,MAAM,CAAC,IAAI,IAAI,CAAC,cAAc;YAAE,CAAC,CAAC,OAAO,EAAE,CAAC;QACjD,KAAK,MAAM,EAAE,IAAI,EAAE,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,EAAE,CAAC;YAC/C,IAAI,CAAC;gBAAC,IAAI,CAAC,IAAI,EAAE,CAAC;YAAC,CAAC;YAAC,MAAM,CAAC,CAAC,UAAU,CAAC,CAAC;QAC3C,CAAC;QACD,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC;IACzB,CAAC;IAED,KAAK,CAAC,4BAA4B,CAAC,OAA4B;QAC7D,MAAM,GAAG,GAAG,MAAM,CAAC,SAAS,CAAC,gBAAgB,CAAC,OAAO,CAAC,CAAC;QACvD,MAAM,OAAO,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC;QAC7C,MAAM,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC;QAC5F,MAAM,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAC7C,MAAM,GAAG,GAAG,OAAO,OAAO,CAAC,aAAa,CAAC,GAAG,KAAK,QAAQ,IAAI,OAAO,CAAC,aAAa,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC;YAC/F,CAAC,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG;YAC3B,CAAC,CAAC,CAAC,MAAM,CAAC,SAAS,CAAC,gBAAgB,EAAE,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,IAAI,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;QAE1E,6BAA6B;QAC7B,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,GAAG,EAAE,SAAS,CAAC,CAAC;QACrE,IAAI,SAAS,CAAC,EAAE,EAAE,CAAC;YACjB,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,SAAS,CAAC;YACjC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;YAC/C,OAAO,IAAI,MAAM,CAAC,kBAAkB,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;QAC1D,CAAC;QAED,gCAAgC;QAChC,MAAM,IAAI,GAAG,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,GAAG,EAAE,SAAS,CAAC,CAAC;QAC3D,MAAM,IAAI,GAAyC,EAAE,GAAG,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC;QACrE,MAAM,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAC1C,IAAI,MAAM,EAAE,CAAC;YAAC,IAAI,CAAC,GAAG,GAAG,MAAM,CAAC;QAAC,CAAC;QAClC,MAAM,IAAI,GAAG,IAAI,MAAM,CAAC,sBAAsB,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAC9E,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,kBAAkB,CAAC,GAAkC;QAC3D,0GAA0G;QAC1G,MAAM,MAAM,GAAG,GAAG,CAAC,GAAG,CAAS,eAAe,CAAC,CAAC;QAChD,IAAI,MAAM,EAAE,IAAI,EAAE,CAAC,MAAM;YAAE,OAAO,MAAM,CAAC;QAEzC,MAAM,aAAa,GAAG,GAAG,CAAC,GAAG,CAAS,eAAe,CAAC,IAAI,GAAG,CAAC,GAAG,CAAS,gBAAgB,CAAC,CAAC;QAC5F,MAAM,SAAS,GAAG,GAAG,CAAC,GAAG,CAAS,cAAc,CAAC,IAAI,GAAG,CAAC,GAAG,CAAS,SAAS,CAAC,IAAI,eAAe,CAAC;QAEnG,IAAI,aAAa,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;YACjD,OAAO,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,SAAS,CAAC,CAAC;QAC7C,CAAC;QACD,OAAO,SAAS,CAAC;IACnB,CAAC;IAEO,KAAK,CAAC,cAAc,CAAC,OAAe,EAAE,GAAW,EAAE,SAAmB;QAC5E,4EAA4E;QAC5E,MAAM,KAAK,GAAG,CAAC,KAAK,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,SAAS,CAAC,CAAC;QACnD,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;QACpE,IAAI,QAAQ,CAAC,EAAE;YAAE,OAAO,QAAQ,CAAC;QAEjC,iDAAiD;QACjD,MAAM,KAAK,GAAG,CAAC,OAAO,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,SAAS,CAAC,CAAC;QACrD,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;QACpE,IAAI,QAAQ,CAAC,EAAE;YAAE,OAAO,QAAQ,CAAC;QAEjC,oFAAoF;QACpF,MAAM,KAAK,GAAG,CAAC,KAAK,EAAE,GAAG,SAAS,CAAC,CAAC;QACpC,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;QACpE,IAAI,QAAQ,CAAC,EAAE;YAAE,OAAO,QAAQ,CAAC;QAEjC,OAAO,EAAE,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,IAAI,KAAK,CAAC,gDAAgD,CAAC,EAAE,CAAC;IAC3F,CAAC;IAEO,kBAAkB,CAAC,OAAe,EAAE,IAAc,EAAE,GAAW;QACrE,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC7B,IAAI,QAAQ,GAAG,KAAK,CAAC;YACrB,MAAM,GAAG,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,eAAe,CAAC,CAAC;YACxD,MAAM,IAAI,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;YACrC,MAAM,IAAI,GAAG,EAAE,CAAC,KAAK,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE,GAAG,EAAE,IAAI,CAAC,YAAY,CAAC,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,CAAC,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,KAAK,EAAE,CAAC,QAAQ,EAAE,MAAM,EAAE,MAAM,CAAC,EAAE,CAAC,CAAC;YAEtI,MAAM,OAAO,GAAG,CAAC,GAAW,EAAE,EAAE;gBAC9B,IAAI,CAAC,QAAQ,EAAE,CAAC;oBACd,QAAQ,GAAG,IAAI,CAAC;oBAChB,OAAO,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,IAAI,IAAI,KAAK,CAAC,2BAA2B,CAAC,EAAE,CAAC,CAAC;gBAC/E,CAAC;YACH,CAAC,CAAC;YAEF,MAAM,MAAM,GAAG,CAAC,IAAY,EAAE,EAAE;gBAC9B,IAAI,QAAQ;oBAAE,OAAO;gBACrB,MAAM,IAAI,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;gBAC7B,8CAA8C;gBAC9C,YAAY;gBACZ,sCAAsC;gBACtC,+BAA+B;gBAC/B,oBAAoB;gBACpB,MAAM,SAAS,GAAG,0DAA0D,CAAC;gBAC7E,MAAM,KAAK,GAAG,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACnC,IAAI,KAAK,EAAE,CAAC;oBACV,MAAM,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;oBACnB,IAAI,CAAC,CAAC;wBAAE,OAAO,CAAC,qCAAqC;oBACrD,MAAM,IAAI,GAAG,MAAM,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;oBACpC,IAAI,MAAM,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,IAAI,GAAG,KAAK,EAAE,CAAC;wBACvD,QAAQ,GAAG,IAAI,CAAC;wBAChB,mDAAmD;wBACnD,MAAM,IAAI,GAAG,IAAI,GAAG,CAAC,MAAM,EAAE,CAAC;wBAC9B,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,GAAG,EAAE;4BACtB,6DAA6D;4BAC7D,OAAO,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;wBACpC,CAAC,CAAC,CAAC;wBACH,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,WAAW,EAAE,GAAG,EAAE;4BACnC,IAAI,CAAC,OAAO,EAAE,CAAC;4BACf,OAAO,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;wBACpC,CAAC,CAAC,CAAC;oBACL,CAAC;gBACH,CAAC;YACH,CAAC,CAAC;YAEF,IAAI,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;YAChC,IAAI,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;YAEhC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC;YAC1C,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,MAAM,EAAE,EAAE;gBACjC,IAAI,CAAC,QAAQ,EAAE,CAAC;oBACd,OAAO,CAAC,IAAI,KAAK,CAAC,+CAA+C,IAAI,YAAY,MAAM,IAAI,MAAM,GAAG,CAAC,CAAC,CAAC;gBACzG,CAAC;YACH,CAAC,CAAC,CAAC;YAEH,iBAAiB;YACjB,UAAU,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,IAAI,KAAK,CAAC,8BAA8B,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;QAC7E,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,eAAe,CAAC,OAAe,EAAE,GAAW,EAAE,SAAmB;QACvE,4DAA4D;QAC5D,iFAAiF;QACjF,MAAM,mBAAmB,GAAe;YACtC,CAAC,KAAK,EAAE,SAAS,CAAC;YAClB,CAAC,OAAO,EAAE,SAAS,CAAC;YACpB,EAAE;SACH,CAAC;QACF,IAAI,IAAI,GAAG,SAAS,CAAC;QACrB,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACtB,IAAI,GAAG,mBAAmB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,IAAI,EAAE,CAAC;QAC3D,CAAC;QAED,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,CAAC;IACpF,CAAC;CACF;AAlKD,gFAkKC;AAED,SAAgB,oBAAoB,CAAC,GAA4B;IAC/D,MAAM,OAAO,GAAG,IAAI,kCAAkC,EAAE,CAAC;IACzD,GAAG,CAAC,aAAa,CAAC,IAAI,CACpB,MAAM,CAAC,KAAK,CAAC,qCAAqC,CAAC,OAAO,EAAE,OAAO,CAAC,EACpE,OAAO,CACR,CAAC;AACJ,CAAC","sourcesContent":["import * as vscode from 'vscode';\nimport * as cp from 'child_process';\nimport * as net from 'net';\nimport * as path from 'path';\n\n/**\n * Vitte Debug Adapter factory.\n * Spawns `vitte-runtime` in DAP server mode when possible.\n * Falls back to stdio if server mode is not available.\n */\nexport class VitteDebugAdapterDescriptorFactory implements vscode.DebugAdapterDescriptorFactory, vscode.Disposable {\n  private _subscriptions: vscode.Disposable[] = [];\n  private _sessions = new Map<string, { proc: cp.ChildProcess; port?: number }>();\n\n  private toVscodeEnv(env: NodeJS.ProcessEnv | undefined): Record<string, string> | undefined {\n    if (!env) return undefined;\n    const out: Record<string, string> = {};\n    for (const [key, value] of Object.entries(env)) {\n      if (typeof value === 'string') out[key] = value;\n    }\n    return out;\n  }\n\n  private ensureString(x: string | undefined, fallback: string): string {\n    return (typeof x === 'string' && x.length > 0) ? x : fallback;\n  }\n\n  private sanitizeArgs(args: unknown[]): string[] {\n    return args.filter((a): a is string => typeof a === 'string' && a.length > 0);\n  }\n\n  dispose(): void {\n    for (const d of this._subscriptions) d.dispose();\n    for (const { proc } of this._sessions.values()) {\n      try { proc.kill(); } catch { /* noop */ }\n    }\n    this._sessions.clear();\n  }\n\n  async createDebugAdapterDescriptor(session: vscode.DebugSession): Promise<vscode.DebugAdapterDescriptor> {\n    const cfg = vscode.workspace.getConfiguration('vitte');\n    const program = this.resolveRuntimePath(cfg);\n    const rawArgs = Array.isArray(session.configuration.args) ? session.configuration.args : [];\n    const extraArgs = this.sanitizeArgs(rawArgs);\n    const cwd = typeof session.configuration.cwd === 'string' && session.configuration.cwd.length > 0\n      ? session.configuration.cwd\n      : (vscode.workspace.workspaceFolders?.[0]?.uri.fsPath ?? process.cwd());\n\n    // Try DAP server mode first.\n    const serverTry = await this.tryStartServer(program, cwd, extraArgs);\n    if (serverTry.ok) {\n      const { proc, port } = serverTry;\n      this._sessions.set(session.id, { proc, port });\n      return new vscode.DebugAdapterServer(port, '127.0.0.1');\n    }\n\n    // Fallback to stdio executable.\n    const exec = this.buildExecutable(program, cwd, extraArgs);\n    const opts: vscode.DebugAdapterExecutableOptions = { cwd: exec.cwd };\n    const envMap = this.toVscodeEnv(exec.env);\n    if (envMap) { opts.env = envMap; }\n    const desc = new vscode.DebugAdapterExecutable(exec.command, exec.args, opts);\n    return desc;\n  }\n\n  private resolveRuntimePath(cfg: vscode.WorkspaceConfiguration): string {\n    // Prefer project setting `vitte.debug.program`, then `vitte.runtime` or `vitte.build.path`, then default.\n    const direct = cfg.get<string>('debug.program');\n    if (direct?.trim().length) return direct;\n\n    const toolchainRoot = cfg.get<string>('toolchainPath') ?? cfg.get<string>('toolchain.root');\n    const candidate = cfg.get<string>('runtime.path') ?? cfg.get<string>('runtime') ?? 'vitte-runtime';\n\n    if (toolchainRoot && !path.isAbsolute(candidate)) {\n      return path.join(toolchainRoot, candidate);\n    }\n    return candidate;\n  }\n\n  private async tryStartServer(program: string, cwd: string, extraArgs: string[]): Promise<{ ok: true, proc: cp.ChildProcess, port: number } | { ok: false, error: Error } > {\n    // Strategy A: runtime supports `dap --port 0` and prints the selected port.\n    const argsA = ['dap', '--port', '0', ...extraArgs];\n    const attemptA = await this.spawnAndDetectPort(program, argsA, cwd);\n    if (attemptA.ok) return attemptA;\n\n    // Strategy B: runtime supports `--dap --port 0`.\n    const argsB = ['--dap', '--port', '0', ...extraArgs];\n    const attemptB = await this.spawnAndDetectPort(program, argsB, cwd);\n    if (attemptB.ok) return attemptB;\n\n    // Strategy C: runtime supports `dap` with a fixed ephemeral port printed on stdout.\n    const argsC = ['dap', ...extraArgs];\n    const attemptC = await this.spawnAndDetectPort(program, argsC, cwd);\n    if (attemptC.ok) return attemptC;\n\n    return { ok: false, error: new Error('DAP server mode not detected on vitte-runtime.') };\n  }\n\n  private spawnAndDetectPort(program: string, args: string[], cwd: string): Promise<{ ok: true, proc: cp.ChildProcess, port: number } | { ok: false, error: Error }> {\n    return new Promise((resolve) => {\n      let resolved = false;\n      const cmd = this.ensureString(program, 'vitte-runtime');\n      const argv = this.sanitizeArgs(args);\n      const proc = cp.spawn(cmd, argv, { cwd: this.ensureString(cwd, process.cwd()), env: process.env, stdio: ['ignore', 'pipe', 'pipe'] });\n\n      const cleanup = (err?: Error) => {\n        if (!resolved) {\n          resolved = true;\n          resolve({ ok: false, error: err ?? new Error('Failed to detect DAP port') });\n        }\n      };\n\n      const onData = (data: Buffer) => {\n        if (resolved) return;\n        const text = data.toString();\n        // Common patterns to detect an announced port\n        // Examples:\n        //  - DAP listening on 127.0.0.1:51234\n        //  - debug-adapter: port=51234\n        //  - DAP_PORT=51234\n        const portMatch = /(?:listening\\s+on\\s+[^:]+:|port\\s*=|DAP_PORT=)(\\d{3,5})/i;\n        const match = portMatch.exec(text);\n        if (match) {\n          const g = match[1];\n          if (!g) return; // group may be undefined in TS types\n          const port = Number.parseInt(g, 10);\n          if (Number.isInteger(port) && port > 0 && port < 65536) {\n            resolved = true;\n            // Verify the port is accepting connections briefly\n            const sock = new net.Socket();\n            sock.once('error', () => {\n              // Might not be ready yet, still resolve and let VSCode retry\n              resolve({ ok: true, proc, port });\n            });\n            sock.connect(port, '127.0.0.1', () => {\n              sock.destroy();\n              resolve({ ok: true, proc, port });\n            });\n          }\n        }\n      };\n\n      proc.stdout?.on('data', onData);\n      proc.stderr?.on('data', onData);\n\n      proc.once('error', (err) => cleanup(err));\n      proc.once('exit', (code, signal) => {\n        if (!resolved) {\n          cleanup(new Error(`runtime exited before announcing port (code=${code}, signal=${signal ?? 'null'})`));\n        }\n      });\n\n      // Safety timeout\n      setTimeout(() => cleanup(new Error('timeout waiting for DAP port')), 4000);\n    });\n  }\n\n  private buildExecutable(program: string, cwd: string, extraArgs: string[]) {\n    // Fallback: stdio mode executed as a DebugAdapterExecutable\n    // Try common flags to force stdio DAP if supported. Otherwise, leave args as-is.\n    const stdioArgsCandidates: string[][] = [\n      ['dap', '--stdio'],\n      ['--dap', '--stdio'],\n      []\n    ];\n    let args = extraArgs;\n    if (args.length === 0) {\n      args = stdioArgsCandidates.find(a => a.length > 0) ?? [];\n    }\n\n    return { command: program, args: this.sanitizeArgs(args), cwd, env: process.env };\n  }\n}\n\nexport function registerDebugFactory(ctx: vscode.ExtensionContext) {\n  const factory = new VitteDebugAdapterDescriptorFactory();\n  ctx.subscriptions.push(\n    vscode.debug.registerDebugAdapterDescriptorFactory('vitte', factory),\n    factory\n  );\n}\n"]}