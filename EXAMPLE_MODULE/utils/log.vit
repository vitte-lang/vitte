# ============================================================
# EXAMPLE_MODULE::utils::log
# Système de logging simple et déterministe
# ============================================================

space EXAMPLE_MODULE/utils


# ------------------------------------------------------------
# Niveaux de log
# ------------------------------------------------------------

pick LogLevel
    case Trace
    case Debug
    case Info
    case Warn
    case Error
.end


# ------------------------------------------------------------
# Configuration du logger
# ------------------------------------------------------------

form LogConfig
    level: LogLevel
    enabled: bool
.end


proc LogConfig::default
-> LogConfig

    give LogConfig {
        level = LogLevel::Info
        enabled = true
    }
.end


# ------------------------------------------------------------
# État global simple
# ------------------------------------------------------------

let mut GLOBAL_LOG_CONFIG: LogConfig = LogConfig::default()


proc set_log_config
    cfg: LogConfig
-> void

    GLOBAL_LOG_CONFIG = cfg
.end


# ------------------------------------------------------------
# Helpers internes
# ------------------------------------------------------------

proc level_value
    lvl: LogLevel
-> u32

    select lvl
        when LogLevel::Trace give 0
        when LogLevel::Debug give 1
        when LogLevel::Info  give 2
        when LogLevel::Warn  give 3
        when LogLevel::Error give 4
    .end
.end


proc should_log
    lvl: LogLevel
-> bool

    if not GLOBAL_LOG_CONFIG.enabled
        give false
    .end

    give
        level_value(lvl) >=
        level_value(GLOBAL_LOG_CONFIG.level)
.end


proc prefix
    lvl: LogLevel
-> string

    select lvl
        when LogLevel::Trace give "[TRACE] "
        when LogLevel::Debug give "[DEBUG] "
        when LogLevel::Info  give "[INFO ] "
        when LogLevel::Warn  give "[WARN ] "
        when LogLevel::Error give "[ERROR] "
    .end
.end


# ------------------------------------------------------------
# Fonctions de log publiques
# ------------------------------------------------------------

proc log_trace
    msg: string
-> void

    if should_log(LogLevel::Trace)
        emit prefix(LogLevel::Trace) + msg
    .end
.end


proc log_debug
    msg: string
-> void

    if should_log(LogLevel::Debug)
        emit prefix(LogLevel::Debug) + msg
    .end
.end


proc log_info
    msg: string
-> void

    if should_log(LogLevel::Info)
        emit prefix(LogLevel::Info) + msg
    .end
.end


proc log_warn
    msg: string
-> void

    if should_log(LogLevel::Warn)
        emit prefix(LogLevel::Warn) + msg
    .end
.end


proc log_error
    msg: string
-> void

    if should_log(LogLevel::Error)
        emit prefix(LogLevel::Error) + msg
    .end
.end
