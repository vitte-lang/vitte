
# ============================================================================
# Muffin Manifest Format (MUF) â€” Grammar (EBNF)
#
# Goal:
#   - Deterministic, TOML-like manifest DSL for building/packaging Vitte projects
#   - Human-editable, line-oriented, with explicit block terminators: `.end`
#   - No braces required in user-facing syntax (legacy braces/maps are optional)
#
# Notes:
#   - This grammar defines syntax only. See `muf_semantics.md` for meaning.
#   - Whitespace is generally flexible; NEWLINE separates statements.
#   - Comments: `# ...` and `// ...` to end-of-line.
# ============================================================================

MufFile         = Spacing, { TopItem, Spacing }, EOF ;

TopItem         = Comment
                | EmptyLine
                | IncludeDecl
                | WorkspaceDecl
                | PackageDecl
                | ModuleDecl
                | TargetDecl
                | ProfileDecl
                | ToolchainDecl
                | DepsDecl
                | ScriptsDecl
                | PublishDecl
                | LockDecl
                | MetaDecl
                ;

# ----------------------------------------------------------------------------
# Top-level declarations
# ----------------------------------------------------------------------------

IncludeDecl     = "include", WS1, String, LineEnd ;

WorkspaceDecl   = "workspace", WS1, ModulePath, LineEnd,
                  WorkspaceBody,
                  EndBlock ;

PackageDecl     = "package", WS1, Ident, LineEnd,
                  PackageBody,
                  EndBlock ;

ModuleDecl      = "module", WS1, ModulePath, LineEnd,
                  ModuleBody,
                  EndBlock ;

TargetDecl      = "target", WS1, Ident, LineEnd,
                  TargetBody,
                  EndBlock ;

ProfileDecl     = "profile", WS1, Ident, LineEnd,
                  ProfileBody,
                  EndBlock ;

ToolchainDecl   = "toolchain", WS1, Ident, LineEnd,
                  ToolchainBody,
                  EndBlock ;

DepsDecl        = "deps", LineEnd,
                  DepsBody,
                  EndBlock ;

ScriptsDecl     = "scripts", LineEnd,
                  ScriptsBody,
                  EndBlock ;

PublishDecl     = "publish", LineEnd,
                  PublishBody,
                  EndBlock ;

LockDecl        = "lock", LineEnd,
                  LockBody,
                  EndBlock ;

MetaDecl        = "meta", LineEnd,
                  MetaBody,
                  EndBlock ;

# ----------------------------------------------------------------------------
# Bodies (each body is a list of items terminated by `.end`)
# ----------------------------------------------------------------------------

WorkspaceBody   = { Spacing, ( KvStmt
                              | MembersDecl
                              | WorkspacePathsDecl
                              | FeaturesDecl
                              | OverridesDecl
                              | AllowDenyDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

PackageBody     = { Spacing, ( KvStmt
                              | AuthorsDecl
                              | LicenseDecl
                              | ReadmeDecl
                              | HomepageDecl
                              | RepositoryDecl
                              | KeywordsDecl
                              | CategoriesDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

ModuleBody      = { Spacing, ( KvStmt
                              | SourcesDecl
                              | ExportsDecl
                              | ImportsDecl
                              | FeaturesDecl
                              | DepsInlineDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

TargetBody      = { Spacing, ( KvStmt
                              | DefinesDecl
                              | LinkDecl
                              | CFlagsDecl
                              | LdFlagsDecl
                              | EnvDecl
                              | StepsDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

ProfileBody     = { Spacing, ( KvStmt
                              | OptDecl
                              | DebugDecl
                              | SanitizersDecl
                              | LtoDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

ToolchainBody   = { Spacing, ( KvStmt
                              | CCompilerDecl
                              | AsmDecl
                              | LinkerDecl
                              | SysrootDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

DepsBody        = { Spacing, ( DepEntry
                              | DepGroupDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

ScriptsBody     = { Spacing, ( ScriptEntry
                              | ScriptGroupDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

PublishBody     = { Spacing, ( KvStmt
                              | ArtifactsDecl
                              | ChecksumsDecl
                              | SignDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

LockBody        = { Spacing, ( KvStmt
                              | LockEntry
                              | Comment
                              | EmptyLine ), Spacing } ;

MetaBody        = { Spacing, ( KvStmt
                              | Comment
                              | EmptyLine ), Spacing } ;

# ----------------------------------------------------------------------------
# Common statements
# ----------------------------------------------------------------------------

KvStmt          = Key, Spacing, "=", Spacing, Value, LineEnd ;

Key             = Ident, { ".", Ident } ;

Value           = String
                | Bool
                | Int
                | Float
                | Version
                | Path
                | Array
                | InlineTable
                | IdentRef
                ;

IdentRef        = "@", Ident, { ".", Ident } ;

# Arrays: [a, b, c]
Array           = "[", Spacing,
                  [ Value, Spacing, { ",", Spacing, Value, Spacing }, [ ",", Spacing ] ],
                  "]" ;

# Inline tables: { key = value, ... }
InlineTable     = "{", Spacing,
                  [ KvPair, Spacing, { ",", Spacing, KvPair, Spacing }, [ ",", Spacing ] ],
                  "}" ;

KvPair          = Key, Spacing, "=", Spacing, Value ;

# ----------------------------------------------------------------------------
# Workspace helpers
# ----------------------------------------------------------------------------

MembersDecl     = "members", LineEnd,
                  ListBody,
                  EndBlock ;

WorkspacePathsDecl = "paths", LineEnd,
                     ListBody,
                     EndBlock ;

OverridesDecl   = "overrides", LineEnd,
                  OverridesBody,
                  EndBlock ;

OverridesBody   = { Spacing, ( OverrideEntry
                              | Comment
                              | EmptyLine ), Spacing } ;

OverrideEntry   = "override", WS1, ModulePath, LineEnd,
                  { Spacing, ( KvStmt | Comment | EmptyLine ), Spacing },
                  EndBlock ;

AllowDenyDecl   = ("allow" | "deny"), WS1, Ident, LineEnd ;

# ----------------------------------------------------------------------------
# Package helpers
# ----------------------------------------------------------------------------

AuthorsDecl     = "authors", WS1, Array, LineEnd ;
LicenseDecl     = "license", WS1, String, LineEnd ;
ReadmeDecl      = "readme", WS1, PathOrString, LineEnd ;
HomepageDecl    = "homepage", WS1, String, LineEnd ;
RepositoryDecl  = "repository", WS1, String, LineEnd ;
KeywordsDecl    = "keywords", WS1, Array, LineEnd ;
CategoriesDecl  = "categories", WS1, Array, LineEnd ;

PathOrString    = Path | String ;

# ----------------------------------------------------------------------------
# Module helpers
# ----------------------------------------------------------------------------

SourcesDecl     = "sources", LineEnd,
                  ListBody,
                  EndBlock ;

ExportsDecl     = "exports", LineEnd,
                  ListBody,
                  EndBlock ;

ImportsDecl     = "imports", LineEnd,
                  ListBody,
                  EndBlock ;

FeaturesDecl    = "features", LineEnd,
                  FeaturesBody,
                  EndBlock ;

FeaturesBody    = { Spacing, ( FeatureEntry
                              | Comment
                              | EmptyLine ), Spacing } ;

FeatureEntry    = "feature", WS1, Ident, LineEnd,
                  { Spacing, ( KvStmt
                              | "enable", WS1, Ident, LineEnd
                              | "disable", WS1, Ident, LineEnd
                              | Comment
                              | EmptyLine ), Spacing },
                  EndBlock ;

DepsInlineDecl  = "deps", LineEnd,
                  DepsBody,
                  EndBlock ;

# ----------------------------------------------------------------------------
# Target helpers
# ----------------------------------------------------------------------------

DefinesDecl     = "defines", LineEnd,
                  MapBody,
                  EndBlock ;

LinkDecl        = "link", LineEnd,
                  ListBody,
                  EndBlock ;

CFlagsDecl      = "cflags", LineEnd,
                  ListBody,
                  EndBlock ;

LdFlagsDecl     = "ldflags", LineEnd,
                  ListBody,
                  EndBlock ;

EnvDecl         = "env", LineEnd,
                  MapBody,
                  EndBlock ;

StepsDecl       = "steps", LineEnd,
                  StepsBody,
                  EndBlock ;

StepsBody       = { Spacing, ( StepEntry
                              | Comment
                              | EmptyLine ), Spacing } ;

StepEntry       = "step", WS1, Ident, LineEnd,
                  { Spacing, ( KvStmt
                              | RunDecl
                              | InputsDecl
                              | OutputsDecl
                              | Comment
                              | EmptyLine ), Spacing },
                  EndBlock ;

RunDecl         = "run", WS1, String, LineEnd ;
InputsDecl      = "inputs", WS1, Array, LineEnd ;
OutputsDecl     = "outputs", WS1, Array, LineEnd ;

# ----------------------------------------------------------------------------
# Profile helpers
# ----------------------------------------------------------------------------

OptDecl         = "opt", WS1, ("0"|"1"|"2"|"3"|"s"|"z"), LineEnd ;
DebugDecl       = "debug", WS1, Bool, LineEnd ;
SanitizersDecl  = "sanitizers", WS1, Array, LineEnd ;
LtoDecl         = "lto", WS1, ("off"|"thin"|"full"), LineEnd ;

# ----------------------------------------------------------------------------
# Toolchain helpers
# ----------------------------------------------------------------------------

CCompilerDecl   = "cc", WS1, String, LineEnd ;
AsmDecl         = "asm", WS1, String, LineEnd ;
LinkerDecl      = "ld", WS1, String, LineEnd ;
SysrootDecl     = "sysroot", WS1, PathOrString, LineEnd ;

# ----------------------------------------------------------------------------
# Dependencies
# ----------------------------------------------------------------------------

DepEntry        = "dep", WS1, Ident, LineEnd,
                  DepBody,
                  EndBlock ;

DepGroupDecl    = "group", WS1, Ident, LineEnd,
                  { Spacing, ( DepEntry | Comment | EmptyLine ), Spacing },
                  EndBlock ;

DepBody         = { Spacing, ( KvStmt
                              | DepSourceDecl
                              | DepFeaturesDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

DepSourceDecl   = "source", WS1, DepSource, LineEnd ;

DepSource       = "path", WS1, PathOrString
                | "git", WS1, String, [ WS1, "rev", WS1, String ]
                | "registry", WS1, String
                ;

DepFeaturesDecl = "features", WS1, Array, LineEnd ;

# ----------------------------------------------------------------------------
# Scripts
# ----------------------------------------------------------------------------

ScriptEntry     = "script", WS1, Ident, LineEnd,
                  ScriptBody,
                  EndBlock ;

ScriptGroupDecl = "group", WS1, Ident, LineEnd,
                  { Spacing, ( ScriptEntry | Comment | EmptyLine ), Spacing },
                  EndBlock ;

ScriptBody      = { Spacing, ( KvStmt
                              | RunDecl
                              | Comment
                              | EmptyLine ), Spacing } ;

# ----------------------------------------------------------------------------
# Publish / artifacts
# ----------------------------------------------------------------------------

ArtifactsDecl   = "artifacts", LineEnd,
                  ListBody,
                  EndBlock ;

ChecksumsDecl   = "checksums", LineEnd,
                  ListBody,
                  EndBlock ;

SignDecl        = "sign", WS1, Bool, LineEnd ;

# ----------------------------------------------------------------------------
# Lockfile entries (syntax-only; content defined in muf_lockfile.md)
# ----------------------------------------------------------------------------

LockEntry       = "entry", WS1, Ident, LineEnd,
                  { Spacing, ( KvStmt | Comment | EmptyLine ), Spacing },
                  EndBlock ;

# ----------------------------------------------------------------------------
# Generic list/map blocks
# ----------------------------------------------------------------------------

ListBody        = { Spacing, ( ListItem | Comment | EmptyLine ), Spacing } ;
ListItem        = "-", WS1, Value, LineEnd ;

MapBody         = { Spacing, ( MapItem | Comment | EmptyLine ), Spacing } ;
MapItem         = Key, Spacing, ":", Spacing, Value, LineEnd ;

# ----------------------------------------------------------------------------
# Block terminators
# ----------------------------------------------------------------------------

EndBlock        = ".end", LineEnd ;

# ----------------------------------------------------------------------------
# Lexical grammar
# ----------------------------------------------------------------------------

ModulePath      = Ident, { ("." | "/"), Ident } ;

Ident           = IdentStart, { IdentCont } ;
IdentStart      = Letter | "_" ;
IdentCont       = Letter | Digit | "_" | "-" ;

String          = DQString | SQString ;
DQString        = '"', { DQChar }, '"' ;
SQString        = "'", { SQChar }, "'" ;

DQChar          = Escape | ( ? any char except '"' and NEWLINE ? ) ;
SQChar          = Escape | ( ? any char except "'" and NEWLINE ? ) ;

Escape          = "\\", ("\\"|"\""|"'"|"n"|"r"|"t"|"0"|"x", Hex, Hex | "u", Hex, Hex, Hex, Hex) ;

Bool            = "true" | "false" ;

Int             = ["+"|"-"], Digit, { Digit } ;
Float           = ["+"|"-"], Digit, { Digit }, ".", Digit, { Digit }, [ Exponent ]
                | ["+"|"-"], Digit, { Digit }, Exponent ;
Exponent        = ("e"|"E"), ["+"|"-"], Digit, { Digit } ;

# Version is treated as a string token by the lexer, but recognized here
Version         = "v", Digit, { Digit }, ".", Digit, { Digit }, ".", Digit, { Digit },
                  [ ("-"|"+"), Ident, { ("."|"-"), Ident } ] ;

# Paths can be unquoted when safe, or quoted strings
Path            = PathBare | ("path", "(", Spacing, String, Spacing, ")") ;
PathBare        = "." | ".." | PathSeg, { "/", PathSeg } ;
PathSeg         = Ident | Digit, { Digit } ;

Letter          = "A".."Z" | "a".."z" ;
Digit           = "0".."9" ;
Hex             = Digit | "A".."F" | "a".."f" ;

# ----------------------------------------------------------------------------
# Whitespace / comments / line endings
# ----------------------------------------------------------------------------

LineEnd         = Spacing, ( NEWLINE | EOF ) ;

Spacing         = { WS | Comment } ;
WS              = " " | "\t" ;
WS1             = WS, { WS } ;

NEWLINE         = "\n" | "\r\n" ;
EOF             = ? end of input ? ;

Comment         = HashComment | SlashComment ;
HashComment     = "#", { ? any char except NEWLINE ? }, (NEWLINE | EOF) ;
SlashComment    = "//", { ? any char except NEWLINE ? }, (NEWLINE | EOF) ;

EmptyLine       = Spacing, NEWLINE ;
