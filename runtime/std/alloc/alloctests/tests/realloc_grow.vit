space vitte/runtime/std/alloc/alloctests/tests

# ============================================================
# Realloc grow correctness tests
# - Validates allocator behavior when growing allocations
# - Focus on data preservation and stability
# ============================================================

pull vitte/runtime/std/alloc/alloctests/tests/utils

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

proc fill_pattern(buf: List of u8, value: u8)
    let i = 0
    loop while i < buf.len
        buf[i] = value
        i = i + 1
    .end
.end

proc check_pattern(buf: List of u8, value: u8) give bool
    let i = 0
    loop while i < buf.len
        if buf[i] != value
            give false
        .end
        i = i + 1
    .end
    give true
.end

# ------------------------------------------------------------
# Tests
# ------------------------------------------------------------

proc test_realloc_grow_small give bool
    # Start small
    let buf: List of u8 = []
    let i = 0
    loop while i < 16
        buf.push(0)
        i = i + 1
    .end

    fill_pattern(buf, 0xAA)

    # Grow buffer
    let j = 0
    loop while j < 128
        buf.push(0)
        j = j + 1
    .end

    # Verify original region preserved
    let k = 0
    loop while k < 16
        if buf[k] != 0xAA
            panic("data corruption on small realloc grow")
        .end
        k = k + 1
    .end

    give true
.end

proc test_realloc_grow_medium give bool
    # Start medium
    let buf: List of u8 = []
    let i = 0
    loop while i < 256
        buf.push(0)
        i = i + 1
    .end

    fill_pattern(buf, 0x55)

    # Grow significantly
    let j = 0
    loop while j < 4_096
        buf.push(0)
        j = j + 1
    .end

    # Verify preserved data
    utils::assert_true(check_pattern(buf.slice(0, 256), 0x55),
        "data corruption on medium realloc grow")

    give true
.end

proc test_realloc_grow_multiple_steps give bool
    let buf: List of u8 = []

    let step = 0
    loop while step < 8
        # Append 64 bytes each step
        let i = 0
        loop while i < 64
            buf.push(step as u8)
            i = i + 1
        .end
        step = step + 1
    .end

    # Verify each segment preserved
    let seg = 0
    loop while seg < 8
        let start = seg * 64
        let i = 0
        loop while i < 64
            if buf[start + i] != (seg as u8)
                panic("data corruption in multi-step realloc grow")
            .end
            i = i + 1
        .end
        seg = seg + 1
    .end

    give true
.end

# ------------------------------------------------------------
# Entry
# ------------------------------------------------------------

proc realloc_grow_tests give bool
    test_realloc_grow_small()
    test_realloc_grow_medium()
    test_realloc_grow_multiple_steps()
    give true
.end
