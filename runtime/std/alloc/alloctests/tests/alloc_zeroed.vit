space vitte/runtime/std/alloc/alloctests/tests

# ============================================================
# Zeroed allocation correctness tests
# - Verifies memory returned is zero-initialized
# - Critical for alloc_zeroed / calloc-like paths
# ============================================================

pull vitte/runtime/std/alloc/alloctests/tests/utils

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

proc is_all_zero(buf: List of u8) give bool
    let i = 0
    loop while i < buf.len
        if buf[i] != 0
            give false
        .end
        i = i + 1
    .end
    give true
.end

# ------------------------------------------------------------
# Tests
# ------------------------------------------------------------

proc test_zeroed_small give bool
    let buf: List of u8 = []
    let i = 0
    loop while i < 64
        buf.push(0)
        i = i + 1
    .end
    utils::assert_true(is_all_zero(buf), "small zeroed alloc failed")
    give true
.end

proc test_zeroed_medium give bool
    let buf: List of u8 = []
    let i = 0
    loop while i < 4_096
        buf.push(0)
        i = i + 1
    .end
    utils::assert_true(is_all_zero(buf), "medium zeroed alloc failed")
    give true
.end

proc test_zeroed_reuse give bool
    # Allocate, drop, reallocate and verify zeroing again
    let buf1: List of u8 = []
    let i = 0
    loop while i < 256
        buf1.push(0)
        i = i + 1
    .end
    utils::assert_true(is_all_zero(buf1), "initial zeroed alloc failed")

    # drop buf1
    let buf2: List of u8 = []
    let j = 0
    loop while j < 256
        buf2.push(0)
        j = j + 1
    .end
    utils::assert_true(is_all_zero(buf2), "reused zeroed alloc failed")
    give true
.end

# ------------------------------------------------------------
# Entry
# ------------------------------------------------------------

proc alloc_zeroed_tests give bool
    test_zeroed_small()
    test_zeroed_medium()
    test_zeroed_reuse()
    give true
.end
