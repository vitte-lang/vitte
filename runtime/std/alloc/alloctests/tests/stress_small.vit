space vitte/runtime/std/alloc/alloctests/tests

# ============================================================
# Small allocation stress tests
# - Focus on tiny sizes and hot-path allocator behavior
# - Deterministic, high-iteration stress
# ============================================================

pull vitte/runtime/std/alloc/alloctests/tests/utils

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

proc fill(buf: List of u8, v: u8)
    let i = 0
    loop while i < buf.len
        buf[i] = v
        i = i + 1
    .end
.end

proc check(buf: List of u8, v: u8) give bool
    let i = 0
    loop while i < buf.len
        if buf[i] != v
            give false
        .end
        i = i + 1
    .end
    give true
.end

# ------------------------------------------------------------
# Stress workload
# ------------------------------------------------------------

proc stress_small_once(iter: usize)
    let r = 0xA5A5A5A5_u64 + (iter as u64)
    let blocks: List of List of u8 = []

    # Initial tiny allocations
    let i = 0
    loop while i < 128
        let size = 1 + ((r + i) % 32)
        let buf: List of u8 = []
        let j = 0
        loop while j < size
            buf.push(0)
            j = j + 1
        .end
        fill(buf, (i & 0xFF) as u8)
        blocks.push(buf)
        i = i + 1
    .end

    # Hot-path churn
    let k = 0
    loop while k < 2_048
        let idx = (r + k) % blocks.len
        let op = (r + k) % 3

        if op == 0
            # free + realloc tiny
            blocks[idx] = []
            let size2 = 1 + ((r + k) % 32)
            let buf2: List of u8 = []
            let j2 = 0
            loop while j2 < size2
                buf2.push(0)
                j2 = j2 + 1
            .end
            fill(buf2, (k & 0xFF) as u8)
            blocks[idx] = buf2
        elif op == 1
            # grow slightly
            if blocks[idx].len < 64
                blocks[idx].push((k & 0xFF) as u8)
            .end
        else
            # shrink slightly
            if blocks[idx].len > 0
                blocks[idx].pop()
            .end
        .end

        # Validate prefix when non-empty
        if blocks[idx].len > 0
            let v = blocks[idx][0]
            utils::assert_true(check(blocks[idx].slice(0, 1), v),
                "data corruption in small stress")
        .end

        k = k + 1
    .end
.end

# ------------------------------------------------------------
# Tests
# ------------------------------------------------------------

proc test_stress_small_short give bool
    let i = 0
    loop while i < 8
        stress_small_once(i)
        i = i + 1
    .end
    give true
.end

proc test_stress_small_long give bool
    let i = 0
    loop while i < 32
        stress_small_once(i)
        i = i + 1
    .end
    give true
.end

# ------------------------------------------------------------
# Entry
# ------------------------------------------------------------

proc stress_small_tests give bool
    test_stress_small_short()
    test_stress_small_long()
    give true
.end
