space vitte/runtime/std/alloc/alloctests/tests

# ============================================================
# Realloc shrink correctness tests
# - Validates allocator behavior when shrinking allocations
# - Ensures data preservation and safe truncation
# ============================================================

pull vitte/runtime/std/alloc/alloctests/tests/utils

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

proc fill_pattern(buf: List of u8, value: u8)
    let i = 0
    loop while i < buf.len
        buf[i] = value
        i = i + 1
    .end
.end

proc check_prefix(buf: List of u8, len: usize, value: u8) give bool
    let i = 0
    loop while i < len
        if buf[i] != value
            give false
        .end
        i = i + 1
    .end
    give true
.end

# ------------------------------------------------------------
# Tests
# ------------------------------------------------------------

proc test_realloc_shrink_small give bool
    # Start with a medium buffer
    let buf: List of u8 = []
    let i = 0
    loop while i < 128
        buf.push(0)
        i = i + 1
    .end

    fill_pattern(buf, 0xAB)

    # Shrink to small size
    let k = 0
    loop while k < 96
        buf.pop()
        k = k + 1
    .end

    utils::assert_len(buf, 32, "shrink small length mismatch")
    utils::assert_true(check_prefix(buf, 32, 0xAB),
        "data corruption on small realloc shrink")

    give true
.end

proc test_realloc_shrink_to_zero give bool
    # Allocate then shrink to zero
    let buf: List of u8 = []
    let i = 0
    loop while i < 64
        buf.push(0)
        i = i + 1
    .end

    fill_pattern(buf, 0xCD)

    # Shrink fully
    let j = 0
    loop while j < 64
        buf.pop()
        j = j + 1
    .end

    utils::assert_len(buf, 0, "shrink to zero failed")
    give true
.end

proc test_realloc_shrink_stepwise give bool
    # Gradual shrink, checking prefix each time
    let buf: List of u8 = []
    let i = 0
    loop while i < 256
        buf.push(0)
        i = i + 1
    .end

    fill_pattern(buf, 0xEF)

    let step = 0
    loop while step < 8
        # Remove 16 bytes per step
        let k = 0
        loop while k < 16
            buf.pop()
            k = k + 1
        .end

        let expected = 256 - ((step + 1) * 16)
        utils::assert_len(buf, expected, "stepwise shrink length mismatch")
        utils::assert_true(check_prefix(buf, expected, 0xEF),
            "data corruption during stepwise realloc shrink")

        step = step + 1
    .end

    give true
.end

# ------------------------------------------------------------
# Entry
# ------------------------------------------------------------

proc realloc_shrink_tests give bool
    test_realloc_shrink_small()
    test_realloc_shrink_to_zero()
    test_realloc_shrink_stepwise()
    give true
.end
