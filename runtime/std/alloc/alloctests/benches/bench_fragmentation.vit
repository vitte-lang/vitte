space vitte/runtime/std/alloc/alloctests/benches

# ============================================================
# Allocator fragmentation benchmark
# - Stress allocator with churn + varying sizes
# - Measures time cost; fragmentation analysis is implicit
# ============================================================

pull vitte/runtime/std/alloc/alloctests/benches/utils

# ------------------------------------------------------------
# Fragmentation workload
# ------------------------------------------------------------

proc fragmentation_workload()
    let r = utils::rng_default()
    let blocks: List of List of u8 = []

    # Initial population
    let i = 0
    loop while i < 1_000
        let size = utils::next_range(r, 8, 4096)
        let buf: List of u8 = []
        let j = 0
        loop while j < size
            buf.push(0)
            j = j + 1
        .end
        blocks.push(buf)
        i = i + 1
    .end

    # Churn phase: random free + alloc
    let k = 0
    loop while k < 5_000
        let idx = utils::next_range(r, 0, blocks.len)
        blocks[idx] = []   # drop block

        let size = utils::next_range(r, 8, 4096)
        let buf2: List of u8 = []
        let j2 = 0
        loop while j2 < size
            buf2.push(0)
            j2 = j2 + 1
        .end
        blocks[idx] = buf2

        k = k + 1
    .end
.end

# ------------------------------------------------------------
# Bench runner
# ------------------------------------------------------------

proc bench_fragmentation()
    let cfg = utils::MeasureConfig(
        name: "alloc_fragmentation",
        warmup: 50,
        iterations: 200
    )
    do utils::measure(cfg, fragmentation_workload)
.end
