

; ============================================================================
; bench/config/targets/darwin_x86_64.ini
;
; Target profile for micro-benchmarks on macOS (Darwin) x86_64 (Intel Macs).
;
; Intended consumer:
;   - a thin bench runner / build wrapper that compiles files in bench/micro/
;   - reuses the same include tree as the main repo (include/)
;
; Philosophy:
;   - Keep the format stable and boring (ini).
;   - Provide both a “system clang” path and an optional “zig cc” override.
;   - Separate debug/release flag sets.
;
; Notes (Darwin specifics):
;   - pthread is part of libSystem; linking -lpthread is usually unnecessary.
;   - If you use zig cc, you may need to pass -target x86_64-apple-darwin and
;     a valid -isysroot from xcrun.
; ============================================================================

[target]
name = darwin_x86_64
os = darwin
arch = x86_64
triple = x86_64-apple-darwin
endianness = little
pointer_bits = 64

[toolchain]
; Prefer clang on macOS.
; If you want hermetic builds, use zig:
;   cc = /path/to/zig cc
; You can keep this file as a “default” and override in your runner.
cc = clang
cxx = clang++

; Optional: xcrun helpers (if your runner supports calling these).
; sdk_path_cmd = xcrun --sdk macosx --show-sdk-path
; clang_cmd    = xcrun --sdk macosx clang

[paths]
; Repo-relative paths (runner should resolve relative to workspace root).
include_dir = include
src_root = .
bench_root = bench/micro
out_dir = target/bench
obj_dir = target/bench/obj

[defines]
; Common compile-time defines for benches.
STEEL_POSIX = 1
STEEL_DARWIN = 1
STEEL_ARCH_X86_64 = 1
STEEL_BENCH = 1

; Optional: enable x86_64-specific fast paths in your codebase.
; STEEL_HAVE_SSE2 = 1
; STEEL_HAVE_PCLMUL = 1

[cflags.common]
std = -std=c11
warnings = -Wall -Wextra -Wshadow -Wstrict-prototypes -Wmissing-prototypes
frameptr = -fno-omit-frame-pointer
includes = -Iinclude

; Conservative baseline (Intel Macs typically support >= 10.13, pick 11.0 to
; match the arm64 profile unless you need older).
macos_min = -mmacosx-version-min=11.0

[cflags.debug]
opt = -O0
dbg = -g
san = ; (optional) -fsanitize=address,undefined

[cflags.release]
opt = -O2
ndebug = -DNDEBUG=1
lto = ; (optional) -flto

[ldflags.common]
libs =
frameworks =

[ldflags.debug]
extra =

[ldflags.release]
extra =

[run]
exe_prefix =

env =

[bench]
lexer_default = --bytes 1048576 --iters 200 --warmup 20
parser_default = --bytes 1048576 --funcs 512 --stmts 6 --iters 200 --warmup 20
backend_c_default = --iters 10000 --warmup 200 --outdir target/bench
pal_fs_default = --iters 2000 --warmup 100 --dir target/bench_fs --payload 4096

qos =

; Notes:
; - If you produce universal2 binaries, your runner can override cc + flags
;   and build both darwin_arm64 and darwin_x86_64 profiles.
; - If you add asm variants (x86_64/memwipe.S, x86_64/ct_eq.S), wire them in
;   your bench harness and define STEEL_HAVE_ASM_MEMWIPE/STEEL_HAVE_ASM_CT_EQ.