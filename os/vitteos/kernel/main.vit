use std/kernel/console as console
use std/kernel/shell as shell
use std/kernel/task as task
use std/kernel/time as time
use std/core/types.Unit

proc write_prompt() -> Unit {
  console.write_byte(118)
  console.write_byte(105)
  console.write_byte(116)
  console.write_byte(116)
  console.write_byte(101)
  console.write_byte(79)
  console.write_byte(83)
  console.write_byte(62)
  console.write_byte(32)
  return
}

proc write_nl() -> Unit {
  console.write_byte(13)
  console.write_byte(10)
  return
}

proc write_help() -> Unit {
  console.write_byte(104) # h
  console.write_byte(101) # e
  console.write_byte(108) # l
  console.write_byte(112) # p
  console.write_byte(58)
  console.write_byte(32)
  console.write_byte(104)
  console.write_byte(101)
  console.write_byte(108)
  console.write_byte(112)
  console.write_byte(44)
  console.write_byte(32)
  console.write_byte(101)
  console.write_byte(99)
  console.write_byte(104)
  console.write_byte(111)
  console.write_byte(44)
  console.write_byte(32)
  console.write_byte(116)
  console.write_byte(105)
  console.write_byte(99)
  console.write_byte(107)
  console.write_byte(115)
  console.write_byte(44)
  console.write_byte(32)
  console.write_byte(99)
  console.write_byte(108)
  console.write_byte(101)
  console.write_byte(97)
  console.write_byte(114)
  console.write_byte(44)
  console.write_byte(32)
  console.write_byte(114)
  console.write_byte(101)
  console.write_byte(98)
  console.write_byte(111)
  console.write_byte(111)
  console.write_byte(116)
  write_nl()
  return
}

proc write_unknown() -> Unit {
  console.write_byte(117)
  console.write_byte(110)
  console.write_byte(107)
  console.write_byte(110)
  console.write_byte(111)
  console.write_byte(119)
  console.write_byte(110)
  write_nl()
  return
}

proc clear_screen() -> Unit {
  let i = 0
  loop {
    if i >= 30 {
      return
    }
    write_nl()
    i = i + 1
  }
  return
}

proc shell_loop() -> Unit {
  loop {
    write_prompt()
    let cmd = shell.read_cmd()
    if cmd == shell.CMD_HELP {
      write_help()
    } else if cmd == shell.CMD_ECHO {
      shell.write_arg()
      write_nl()
    } else if cmd == shell.CMD_TICKS {
      let _ = time.ticks()
      write_nl()
    } else if cmd == shell.CMD_CLEAR {
      clear_screen()
    } else if cmd == shell.CMD_REBOOT {
      loop {
        task.yield()
      }
    } else if cmd == shell.CMD_UNKNOWN {
      write_unknown()
    }
  }
  return
}

entry main at core/app {
  shell_loop()

  return 0
}
