use std/cli/args
use std/core/types.Unit
use std/core/types.i32
use std/core/types.u8
use std/core/types.string

<<<
externs (VitteOS syscalls/libc)
>>>

#[extern]
proc stdin_fd() -> i32

#[extern]
proc open_read(path: string) -> i32

#[extern]
proc read_byte(fd: i32) -> i32

#[extern]
proc close(fd: i32) -> Unit

#[extern]
proc print_err(path: string) -> Unit

#[extern]
proc write_byte(b: u8) -> Unit

form State {
  col: i32
  lastc: i32
  sflag: i32
  tflag: i32
}

proc is_printable(c: i32) -> bool {
  if c >= 32 {
    if c <= 126 {
      give true
    }
  }
  give false
}

proc put_char(st: *State, c_in: i32) -> Unit {
  let c = c_in
  let inc = c
  if c == 10 {
    if st.lastc == 32 {
      write_byte(92)
      write_byte(110)
    }
  } else {
    if st.col >= 66 {
      write_byte(92)
      write_byte(10)
      write_byte(9)
      st.col = 8
    }
    if st.tflag != 0 {
      if c == 9 {
        st.col = st.col + 7
      }
    }
    if c == 8 {
      write_byte(92)
      write_byte(98)
      st.col = st.col + 1
    } else if c == 92 {
      write_byte(92)
      write_byte(92)
      st.col = st.col + 1
    } else if c == 9 {
      write_byte(92)
      write_byte(116)
      st.col = st.col + 1
    } else {
      if c >= 128 || c < 32 || c == 127 {
        write_byte(92)
        let d1 = (c / 64) % 4
        let d2 = (c / 8) % 8
        let d3 = c - (c / 8) * 8
        write_byte((d1 + 48) as u8)
        write_byte((d2 + 48) as u8)
        write_byte((d3 + 48) as u8)
        st.col = st.col + 3
        c = d3 + 48
      }
    }
    st.col = st.col + 1
  }
  write_byte(c as u8)
  if c == 10 {
    st.col = 0
  }
  st.lastc = inc
  return
}

proc sput(st: *State, c: i32) -> Unit {
  if is_printable(c) || c == 9 || c == 10 {
    write_byte(c as u8)
  }
}

proc is_flag(arg: string, ch: string) -> bool {
  if arg.len < 2 {
    give false
  }
  if arg.slice(0, 1) != "-" {
    give false
  }
  if arg.slice(1, 2) == ch {
    give true
  }
  give false
}

proc printfile(st: *State, path: string, use_stdin: bool) -> Unit {
  let fd: i32 = 0
  if use_stdin {
    fd = stdin_fd()
  } else {
    fd = open_read(path)
  }
  if fd < 0 {
    print_err(path)
    return
  }
  loop {
    let c = read_byte(fd)
    if c < 0 {
      break
    }
    if st.sflag != 0 {
      sput(st, c)
    } else {
      put_char(st, c)
    }
  }
  close(fd)
}

entry main at core/app {
  let argv = args()
  let st = State(col = 0, lastc = 0, sflag = 0, tflag = 0)
  let nprintfiles: i32 = 0

  let i: i32 = 1
  loop {
    if i >= argv.len as i32 {
      break
    }
    let arg = argv[i as usize]
    if is_flag(arg, "s") {
      st.sflag = st.sflag + 1
    } else if is_flag(arg, "t") {
      st.tflag = st.tflag + 1
    } else {
      printfile(&st, arg, false)
      nprintfiles = nprintfiles + 1
    }
    i = i + 1
  }

  if nprintfiles == 0 {
    printfile(&st, "", true)
  }
  return 0
}
