# ============================================================
# vitte_const_eval :: context
# Constant evaluation context and configuration
# ============================================================

space vitte/core/const_eval

pull vitte/core/const_eval/error
pull vitte/core/const_eval/value

# ------------------------------------------------------------
# ConstEvalMode
# ------------------------------------------------------------

# Defines how strict the evaluator is
pick ConstEvalMode
    Strict        # compile-time only, no UB tolerated
    Relaxed       # allow some runtime-like behaviors
.end

# ------------------------------------------------------------
# ConstEvalLimits
# ------------------------------------------------------------

# Hard limits to prevent runaway evaluation
form ConstEvalLimits
    max_steps: UInt
    max_depth: UInt
    max_expr_size: UInt
.end

proc ConstEvalLimits::default()
    gives ConstEvalLimits
    give ConstEvalLimits {
        max_steps: 10_000,
        max_depth: 256,
        max_expr_size: 1_024,
    }
.end

# ------------------------------------------------------------
# ConstEvalFlags
# ------------------------------------------------------------

# Feature toggles
form ConstEvalFlags
    checked_arith: Bool        # overflow checks
    allow_float: Bool          # allow float const-eval
    allow_div_zero: Bool       # usually false
    allow_pointer: Bool        # future-proof
    allow_bitwise: Bool
.end

proc ConstEvalFlags::strict()
    gives ConstEvalFlags
    give ConstEvalFlags {
        checked_arith: true,
        allow_float: true,
        allow_div_zero: false,
        allow_pointer: false,
        allow_bitwise: true,
    }
.end

proc ConstEvalFlags::relaxed()
    gives ConstEvalFlags
    give ConstEvalFlags {
        checked_arith: false,
        allow_float: true,
        allow_div_zero: true,
        allow_pointer: false,
        allow_bitwise: true,
    }
.end

# ------------------------------------------------------------
# ConstEvalStats
# ------------------------------------------------------------

# Runtime statistics (debug / diagnostics)
form ConstEvalStats
    steps: UInt
    depth: UInt
.end

proc ConstEvalStats::new()
    gives ConstEvalStats
    give ConstEvalStats {
        steps: 0,
        depth: 0,
    }
.end

# ------------------------------------------------------------
# ConstEvalContext
# ------------------------------------------------------------

form ConstEvalContext
    mode: ConstEvalMode
    flags: ConstEvalFlags
    limits: ConstEvalLimits
    stats: ConstEvalStats
.end

# ------------------------------------------------------------
# Constructors
# ------------------------------------------------------------

proc ConstEvalContext::new(mode: ConstEvalMode)
    gives ConstEvalContext

    match mode
        Strict =>
            give ConstEvalContext {
                mode: Strict,
                flags: ConstEvalFlags::strict(),
                limits: ConstEvalLimits::default(),
                stats: ConstEvalStats::new(),
            }

        Relaxed =>
            give ConstEvalContext {
                mode: Relaxed,
                flags: ConstEvalFlags::relaxed(),
                limits: ConstEvalLimits::default(),
                stats: ConstEvalStats::new(),
            }
    .end
.end

proc ConstEvalContext::strict()
    gives ConstEvalContext
    give ConstEvalContext::new(Strict)
.end

proc ConstEvalContext::relaxed()
    gives ConstEvalContext
    give ConstEvalContext::new(Relaxed)
.end

# ------------------------------------------------------------
# Step / depth accounting
# ------------------------------------------------------------

proc ConstEvalContext::enter_expr(self: &mut ConstEvalContext)
    gives Result<(), ConstEvalError>

    self.stats.steps += 1
    self.stats.depth += 1

    if self.stats.steps > self.limits.max_steps
        give Error(ConstEvalError::StepLimitExceeded)

    if self.stats.depth > self.limits.max_depth
        give Error(ConstEvalError::DepthLimitExceeded)

    give Ok(())
.end

proc ConstEvalContext::leave_expr(self: &mut ConstEvalContext)
    self.stats.depth -= 1
.end

# ------------------------------------------------------------
# Policy helpers
# ------------------------------------------------------------

proc ConstEvalContext::checked_arith(self: &ConstEvalContext)
    gives Bool
    give self.flags.checked_arith
.end

proc ConstEvalContext::allow_float(self: &ConstEvalContext)
    gives Bool
    give self.flags.allow_float
.end

proc ConstEvalContext::allow_div_zero(self: &ConstEvalContext)
    gives Bool
    give self.flags.allow_div_zero
.end

proc ConstEvalContext::allow_bitwise(self: &ConstEvalContext)
    gives Bool
    give self.flags.allow_bitwise
.end

# ------------------------------------------------------------
# Validation helpers
# ------------------------------------------------------------

proc ConstEvalContext::require_float(self: &ConstEvalContext)
    gives Result<(), ConstEvalError>

    if !self.flags.allow_float
        give Error(ConstEvalError::FloatNotAllowed)

    give Ok(())
.end

proc ConstEvalContext::require_bitwise(self: &ConstEvalContext)
    gives Result<(), ConstEvalError>

    if !self.flags.allow_bitwise
        give Error(ConstEvalError::BitwiseNotAllowed)

    give Ok(())
.end

# ------------------------------------------------------------
# Reset / clone
# ------------------------------------------------------------

proc ConstEvalContext::reset_stats(self: &mut ConstEvalContext)
    self.stats = ConstEvalStats::new()
.end

proc ConstEvalContext::clone_shallow(self: &ConstEvalContext)
    gives ConstEvalContext

    give ConstEvalContext {
        mode: self.mode,
        flags: self.flags,
        limits: self.limits,
        stats: ConstEvalStats::new(),
    }
.end

# ------------------------------------------------------------
# Debug helpers (optional)
# ------------------------------------------------------------

proc ConstEvalContext::debug_summary(self: &ConstEvalContext)
    gives String

    give format(
        "ConstEvalContext(mode={:?}, steps={}, depth={})",
        self.mode,
        self.stats.steps,
        self.stats.depth
    )
.end
