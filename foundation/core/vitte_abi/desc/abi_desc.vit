# ============================================================
# Vitte â€” ABI Description
# File: desc/abi_desc.vit
#
# Role:
#   Canonical description of an Application Binary Interface.
#
# This file:
#   - Enumerates supported ABIs
#   - Describes their fundamental properties
#   - Acts as the bridge between target, calling convention,
#     mangling, and codegen
#
# Used by:
#   - vitte_target
#   - vitte_abi/calling
#   - vitte_symbol_mangling
#   - Codegen backends
#
# ============================================================

space foundation/core/vitte_abi/desc/abi_desc


# ============================================================
# ABI kind
# ============================================================

pick AbiKind
    SysV        # System V AMD64
    Win64       # Microsoft x64
    AArch64     # AAPCS64
    Wasm32      # WebAssembly (future)
    Custom      # User-defined ABI
.end


# ============================================================
# Object format
# ============================================================

pick ObjectFormat
    ELF
    COFF
    MachO
    Wasm
    Raw
.end


# ============================================================
# ABI capabilities / flags
# ============================================================

form AbiCaps
    has_red_zone: Bool          # SysV only
    has_shadow_space: Bool      # Win64 only
    supports_varargs: Bool
    supports_sret: Bool
    supports_vector_regs: Bool
.end


# ============================================================
# ABI descriptor
# ============================================================

form AbiDesc
    kind: AbiKind
    object_format: ObjectFormat

    # Calling convention family identifier
    calling: String

    # Pointer / word size (bytes)
    pointer_size: Int

    # Stack alignment (bytes)
    stack_align: Int

    # ABI capabilities
    caps: AbiCaps
.end


# ============================================================
# Canonical ABI constructors
# ============================================================

proc AbiDesc::sysv_amd64()
gives AbiDesc
.end
    give AbiDesc {
        kind: AbiKind::SysV,
        object_format: ObjectFormat::ELF,
        calling: "sysv",
        pointer_size: 8,
        stack_align: 16,
        caps: AbiCaps {
            has_red_zone: true,
            has_shadow_space: false,
            supports_varargs: true,
            supports_sret: true,
            supports_vector_regs: true,
        },
    }
.end


proc AbiDesc::win64()
gives AbiDesc
.end
    give AbiDesc {
        kind: AbiKind::Win64,
        object_format: ObjectFormat::COFF,
        calling: "win64",
        pointer_size: 8,
        stack_align: 16,
        caps: AbiCaps {
            has_red_zone: false,
            has_shadow_space: true,
            supports_varargs: true,
            supports_sret: true,
            supports_vector_regs: true,
        },
    }
.end


proc AbiDesc::aarch64()
gives AbiDesc
.end
    give AbiDesc {
        kind: AbiKind::AArch64,
        object_format: ObjectFormat::ELF,
        calling: "aarch64",
        pointer_size: 8,
        stack_align: 16,
        caps: AbiCaps {
            has_red_zone: false,
            has_shadow_space: false,
            supports_varargs: true,
            supports_sret: true,
            supports_vector_regs: true,
        },
    }
.end


# ============================================================
# Validation
# ============================================================

proc AbiDesc::validate(self)
gives ()
.end
    if self.pointer_size <= 0
        panic("ABI pointer_size must be positive")
    end

    if self.stack_align <= 0
        panic("ABI stack_align must be positive")
    end

    # Shadow space is only valid for Win64
    if self.caps.has_shadow_space && self.kind != AbiKind::Win64
        panic("shadow space is only valid for Win64 ABI")
    end
.end


# ============================================================
# Helpers
# ============================================================

proc AbiDesc::is_sysv(self)
gives Bool
.end
    give self.kind == AbiKind::SysV
.end


proc AbiDesc::is_win64(self)
gives Bool
.end
    give self.kind == AbiKind::Win64
.end


proc AbiDesc::is_aarch64(self)
gives Bool
.end
    give self.kind == AbiKind::AArch64
.end
