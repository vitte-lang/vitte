# ============================================================
# Vitte â€” ABI / Tests
# File: tests/abi_smoke.vit
#
# Role:
#   Smoke tests for ABI subsystems:
#     - layout
#     - classification
#     - lowering (signature, varargs)
#
# These tests are intentionally small, deterministic,
# and architecture-independent.
#
# ============================================================

space foundation/core/vitte_abi/tests/abi_smoke

pull foundation/core/vitte_abi/desc
pull foundation/core/vitte_abi/types
pull foundation/core/vitte_abi/layout
pull foundation/core/vitte_abi/classify
pull foundation/core/vitte_abi/lower
pull foundation/core/vitte_abi/errors


# ============================================================
# Minimal test helpers
# ============================================================

proc assert_eq_i(a: Int, b: Int, msg: String)
gives ()
.end
    if a != b
        panic(msg)
    end
.end


proc assert_true(v: Bool, msg: String)
gives ()
.end
    if !v
        panic(msg)
    end
.end


# ============================================================
# Layout tests
# ============================================================

proc test_layout_scalars()
gives ()
.end
    let i32 = layout::type_layout(types::AbiType::I32)
    assert_eq_i(i32.size, 4, "i32 size")
    assert_eq_i(i32.align, 4, "i32 align")

    let f64 = layout::type_layout(types::AbiType::F64)
    assert_eq_i(f64.size, 8, "f64 size")
    assert_eq_i(f64.align, 8, "f64 align")
.end


proc test_layout_struct()
gives ()
.end
    let s = layout::records::structs::compute_struct_layout([
        ("a", types::AbiType::I8),
        ("b", types::AbiType::I32),
        ("c", types::AbiType::I16),
    ])

    # Expected: align = 4, size = 12
    assert_eq_i(s.align, 4, "struct align")
    assert_eq_i(s.size, 12, "struct size")
.end


proc test_layout_union()
gives ()
.end
    let u = layout::records::unions::compute_union_layout([
        ("a", types::AbiType::I8),
        ("b", types::AbiType::I64),
    ])

    assert_eq_i(u.align, 8, "union align")
    assert_eq_i(u.size, 8, "union size")
.end


proc test_layout_simd()
gives ()
.end
    let v = layout::vectors::simd::compute_simd_layout(
        types::AbiType::F32,
        4
    )

    assert_eq_i(v.size, 16, "simd size")
    assert_eq_i(v.align, 16, "simd align")
.end


# ============================================================
# Classification tests
# ============================================================

proc test_classify_registers()
gives ()
.end
    let cls_i64 = classify::registers::classify(
        types::AbiType::I64,
        classify::registers::RegUse::Arg
    )

    assert_true(
        cls_i64.class == classify::registers::RegClass::GP,
        "i64 should be GP"
    )

    let cls_f64 = classify::registers::classify(
        types::AbiType::F64,
        classify::registers::RegUse::Arg
    )

    assert_true(
        cls_f64.class == classify::registers::RegClass::FP,
        "f64 should be FP"
    )
.end


proc test_classify_memory()
gives ()
.end
    let big = types::AbiType::Struct([
        ("a", types::AbiType::I64),
        ("b", types::AbiType::I64),
        ("c", types::AbiType::I64),
    ])

    let mem = classify::memory::classify_ret(Some(big))

    assert_true(
        mem.kind == classify::memory::MemoryKind::Indirect,
        "big struct must be sret"
    )
.end


# ============================================================
# Lowering tests
# ============================================================

proc test_lower_signature_sret_sysv()
gives ()
.end
    let abi = desc::AbiDesc::sysv_amd64()

    let big = types::AbiType::Struct([
        ("a", types::AbiType::I64),
        ("b", types::AbiType::I64),
        ("c", types::AbiType::I64),
    ])

    let sig = lower::lower_signature(
        abi,
        [ types::AbiType::I32 ],
        Some(big)
    )

    # sret pointer + 1 explicit argument
    assert_eq_i(sig.args.len(), 2, "sret arg count")
    assert_true(sig.ret.is_none(), "sret => no direct return")
.end


proc test_lower_varargs_models()
gives ()
.end
    let fixed = [
        types::AbiType::I32,
        types::AbiType::F64,
    ]

    let sysv = lower::lower_varargs(
        desc::AbiDesc::sysv_amd64(),
        fixed
    )
    assert_true(
        sysv.model == lower::VarArgModel::SysV,
        "sysv varargs model"
    )

    let win = lower::lower_varargs(
        desc::AbiDesc::win64(),
        fixed
    )
    assert_true(
        win.model == lower::VarArgModel::Win64,
        "win64 varargs model"
    )

    let arm = lower::lower_varargs(
        desc::AbiDesc::aarch64(),
        fixed
    )
    assert_true(
        arm.model == lower::VarArgModel::AArch64,
        "aarch64 varargs model"
    )
.end


# ============================================================
# Test entry point
# ============================================================

proc run_abi_smoke_tests()
gives ()
.end
    test_layout_scalars()
    test_layout_struct()
    test_layout_union()
    test_layout_simd()

    test_classify_registers()
    test_classify_memory()

    test_lower_signature_sret_sysv()
    test_lower_varargs_models()
.end
