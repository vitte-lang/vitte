# ============================================================
# vitte_driver :: tests :: driver_smoke
# Smoke tests for compiler driver
# ============================================================

space vitte/driver/tests

pull vitte/driver/context
pull vitte/driver/options
pull vitte/driver/targets
pull vitte/driver/steps
pull vitte/driver/pipeline

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

proc assert_ok(res: Result<(), DriverError>)
    match res
        Ok(_) => ()
        Error(e) =>
            panic(format(
                "expected Ok, got error: {}",
                e.message()
            ))
    .end
.end

proc assert_err(res: Result<(), DriverError>)
    match res
        Ok(_) =>
            panic("expected error, got Ok")
        Error(_) => ()
    .end
.end

# ------------------------------------------------------------
# Minimal test target
# ------------------------------------------------------------

proc test_target()
    gives TargetTriple

    give TargetTriple {
        arch: X86_64,
        os: Linux,
        abi: Gnu,
    }
.end

# ------------------------------------------------------------
# Smoke: parse only
# ------------------------------------------------------------

proc test_parse_only()
    let opts = DriverOptions::default()
    let mut ctx = DriverContext::new(
        Compile,
        opts,
        test_target()
    )

    assert_ok(parse(&mut ctx))
.end

# ------------------------------------------------------------
# Smoke: full frontend (parse + typecheck)
# ------------------------------------------------------------

proc test_frontend()
    let opts = DriverOptions::default()
    let mut ctx = DriverContext::new(
        Compile,
        opts,
        test_target()
    )

    assert_ok(parse(&mut ctx))
    assert_ok(lower(&mut ctx))
    assert_ok(type_check(&mut ctx))
.end

# ------------------------------------------------------------
# Smoke: middle-end (mono + MIR + SSA)
# ------------------------------------------------------------

proc test_middle_end()
    let opts = DriverOptions::default()
    let mut ctx = DriverContext::new(
        Compile,
        opts,
        test_target()
    )

    assert_ok(parse(&mut ctx))
    assert_ok(lower(&mut ctx))
    assert_ok(type_check(&mut ctx))
    assert_ok(monomorphize(&mut ctx))
    assert_ok(build_mir(&mut ctx))
    assert_ok(build_ssa(&mut ctx))
.end

# ------------------------------------------------------------
# Smoke: pipeline compile (no link)
# ------------------------------------------------------------

proc test_compile_pipeline()
    let mut flags = DriverFlags::default()
    flags.emit = EmitKind::Obj   # stop before link

    let opts = DriverOptions {
        flags: flags,
        mode: ModeConfig::default(),
    }

    let mut ctx = DriverContext::new(
        Compile,
        opts,
        test_target()
    )

    match compile(&mut ctx)
        Success => ()
        Failed =>
            panic("compile pipeline failed")
    .end
.end

# ------------------------------------------------------------
# Smoke: error propagation
# ------------------------------------------------------------

proc test_error_propagation()
    let mut flags = DriverFlags::default()
    flags.experimental = false

    let opts = DriverOptions {
        flags: flags,
        mode: ModeConfig::check(),
    }

    let mut ctx = DriverContext::new(
        Check,
        opts,
        test_target()
    )

    # Intentionally skip parse
    assert_err(type_check(&mut ctx))
.end

# ------------------------------------------------------------
# Entry point
# ------------------------------------------------------------

entry test at vitte/driver/tests
    test_parse_only()
    test_frontend()
    test_middle_end()
    test_compile_pipeline()
    test_error_propagation()
.end
.end