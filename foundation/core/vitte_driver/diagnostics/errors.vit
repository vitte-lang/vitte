# ============================================================
# vitte_driver :: diagnostics :: errors
# Canonical driver error definitions
# ============================================================

space vitte/driver/diagnostics

pull vitte/core/const_eval
pull vitte/driver/targets

# ------------------------------------------------------------
# DriverError
# ------------------------------------------------------------

pick DriverError

    # --------------------------------------------------------
    # Frontend / parsing
    # --------------------------------------------------------

    IoError(
        path: String,
        message: String
    )

    InvalidSourceEncoding(
        path: String
    )

    ParseError(
        path: String,
        line: UInt,
        column: UInt,
        message: String
    )

    UnexpectedToken(
        expected: String,
        found: String
    )

    # --------------------------------------------------------
    # Module / import system
    # --------------------------------------------------------

    ModuleNotFound(
        module: String
    )

    DuplicateModule(
        module: String
    )

    CircularDependency(
        module: String
    )

    # --------------------------------------------------------
    # Name resolution
    # --------------------------------------------------------

    UndefinedSymbol(
        name: String
    )

    DuplicateSymbol(
        name: String
    )

    PrivateSymbolAccess(
        name: String
    )

    # --------------------------------------------------------
    # Type system
    # --------------------------------------------------------

    TypeMismatch(
        expected: String,
        found: String
    )

    IncompatibleTypes(
        left: String,
        right: String
    )

    UnknownType(
        name: String
    )

    InvalidCast(
        from: String,
        to: String
    )

    # --------------------------------------------------------
    # Const evaluation
    # --------------------------------------------------------

    ConstEvalFailed(
        error: ConstEvalError
    )

    ConstRequired(
        context: String
    )

    # --------------------------------------------------------
    # Control flow / semantics
    # --------------------------------------------------------

    UnreachableCode

    MissingReturn(
        function: String
    )

    InvalidBreak
    InvalidContinue

    # --------------------------------------------------------
    # Target / backend
    # --------------------------------------------------------

    UnsupportedTarget(
        triple: TargetTriple
    )

    UnsupportedFeature(
        feature: String
    )

    BackendError(
        backend: String,
        message: String
    )

    # --------------------------------------------------------
    # Linking / output
    # --------------------------------------------------------

    LinkerNotFound(
        name: String
    )

    LinkerFailed(
        message: String
    )

    OutputWriteFailed(
        path: String
    )

    # --------------------------------------------------------
    # Driver / CLI
    # --------------------------------------------------------

    InvalidOption(
        option: String
    )

    MissingOption(
        option: String
    )

    ConflictingOptions(
        first: String,
        second: String
    )

    # --------------------------------------------------------
    # Internal / safety
    # --------------------------------------------------------

    InternalCompilerError(
        message: String
    )

.end

# ------------------------------------------------------------
# Human-readable messages
# ------------------------------------------------------------

proc DriverError::message(self: &DriverError)
    gives String

    match self

        # Frontend
        IoError(path, msg) =>
            format("cannot read `{}`: {}", path, msg)

        InvalidSourceEncoding(path) =>
            format("invalid source encoding in `{}`", path)

        ParseError(path, line, col, msg) =>
            format(
                "{}:{}:{}: parse error: {}",
                path,
                line,
                col,
                msg
            )

        UnexpectedToken(exp, found) =>
            format(
                "unexpected token: expected `{}`, found `{}`",
                exp,
                found
            )

        # Modules
        ModuleNotFound(m) =>
            format("module `{}` not found", m)

        DuplicateModule(m) =>
            format("duplicate module `{}`", m)

        CircularDependency(m) =>
            format("circular dependency involving module `{}`", m)

        # Names
        UndefinedSymbol(n) =>
            format("use of undefined symbol `{}`", n)

        DuplicateSymbol(n) =>
            format("duplicate definition of symbol `{}`", n)

        PrivateSymbolAccess(n) =>
            format("symbol `{}` is private", n)

        # Types
        TypeMismatch(exp, found) =>
            format("type mismatch: expected `{}`, found `{}`", exp, found)

        IncompatibleTypes(l, r) =>
            format("incompatible types `{}` and `{}`", l, r)

        UnknownType(n) =>
            format("unknown type `{}`", n)

        InvalidCast(from, to) =>
            format("invalid cast from `{}` to `{}`", from, to)

        # Const-eval
        ConstEvalFailed(e) =>
            format("constant evaluation failed: {}", e.message())

        ConstRequired(ctx) =>
            format("constant value required in {}", ctx)

        # Control flow
        UnreachableCode =>
            "unreachable code detected"

        MissingReturn(f) =>
            format("missing return in function `{}`", f)

        InvalidBreak =>
            "`break` used outside of a loop"

        InvalidContinue =>
            "`continue` used outside of a loop"

        # Target / backend
        UnsupportedTarget(t) =>
            format("unsupported target `{}`", t.to_string())

        UnsupportedFeature(f) =>
            format("unsupported target feature `{}`", f)

        BackendError(b, msg) =>
            format("backend `{}` error: {}", b, msg)

        # Linking
        LinkerNotFound(n) =>
            format("linker `{}` not found", n)

        LinkerFailed(msg) =>
            format("linking failed: {}", msg)

        OutputWriteFailed(p) =>
            format("failed to write output to `{}`", p)

        # CLI
        InvalidOption(o) =>
            format("invalid command-line option `{}`", o)

        MissingOption(o) =>
            format("missing required option `{}`", o)

        ConflictingOptions(a, b) =>
            format("conflicting options `{}` and `{}`", a, b)

        # Internal
        InternalCompilerError(msg) =>
            format("internal compiler error: {}", msg)
    .end
.end

# ------------------------------------------------------------
# Severity
# ------------------------------------------------------------

pick DriverErrorSeverity
    Error
    Fatal
.end

proc DriverError::severity(self: &DriverError)
    gives DriverErrorSeverity

    match self
        InternalCompilerError(_) => Fatal
        otherwise => Error
    .end
.end
