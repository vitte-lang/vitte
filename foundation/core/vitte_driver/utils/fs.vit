# ============================================================
# vitte_driver :: utils :: fs
# Filesystem utilities for the compiler driver
# ============================================================

space vitte/driver/utils

pull vitte/driver/diagnostics

# ------------------------------------------------------------
# Path helpers
# ------------------------------------------------------------

proc normalize_path(path: String)
    gives String
    # Normalize separators and remove trailing slashes where possible
    let p = path.replace("\\", "/")
    if p.ends_with("/") && p.len() > 1
        give p.trim_end_matches("/")
    give p
.end

proc join_path(base: String, part: String)
    gives String
    if base.ends_with("/") || base.ends_with("\\")
        give normalize_path(base + part)
    give normalize_path(base + "/" + part)
.end

proc file_name(path: String)
    gives String
    let p = normalize_path(path)
    match p.rsplit_once("/")
        Some((_, name)) => give name
        None => give p
    .end
.end

proc parent_dir(path: String)
    gives String?
    let p = normalize_path(path)
    match p.rsplit_once("/")
        Some((dir, _)) => give Some(dir)
        None => give None
    .end
.end

proc extension(path: String)
    gives String?
    let name = file_name(path)
    match name.rsplit_once(".")
        Some((_, ext)) => give Some(ext)
        None => give None
    .end
.end

# ------------------------------------------------------------
# Existence / metadata
# ------------------------------------------------------------

proc exists(path: String)
    gives Bool
    fs::exists(path)
.end

proc is_file(path: String)
    gives Bool
    fs::is_file(path)
.end

proc is_dir(path: String)
    gives Bool
    fs::is_dir(path)
.end

proc file_size(path: String)
    gives Result<UInt, DriverError>
    match fs::metadata(path)
        Ok(meta) => give Ok(meta.size)
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

# ------------------------------------------------------------
# Read / write
# ------------------------------------------------------------

proc read_to_string(path: String)
    gives Result<String, DriverError>
    match fs::read_to_string(path)
        Ok(s) => give Ok(s)
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

proc read_bytes(path: String)
    gives Result<List<Byte>, DriverError>
    match fs::read(path)
        Ok(b) => give Ok(b)
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

proc write_string(path: String, content: String)
    gives Result<(), DriverError>

    ensure_parent_dir(path)?

    match fs::write(path, content)
        Ok(_) => give Ok(())
        Error(e) =>
            give Error(
                DriverError::OutputWriteFailed(path)
            )
    .end
.end

proc write_bytes(path: String, content: List<Byte>)
    gives Result<(), DriverError>

    ensure_parent_dir(path)?

    match fs::write(path, content)
        Ok(_) => give Ok(())
        Error(_) =>
            give Error(
                DriverError::OutputWriteFailed(path)
            )
    .end
.end

# ------------------------------------------------------------
# Atomic write
# ------------------------------------------------------------

proc write_atomic(path: String, content: List<Byte>)
    gives Result<(), DriverError>

    let tmp = path + ".tmp"

    write_bytes(tmp, content)?

    match fs::rename(tmp, path)
        Ok(_) => give Ok(())
        Error(e) =>
            give Error(
                DriverError::OutputWriteFailed(path)
            )
    .end
.end

# ------------------------------------------------------------
# Directories
# ------------------------------------------------------------

proc ensure_dir(path: String)
    gives Result<(), DriverError>

    if exists(path)
        if is_dir(path)
            give Ok(())
        give Error(
            DriverError::IoError(
                path,
                "path exists and is not a directory"
            )
        )

    match fs::create_dir_all(path)
        Ok(_) => give Ok(())
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

proc ensure_parent_dir(path: String)
    gives Result<(), DriverError>

    match parent_dir(path)
        Some(dir) => ensure_dir(dir)
        None => give Ok(())
    .end
.end

# ------------------------------------------------------------
# Directory traversal
# ------------------------------------------------------------

proc list_dir(path: String)
    gives Result<List<String>, DriverError>

    match fs::read_dir(path)
        Ok(entries) =>
            let mut out = []
            for e in entries
                out.push(normalize_path(e.path))
            .end
            give Ok(out)
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

proc walk_dir(path: String)
    gives Result<List<String>, DriverError>

    let mut acc = []

    match fs::read_dir(path)
        Ok(entries) =>
            for e in entries
                let p = normalize_path(e.path)
                acc.push(p)
                if fs::is_dir(p)
                    let sub = walk_dir(p)?
                    acc.extend(sub)
                .end
            .end
            give Ok(acc)
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

# ------------------------------------------------------------
# Temp directories / files
# ------------------------------------------------------------

proc temp_dir()
    gives String
    normalize_path(fs::temp_dir())
.end

proc make_temp_file(prefix: String)
    gives String

    let dir = temp_dir()
    let name = format(
        "{}_{}",
        prefix,
        time::now_unix_ns()
    )

    join_path(dir, name)
.end

# ------------------------------------------------------------
# Copy / remove
# ------------------------------------------------------------

proc copy(src: String, dst: String)
    gives Result<(), DriverError>

    ensure_parent_dir(dst)?

    match fs::copy(src, dst)
        Ok(_) => give Ok(())
        Error(e) =>
            give Error(
                DriverError::IoError(src, e.message())
            )
    .end
.end

proc remove_file(path: String)
    gives Result<(), DriverError>

    if !exists(path)
        give Ok(())

    match fs::remove_file(path)
        Ok(_) => give Ok(())
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

proc remove_dir_all(path: String)
    gives Result<(), DriverError>

    if !exists(path)
        give Ok(())

    match fs::remove_dir_all(path)
        Ok(_) => give Ok(())
        Error(e) =>
            give Error(
                DriverError::IoError(path, e.message())
            )
    .end
.end

# ------------------------------------------------------------
# Notes
# ------------------------------------------------------------
#
# - All functions:
#     * normalize paths
#     * propagate DriverError
#
# - No silent failures.
# - Safe for concurrent builds (atomic writes).
# - Suitable for:
#     * object emission
#     * temp artifacts
#     * cache directories
#
