# ============================================================
# vitte_driver_impl :: link :: lld
# LLVM lld linker implementation
# ============================================================

space vitte/driver_impl/link

pull vitte/driver/context
pull vitte/driver/diagnostics
pull vitte/driver/options
pull vitte/driver/targets

pull vitte/driver/utils
pull vitte/driver/utils/process
pull vitte/driver/utils/fs

# ------------------------------------------------------------
# LldFlavor
# ------------------------------------------------------------

pick LldFlavor
    Elf        # lld (Linux / ELF)
    Coff       # lld-link (Windows / COFF)
    MachO      # ld64.lld (macOS)
.end

# ------------------------------------------------------------
# LldConfig
# ------------------------------------------------------------

form LldConfig
    flavor: LldFlavor
    program: String          # executable name or path
    args: List<String>
.end

proc LldConfig::from_context(ctx: &DriverContext)
    gives Result<LldConfig, DriverError>

    match ctx.target.os
        Linux =>
            give Ok(
                LldConfig {
                    flavor: Elf,
                    program: "ld.lld",
                    args: [],
                }
            )

        Windows =>
            give Ok(
                LldConfig {
                    flavor: Coff,
                    program: "lld-link",
                    args: [],
                }
            )

        MacOS =>
            give Ok(
                LldConfig {
                    flavor: MachO,
                    program: "ld64.lld",
                    args: [],
                }
            )

        otherwise =>
            give Error(
                DriverError::UnsupportedTarget(
                    ctx.target.triple()
                )
            )
    .end
.end

# ------------------------------------------------------------
# Entry point
# ------------------------------------------------------------

proc link_lld(ctx: &mut DriverContext)
    gives Result<(), DriverError>

    let cfg = LldConfig::from_context(ctx)?

    # --------------------------------------------------------
    # Resolve linker executable
    # --------------------------------------------------------
    let program =
        match find_in_path(cfg.program)
            Some(p) => p
            None =>
                give Error(
                    DriverError::LinkerNotFound(cfg.program)
                )
        .end

    let output = ctx.session.output_binary_path()
    ensure_parent_dir(output)?

    # --------------------------------------------------------
    # Build command
    # --------------------------------------------------------
    let mut cmd = Command::new(program)

    match cfg.flavor

        Elf =>
            build_elf_command(ctx, &mut cmd, output)?

        Coff =>
            build_coff_command(ctx, &mut cmd, output)?

        MachO =>
            build_macho_command(ctx, &mut cmd, output)?
    .end

    # Extra args (future options)
    for a in cfg.args
        cmd.arg(a)
    .end

    if ctx.options.flags.verbose
        ctx.diagnostics.note(
            format("lld command: {}", cmd.debug_string())
        )

    # --------------------------------------------------------
    # Execute
    # --------------------------------------------------------
    run_checked(&cmd)
.end

# ------------------------------------------------------------
# ELF (Linux)
# ------------------------------------------------------------

proc build_elf_command(
    ctx: &DriverContext,
    cmd: &mut Command,
    output: String
)
    gives Result<(), DriverError>

    cmd.arg("-o")
    cmd.arg(output)

    # object files
    for obj in ctx.session.object_files()
        cmd.arg(obj)
    .end

    # target triple
    cmd.arg("--target")
    cmd.arg(ctx.target.triple())

    # static / shared
    if ctx.options.flags.emit == EmitKind::Obj
        cmd.arg("-static")

    give Ok(())
.end

# ------------------------------------------------------------
# COFF (Windows)
# ------------------------------------------------------------

proc build_coff_command(
    ctx: &DriverContext,
    cmd: &mut Command,
    output: String
)
    gives Result<(), DriverError>

    cmd.arg(format("/OUT:{}", output))

    for obj in ctx.session.object_files()
        cmd.arg(obj)
    .end

    # subsystem
    cmd.arg("/SUBSYSTEM:CONSOLE")

    give Ok(())
.end

# ------------------------------------------------------------
# Mach-O (macOS)
# ------------------------------------------------------------

proc build_macho_command(
    ctx: &DriverContext,
    cmd: &mut Command,
    output: String
)
    gives Result<(), DriverError>

    cmd.arg("-o")
    cmd.arg(output)

    for obj in ctx.session.object_files()
        cmd.arg(obj)
    .end

    # minimum macOS version (safe default)
    cmd.arg("-macosx_version_min")
    cmd.arg("11.0")

    give Ok(())
.end

# ------------------------------------------------------------
# Notes
# ------------------------------------------------------------
#
# - This file:
#     * executes lld only
#     * does NOT select the linker
#
# - Selection logic lives in:
#     vitte_driver/backend/link.vit
#
# - Supported formats:
#     * ELF   (ld.lld)
#     * COFF  (lld-link)
#     * MachO (ld64.lld)
#
# - Future extensions:
#     * LTO flags
#     * response files (.rsp)
#     * sysroot / SDK handling
#     * WASM (wasm-ld)
#
