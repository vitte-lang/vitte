# ============================================================
# vitte_errors :: diagnostic :: builder :: with_note
# ------------------------------------------------------------
# Extension du DiagnosticBuilder avec support avancé des notes.
# - Notes explicatives
# - Notes multiples / groupées
# - Aucun fix-it
# ============================================================

space vitte_errors/diagnostic/builder/with_note

pull vitte_error_codes/context
pull vitte_errors/diagnostic/builder/core as core

# ------------------------------------------------------------
# Types
# ------------------------------------------------------------

form DiagnosticBuilderWithNote
  base  : core/DiagnosticBuilder
.end

# ------------------------------------------------------------
# Construction
# ------------------------------------------------------------

proc new(
  code : string,
  phase : context/ErrorPhase,
  message : string
) gives DiagnosticBuilderWithNote
  give DiagnosticBuilderWithNote
    base = core/new(code, phase, message)
  end
.end

proc from_builder(
  b : core/DiagnosticBuilder
) gives DiagnosticBuilderWithNote
  give DiagnosticBuilderWithNote
    base = b
  end
.end

# ------------------------------------------------------------
# Fluent modifiers (hérités)
# ------------------------------------------------------------

proc at(
  b : DiagnosticBuilderWithNote,
  file : string,
  line : u32,
  column : u32
) gives DiagnosticBuilderWithNote
  let mut out = b
  out.base = core/at(out.base, file, line, column)
  give out
.end

# ------------------------------------------------------------
# Notes API
# ------------------------------------------------------------

proc note(
  b : DiagnosticBuilderWithNote,
  message : string
) gives DiagnosticBuilderWithNote
  let mut out = b
  out.base = core/note(out.base, message)
  give out
.end

proc notes(
  b : DiagnosticBuilderWithNote,
  items : List<string>
) gives DiagnosticBuilderWithNote
  let mut out = b
  out.base = core/notes(out.base, items)
  give out
.end

proc because(
  b : DiagnosticBuilderWithNote,
  reason : string
) gives DiagnosticBuilderWithNote
  give note(b, "because: " + reason)
.end

proc help(
  b : DiagnosticBuilderWithNote,
  hint : string
) gives DiagnosticBuilderWithNote
  give note(b, "help: " + hint)
.end

# ------------------------------------------------------------
# Finalisation
# ------------------------------------------------------------

proc build(
  b : DiagnosticBuilderWithNote
) gives context/ErrorContext
  give core/build(b.base)
.end

# ------------------------------------------------------------
# Raccourci statique
# ------------------------------------------------------------

proc simple(
  code : string,
  phase : context/ErrorPhase,
  message : string,
  notes : List<string>
) gives context/ErrorContext
  let mut b = new(code, phase, message)
  b = notes(b, notes)
  give build(b)
.end
