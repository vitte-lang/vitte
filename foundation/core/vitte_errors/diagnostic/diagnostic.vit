# ============================================================
# vitte_errors :: diagnostic
# ------------------------------------------------------------
# Type Diagnostic unifié.
# - Enveloppe ErrorContext
# - Prêt pour collecte, rendu et LSP
# ============================================================

space vitte_errors/diagnostic

pull vitte_error_codes/context
pull vitte_error_messages/context as msg_ctx
pull vitte_error_messages/render

# ------------------------------------------------------------
# Types
# ------------------------------------------------------------

form Diagnostic
  ctx : context/ErrorContext
.end

# ------------------------------------------------------------
# Construction
# ------------------------------------------------------------

proc new(ctx : context/ErrorContext) gives Diagnostic
  give Diagnostic
    ctx = ctx
  end
.end

# ------------------------------------------------------------
# Accesseurs directs
# ------------------------------------------------------------

proc context(d : Diagnostic) gives context/ErrorContext
  give d.ctx
.end

proc code(d : Diagnostic) gives string
  give d.ctx.code
.end

proc phase(d : Diagnostic) gives context/ErrorPhase
  give d.ctx.phase
.end

proc span(d : Diagnostic) gives context/ErrorSpan?
  give d.ctx.span
.end

proc notes(d : Diagnostic) gives List<context/ErrorNote>
  give d.ctx.notes
.end

# ------------------------------------------------------------
# Enrichissement messages (locale + docs)
# ------------------------------------------------------------

proc message_context(d : Diagnostic) gives msg_ctx/MessageContext
  give msg_ctx/from_error_context(d.ctx)
.end

# ------------------------------------------------------------
# Rendus
# ------------------------------------------------------------

proc render_plain(d : Diagnostic) gives string
  give render/render(d.ctx)
.end

proc render_json(d : Diagnostic) gives string
  give render/json/render(d.ctx)
.end

proc render_lsp(d : Diagnostic)
  gives render/lsp/Diagnostic
  give render/lsp/render(d.ctx)
.end

# ------------------------------------------------------------
# Batch helpers
# ------------------------------------------------------------

proc render_plain_all(
  diags : List<Diagnostic>
) gives string
  let mut out = ""
  let mut first = true

  for d in diags
    if not first
      out = out + "\n\n"
    end
    first = false
    out = out + render_plain(d)
  end

  give out
.end

proc render_lsp_all(
  diags : List<Diagnostic>
) gives List<render/lsp/Diagnostic>
  let mut out = List<render/lsp/Diagnostic>.new()
  for d in diags
    out.push(render_lsp(d))
  end
  give out
.end
