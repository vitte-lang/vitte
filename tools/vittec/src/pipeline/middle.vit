# ============================================================
# vittec — pipeline/middle.vit
# Middle-End Pipeline (IR passes & optimizations) — ULTRA MAX
# ============================================================

space vittec/pipeline

# ----------------------------
# Imports
# ----------------------------

pull vittec/diagnostics
pull vitte/ast_ir/program
pull vitte/ast_ir/analysis
pull vitte/ast_ir/control_flow
pull vitte/collections/list
pull vitte/collections/map

# ----------------------------
# Public API
# ----------------------------

share all

# ----------------------------
# Middle-end options
# ----------------------------

type MiddleOptions
    optimize        : bool
    level           : int          # -O0, -O1, -O2, -O3
    dump_after      : bool
.end

# ----------------------------
# Middle-end context
# ----------------------------

type MiddleContext
    program         : ProgramBundle
    options         : MiddleOptions
.end

# ----------------------------
# Entry
# ----------------------------

proc run(ctx: MiddleContext, diag: DiagnosticContext)
    # --------------------------------
    # 1. Baseline validation
    # --------------------------------

    ctx.program.validate(diag)
    if diag.has_errors()
        return
    .end

    # --------------------------------
    # 2. Mandatory analyses
    # --------------------------------

    ctx.program.build_ssa()

    # --------------------------------
    # 3. Optional optimizations
    # --------------------------------

    if ctx.options.optimize
        match ctx.options.level
            0 => ()
            1 => opt_level_1(ctx)
            2 => opt_level_2(ctx)
            _ => opt_level_3(ctx)
        .end
    .end

    # --------------------------------
    # 4. Optional dump
    # --------------------------------

    if ctx.options.dump_after
        dump(ctx.program)
    .end
.end

# ----------------------------
# Optimization levels
# ----------------------------

proc opt_level_1(ctx: MiddleContext)
    # Basic cleanups
    pass_dce(ctx)
.end

proc opt_level_2(ctx: MiddleContext)
    # Standard optimizations
    pass_dce(ctx)
    pass_simplify_cfg(ctx)
.end

proc opt_level_3(ctx: MiddleContext)
    # Aggressive optimizations
    pass_dce(ctx)
    pass_simplify_cfg(ctx)
    pass_gvn(ctx)
.end

# ----------------------------
# Passes (stubs)
# ----------------------------

proc pass_dce(ctx: MiddleContext)
    # Dead Code Elimination
    for (_, m) in ctx.program.program.modules.modules
        m.run_dce()
    .end
.end

proc pass_simplify_cfg(ctx: MiddleContext)
    # CFG simplification
    for (_, m) in ctx.program.program.modules.modules
        m.simplify_cfg()
    .end
.end

proc pass_gvn(ctx: MiddleContext)
    # Global Value Numbering
    for (_, m) in ctx.program.program.modules.modules
        m.run_gvn()
    .end
.end

# ----------------------------
# Debug / Dump
# ----------------------------

proc dump(p: ProgramBundle)
    say "=== MIDDLE-END IR ==="
    p.dump()
.end

# ----------------------------
# End of module
# ----------------------------
