# ============================================================
# vittec â€” tests/cli.vit
# CLI Integration Tests â€” ULTRA MAX
# ============================================================

space vittec/tests

# ----------------------------
# Imports
# ----------------------------

pull vittec/cli
pull vittec/driver
pull vittec/diagnostics
pull vitte/collections/list
pull vitte/fs
pull vitte/path

# ----------------------------
# Public API
# ----------------------------

share all

# ----------------------------
# Test utilities
# ----------------------------

proc make_ctx(args: List[String]) -> CliContext
    let cli_args = args.parse(args)
    let config   = config.load(cli_args)
    return CliContext.new(cli_args, config)
.end

proc with_temp_file(name: String, content: String, f: fn(String))
    let p = path.join("/tmp", name)
    fs.write(p, content)
    f(p)
    fs.remove(p)
.end

# ----------------------------
# Tests: version
# ----------------------------

proc test_version()
    let code = version.print()
    assert(code == 0)
.end

# ----------------------------
# Tests: check
# ----------------------------

proc test_check_empty()
    let ctx = make_ctx(List.of("check"))
    let rc  = driver.run_check(ctx)
    assert(rc != 0)
.end

proc test_check_missing_file()
    let ctx = make_ctx(List.of("check", "missing.vit"))
    let rc  = driver.run_check(ctx)
    assert(rc != 0)
.end

# ----------------------------
# Tests: build
# ----------------------------

proc test_build_stub()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("build", p))
        let rc  = driver.run_build(ctx)
        assert(rc == 0)
    .end)
.end

# ----------------------------
# Tests: compile
# ----------------------------

proc test_compile_stub()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("compile", p))
        let rc  = driver.run_compile(ctx)
        assert(rc == 0)
    .end)
.end

# ----------------------------
# Tests: run
# ----------------------------

proc test_run_stub()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("run", p))
        let rc = driver.run_compile(ctx)
        assert(rc == 0)
    .end)
.end

# ----------------------------
# Test suite entry
# ----------------------------

proc main() -> int
    test_version()
    test_check_empty()
    test_check_missing_file()
    test_build_stub()
    test_compile_stub()
    test_run_stub()

    say "All CLI tests passed"
    return 0
.end

# ----------------------------
# End of test suite
# ----------------------------
