# ============================================================
# vittec — tests/compile.vit
# Compile Driver Integration Tests — ULTRA MAX
# ============================================================

space vittec/tests

# ----------------------------
# Imports
# ----------------------------

pull vittec/cli
pull vittec/driver
pull vittec/diagnostics
pull vitte/collections/list
pull vitte/fs
pull vitte/path

# ----------------------------
# Public API
# ----------------------------

share all

# ----------------------------
# Test utilities
# ----------------------------

proc make_ctx(args: List[String]) -> CliContext
    let cli_args = args.parse(args)
    let config   = config.load(cli_args)
    return CliContext.new(cli_args, config)
.end

proc with_temp_file(name: String, content: String, f: fn(String))
    let p = path.join("/tmp", name)
    fs.write(p, content)
    f(p)
    fs.remove(p)
.end

# ----------------------------
# Tests: compile (errors)
# ----------------------------

proc test_compile_no_inputs()
    let ctx = make_ctx(List.of("compile"))
    let rc  = driver.run_compile(ctx)
    assert(rc != 0)
.end

proc test_compile_missing_file()
    let ctx = make_ctx(List.of("compile", "missing.vit"))
    let rc  = driver.run_compile(ctx)
    assert(rc != 0)
.end

# ----------------------------
# Tests: compile (success path)
# ----------------------------

proc test_compile_single_file()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("compile", p))
        let rc  = driver.run_compile(ctx)
        assert(rc == 0)
    .end)
.end

proc test_compile_with_output()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("compile", p, "-o", "out.bin"))
        let rc  = driver.run_compile(ctx)
        assert(rc == 0)
        assert(fs.exists("out.bin"))
        fs.remove("out.bin")
    .end)
.end

# ----------------------------
# Tests: compile options
# ----------------------------

proc test_compile_emit_ir()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("compile", p, "--emit-ir"))
        let rc  = driver.run_compile(ctx)
        assert(rc == 0)
    .end)
.end

proc test_compile_optimize()
    with_temp_file("main.vit", "space test\n", fn(p)
        let ctx = make_ctx(List.of("compile", p, "-O2"))
        let rc  = driver.run_compile(ctx)
        assert(rc == 0)
    .end)
.end

# ----------------------------
# Test suite entry
# ----------------------------

proc main() -> int
    test_compile_no_inputs()
    test_compile_missing_file()
    test_compile_single_file()
    test_compile_with_output()
    test_compile_emit_ir()
    test_compile_optimize()

    say "All compile tests passed"
    return 0
.end

# ----------------------------
# End of test suite
# ----------------------------
