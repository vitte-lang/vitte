# ============================================================
# vittec â€” config/mod.vit
# Configuration module (ULTRA MAX)
# ============================================================

space vittec/config

# ----------------------------
# Imports
# ----------------------------

pull vittec/config/profile
pull vittec/config/loader
pull vittec/config/validator
pull vittec/config/defaults
pull vittec/config/errors

# ----------------------------
# Public API
# ----------------------------

share all

# ----------------------------
# Types
# ----------------------------

type Config
    profile     : Profile
    raw         : Map[String, Any]
    resolved    : bool
.end

# ----------------------------
# Constructors
# ----------------------------

proc Config.new() -> Config
    let prof = Profile.default()
    return Config {
        profile  = prof,
        raw      = Map.new(),
        resolved = false
    }
.end

# ----------------------------
# Loading
# ----------------------------

proc load(path: String) -> Config
    let raw_cfg = loader.load_file(path)
    let cfg = Config.new()
    cfg.raw = raw_cfg
    return cfg
.end

# ----------------------------
# Resolution
# ----------------------------

proc resolve(cfg: Config) -> Config
    if cfg.resolved
        return cfg
    .end

    let merged = defaults.apply(cfg.raw)
    let prof   = Profile.from_map(merged)

    cfg.profile  = prof
    cfg.resolved = true

    return cfg
.end

# ----------------------------
# Validation
# ----------------------------

proc validate(cfg: Config)
    if !cfg.resolved
        error.raise(ConfigError::NotResolved)
    .end

    validator.validate_profile(cfg.profile)
.end

# ----------------------------
# High-level helper
# ----------------------------

proc load_and_validate(path: String) -> Config
    let cfg = load(path)
    let res = resolve(cfg)
    validate(res)
    return res
.end

# ----------------------------
# Debug / Introspection
# ----------------------------

proc dump(cfg: Config)
    say "Config(resolved=", cfg.resolved, ")"
    say cfg.profile
.end

# ----------------------------
# End of module
# ----------------------------
