// vittec src ULTRA MAX skeleton

# =========================================================
# vittec — Config / Environment
# =========================================================

space vittec/config/env

share all

<<< doc
Ce module définit l’accès centralisé à l’environnement
d’exécution du compilateur vittec.

Il encapsule :
- variables d’environnement
- informations système
- informations de build
- détection plateforme / cible

Objectifs :
- API stable
- déterminisme maximal
- aucune dépendance directe aux APIs système ailleurs

Ce module est utilisé par :
- config
- compiler/session
- cache/fingerprint
- driver
>>>

# ---------------------------------------------------------
# Dépendances
# ---------------------------------------------------------

pull vittec/fs as fs

# ---------------------------------------------------------
# Plateforme hôte
# ---------------------------------------------------------

pick HostOS
    case Linux
    case MacOS
    case Windows
    case FreeBSD
    case Unknown
.end

pick HostArch
    case X86
    case X86_64
    case ARM
    case ARM64
    case RISCV64
    case Unknown
.end

form HostInfo
    field os as HostOS
    field arch as HostArch
    field triple as string
.end

# ---------------------------------------------------------
# Environnement cible
# ---------------------------------------------------------

form TargetInfo
    field triple as string
    field os as HostOS
    field arch as HostArch
.end

# ---------------------------------------------------------
# Informations build
# ---------------------------------------------------------

form BuildInfo
    field compiler_version as string
    field commit_hash as Option[string]
    field build_date as Option[string]
.end

# ---------------------------------------------------------
# Accès aux variables d’environnement
# ---------------------------------------------------------

proc get(name as string) gives Option[string]
    give fs.getenv(name)
.end

proc get_or(
    name as string,
    default as string
) gives string

    select fs.getenv(name)
        when some(v)
            give v
    otherwise
        give default
    .end
.end

proc is_set(name as string) gives bool
    give fs.getenv(name) != none
.end

# ---------------------------------------------------------
# Détection hôte
# ---------------------------------------------------------

proc detect_host_os() gives HostOS

    make os as string = fs.host_os()

    select os
        when "linux"
            give Linux
        when "macos"
            give MacOS
        when "windows"
            give Windows
        when "freebsd"
            give FreeBSD
    otherwise
        give Unknown
    .end
.end

proc detect_host_arch() gives HostArch

    make arch as string = fs.host_arch()

    select arch
        when "x86"
            give X86
        when "x86_64"
            give X86_64
        when "arm"
            give ARM
        when "aarch64"
            give ARM64
        when "riscv64"
            give RISCV64
    otherwise
        give Unknown
    .end
.end

proc host_info() gives HostInfo

    make os as HostOS = detect_host_os()
    make arch as HostArch = detect_host_arch()
    make triple as string = fs.host_triple()

    give HostInfo(os, arch, triple)
.end

# ---------------------------------------------------------
# Détection cible
# ---------------------------------------------------------

proc target_info() gives TargetInfo

    make triple as string =
        get_or("VITTEC_TARGET", fs.host_triple())

    make os as HostOS = detect_host_os()
    make arch as HostArch = detect_host_arch()

    give TargetInfo(triple, os, arch)
.end

# ---------------------------------------------------------
# Informations de build
# ---------------------------------------------------------

proc build_info() gives BuildInfo

    give BuildInfo(
        get_or("VITTEC_VERSION", "0.1.0"),
        get("VITTEC_COMMIT"),
        get("VITTEC_BUILD_DATE")
    )
.end