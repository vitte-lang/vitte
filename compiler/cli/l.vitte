module vitte.compiler.cli.lc

import std.collections as coll
import vitte.compiler.diagnostics as diag
import vitte.bootstrap.cli.bt_args as bt_args
import vitte.bootstrap.cli.bt_cli as bt_cli
import vitte.bootstrap.cli.bt_commands as bt_commands
import vitte.bootstrap.cli.bt_help as bt_help
import vitte.bootstrap.cli.bt_colors as bt_colors

# ============================================================================
# Vitte compiler – Frontend `lc` (logical model, declarative)
#
# Rôle :
#   - décrire la configuration logique du frontend multi-commandes `lc` :
#       * nom, version, codes de sortie,
#       * options globales (verbosité, couleur, dry-run),
#       * intégration avec le driver CLI bootstrap (bt_cli),
#       * intégration avec le registre de commandes (bt_commands),
#       * intégration avec le système d’aide (bt_help),
#       * intégration avec les profils/couleurs (bt_colors).
#   - ne contenir aucune logique de parsing, ni I/O, ni `program` :
#       * tout le comportement effectif est délégué à un runner externe
#         qui consomme ces structures.
#
# Conventions :
#   - syntaxe Vitte sans accolades, blocs terminés par `.end`,
#   - module purement déclaratif : types, enums, structs, unions, constantes.
# ============================================================================

# ----------------------------------------------------------------------------
# Identifiants & noms
# ----------------------------------------------------------------------------

type LcFrontendId          = i32
type LcFrontendSessionId   = i32
type LcExitCodeId          = i32
type LcGlobalOptionId      = i32
type LcGlobalFlagBindingId = i32

struct LcName
    id: i32
    text: String
    origin_span: diag.SpanId
.end

# ----------------------------------------------------------------------------
# Nom, version et codes de sortie de `lc`
# ----------------------------------------------------------------------------

enum LcExitCodeKind
    | LcExitOk       # exécution réussie
    | LcExitFail     # erreur interne / backend
    | LcExitUsage    # erreur d’usage CLI (arguments invalides)
.end

struct LcExitCode
    id: LcExitCodeId
    kind: LcExitCodeKind

    # Valeur numérique (habituellement 0, 1, 2, …)
    value: i32

    # Message descriptif pour humans / docs
    message: String
.end

struct LcIdentity
    frontend_id: LcFrontendId
    binary_name: String        # "lc"
    long_name: String          # "Vitte language compiler"
    version_string: String     # ex: "0.1.0"
    edition: String            # ex: "2025"
.end

# ----------------------------------------------------------------------------
# Options globales (verbosité, couleur, dry-run)
# ----------------------------------------------------------------------------

enum LcVerbosity
    | LcVerboseQuiet
    | LcVerboseNormal
    | LcVerboseDebug
.end

enum LcColorMode
    | LcColorAuto
    | LcColorAlways
    | LcColorNever
.end

struct LcGlobalOptions
    verbosity: LcVerbosity
    color_mode: LcColorMode
    dry_run: bool
.end

enum LcGlobalOptionKind
    | LcOptVerbosity
    | LcOptColor
    | LcOptDryRun
    | LcOptCustom
.end

struct LcGlobalOptionSpec
    id: LcGlobalOptionId
    name: LcName
    kind: LcGlobalOptionKind

    # Texte lisible (ex: "-v, --verbose")
    cli_label: String

    # Description visible dans l’aide globale
    description: String

    # Option(s) CLI sous-jacentes (bt_args)
    cli_options: coll.Vec[bt_args.BtCliOptionSpecId]
.end

enum LcGlobalFlagEffectKind
    | LcEffectSetVerbosity
    | LcEffectSetColorMode
    | LcEffectEnableDryRun
    | LcEffectCustom
.end

struct LcGlobalFlagBinding
    id: LcGlobalFlagBindingId

    # Option CLI déclencheuse (flag global)
    cli_option: bt_args.BtCliOptionSpecId

    # Effet logique sur LcGlobalOptions
    effect_kind: LcGlobalFlagEffectKind

    # Valeurs symboliques (ex: "quiet", "debug", "always", "never")
    effect_value: String
.end

struct LcGlobalConfig
    # Valeurs par défaut des options globales
    default_options: LcGlobalOptions

    # Spécifications d’options globales
    specs: coll.Vec[LcGlobalOptionSpec]

    # Binding options CLI → effets sur LcGlobalOptions
    flag_bindings: coll.Vec[LcGlobalFlagBinding]
.end

# ----------------------------------------------------------------------------
# Intégration avec le driver CLI bootstrap
# ----------------------------------------------------------------------------

enum LcDispatchMode
    | LcDispatchStrictUnknownCommand    # commande inconnue => erreur usage
    | LcDispatchAliasToBuild            # `lc` se comporte comme alias `lc build`
    | LcDispatchCustom                  # comportement défini par l’hôte
.end

struct LcDispatchConfig
    # Mode de dispatch quand la commande est vide ou inconnue
    mode_for_empty_or_unknown: LcDispatchMode

    # Commande par défaut pour "alias build" (ex: cmd_build dans bt_commands)
    default_build_command: bt_commands.BtCmdDescriptorId
    has_default_build_command: bool
.end

struct LcCliIntegration
    # Driver CLI bootstrap
    driver_config: bt_cli.BtCliDriverConfig

    # Registre de commandes
    command_registry: bt_commands.BtCmdRegistry

    # Config d’aide
    help_config: bt_help.BtHelpConfig

    # Config de couleurs
    color_config: bt_colors.BtColorConfig

    # Politique de dispatch global
    dispatch: LcDispatchConfig
.end

# ----------------------------------------------------------------------------
# Vue logique d’une invocation de `lc`
# ----------------------------------------------------------------------------

struct LcInvocation
    # Arguments bruts vus par `lc` (après extraction par le runtime)
    raw_argv: coll.Vec[String]

    # Session CLI bootstrap (bt_args)
    cli_session: bt_args.BtCliSession

    # Session driver (pipeline d’actions)
    cli_run_session: bt_cli.BtCliRunSession

    # Session d’aide éventuelle (si on a appelé `lc help` / `--help`)
    help_session: bt_help.BtHelpSession

    # Session de couleurs
    color_session: bt_colors.BtColorSession

    # Options globales dérivées
    global_options: LcGlobalOptions
.end

enum LcInvocationKind
    | LcInvokeCommand        # ex: `lc build ...`
    | LcInvokeHelp           # ex: `lc --help` ou `lc help`
    | LcInvokeVersion        # ex: `lc --version`
    | LcInvokeAliasToBuild   # alias transparent vers build
    | LcInvokeCustom
.end

struct LcInvocationSummary
    # Type d’invocation
    kind: LcInvocationKind

    # Commande principale résolue (si applicable)
    command: bt_commands.BtCmdDescriptorId
    has_command: bool

    # Indique si l’invocation est strictement "safe" (lecture seule)
    is_safe: bool

    # Indique si l’invocation est adaptée aux scripts/CI
    is_ci_friendly: bool
.end

# ----------------------------------------------------------------------------
# Résultats de l’exécution de `lc`
# ----------------------------------------------------------------------------

struct LcExecutionResult
    # Code de sortie logique
    exit_code: LcExitCodeId

    # Résultat du driver CLI (bt_cli)
    cli_result: bt_cli.BtCliResult

    # Indicateurs d’état
    had_errors: bool
    had_warnings: bool
.end

# ----------------------------------------------------------------------------
# Configuration globale du frontend `lc`
# ----------------------------------------------------------------------------

struct LcFrontendConfig
    identity: LcIdentity

    # Codes de sortie supportés par `lc`
    exit_codes: coll.Vec[LcExitCode]

    # Options globales (verbosité, couleur, dry-run)
    global_config: LcGlobalConfig

    # Intégration CLI/bootstrap
    cli_integration: LcCliIntegration
.end

# ----------------------------------------------------------------------------
# Session complète d’un run `lc`
# ----------------------------------------------------------------------------

struct LcFrontendSession
    id: LcFrontendSessionId
    name: LcName

    # Configuration globale
    config: LcFrontendConfig

    # Invocation observée
    invocation: LcInvocation

    # Résumé logique de l’invocation
    invocation_summary: LcInvocationSummary

    # Résultat final
    result: LcExecutionResult
.end