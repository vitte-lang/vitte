{
  "toolchain": "clang"
}

{
  "schema": "vitte.toolchain.config",
  "schema_version": 1,

  "toolchain": "clang",
  "display_name": "Clang/LLVM",
  "notes": [
    "Toolchain definition consumed by Vitte build/compiler drivers.",
    "This file is intended to be repo-stable and overrideable per-user via env.",
    "Wrappers/templates live under compiler/build/toolchain/."
  ],

  "capabilities": {
    "languages": ["c", "c++"],
    "supports_response_files": true,
    "supports_lto": true,
    "supports_sanitizers": true,
    "supports_thinlto": true,
    "supports_pie": true,
    "supports_build_id": true,
    "supports_deterministic": true
  },

  "binaries": {
    "cc": {
      "preferred": ["clang"],
      "fallback": ["cc", "gcc"],
      "env": ["CC"]
    },
    "cxx": {
      "preferred": ["clang++"],
      "fallback": ["c++", "g++"],
      "env": ["CXX"]
    },
    "ar": {
      "preferred": ["llvm-ar"],
      "fallback": ["ar"],
      "env": ["AR"]
    },
    "ranlib": {
      "preferred": ["llvm-ranlib"],
      "fallback": ["ranlib"],
      "env": ["RANLIB"]
    },
    "ld": {
      "preferred": ["clang++", "clang"],
      "fallback": ["ld.lld", "ld"],
      "env": ["LD"]
    },
    "nm": {
      "preferred": ["llvm-nm"],
      "fallback": ["nm"],
      "env": ["NM"]
    },
    "objdump": {
      "preferred": ["llvm-objdump"],
      "fallback": ["objdump"],
      "env": ["OBJDUMP"]
    },
    "readelf": {
      "preferred": ["readelf"],
      "fallback": ["llvm-readelf"],
      "env": ["READELF"]
    }
  },

  "wrappers": {
    "cc": {
      "path": "compiler/build/toolchain/wrappers/ccwrap.sh",
      "mode": "shim",
      "notes": "Selects clang/gcc drivers and injects best-effort determinism flags when requested."
    },
    "ld": {
      "path": "compiler/build/toolchain/wrappers/ldwrap.sh",
      "mode": "shim",
      "notes": "Selects clang driver or raw linker and injects optional PIE/LTO/strip/build-id flags."
    },
    "ar": {
      "path": "compiler/build/toolchain/wrappers/arwrap.sh",
      "mode": "shim",
      "notes": "Selects llvm-ar/ar and enables deterministic archive mode when supported."
    }
  },

  "response_files": {
    "compile": {
      "template": "compiler/build/toolchain/response_files/clang.rsp.tmpl",
      "prefix": "@",
      "notes": "Rendered by build system; multi-line placeholders expand to args per line."
    },
    "link": {
      "template": "compiler/build/toolchain/response_files/lld.rsp.tmpl",
      "prefix": "@",
      "notes": "May be used for lld or clang driver; wrapper adapts when possible."
    }
  },

  "defaults": {
    "lang": {
      "c": {
        "std": "c17",
        "pic": true,
        "exceptions": false,
        "rtti": false
      },
      "c++": {
        "std": "c++20",
        "pic": true,
        "exceptions": true,
        "rtti": true
      }
    },

    "warnings": {
      "base": [
        "-Wall",
        "-Wextra",
        "-Wpedantic"
      ],
      "disable": [
        "-Wno-unused-parameter"
      ],
      "werror": false
    },

    "optimization": {
      "level": "2",
      "debug": false,
      "lto": "off"
    },

    "determinism": {
      "enabled": true,
      "env": {
        "TZ": "UTC",
        "LC_ALL": "C"
      },
      "compiler_flags": [
        "-ffile-prefix-map=${PWD}=.",
        "-fmacro-prefix-map=${PWD}=.",
        "-fdebug-prefix-map=${PWD}=.",
        "-fno-record-gcc-switches"
      ],
      "notes": "Best-effort; some flags may be ignored depending on compiler/version."
    },

    "link": {
      "pie": true,
      "build_id": "sha1",
      "gc_sections": true,
      "strip": false
    }
  },

  "platform": {
    "darwin": {
      "notes": [
        "Prefer linking via clang/clang++ driver for correct SDK/runtime resolution.",
        "If targeting macOS/iOS, pass -isysroot/-target via rendered response file."
      ],
      "link_driver_preferred": true
    },
    "linux": {
      "notes": [
        "LLD is recommended when available (ld.lld).",
        "Build-id defaults to sha1 when determinism is enabled."
      ],
      "link_driver_preferred": true
    }
  },

  "env_overrides": {
    "verbose": "VITTE_VERBOSE",
    "deterministic": "VITTE_DETERMINISTIC",
    "lang": "VITTE_LANG",
    "std": "VITTE_STD",
    "opt": "VITTE_OPT",
    "debug": "VITTE_DEBUG",
    "sanitize": "VITTE_SANITIZE",
    "werror": "VITTE_WERROR",
    "pie": "VITTE_PIE",
    "lto": "VITTE_LTO",
    "strip": "VITTE_STRIP",
    "build_id": "VITTE_BUILD_ID",
    "ar_deterministic": "VITTE_AR_DETERMINISTIC"
  },

  "probes": {
    "version": {
      "command": ["${cc}", "--version"],
      "parse": "first_line"
    },
    "target_triple": {
      "command": ["${cc}", "-dumpmachine"],
      "parse": "trim"
    },
    "supports_flag": {
      "command": ["${cc}", "-Werror", "-x", "c", "-", "-c"],
      "stdin": "int main(void){return 0;}",
      "notes": "Generic probe; tooling may wrap to test a candidate flag."
    }
  }
}