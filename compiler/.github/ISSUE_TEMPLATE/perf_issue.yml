name: "Performance issue"
description: "Report a performance regression or hotspot in Vitte (compiler/runtime/stdlib/tools)"
title: "[Perf]: "
labels:
  - performance
  - needs-triage
body:
  - type: markdown
    attributes:
      value: |
        Use this form to report performance problems (regressions, slow paths, excessive memory).

        Before submitting:
        - Search existing issues (including closed).
        - If possible, include a minimal benchmark and raw measurements.
        - Prefer comparing **two commits/versions** (good vs bad).

  - type: checkboxes
    id: preflight
    attributes:
      label: "Pre-flight checks"
      options:
        - label: "I searched existing issues and did not find a duplicate."
          required: true
        - label: "I can reproduce this issue reliably (or I specify the variability below)."
          required: true
        - label: "I include enough data to be actionable (numbers, environment, commands)."
          required: true

  - type: dropdown
    id: component
    attributes:
      label: "Component"
      description: "Where is the perf issue?"
      options:
        - "compiler: lexer"
        - "compiler: parser (core)"
        - "compiler: parser (phrase/desugar)"
        - "compiler: sema/typecheck"
        - "compiler: lower/IR"
        - "compiler: codegen"
        - "compiler: diagnostics"
        - "compiler: CLI (vittec)"
        - "muffin (manifest/build)"
        - "runtime: VM/bytecode"
        - "runtime: GC/alloc"
        - "runtime: FFI/ABI"
        - "stdlib"
        - "bench"
        - "lsp / tooling"
        - "other"
    validations:
      required: true

  - type: dropdown
    id: perf_type
    attributes:
      label: "Perf type"
      options:
        - "regression (slower than before)"
        - "hotspot (always slow)"
        - "memory increase"
        - "CPU increase"
        - "startup time"
        - "I/O (disk)"
        - "other"
    validations:
      required: true

  - type: dropdown
    id: metric
    attributes:
      label: "Primary metric"
      description: "What is getting worse?"
      options:
        - "wall time"
        - "CPU time"
        - "peak RSS"
        - "allocations"
        - "binary size"
        - "other"
    validations:
      required: true

  - type: input
    id: baseline
    attributes:
      label: "Baseline (good) version/commit"
      description: "Tag or commit SHA that performs well."
      placeholder: "e.g. v0.3.0 or abcdef01..."
    validations:
      required: false

  - type: input
    id: regression
    attributes:
      label: "Regressed (bad) version/commit"
      description: "Tag or commit SHA that performs worse."
      placeholder: "e.g. v0.3.1 or 0123abcd..."
    validations:
      required: false

  - type: input
    id: vitte_version
    attributes:
      label: "Current Vitte version/commit"
      description: "Tag or full commit SHA from `git rev-parse HEAD`."
      placeholder: "e.g. 0123abcd..."
    validations:
      required: true

  - type: dropdown
    id: host_os
    attributes:
      label: "Host OS"
      options:
        - "Linux"
        - "macOS"
        - "Windows"
        - "FreeBSD"
        - "NetBSD"
        - "OpenBSD"
        - "DragonFly BSD"
        - "Solaris / illumos"
        - "Other (specify below)"
    validations:
      required: true

  - type: input
    id: host_os_version
    attributes:
      label: "Host OS version"
      placeholder: "e.g. Ubuntu 24.04"
    validations:
      required: true

  - type: input
    id: host_arch
    attributes:
      label: "Host architecture"
      placeholder: "e.g. x86_64, aarch64"
    validations:
      required: true

  - type: input
    id: cpu_model
    attributes:
      label: "CPU model"
      description: "Example: Intel i7-12700K, Ryzen 7 5800X, Apple M2"
      placeholder: "e.g. Apple M2"
    validations:
      required: false

  - type: input
    id: ram
    attributes:
      label: "RAM"
      placeholder: "e.g. 32 GB"
    validations:
      required: false

  - type: input
    id: storage
    attributes:
      label: "Storage"
      description: "SSD/NVMe/HDD; optional."
      placeholder: "e.g. NVMe SSD"
    validations:
      required: false

  - type: input
    id: toolchain
    attributes:
      label: "Build toolchain"
      description: "Compiler used to build Vitte (clang/gcc/MSVC + version)."
      placeholder: "e.g. clang 18.1.8"
    validations:
      required: false

  - type: dropdown
    id: build_profile
    attributes:
      label: "Build profile"
      options:
        - "release"
        - "debug"
        - "pgo"
        - "lto"
        - "asan"
        - "ubsan"
        - "tsan"
        - "other"
    validations:
      required: true

  - type: textarea
    id: summary
    attributes:
      label: "Summary"
      description: "What is slow and how do you observe it?"
      placeholder: "Example: vittec build takes 2.1s instead of 1.2s on project X."
    validations:
      required: true

  - type: textarea
    id: reproduction
    attributes:
      label: "Reproduction / benchmark"
      description: |
        Provide a runnable benchmark:
        - exact commands
        - input repo/data (or minimal reproduction)
        - number of iterations
        - warmup strategy
      value: |
        **Commands:**
        ```sh
        # baseline
        git checkout <good>
        ./scripts/build.sh
        hyperfine -w 3 -r 20 'vittec build'

        # regression
        git checkout <bad>
        ./scripts/build.sh
        hyperfine -w 3 -r 20 'vittec build'
        ```

        **Notes:**
        - CPU governor / power mode:
        - background load:
    validations:
      required: true

  - type: textarea
    id: measurements
    attributes:
      label: "Raw measurements"
      description: "Paste raw numbers (hyperfine output, perf stat, time -v, RSS, alloc counts)."
      render: text
      placeholder: |
        ```
        paste measurements here
        ```
    validations:
      required: true

  - type: textarea
    id: profiles
    attributes:
      label: "Profiles / traces"
      description: |
        Attach or paste excerpts:
        - Linux: `perf record/report`, `perf stat`
        - macOS: Instruments Time Profiler
        - Windows: WPA / ETW
      render: text
      placeholder: |
        ```
        top stacks / flamegraph summary
        ```
    validations:
      required: false

  - type: textarea
    id: compiler_flags
    attributes:
      label: "Relevant flags / config"
      description: "Any flags that affect perf (vittec flags, env vars, Muffin profiles)."
      placeholder: |
        - vittec flags:
        - env:
        - muffin profile:
    validations:
      required: false

  - type: textarea
    id: dataset
    attributes:
      label: "Dataset / workload"
      description: "Describe input size and shape (LOC, tokens, modules)."
      placeholder: |
        - LOC:
        - files/modules:
        - token count:
        - type count:
        - macro/feature usage:
    validations:
      required: false

  - type: dropdown
    id: variability
    attributes:
      label: "Variability"
      description: "How stable are the results?"
      options:
        - "stable (<2% variance)"
        - "moderate (2â€“10% variance)"
        - "high (>10% variance)"
        - "unknown"
    validations:
      required: true

  - type: textarea
    id: bisect
    attributes:
      label: "Bisect info"
      description: "If you ran git bisect, provide the first bad commit."
      placeholder: "First bad commit: ..."
    validations:
      required: false

  - type: checkboxes
    id: mitigation
    attributes:
      label: "Mitigation ideas"
      description: "Optional, but helpful."
      options:
        - label: "I can provide a minimized benchmark / reduced input."
          required: false
        - label: "I can run additional profiles (perf/Instruments/ETW) if requested."
          required: false
        - label: "I can test candidate patches quickly."
          required: false

  - type: textarea
    id: extra
    attributes:
      label: "Additional context"
      placeholder: "Any other details, links, screenshots."
    validations:
      required: false

  - type: checkboxes
    id: coc
    attributes:
      label: "Code of Conduct"
      options:
        - label: "I agree to follow this project's Code of Conduct."
          required: true
