# ============================================================
# vitte_mir_build::context
# Contexte global du MIR build
# ============================================================

space vitte/compiler/backends/vitte_mir_build


pull vitte/compiler/backends/vitte_mir_build/mir/mod as mir
pull vitte/compiler/backends/vitte_mir_build/analysis/mod as analysis
pull vitte/compiler/backends/vitte_mir_build/opt/mod as opt

pull std/collections/map as Map
pull std/collections/list as List


# ------------------------------------------------------------
# Options du MIR builder
# ------------------------------------------------------------

form MirBuildOptions
    enable_simplify: bool
    enable_dce: bool
    debug: bool
.end


proc MirBuildOptions::default
-> MirBuildOptions

    give MirBuildOptions {
        enable_simplify = true
        enable_dce = true
        debug = false
    }
.end


# ------------------------------------------------------------
# Diagnostics MIR
# ------------------------------------------------------------

pick MirDiagnosticKind
    case Info
    case Warning
    case Error
.end


form MirDiagnostic
    kind: MirDiagnosticKind
    message: string
.end


# ------------------------------------------------------------
# Contexte MIR build
# ------------------------------------------------------------

form MirBuildContext
    options: MirBuildOptions
    functions: Map[mir::FunctionId, mir::Function]
    diagnostics: List[MirDiagnostic]
.end


# ------------------------------------------------------------
# Constructeur
# ------------------------------------------------------------

proc MirBuildContext::new
    opts: MirBuildOptions
-> MirBuildContext

    give MirBuildContext {
        options = opts
        functions = Map::new()
        diagnostics = List::new()
    }
.end


# ------------------------------------------------------------
# Gestion des fonctions MIR
# ------------------------------------------------------------

proc MirBuildContext::add_function
    self: &mut MirBuildContext
    func: mir::Function
-> void

    self.functions.insert(func.id, func)
.end


proc MirBuildContext::get_function
    self: &MirBuildContext
    id: mir::FunctionId
-> &mir::Function

    give self.functions.get(id)
.end


proc MirBuildContext::get_function_mut
    self: &mut MirBuildContext
    id: mir::FunctionId
-> &mut mir::Function

    give self.functions.get_mut(id)
.end


# ------------------------------------------------------------
# Diagnostics
# ------------------------------------------------------------

proc MirBuildContext::emit_diag
    self: &mut MirBuildContext
    kind: MirDiagnosticKind
    msg: string
-> void

    self.diagnostics.push(
        MirDiagnostic {
            kind = kind
            message = msg
        }
    )
.end


# ------------------------------------------------------------
# Pipeline MIR complet sur une fonction
# ------------------------------------------------------------

proc MirBuildContext::run_pipeline
    self: &mut MirBuildContext
    id: mir::FunctionId
-> void

    let func = self.get_function_mut(id)

    if self.options.enable_simplify
        opt::run_simplify(func)
    .end

    if self.options.enable_dce
        opt::run_dce(func)
    .end

    if not func.validate()
        self.emit_diag(
            MirDiagnosticKind::Error,
            "invalid MIR function after pipeline"
        )
    .end

    if self.options.debug
        let cfg = analysis::build_cfg(func)
        if not analysis::validate_cfg(&cfg)
            self.emit_diag(
                MirDiagnosticKind::Warning,
                "CFG validation failed"
            )
        .end
    .end
.end
