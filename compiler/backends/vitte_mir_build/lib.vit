# ============================================================
# vitte_mir_build::lib
# Façade publique du backend MIR build
# ============================================================

space vitte/compiler/backends/vitte_mir_build


# ------------------------------------------------------------
# Sous-systèmes
# ------------------------------------------------------------

# MIR IR
pull vitte/compiler/backends/vitte_mir_build/mir/mod as mir

# Lowering
pull vitte/compiler/backends/vitte_mir_build/lower/mod as lower

# Analyses
pull vitte/compiler/backends/vitte_mir_build/analysis/mod as analysis

# Optimisations
pull vitte/compiler/backends/vitte_mir_build/opt/mod as opt

# Contexte global
pull vitte/compiler/backends/vitte_mir_build/context as ctx


# ------------------------------------------------------------
# Re-exports essentiels
# ------------------------------------------------------------

# MIR
use mir::Function
use mir::FunctionId
use mir::Block
use mir::BlockId
use mir::Instr
use mir::ValueId

# Context
use ctx::MirBuildContext
use ctx::MirBuildOptions
use ctx::MirDiagnostic
use ctx::MirDiagnosticKind

# Lowering
use lower::lower_from_hir

# Analyses
use analysis::build_cfg
use analysis::analyze_liveness

# Optimisations
use opt::run_simplify
use opt::run_dce


# ------------------------------------------------------------
# Pipeline MIR build haut niveau
# ------------------------------------------------------------

proc build_mir_from_hir
    hir_func: &vitte/compiler/backends/vitte_hir/ir/function::Function
    opts: MirBuildOptions
-> MirBuildContext

    let mut context =
        MirBuildContext::new(opts)

    # 1) Lowering HIR -> MIR
    let mir_func =
        lower_from_hir(hir_func)

    let fid = mir_func.id

    context.add_function(mir_func)

    # 2) Pipeline d’optimisation
    context.run_pipeline(fid)

    give context
.end


# ------------------------------------------------------------
# Accès direct simplifié (cas commun)
# ------------------------------------------------------------

proc lower_and_optimize
    hir_func: &vitte/compiler/backends/vitte_hir/ir/function::Function
-> mir::Function

    let ctx =
        build_mir_from_hir(
            hir_func,
            MirBuildOptions::default()
        )

    # une seule fonction produite
    for (_, f) in ctx.functions.iter()
        give f
    .end

    panic("no MIR function produced")
.end
