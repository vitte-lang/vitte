# ============================================================
# vitte_codegen_cranelift::space
# Gestion des espaces (modules) Vitte côté Cranelift
# ============================================================

space vitte/compiler/backends/vitte_codegen_cranelift

pull vitte/compiler/mir/ast as mir

pull vitte/compiler/backends/vitte_codegen_cranelift/context as cl_ctx
pull vitte/compiler/backends/vitte_codegen_cranelift/module as cl_mod_backend
pull vitte/compiler/backends/vitte_codegen_cranelift/errors as cl_err


# ------------------------------------------------------------
# Représentation backend d’un space Vitte
# ------------------------------------------------------------

form SpaceBackend
    name: string
    program: &mir::Program
.end


# ------------------------------------------------------------
# Construction
# ------------------------------------------------------------

proc SpaceBackend::new
    space_decl: &mir::SpaceDecl
    program: &mir::Program
-> SpaceBackend

    give SpaceBackend
        name = space_decl.name
        program = program
    .end
.end


# ------------------------------------------------------------
# Validation du space
# ------------------------------------------------------------

proc SpaceBackend::validate
    self: &SpaceBackend
-> ()

    if self.name.is_empty()
        cl_err::panic(
            "space name cannot be empty"
        )
    .end

    # Vérifications extensibles :
    # - conflits de symboles
    # - visibilité inter-space
    # - règles `share`
.end


# ------------------------------------------------------------
# Compilation d’un space
# ------------------------------------------------------------

proc SpaceBackend::compile
    self: &SpaceBackend
    ctx: &mut cl_ctx::CodegenCtx
-> bytes

    self.validate()

    let mut module_backend =
        cl_mod_backend::ModuleBackend::new(ctx)

    module_backend.declare(self.program)
    module_backend.codegen(self.program)
    module_backend.finalize()

    give ctx.module.finish()
.end


# ------------------------------------------------------------
# API haut niveau (utilisée par le driver)
# ------------------------------------------------------------

proc compile_space
    ctx: &mut cl_ctx::CodegenCtx
    space_decl: &mir::SpaceDecl
    program: &mir::Program
-> bytes

    let space = SpaceBackend::new(
        space_decl,
        program
    )

    give space.compile(ctx)
.end
