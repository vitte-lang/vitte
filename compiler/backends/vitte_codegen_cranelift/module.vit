# ============================================================
# vitte_codegen_cranelift::module
# Orchestration du codegen Cranelift au niveau module
# ============================================================

space vitte/compiler/backends/vitte_codegen_cranelift

pull vitte/compiler/mir/ast as mir

pull vitte/compiler/backends/vitte_codegen_cranelift/context as cl_ctx
pull vitte/compiler/backends/vitte_codegen_cranelift/function
pull vitte/compiler/backends/vitte_codegen_cranelift/errors as cl_err

pull cranelift/module as cl_mod


# ------------------------------------------------------------
# Structure ModuleBackend
# ------------------------------------------------------------

form ModuleBackend
    ctx: &mut cl_ctx::CodegenCtx
.end


# ------------------------------------------------------------
# Construction
# ------------------------------------------------------------

proc ModuleBackend::new
    ctx: &mut cl_ctx::CodegenCtx
-> ModuleBackend
    give ModuleBackend
        ctx = ctx
    .end
.end


# ------------------------------------------------------------
# Phase 1 — Déclaration des symboles
# ------------------------------------------------------------

proc ModuleBackend::declare
    self: &mut ModuleBackend
    program: &mir::Program
-> ()

    for func in program.functions
        self.ctx.declare_function(
            func.id,
            func.sig
        )
    .end
.end


# ------------------------------------------------------------
# Phase 2 — Génération du code
# ------------------------------------------------------------

proc ModuleBackend::codegen
    self: &mut ModuleBackend
    program: &mir::Program
-> ()

    for func in program.functions
        function::lower_fn(
            self.ctx,
            func
        )
    .end
.end


# ------------------------------------------------------------
# Phase 3 — Finalisation
# ------------------------------------------------------------

proc ModuleBackend::finalize
    self: &mut ModuleBackend
-> ()

    # À ce stade, toutes les fonctions doivent être définies
    # Cranelift vérifie la cohérence interne à la finalisation
    self.ctx.module.finalize_definitions()
.end


# ------------------------------------------------------------
# API compacte (module → objet)
# ------------------------------------------------------------

proc compile_module
    ctx: &mut cl_ctx::CodegenCtx
    program: &mir::Program
-> bytes

    let mut backend = ModuleBackend::new(ctx)

    backend.declare(program)
    backend.codegen(program)
    backend.finalize()

    give ctx.module.finish()
.end
