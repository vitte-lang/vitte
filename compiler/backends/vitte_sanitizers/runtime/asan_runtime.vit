# ============================================================
# Vitte â€” AddressSanitizer Runtime
# File: runtime/asan_runtime.vit
#
# Role:
#   Provide runtime support for ASan instrumentation.
#
# Contract:
#   - Called by MIR intrinsics: __asan_*
#   - ABI-stable, backend-agnostic
#   - Target-specific lowering happens later
#
# ============================================================

space compiler/backends/vitte_sanitizers/runtime/asan_runtime

pull compiler/backends/vitte_sanitizers/config
pull compiler/backends/vitte_sanitizers/messages
pull compiler/backends/vitte_sanitizers/context


# ============================================================
# Public ABI (intrinsics)
# ============================================================

# Called before a memory load
proc __asan_check_load(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    if !asan_is_addressable(ptr, size)
        asan_report_load(ptr, size)
    end
.end


# Called before a memory store
proc __asan_check_store(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    if !asan_is_addressable(ptr, size)
        asan_report_store(ptr, size)
    end
.end


# Called after allocation
proc __asan_alloc(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    asan_poison_redzones(ptr, size)
.end


# Called before free
proc __asan_free(
    ptr: Ptr
)
gives ()
.end
    asan_unpoison_region(ptr)
.end


# ============================================================
# Core logic (simplified reference implementation)
# ============================================================

proc asan_is_addressable(
    ptr: Ptr,
    size: Int
)
gives Bool
.end
    # Placeholder logic:
    # - real impl uses shadow memory
    # - target-dependent mapping
    if ptr == null
        give false
    end

    # TODO: consult shadow memory
    give true
.end


proc asan_poison_redzones(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    # TODO: poison left/right redzones in shadow memory
    ()
.end


proc asan_unpoison_region(
    ptr: Ptr
)
gives ()
.end
    # TODO: mark region as freed in shadow memory
    ()
.end


# ============================================================
# Reporting
# ============================================================

proc asan_report_load(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    asan_print_header("heap-buffer-overflow (read)")
    asan_print_location(ptr, size)
    asan_abort()
.end


proc asan_report_store(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    asan_print_header("heap-buffer-overflow (write)")
    asan_print_location(ptr, size)
    asan_abort()
.end


proc asan_print_header(
    kind: String
)
gives ()
.end
    runtime_println("AddressSanitizer: " + kind)
.end


proc asan_print_location(
    ptr: Ptr,
    size: Int
)
gives ()
.end
    runtime_println("  address: " + ptr.to_string())
    runtime_println("  size: " + size.to_string())
.end


proc asan_abort()
gives Never
.end
    runtime_abort()
.end


# ============================================================
# Runtime hooks (provided by platform / std)
# ============================================================

foreign proc runtime_println(msg: String) gives ()
foreign proc runtime_abort() gives Never
