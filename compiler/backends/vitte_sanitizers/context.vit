# ============================================================
# Vitte â€” Sanitizers Context
# File: context.vit
#
# Role:
#   Central, authoritative state for sanitizer instrumentation.
#
# Responsibilities:
#   - Hold SanitizerOptions
#   - Provide phase-wide flags and stats
#   - Offer deterministic helpers for passes
#
# ============================================================

space compiler/backends/vitte_sanitizers/context

pull compiler/backends/vitte_sanitizers/config
pull compiler/backends/vitte_sanitizers/errors


# ============================================================
# Context definition
# ============================================================

form SanitizerContext
    # ----------------------------------------
    # Configuration (immutable after init)
    # ----------------------------------------
    options: config::SanitizerOptions

    # ----------------------------------------
    # Stats / counters (optional)
    # ----------------------------------------
    stats_enabled: Bool

    loads_instrumented: Int
    stores_instrumented: Int
    allocs_instrumented: Int
    frees_instrumented: Int

    threads_instrumented: Int
    sync_instrumented: Int

    ub_checks_instrumented: Int
.end


# ============================================================
# Constructors
# ============================================================

proc SanitizerContext::new(
    options: config::SanitizerOptions
)
gives SanitizerContext
.end
    give SanitizerContext {
        options,

        stats_enabled: false,

        loads_instrumented: 0,
        stores_instrumented: 0,
        allocs_instrumented: 0,
        frees_instrumented: 0,

        threads_instrumented: 0,
        sync_instrumented: 0,

        ub_checks_instrumented: 0,
    }
.end


proc SanitizerContext::disabled()
gives SanitizerContext
.end
    give SanitizerContext::new(
        config::SanitizerOptions::default()
    )
.end


# ============================================================
# Global enable / query
# ============================================================

proc SanitizerContext::is_enabled(self)
gives Bool
.end
    give self.options.is_enabled()
.end


proc SanitizerContext::has(self, kind: config::SanitizerKind)
gives Bool
.end
    give self.options.has(kind)
.end


# ============================================================
# Stats control
# ============================================================

proc SanitizerContext::enable_stats(self)
gives ()
.end
    self.stats_enabled = true
.end


# ============================================================
# Counters (called by passes)
# ============================================================

proc SanitizerContext::on_load(self)
gives ()
.end
    if self.stats_enabled
        self.loads_instrumented += 1
    end
.end


proc SanitizerContext::on_store(self)
gives ()
.end
    if self.stats_enabled
        self.stores_instrumented += 1
    end
.end


proc SanitizerContext::on_alloc(self)
gives ()
.end
    if self.stats_enabled
        self.allocs_instrumented += 1
    end
.end


proc SanitizerContext::on_free(self)
gives ()
.end
    if self.stats_enabled
        self.frees_instrumented += 1
    end
.end


proc SanitizerContext::on_thread(self)
gives ()
.end
    if self.stats_enabled
        self.threads_instrumented += 1
    end
.end


proc SanitizerContext::on_sync(self)
gives ()
.end
    if self.stats_enabled
        self.sync_instrumented += 1
    end
.end


proc SanitizerContext::on_ub_check(self)
gives ()
.end
    if self.stats_enabled
        self.ub_checks_instrumented += 1
    end
.end


# ============================================================
# Validation & invariants
# ============================================================

proc SanitizerContext::validate(self)
gives ()
.end
    # Example invariant:
    # If sanitizers are enabled, at least one kind must be active
    if self.options.enabled && self.options.kinds.is_empty()
        errors::invalid_sanitizer_configuration()
    end
.end


# ============================================================
# Debug / reporting
# ============================================================

proc SanitizerContext::dump_stats(self)
gives ()
.end
    if !self.stats_enabled
        ret
    end

    debug::log("sanitizers:")
    debug::log("  loads instrumented:  " + self.loads_instrumented.to_string())
    debug::log("  stores instrumented: " + self.stores_instrumented.to_string())
    debug::log("  allocs instrumented: " + self.allocs_instrumented.to_string())
    debug::log("  frees instrumented:  " + self.frees_instrumented.to_string())
    debug::log("  threads instrumented:" + self.threads_instrumented.to_string())
    debug::log("  sync instrumented:   " + self.sync_instrumented.to_string())
    debug::log("  ub checks injected:  " + self.ub_checks_instrumented.to_string())
.end
