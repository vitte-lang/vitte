# ============================================================
# vitte_mir_dataflow::analysis::framework::engine
# Moteur générique d’analyses de flot de données
# ============================================================

space vitte/compiler/backends/vitte_mir_dataflow/analysis/framework


pull vitte/compiler/backends/vitte_mir_dataflow/analysis/framework/direction
    as direction

pull vitte/compiler/backends/vitte_mir_dataflow/analysis/framework/domain
    as domain

pull vitte/compiler/backends/vitte_mir_dataflow/analysis/framework/solver
    as solver

pull vitte/compiler/backends/vitte_mir_dataflow/analysis/framework/transfer
    as transfer


# ------------------------------------------------------------
# Description complète d’une analyse dataflow
# ------------------------------------------------------------

form DataflowAnalysis
    name: string

    # Direction (forward / backward)
    direction: direction::DataflowDirection

    # Domaine abstrait
    domain: domain::DataflowDomain

    # Fonctions de transfert
    transfer: transfer::TransferFunctions
.end


# ------------------------------------------------------------
# Résultat générique d’une analyse
# ------------------------------------------------------------

form DataflowResult
    # In / Out par nœud (BlockId générique)
    in_state:  map[any, any]
    out_state: map[any, any]
.end


# ------------------------------------------------------------
# Exécution d’une analyse
# ------------------------------------------------------------

proc run_analysis
    analysis: &DataflowAnalysis
    graph: &solver::DataflowGraph
-> DataflowResult

    # Initialisation des états
    let (in_state, out_state) =
        solver::initialize_states(
            graph,
            analysis.domain
        )

    # Résolution par point fixe
    solver::solve(
        graph,
        analysis.direction,
        analysis.domain,
        analysis.transfer,
        &mut in_state,
        &mut out_state
    )

    give DataflowResult {
        in_state = in_state
        out_state = out_state
    }
.end


# ------------------------------------------------------------
# Helpers de debug
# ------------------------------------------------------------

proc dump_result
    analysis: &DataflowAnalysis
    result: &DataflowResult
-> void

    print("Dataflow analysis: " + analysis.name)

    for (node, value) in result.in_state.iter()
        print("IN[" + node.to_string() + "] = " + value.to_string())
    .end

    for (node, value) in result.out_state.iter()
        print("OUT[" + node.to_string() + "] = " + value.to_string())
    .end
.end
