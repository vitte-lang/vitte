# ============================================================
# vitte_transmute::lib
# API publique du sous-système de transmutation
# ============================================================

space vitte/compiler/backends/vitte_transmute


# ------------------------------------------------------------
# Modules fondamentaux
# ------------------------------------------------------------

# Contexte et politique
pull vitte/compiler/backends/vitte_transmute/context

# Analyses ABI / layout
pull vitte/compiler/backends/vitte_transmute/analysis/mod as analysis

# Lowering vers SSA / IR
pull vitte/compiler/backends/vitte_transmute/lower/mod as lower


# ------------------------------------------------------------
# Re-exports publics
# ------------------------------------------------------------

# Contexte
use context::TransmuteContext
use context::TransmutePolicy

# Analyses
use analysis::Alignment
use analysis::AlignPolicy
use analysis::Validity
use analysis::ValidityContext
use analysis::analyze_validity
use analysis::can_transmute

# Lowering
use lower::EmitKind
use lower::EmitResult
use lower::emit_transmute
use lower::lower_transmute


# ------------------------------------------------------------
# Façade haut niveau
# ------------------------------------------------------------

proc transmute
    ctx: &mut vitte/compiler/backends/vitte_codegen_ssa/context::CodegenCtx
    tctx: &TransmuteContext
    from_ty: &vitte/compiler/backends/vitte_transmute/ir/type::Type
    to_ty: &vitte/compiler/backends/vitte_transmute/ir/type::Type
    value: vitte/compiler/backends/vitte_codegen_ssa/ir/value::Value
-> vitte/compiler/backends/vitte_codegen_ssa/ir/value::Value

    # --------------------------------------------------------
    # Analyse avec la politique courante
    # --------------------------------------------------------

    let vctx =
        tctx.validity_context()

    let v =
        analysis::analyze_validity(
            from_ty,
            to_ty,
            &vctx
        )

    select v

        when analysis::Validity::Valid
            give lower::lower_transmute(
                ctx,
                from_ty,
                to_ty,
                value
            )

        when analysis::Validity::Unsafe(reason)
            if not tctx.policy.allow_unsafe
                panic(
                    "unsafe transmute rejected: " + reason
                )
            .end

            give lower::lower_transmute(
                ctx,
                from_ty,
                to_ty,
                value
            )

        when analysis::Validity::Invalid(reason)
            panic(
                "invalid transmute: " + reason
            )
    .end
.end
