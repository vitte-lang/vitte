# ============================================================
# vitte_target::context
# Contexte global de la cible (ABI / mangling / machine)
# ============================================================

space vitte/compiler/backends/vitte_target


pull vitte/compiler/backends/vitte_target/schemes/itanium
pull vitte/compiler/backends/vitte_target/schemes/msvc
pull vitte/compiler/backends/vitte_target/schemes/simple

pull vitte/compiler/backends/vitte_target/utils/mod as utils


# ------------------------------------------------------------
# Endianness
# ------------------------------------------------------------

pick Endianness
    case Little
    case Big
.end


# ------------------------------------------------------------
# ABI / Mangling scheme
# ------------------------------------------------------------

pick AbiKind
    case Itanium
    case MSVC
    case Simple
.end


# ------------------------------------------------------------
# Description de la machine cible
# ------------------------------------------------------------

form TargetMachine
    triple: string
    pointer_size: u32
    pointer_align: u32
    endianness: Endianness
.end


proc TargetMachine::default
-> TargetMachine

    # Valeurs génériques sûres (x86_64-like)
    give TargetMachine {
        triple = "unknown-unknown-unknown"
        pointer_size = 8
        pointer_align = 8
        endianness = Endianness::Little
    }
.end


# ------------------------------------------------------------
# Contexte cible global
# ------------------------------------------------------------

form TargetContext
    machine: TargetMachine
    abi: AbiKind
.end


proc TargetContext::default
-> TargetContext

    give TargetContext {
        machine = TargetMachine::default()
        abi = AbiKind::Simple
    }
.end


proc TargetContext::with_triple
    triple: string
-> TargetContext

    # Heuristique simple basée sur le triple
    if triple.contains("windows")
        give TargetContext {
            machine = TargetMachine {
                triple = triple
                pointer_size = 8
                pointer_align = 8
                endianness = Endianness::Little
            }
            abi = AbiKind::MSVC
        }
    .end

    if triple.contains("linux")
        give TargetContext {
            machine = TargetMachine {
                triple = triple
                pointer_size = 8
                pointer_align = 8
                endianness = Endianness::Little
            }
            abi = AbiKind::Itanium
        }
    .end

    # Fallback
    give TargetContext {
        machine = TargetMachine::default()
        abi = AbiKind::Simple
    }
.end


# ------------------------------------------------------------
# Accesseurs ABI
# ------------------------------------------------------------

proc TargetContext::abi_scheme_name
    self: &TargetContext
-> string

    select self.abi
        when AbiKind::Itanium give "itanium"
        when AbiKind::MSVC    give "msvc"
        when AbiKind::Simple  give "simple"
    .end
.end


proc TargetContext::abi_version
    self: &TargetContext
-> string

    select self.abi
        when AbiKind::Itanium give itanium::itanium_scheme().version
        when AbiKind::MSVC    give msvc::msvc_scheme().version
        when AbiKind::Simple  give simple::simple_scheme().version
    .end
.end


# ------------------------------------------------------------
# Accesseurs utilitaires
# ------------------------------------------------------------

proc TargetContext::pointer_hash
    self: &TargetContext
-> utils::Hash64

    give utils::fnv1a64(
        self.machine.triple +
        self.abi_scheme_name()
    )
.end
