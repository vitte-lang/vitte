# ============================================================
# vitte_target::lib
# Façade publique du sous-système target
# ============================================================

space vitte/compiler/backends/vitte_target


# ------------------------------------------------------------
# Modules fondamentaux
# ------------------------------------------------------------

# Contexte cible (machine + ABI)
pull vitte/compiler/backends/vitte_target/context

# Schémas ABI / mangling
pull vitte/compiler/backends/vitte_target/schemes/itanium
pull vitte/compiler/backends/vitte_target/schemes/msvc
pull vitte/compiler/backends/vitte_target/schemes/simple

# Utilitaires transverses
pull vitte/compiler/backends/vitte_target/utils/mod as utils


# ------------------------------------------------------------
# Re-exports publics (context)
# ------------------------------------------------------------

use context::TargetContext
use context::TargetMachine
use context::AbiKind
use context::Endianness


# ------------------------------------------------------------
# Re-exports publics (schemes)
# ------------------------------------------------------------

# Métadonnées ABI
use itanium::itanium_scheme
use msvc::msvc_scheme
use simple::simple_scheme


# ------------------------------------------------------------
# Re-exports publics (utils)
# ------------------------------------------------------------

use utils::Hash64
use utils::Hash32
use utils::fnv1a64
use utils::fnv1a32
use utils::hash_suffix


# ------------------------------------------------------------
# Accès unifié au schéma ABI
# ------------------------------------------------------------

proc abi_scheme_name
    ctx: &TargetContext
-> string

    give ctx.abi_scheme_name()
.end


proc abi_version
    ctx: &TargetContext
-> string

    give ctx.abi_version()
.end


# ------------------------------------------------------------
# Dispatcher de schéma (haut niveau)
# ------------------------------------------------------------

pick AbiSchemeRef
    case Itanium
    case MSVC
    case Simple
.end


proc select_scheme
    ctx: &TargetContext
-> AbiSchemeRef

    select ctx.abi
        when AbiKind::Itanium give AbiSchemeRef::Itanium
        when AbiKind::MSVC    give AbiSchemeRef::MSVC
        when AbiKind::Simple  give AbiSchemeRef::Simple
    .end
.end
