# ============================================================
# vitte_codegen_ssa::ir::value
# Définition des valeurs SSA canoniques
# ============================================================

space vitte/compiler/backends/vitte_codegen_ssa/ir

pull vitte/compiler/backends/vitte_codegen_ssa/ir/type as ssa_ty

pull std/collections/list as List


# ------------------------------------------------------------
# Identifiant SSA
# ------------------------------------------------------------

form ValueId
    id: u32
.end


# ------------------------------------------------------------
# Catégories de valeurs SSA
# ------------------------------------------------------------

pick ValueKind
    case Const      # constante immédiate
    case Param      # paramètre de fonction
    case Temp       # résultat d’instruction
    case Phi        # valeur PHI (SSA)
.end


# ------------------------------------------------------------
# Valeur SSA
# ------------------------------------------------------------

form Value
    id: ValueId
    kind: ValueKind
    ty: ssa_ty::Type
    name: string
.end


# ------------------------------------------------------------
# Construction
# ------------------------------------------------------------

proc Value::new
    id: u32
    kind: ValueKind
    ty: ssa_ty::Type
    name: string
-> Value

    give Value
        id = ValueId { id = id }
        kind = kind
        ty = ty
        name = name
    .end
.end


# ------------------------------------------------------------
# Helpers de catégorisation
# ------------------------------------------------------------

proc Value::is_const
    self: &Value
-> bool
    give self.kind == ValueKind::Const
.end

proc Value::is_param
    self: &Value
-> bool
    give self.kind == ValueKind::Param
.end

proc Value::is_temp
    self: &Value
-> bool
    give self.kind == ValueKind::Temp
.end

proc Value::is_phi
    self: &Value
-> bool
    give self.kind == ValueKind::Phi
.end


# ------------------------------------------------------------
# Représentation texte (debug / emit SSA)
# ------------------------------------------------------------

proc Value::to_string
    self: &Value
-> string

    select self.kind
        when ValueKind::Const
            give self.name

        when ValueKind::Param
            give "%" + self.name

        when ValueKind::Temp
            give "%" + self.name

        when ValueKind::Phi
            give "%" + self.name

        otherwise
            give "<invalid>"
    .end
.end
