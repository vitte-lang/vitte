# ============================================================
# vitte_codegen_ssa::ir::mod
# DÃ©finition du module SSA canonique
# ============================================================

space vitte/compiler/backends/vitte_codegen_ssa/ir

pull vitte/compiler/backends/vitte_codegen_ssa/ir/function as ssa_fn
pull vitte/compiler/backends/vitte_codegen_ssa/ir/type as ssa_ty

pull std/collections/map as Map
pull std/collections/list as List


# ------------------------------------------------------------
# Identifiant de module SSA
# ------------------------------------------------------------

form ModuleId
    id: u32
.end


# ------------------------------------------------------------
# Module SSA
# ------------------------------------------------------------

form Module
    id: ModuleId
    name: string

    functions: Map<ssa_fn::FunctionId, ssa_fn::Function>

    next_function_id: u32
.end


# ------------------------------------------------------------
# Construction
# ------------------------------------------------------------

proc Module::new
    name: string
-> Module

    give Module
        id = ModuleId { id = 0 }
        name = name
        functions = Map::new()
        next_function_id = 0
    .end
.end


# ------------------------------------------------------------
# Gestion des fonctions
# ------------------------------------------------------------

proc Module::add_function
    self: &mut Module
    func: ssa_fn::Function
-> ()

    self.functions.insert(
        func.id,
        func
    )
.end


proc Module::new_function_id
    self: &mut Module
-> ssa_fn::FunctionId

    let id = self.next_function_id
    self.next_function_id = id + 1

    give ssa_fn::FunctionId { id = id }
.end


proc Module::get_function
    self: &Module
    id: ssa_fn::FunctionId
-> &ssa_fn::Function

    give self.functions.get(id).unwrap()
.end


proc Module::get_function_mut
    self: &mut Module
    id: ssa_fn::FunctionId
-> &mut ssa_fn::Function

    give self.functions.get_mut(id).unwrap()
.end


# ------------------------------------------------------------
# Validation globale SSA
# ------------------------------------------------------------

proc Module::validate
    self: &Module
-> bool

    # 1) au moins une fonction
    if self.functions.is_empty()
        give false
    .end

    # 2) toutes les fonctions sont SSA-valides
    for (_, func) in self.functions
        if not func.validate()
            give false
        .end
    .end

    give true
.end


# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

proc Module::function_count
    self: &Module
-> u32

    give self.functions.len()
.end
