# ============================================================
# vitte_codegen_ssa::opt::mod
# Façade du pipeline d’optimisation SSA
# ============================================================

space vitte/compiler/backends/vitte_codegen_ssa/opt

pull vitte/compiler/backends/vitte_codegen_ssa/ir/mod as ssa_mod
pull vitte/compiler/backends/vitte_codegen_ssa/context as ssa_ctx
pull vitte/compiler/backends/vitte_codegen_ssa/errors as ssa_err

# Passes SSA
pull vitte/compiler/backends/vitte_codegen_ssa/opt/cfg
pull vitte/compiler/backends/vitte_codegen_ssa/opt/cse
pull vitte/compiler/backends/vitte_codegen_ssa/opt/dce


# ------------------------------------------------------------
# Options d’optimisation SSA
# ------------------------------------------------------------

form OptOptions
    cfg: bool        # CFG cleanup / simplification
    cse: bool        # Common Subexpression Elimination
    dce: bool        # Dead Code Elimination
    verify: bool     # vérification SSA finale
.end


# ------------------------------------------------------------
# Presets d’optimisation
# ------------------------------------------------------------

proc OptOptions::none
-> OptOptions

    give OptOptions {
        cfg = false
        cse = false
        dce = false
        verify = true
    }
.end


proc OptOptions::basic
-> OptOptions

    give OptOptions {
        cfg = true
        cse = false
        dce = true
        verify = true
    }
.end


proc OptOptions::full
-> OptOptions

    give OptOptions {
        cfg = true
        cse = true
        dce = true
        verify = true
    }
.end


# ------------------------------------------------------------
# API principale — pipeline SSA
# ------------------------------------------------------------

proc optimize_module
    ctx: &mut ssa_ctx::CodegenCtx
    module: &mut ssa_mod::Module
    opts: &OptOptions
-> ()

    # --------------------------------------------------------
    # CFG cleanup (toujours en premier)
    # --------------------------------------------------------

    if opts.cfg
        cfg::optimize_cfg(module)
    .end


    # --------------------------------------------------------
    # CSE (après CFG, avant DCE)
    # --------------------------------------------------------

    if opts.cse
        cse::optimize_cse(module)
    .end


    # --------------------------------------------------------
    # DCE (toujours en dernier)
    # --------------------------------------------------------

    if opts.dce
        dce::optimize_dce(module)
    .end


    # --------------------------------------------------------
    # Vérification SSA finale
    # --------------------------------------------------------

    if opts.verify
        if not module.validate()
            ssa_err::panic(
                "SSA validation failed after optimization"
            )
        .end
    .end
.end


# ------------------------------------------------------------
# API convenience
# ------------------------------------------------------------

proc optimize_module_full
    ctx: &mut ssa_ctx::CodegenCtx
    module: &mut ssa_mod::Module
-> ()

    let opts = OptOptions::full()

    optimize_module(
        ctx,
        module,
        &opts
    )
.end


proc optimize_module_basic
    ctx: &mut ssa_ctx::CodegenCtx
    module: &mut ssa_mod::Module
-> ()

    let opts = OptOptions::basic()

    optimize_module(
        ctx,
        module,
        &opts
    )
.end
