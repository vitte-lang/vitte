# ============================================================
# vitte_codegen_ssa::lower::mod
# Façade de lowering MIR -> SSA
# ============================================================

space vitte/compiler/backends/vitte_codegen_ssa/lower

# MIR
pull vitte/compiler/mir/ast as mir

# SSA
pull vitte/compiler/backends/vitte_codegen_ssa/ir/module as ssa_mod
pull vitte/compiler/backends/vitte_codegen_ssa/context as ssa_ctx
pull vitte/compiler/backends/vitte_codegen_ssa/errors as ssa_err

# Sous-passes de lowering
pull vitte/compiler/backends/vitte_codegen_ssa/lower/from_ir


# ------------------------------------------------------------
# Options de lowering SSA
# ------------------------------------------------------------

form LowerOptions
    verify: bool          # vérification SSA après lowering
.end


# ------------------------------------------------------------
# API principale — MIR -> SSA
# ------------------------------------------------------------

proc lower_program
    ctx: &mut ssa_ctx::CodegenCtx
    program: &mir::Program
    opts: &LowerOptions
-> ssa_mod::Module

    # Étape 1 : lowering structurel MIR -> SSA
    let module =
        from_ir::lower_from_mir(
            ctx,
            program
        )

    # Étape 2 : vérification SSA optionnelle
    if opts.verify
        if not module.validate()
            ssa_err::panic(
                "SSA module validation failed"
            )
        .end
    .end

    give module
.end


# ------------------------------------------------------------
# API convenience (options par défaut)
# ------------------------------------------------------------

proc lower_program_default
    ctx: &mut ssa_ctx::CodegenCtx
    program: &mir::Program
-> ssa_mod::Module

    let opts =
        LowerOptions {
            verify = true
        }

    give lower_program(
        ctx,
        program,
        &opts
    )
.end
