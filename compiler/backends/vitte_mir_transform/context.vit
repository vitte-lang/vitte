# ============================================================
# vitte_mir_transform::context
# Contexte global des transformations MIR
# ============================================================

space vitte/compiler/backends/vitte_mir_transform


# ------------------------------------------------------------
# Imports
# ------------------------------------------------------------

pull vitte/compiler/backends/vitte_mir_build/mir/mod as mir

pull vitte/compiler/backends/vitte_mir_transform/passes/mod as passes

pull std/collections/list as List


# ------------------------------------------------------------
# Diagnostics
# ------------------------------------------------------------

pick TransformDiagnosticKind
    case Info
    case Warning
    case Error
.end


form TransformDiagnostic
    kind: TransformDiagnosticKind
    message: string
.end


# ------------------------------------------------------------
# Options de transformation MIR
# ------------------------------------------------------------

form TransformOptions
    enable_simplify: bool
    enable_unreachable: bool
    enable_inlining: bool
    enable_cleanup: bool

    debug: bool
.end


proc TransformOptions::default
-> TransformOptions

    give TransformOptions {
        enable_simplify = true
        enable_unreachable = true
        enable_inlining = false
        enable_cleanup = true
        debug = false
    }
.end


# ------------------------------------------------------------
# Contexte MIR transform
# ------------------------------------------------------------

form TransformContext
    options: TransformOptions
    diagnostics: List[TransformDiagnostic]
.end


# ------------------------------------------------------------
# Constructeur
# ------------------------------------------------------------

proc TransformContext::new
    opts: TransformOptions
-> TransformContext

    give TransformContext {
        options = opts
        diagnostics = List::new()
    }
.end


# ------------------------------------------------------------
# Diagnostics
# ------------------------------------------------------------

proc TransformContext::emit_diag
    self: &mut TransformContext
    kind: TransformDiagnosticKind
    msg: string
-> void

    self.diagnostics.push(
        TransformDiagnostic {
            kind = kind
            message = msg
        }
    )
.end


# ------------------------------------------------------------
# Pipeline standard de transformation MIR
# ------------------------------------------------------------

proc TransformContext::run_pipeline
    self: &mut TransformContext
    func: &mut mir::Function
-> void

    if self.options.debug
        self.emit_diag(
            TransformDiagnosticKind::Info,
            "MIR transform pipeline start"
        )
    .end

    if self.options.enable_simplify
        passes::run_simplify(func)
    .end

    if self.options.enable_unreachable
        passes::run_unreachable(func)
    .end

    if self.options.enable_inlining
        # inlining inter-fonctions non automatique ici
        self.emit_diag(
            TransformDiagnosticKind::Warning,
            "Inlining enabled but no callees provided"
        )
    .end

    if self.options.enable_cleanup
        passes::run_cleanup(func)
    .end

    if self.options.debug
        self.emit_diag(
            TransformDiagnosticKind::Info,
            "MIR transform pipeline end"
        )
    .end
.end
