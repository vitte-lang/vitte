# ============================================================
# vitte â€” ir_terminator.vit
# AST-IR Terminator Instructions (ULTRA MAX)
# ============================================================

space vitte/ast_ir/control_flow

# ----------------------------
# Imports
# ----------------------------

pull vitte/ast_ir/common
pull vitte/ast_ir/attribute
pull vitte/collections/list
pull vitte/collections/set

# ----------------------------
# Public API
# ----------------------------

share all

# ----------------------------
# Terminator kind
# ----------------------------

type TerminatorKind
    Jump            # unconditional jump
    Branch          # conditional branch
    Return          # function return
    Throw           # exception / error exit
    Unreachable     # unreachable code
.end

# ----------------------------
# IR Terminator
# ----------------------------

type IrTerminator
    kind        : TerminatorKind
    targets     : List[BlockId]
    cond        : ValueId?
    value       : ValueId?
    attrs       : AttributeBundle
.end

# ----------------------------
# Constructors
# ----------------------------

proc IrTerminator.jump(target: BlockId) -> IrTerminator
    return IrTerminator {
        kind    = TerminatorKind::Jump,
        targets = List.of(target),
        cond    = none,
        value   = none,
        attrs   = AttributeBundle.new()
    }
.end

proc IrTerminator.branch(cond: ValueId, then_b: BlockId, else_b: BlockId) -> IrTerminator
    return IrTerminator {
        kind    = TerminatorKind::Branch,
        targets = List.of(then_b, else_b),
        cond    = some(cond),
        value   = none,
        attrs   = AttributeBundle.new()
    }
.end

proc IrTerminator.ret(v: ValueId?) -> IrTerminator
    return IrTerminator {
        kind    = TerminatorKind::Return,
        targets = List.new(),
        cond    = none,
        value   = v,
        attrs   = AttributeBundle.new()
    }
.end

proc IrTerminator.throw(v: ValueId?) -> IrTerminator
    return IrTerminator {
        kind    = TerminatorKind::Throw,
        targets = List.new(),
        cond    = none,
        value   = v,
        attrs   = AttributeBundle.new()
    }
.end

proc IrTerminator.unreachable() -> IrTerminator
    return IrTerminator {
        kind    = TerminatorKind::Unreachable,
        targets = List.new(),
        cond    = none,
        value   = none,
        attrs   = AttributeBundle.new()
    }
.end

# ----------------------------
# Queries
# ----------------------------

proc is_control_flow(term: IrTerminator) -> bool
    return term.kind == TerminatorKind::Jump ||
           term.kind == TerminatorKind::Branch
.end

proc is_exit(term: IrTerminator) -> bool
    match term.kind
        TerminatorKind::Return      => true
        TerminatorKind::Throw       => true
        TerminatorKind::Unreachable => true
        _                           => false
    .end
.end

proc successors(term: IrTerminator) -> Set[BlockId]
    let out = Set.new()
    for t in term.targets
        out.insert(t)
    .end
    return out
.end

# ----------------------------
# Debug / Dump
# ----------------------------

proc dump(term: IrTerminator)
    say "IrTerminator kind=", term.kind
    if term.cond?
        say " cond=", term.cond?
    .end
    if term.value?
        say " value=", term.value?
    .end
    say " targets=", term.targets
.end

# ----------------------------
# End of module
# ----------------------------
