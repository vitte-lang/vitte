# =========================================================
# Vitte 1.0 — AST / Item / Foreign
# =========================================================

space vitte/ast/item/foreign

share all

<<< doc
Ce module définit la représentation AST des éléments *foreign*
(FFI) dans le langage Vitte.

Les éléments foreign permettent de :
- déclarer des symboles externes (fonctions, variables)
- décrire l’ABI attendue
- préparer l’intégration backend (C, system, VM)

À ce niveau :
- aucune vérification ABI
- aucune résolution de symbole
- aucune génération de code
Tout est structurel et déclaratif.
>>>

# ---------------------------------------------------------
# Dépendances communes
# ---------------------------------------------------------

pull vitte/ast/common/span
pull vitte/ast/common/ident
pull vitte/ast/common/path

# ---------------------------------------------------------
# ABI supportées (surface / déclaratif)
# ---------------------------------------------------------

pick ForeignAbi
    case C          # ABI C classique
    case System     # ABI système (plateforme)
    case Rust       # ABI Rust (interne)
    case Vitte      # ABI Vitte (interne)
.end

# ---------------------------------------------------------
# Modificateurs foreign
# ---------------------------------------------------------

pick ForeignModifier
    case Variadic          # ... (C varargs)
    case Unsafe            # appel non sûr
    case NoMangle          # pas de name mangling
.end

# ---------------------------------------------------------
# Type foreign (signature simplifiée)
# ---------------------------------------------------------

form ForeignType
    field params as List[TypeExpr]
    field result as TypeExpr
.end

# ---------------------------------------------------------
# Déclaration de fonction foreign
# ---------------------------------------------------------

form ForeignFn
    field name as Ident
    field abi as ForeignAbi
    field modifiers as List[ForeignModifier]
    field signature as ForeignType
    field link_name as Option[string]   # nom symbole externe
    field span as Span
.end

# ---------------------------------------------------------
# Déclaration de variable foreign
# ---------------------------------------------------------

form ForeignVar
    field name as Ident
    field abi as ForeignAbi
    field ty as TypeExpr
    field mutable as bool
    field link_name as Option[string]
    field span as Span
.end

# ---------------------------------------------------------
# Élément foreign (top-level)
# ---------------------------------------------------------

pick ForeignItem
    case Function(item as ForeignFn)
    case Variable(item as ForeignVar)
.end

# ---------------------------------------------------------
# Bloc foreign (groupement)
# ---------------------------------------------------------

form ForeignBlock
    field abi as ForeignAbi
    field items as List[ForeignItem]
    field span as Span
.end

# ---------------------------------------------------------
# Attributs foreign reconnus (pré-HIR)
# ---------------------------------------------------------

pick ForeignAttribute
    case LinkName(value as string)
    case Variadic
    case Unsafe
    case NoMangle
.end

# ---------------------------------------------------------
# Erreurs AST liées au foreign (pré-HIR)
# ---------------------------------------------------------

pick ForeignError
    case InvalidAbi(span as Span)
    case DuplicateLinkName(name as string, span as Span)
    case InvalidModifier(modifier as ForeignModifier, span as Span)
    case MissingLinkName(span as Span)
.end

# ---------------------------------------------------------
# Types (référence minimale)
# ---------------------------------------------------------

pick TypeExpr
    case Simple(name as Ident)
    case Generic(name as Ident, args as List[TypeExpr])
.end