# =========================================================
# Vitte 1.0 — AST / Expr / BlockExpr
# =========================================================

space vitte/ast/expr/block_expr

share all

<<< doc
Ce module définit les *expressions de bloc* dans l’AST Vitte.

Un block expression :
- est un bloc utilisé comme expression
- introduit un scope lexical
- peut produire une valeur (via `give`)
- est distinct d’un block statement classique

Exemples conceptuels :
    x = do
        make a as int = 1
        give a + 1
    .end

À ce niveau :
- aucune vérification de type
- aucune vérification de flux
- aucune règle de terminaison imposée
>>>

# ---------------------------------------------------------
# Dépendances communes
# ---------------------------------------------------------

pull vitte/ast/common/span
pull vitte/ast/common/ident

# ---------------------------------------------------------
# Expression de bloc
# ---------------------------------------------------------

form BlockExpr
    field block as Block
    field span as Span
.end

# ---------------------------------------------------------
# Bloc utilisé comme expression
# ---------------------------------------------------------

form Block
    field statements as List[Stmt]
    field span as Span
.end

# ---------------------------------------------------------
# Statements autorisés dans un block expression
# ---------------------------------------------------------

pick Stmt
    case Make(stmt as MakeStmt)
    case Give(stmt as GiveStmt)
    case Emit(stmt as EmitStmt)
    case If(stmt as IfStmt)
    case Select(stmt as SelectStmt)
    case Expr(stmt as ExprStmt)
.end

# ---------------------------------------------------------
# make <ident> as <type> = <expr>
# ---------------------------------------------------------

form MakeStmt
    field name as Ident
    field ty as TypeExpr
    field value as Expr
    field span as Span
.end

# ---------------------------------------------------------
# give <expr>  (produit la valeur du block expression)
# ---------------------------------------------------------

form GiveStmt
    field value as Expr
    field span as Span
.end

# ---------------------------------------------------------
# emit <expr>
# ---------------------------------------------------------

form EmitStmt
    field value as Expr
    field span as Span
.end

# ---------------------------------------------------------
# if / otherwise (block expression compatible)
# ---------------------------------------------------------

form IfStmt
    field condition as Expr
    field then_block as Block
    field else_block as Option[Block]
    field span as Span
.end

# ---------------------------------------------------------
# select / when / otherwise
# ---------------------------------------------------------

form SelectStmt
    field value as Expr
    field whens as List[WhenStmt]
    field otherwise as Option[Block]
    field span as Span
.end

form WhenStmt
    field pattern as Pattern
    field block as Block
    field span as Span
.end

# ---------------------------------------------------------
# Expression statement
# ---------------------------------------------------------

form ExprStmt
    field expr as Expr
    field span as Span
.end

# ---------------------------------------------------------
# Expressions utilisables dans un block expression
# ---------------------------------------------------------

pick Expr
    case Ident(name as Ident)
    case Literal(value as Literal)
    case Call(expr as CallExpr)
    case Binary(expr as BinaryExpr)
    case Assign(expr as AssignExpr)
    case Block(expr as BlockExpr)
    case Group(expr as Expr)
.end

# ---------------------------------------------------------
# Expressions support
# ---------------------------------------------------------

form CallExpr
    field callee as Expr
    field args as List[Expr]
    field span as Span
.end

form BinaryExpr
    field left as Expr
    field op as BinaryOp
    field right as Expr
    field span as Span
.end

form AssignExpr
    field target as LValue
    field value as Expr
    field span as Span
.end

# ---------------------------------------------------------
# LValue
# ---------------------------------------------------------

pick LValue
    case Ident(name as Ident)
    case Field(base as Expr, field as Ident)
.end

# ---------------------------------------------------------
# Opérateurs binaires
# ---------------------------------------------------------

pick BinaryOp
    case Add
    case Sub
    case Mul
    case Div
    case Eq
    case Ne
    case Lt
    case Le
    case Gt
    case Ge
    case And
    case Or
.end

# ---------------------------------------------------------
# Patterns (pour select / when)
# ---------------------------------------------------------

pick Pattern
    case Ident(name as Ident)
    case Ctor(ty as TypeExpr, args as List[Pattern])
.end

# ---------------------------------------------------------
# Types (référence minimale)
# ---------------------------------------------------------

pick TypeExpr
    case Simple(name as Ident)
    case Generic(name as Ident, args as List[TypeExpr])
.end

# ---------------------------------------------------------
# Littéraux
# ---------------------------------------------------------

pick Literal
    case Bool(value as bool)
    case Int(value as string)
    case String(value as string)
.end

# ---------------------------------------------------------
# Erreurs AST potentielles (pré-HIR)
# ---------------------------------------------------------

pick BlockExprError
    case EmptyBlock(span as Span)
    case MissingGive(span as Span)
    case MultipleGive(span as Span)
.end