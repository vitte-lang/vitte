# =========================================================
# Vitte 1.0 — AST / Common / Path
# =========================================================

space vitte/ast/common/path

share all

<<< doc
Ce module définit la représentation AST des chemins (paths)
dans le langage Vitte.

Un path est utilisé pour :
- les modules (space, pull, at)
- les références qualifiées futures
- la structuration logique du code

Syntaxe source correspondante :
    module_path ::= ident { "/" ident }

Aucune résolution (lookup) n’est faite ici.
>>>

# ---------------------------------------------------------
# Position source
# ---------------------------------------------------------

form Span
    field file as string
    field line_start as u32
    field line_end as u32
    field column_start as u32
    field column_end as u32
.end

# ---------------------------------------------------------
# Identifiant simple (référence)
# ---------------------------------------------------------

form Ident
    field name as string
    field span as Span
.end

# ---------------------------------------------------------
# Segment de chemin
# ---------------------------------------------------------

form PathSegment
    field ident as Ident
.end

# ---------------------------------------------------------
# Chemin AST
# ---------------------------------------------------------

form Path
    field segments as List[PathSegment]
    field span as Span
.end

# ---------------------------------------------------------
# Chemin qualifié (pré-résolution)
# ---------------------------------------------------------

form QualifiedPath
    field path as Path
    field absolute as bool
.end

# ---------------------------------------------------------
# Usage du chemin (contexte syntaxique)
# ---------------------------------------------------------

pick PathKind
    case Module        # space / pull / entry at
    case Type          # type qualifié (futur)
    case Value         # valeur qualifiée (futur)
    case Attribute     # #[path] (futur)
.end

# ---------------------------------------------------------
# Chemin annoté (pré-HIR)
# ---------------------------------------------------------

form AnnotatedPath
    field path as Path
    field kind as PathKind
.end

# ---------------------------------------------------------
# Erreurs syntaxiques liées aux chemins
# ---------------------------------------------------------

pick PathError
    case Empty(span as Span)
    case InvalidSegment(name as string, span as Span)
.end

# ---------------------------------------------------------
# Constructeurs utilitaires (AST-level)
# ---------------------------------------------------------

proc make_path(
    segments as List[Ident],
    span as Span
) gives Path

    give Path(
        segments
            |> map (ident => PathSegment(ident)),
        span
    )
.end

proc single_path(
    ident as Ident
) gives Path

    give Path(
        [PathSegment(ident)],
        ident.span
    )
.end

# ---------------------------------------------------------
# Accès utilitaires
# ---------------------------------------------------------

proc path_length(path as Path) gives u32
    give len(path.segments)
.end

proc path_is_empty(path as Path) gives bool
    give len(path.segments) == 0
.end

proc path_first(path as Path) gives Option[PathSegment]
    select path.segments
        when []
            give none
    otherwise
        give path.segments[0]
    .end
.end

proc path_last(path as Path) gives Option[PathSegment]
    select path.segments
        when []
            give none
    otherwise
        give path.segments[len(path.segments) - 1]
    .end
.end