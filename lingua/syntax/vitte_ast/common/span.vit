# =========================================================
# Vitte 1.0 â€” AST / Common / Span
# =========================================================

space vitte/ast/common/span

share all

<<< doc
Ce module dÃ©finit le modÃ¨le canonique de position source
pour lâ€™ensemble du compilateur Vitte.

Il est utilisÃ© par :
- lexer
- parser
- AST
- diagnostics
- formatter
- LSP

RÃ¨gle stricte :
ðŸ‘‰ AUCUN autre module ne doit redÃ©finir Position ou Span.
>>>

# ---------------------------------------------------------
# Position source Ã©lÃ©mentaire
# ---------------------------------------------------------

form Position
    field line as u32       # ligne (1-based)
    field column as u32     # colonne (1-based)
    field offset as u32     # offset absolu (0-based)
.end

# ---------------------------------------------------------
# Intervalle source
# ---------------------------------------------------------

form Span
    field start as Position
    field end as Position
    field synthetic as bool   # true si gÃ©nÃ©rÃ© (pas issu du source)
.end

# ---------------------------------------------------------
# Constructeurs
# ---------------------------------------------------------

proc position_new(
    line as u32,
    column as u32,
    offset as u32
) gives Position

    give Position(line, column, offset)
.end

proc span_new(
    start as Position,
    end as Position
) gives Span

    give Span(start, end, false)
.end

proc span_synthetic() gives Span

    give Span(
        Position(0, 0, 0),
        Position(0, 0, 0),
        true
    )
.end

# ---------------------------------------------------------
# RequÃªtes utilitaires
# ---------------------------------------------------------

proc span_is_synthetic(span as Span) gives bool
    give span.synthetic
.end

proc span_contains(
    span as Span,
    pos as Position
) gives bool

    give pos.offset >= span.start.offset
     and pos.offset <= span.end.offset
.end

proc span_is_empty(span as Span) gives bool
    give span.start.offset == span.end.offset
.end

# ---------------------------------------------------------
# Fusion de spans
# ---------------------------------------------------------

proc span_merge(
    a as Span,
    b as Span
) gives Span

    if a.synthetic
        give b
    .end

    if b.synthetic
        give a
    .end

    make start as Position =
        if a.start.offset <= b.start.offset
            a.start
        else
            b.start
        .end

    make end as Position =
        if a.end.offset >= b.end.offset
            a.end
        else
            b.end
        .end

    give Span(start, end, false)
.end

# ---------------------------------------------------------
# Comparaisons
# ---------------------------------------------------------

proc span_eq(
    a as Span,
    b as Span
) gives bool

    give a.start.offset == b.start.offset
     and a.end.offset == b.end.offset
     and a.synthetic == b.synthetic
.end

# ---------------------------------------------------------
# ReprÃ©sentation texte (debug / diagnostics)
# ---------------------------------------------------------

proc position_to_string(pos as Position) gives string
    give pos.line + ":" + pos.column
.end

proc span_to_string(span as Span) gives string

    if span.synthetic
        give "<synthetic>"
    .end

    give
        position_to_string(span.start)
        + "-"
        + position_to_string(span.end)
.end